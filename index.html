
<!DOCTYPE html>
<html lang="pt-BR">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gerenciador de Times de Mato Real</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #121212; --bg-card: #1E1E1E; --bg-input: #2C2C2C;
            --primary: #00E676; --secondary: #2979FF; --danger: #FF1744; --warning: #FFC400; --purple: #D500F9;
            --text-main: #FFFFFF; --border: #333333;
        }
        body { background: var(--bg-dark); color: var(--text-main); font-family: 'Roboto', sans-serif; margin: 0; padding-bottom: 80px; -webkit-font-smoothing: antialiased; }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        .card { background: var(--bg-card); padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.4); position: relative; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; transition: 0.2s; margin-bottom: 5px; color: white; }
        .btn:active { transform: scale(0.98); }
        .btn-green { background: var(--primary); color: #000; }
        .btn-blue { background: var(--secondary); }
        .btn-red { background: var(--danger); }
        .btn-gold { background: var(--warning); color: #000; }
        .btn-purple { background: var(--purple); }
        .btn-ghost { background: transparent; border: 1px solid #666; color: #ccc; }
        .input-field { width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border); color: white; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-family: inherit; font-size: 14px; }
        .input-field:focus { outline: 2px solid var(--primary); border-color: transparent; }
        .header { background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px); padding: 15px; position: sticky; top: 0; z-index: 50; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .badge-pos { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 900; margin-right: 8px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        .player-ov { background: #003300; color: #00E676; border: 1px solid #00E676; padding: 2px 6px; border-radius: 4px; font-weight: 900; font-size: 14px; }
        .news-card { background: #262626; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #666; font-size: 13px; line-height: 1.4; white-space: pre-wrap; }
        .news-transfer { border-color: var(--secondary); background: linear-gradient(90deg, #1a1a2e, #16213e); }
        .news-money { border-color: var(--primary); }
        .news-money-minus { border-color: var(--danger); }
        .news-admin { border-color: var(--warning); background: #2a2000; }
        .news-press { border-color: #00bcd4; background: #003333; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; border-top: 1px solid var(--border); display: flex; padding-bottom: env(safe-area-inset-bottom); z-index: 100; }
        .nav-item { flex: 1; padding: 12px; text-align: center; color: #666; font-size: 9px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; display: block; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 999; display: grid; place-items: center; padding: 15px; backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-card); width: 100%; max-width: 450px; padding: 20px; border-radius: 12px; border: 1px solid var(--border); max-height: 90vh; overflow-y: auto; }
        .login-tabs { display: flex; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #666; font-weight: bold; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .rating-badge { color: var(--warning); font-weight: bold; font-size: 11px; margin-left: 5px; display: flex; align-items: center; gap: 2px; text-shadow: 0 1px 2px black; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 10px; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px; }
        .stat-item { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .stat-lbl { font-size: 14px; margin-bottom: 2px; }
        .stat-val { color: #fff; font-weight: 900; font-size: 11px; }
        .dev-credits { font-size: 10px; color: #666; margin-top: -5px; margin-bottom: 15px; text-align: center; display: block; width: 100%; }
        .error-screen { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #220000; color: #ff5555; padding: 20px; text-align: center; }
        .rank-tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .rank-tabs::-webkit-scrollbar { display: none; }
        .rank-tab { background: #333; border: 1px solid #444; color: #888; padding: 8px 16px; border-radius: 20px; font-size: 12px; white-space: nowrap; cursor: pointer; transition: 0.2s; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .rank-tab.active { background: var(--primary); color: #000; border-color: var(--primary); box-shadow: 0 0 10px rgba(0,230,118,0.3); }
        .rank-tab i { font-size: 14px; }
        .highlight-card { background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%); border: 1px solid var(--secondary); padding: 20px; text-align: center; margin-bottom: 15px; border-radius: 12px; position: relative; overflow: hidden; }
        .highlight-card::after { content: '‚òÖ'; position: absolute; top: -10px; right: -10px; font-size: 100px; color: rgba(255,255,255,0.05); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Crash:", error, errorInfo); }
            render() { 
                if (this.state.hasError) { 
                    return (
                        <div className="error-screen">
                            <h2>Ocorreu um erro!</h2>
                            <p>O aplicativo encontrou um problema inesperado.</p>
                            <button className="btn btn-red" onClick={()=>{localStorage.clear(); window.location.reload();}}>REINICIAR APLICATIVO</button>
                        </div>
                    ); 
                } 
                return this.props.children; 
            }
        }
// --- FIM DA ESTRUTURA INICIAL E ERRORBOUNDARY ---

       // --- CONFIGURA√á√ïES FIREBASE E CONSTANTES GLOBAIS ---
        const firebaseConfig = { 
            apiKey: "AIzaSyBrtJFfWAqT0AZYHlm4it-noB5h9jIPJEI", 
            authDomain: "gerenciador-de-times-matoreal.firebaseapp.com", 
            projectId: "gerenciador-de-times-matoreal", 
            storageBucket: "gerenciador-de-times-matoreal.firebasestorage.app", 
            messagingSenderId: "29096266740", 
            appId: "1:29096266740:web:ec48e7225c18c20dbc07a1" 
        };

        try { 
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); 
        } catch (e) { 
            console.error("Erro Firebase Init:", e); 
        }

        const db = firebase.firestore();
        const { useState, useEffect } = React;

        const POS = ['GOL', 'ZAG', 'LD', 'LE', 'VOL', 'MC', 'MEI', 'ATA'];
        const SERIES = ['A', 'B', 'C', 'D'];
        const COSTS = [0, 5000000, 20000000, 50000000, 100000000];
        
        const fmt = (v) => "‚Ç£ " + parseFloat(v||0).toLocaleString('pt-BR');
        
        const getPosColor = (p) => { 
            if(!p) return '#555'; 
            if(p==='GOL') return '#FFD700'; 
            if(['ZAG','LD','LE'].some(x=>p.includes(x))) return '#2979FF'; 
            if(['VOL','MC','MEI'].some(x=>p.includes(x))) return '#00E676'; 
            return '#FF1744'; 
        };

        // --- ETAPA 1: CONSTANTES DE EMPRESAS ---
        const COMPANY_TYPES = {
            'COMERCIO': { label: 'Com√©rcio Local', start: 2500000, tax: 50000, desc: 'Ideal para iniciantes. Imposto baixo.' },
            'MEDIA': { label: 'M√©dia Empresa', start: 20000000, tax: 350000, desc: 'Poder moderado. Imposto m√©dio.' },
            'GRANDE': { label: 'Grande Empresa', start: 100000000, tax: 2000000, desc: 'Gigante do mercado. Imposto alto.' }
        };
        // --- FIM DAS CONSTANTES DE EMPRESAS ---
        
        // --- CATEGORIAS DE PRODUTOS ---
        const PROD_CATS = {
            'CHUTEIRA': 'üëü Chuteira',
            'LUVAS': 'üß§ Luvas/Acess√≥rios',
            'CONSUMIVEL': '‚ö° Consum√≠vel/Energia',
            'VEICULO': 'üöó Ve√≠culo',
            'IMOVEL': 'üè† Im√≥vel',
            'TECNOLOGIA': 'üì± Tecnologia',
            'LUXO': 'üíé Luxo/Moda',
            'SAUDE': 'üíä Sa√∫de'
        };
        // --- FIM DAS CATEGORIAS DE PRODUTOS ---
        
        // --- SISTEMA DE RPG (N√çVEL, XP, ENERGIA) ---
        const MIN_LEVEL = 45;
        const MAX_LEVEL = 100;
        
        // F√≥rmula: Quanto XP precisa para ir pro pr√≥ximo n√≠vel?
        // Ex: N√≠vel 45 precisa de 4500 XP. N√≠vel 90 precisa de 9000 XP.
        const getXPNext = (lvl) => (lvl * 100); 

        // Fun√ß√£o para calcular ganho/perda de XP e mudan√ßa de n√≠vel
        const calcNewLevel = (currentLvl, currentXP, change) => {
            let lvl = currentLvl;
            let xp = currentXP + change;
            
            // L√≥gica para Subir de n√≠vel (Level Up)
            while (xp >= getXPNext(lvl) && lvl < MAX_LEVEL) {
                xp -= getXPNext(lvl);
                lvl++;
            }
            
            // L√≥gica para Cair de n√≠vel (Level Down)
            while (xp < 0 && lvl > MIN_LEVEL) {
                lvl--;
                xp += getXPNext(lvl); // Recupera o XP do n√≠vel anterior para continuar a conta
            }
            
            // Limites de Seguran√ßa
            if (lvl <= MIN_LEVEL && xp < 0) xp = 0;
            if (lvl >= MAX_LEVEL) xp = 0;

            return { lvl, xp };
        };
        // --- FIM DO SISTEMA DE RPG ---
        

        // --- FORMATA√á√ÉO DE DETALHES DA OFERTA ---
        const formatOfferDetails = (type, v, con, meta, swapIds, players) => {
            let details = [];
            
            // Valor principal
            if(v > 0) details.push(`üí∞ Valor: ${fmt(v)}`);
            
            // L√≥gica de Parcelamento
            if (meta.installments > 1) {
                details.push(`üìÖ Parcelamento: ${meta.installments}x de ${fmt(v / meta.installments)}`);
            }
            
            // Dura√ß√£o do v√≠nculo (exceto em trocas puras)
            if (type !== 'TROCA') {
                details.push(`üìù Contrato: ${con} Temporadas`);
            }
            
            // Cl√°usula de Revenda (apenas para compras)
            if (type === 'COMPRA' && meta.sellOn > 0) {
                details.push(`üìà Revenda: ${meta.sellOn}% futura venda`);
            }
            
            // Regras de Empr√©stimo
            if (type === 'EMPRESTIMO') { 
                details.push(`üí∏ Sal√°rios: Comprador paga ${meta.wageSplit}%`); 
                if (meta.buyOpt > 0) details.push(`üõí Op√ß√£o de Compra: ${fmt(meta.buyOpt)}`); 
            }
            
            // L√≥gica de Troca de Jogadores
            if (type === 'TROCA') {
                if (swapIds && swapIds.length > 0) { 
                    const swapNames = swapIds.map(id => players.find(p => p.id === id)?.name).join(', '); 
                    details.push(`üîÑ Troca por: ${swapNames}`); 
                }
                if (v > 0) {
                    details.push(`üíµ Volta: ${meta.cashDir === 'PAY' ? 'Eu pago' : 'Eu recebo'} ${fmt(v)}`);
                }
            }
            
            return details.join('\n');
        };
        // --- FIM DA FORMATA√á√ÉO DE OFERTA ---

        // --- IN√çCIO DO COMPONENTE APP ---
function App() {
    // 1. ESTADOS (Vari√°veis que o React monitora)
    const [user, setUser] = useState(null); 
    const [teams, setTeams] = useState([]);
    const [players, setPlayers] = useState([]);
    const [offers, setOffers] = useState([]);
    const [news, setNews] = useState([]);
    const [reqs, setReqs] = useState([]);
    const [conf, setConf] = useState({ marketOpen: true });
    const [papers, setPapers] = useState([]);
    const [journalists, setJournalists] = useState([]);
    const [companies, setCompanies] = useState([]);
    const [products, setProducts] = useState([]);
    const [sps, setSps] = useState([]);
    
    const [screen, setScreen] = useState('HOME');
    const [modal, setModal] = useState(null);
    const [loading, setLoading] = useState(true);
    const [newNews, setNewNews] = useState(false);
    const [adminTeam, setAdminTeam] = useState(null); 
    const [sales, setSales] = useState([]);

    // 2. SINCRONIZA√á√ÉO COM O BANCO DE DADOS (Firebase)
    useEffect(() => {
        const unsubs = [
            db.collection('teams').onSnapshot(s => setTeams(s.docs.map(d => ({id:d.id, ...d.data()})))),
            db.collection('players').onSnapshot(s => setPlayers(s.docs.map(d => ({id:d.id, ...d.data()})))),
            db.collection('config').doc('system').onSnapshot(s => setConf(s.exists ? s.data() : {marketOpen:true})),
            db.collection('financeRequests').onSnapshot(s => setReqs(s.docs.map(d => ({id:d.id, ...d.data()})))),
            db.collection('newspapers').onSnapshot(s => setPapers(s.docs.map(d => ({id:d.id, ...d.data()})))),
            db.collection('journalists').onSnapshot(s => setJournalists(s.docs.map(d => ({id:d.id, ...d.data()})))),
            db.collection('companies').onSnapshot(s => setCompanies(s.docs.map(d => ({id:d.id, ...d.data()})))),
            db.collection('products').onSnapshot(s => setProducts(s.docs.map(d => ({id:d.id, ...d.data()})))),
            db.collection('sponsorships').onSnapshot(s => setSps(s.docs.map(d => ({id:d.id, ...d.data()})))),
            db.collection('sales').orderBy('date', 'desc').limit(50).onSnapshot(s => setSales(s.docs.map(d => d.data()))),
            db.collection('news').orderBy('date', 'desc').limit(50).onSnapshot(s => { 
                const list = s.docs.map(d => ({id:d.id, ...d.data()})); 
                setNews(list); 
                const lastRead = localStorage.getItem('lastRead'); 
                if (list.length && (!lastRead || list[0].date > parseInt(lastRead))) setNewNews(true); 
                setLoading(false); 
            })
        ];
        return () => unsubs.forEach(u => u());
    }, []);

    // 3. MONITORAMENTO DO USU√ÅRIO LOGADO
    useEffect(() => {
        if (user?.type === 'USER') {
            const me = teams.find(t => t.id === user.data.id);
            if (me) setUser(prev => ({...prev, data: me}));
            return db.collection('offers').onSnapshot(s => {
                setOffers(s.docs.map(d => ({id:d.id, ...d.data()})));
            });
        }
        
        if (user?.type === 'COMPANY') {
            const me = companies.find(c => c.id === user.data.id);
            if (me) {
                if (me.status === 'BLOCKED') { alert("üö´ Empresa Bloqueada/Falida."); window.location.reload(); }
                else setUser(prev => ({...prev, data: me}));
            }
        }
    }, [teams, companies, user?.data?.id]);

    // 4. FUN√á√ïES DE SUPORTE
    const postNews = (text, type='normal') => db.collection('news').add({ text, type, date: Date.now() });

    // 5. SISTEMA DE LOGIN (Multin√≠vel)
    const login = (id, pwd, type) => {
        if (type === 'TEAM') { 
            const t = teams.find(x => x.id === id); 
            if (t && t.password === pwd) { 
                if (t.status === 'PENDING') alert("‚è≥ Aguarde a Federa√ß√£o."); 
                else { setUser({type:'USER', data:t}); setScreen('HOME'); } 
            } else alert("Erro!"); 
        } 
        else if (type === 'PAPER') { 
            const p = papers.find(x => x.id === id); 
            if (p && p.password === pwd) { 
                if (p.status === 'PENDING') alert("‚è≥ Aguarde a Federa√ß√£o."); 
                else { setUser({type:'PRESS', data:p}); setScreen('PRESS_DASH'); } 
            } else alert("Erro!"); 
        } 
        else if (type === 'JOURNALIST') { 
            const j = journalists.find(x => x.id === id); 
            if (j && j.password === pwd) { 
                if (j.status === 'PENDING') alert("‚è≥ Aguarde o Dono do Jornal."); 
                else { setUser({type:'PRESS_WORKER', data:j}); setScreen('PRESS_DASH'); } 
            } else alert("Erro!"); 
        }
        else if (type === 'COMPANY') { 
            const c = companies.find(x => x.id === id); 
            if (c && c.password === pwd) { 
                if (c.status === 'PENDING') alert("‚è≥ Aguarde a Federa√ß√£o."); 
                else if (c.status === 'BLOCKED') alert("üö´ Empresa Bloqueada."); 
                else { setUser({type:'COMPANY', data:c}); setScreen('COMPANY_HOME'); } 
            } else alert("Erro!"); 
        }
        else if (type === 'PLAYER') { 
             const pl = players.find(x => x.id === id); 
             const pass = pl.password || '1234'; 
             if (pl && pass === pwd) { 
                 setUser({type:'PLAYER', data:pl}); 
                 setScreen('PLAYER_DASH'); 
             } else alert("Senha incorreta!"); 
        }
    };
// --- FIM DA L√ìGICA DE LOGIN ---
    
// --- FUN√á√ïES DE ACESSO E CRIA√á√ÉO DE ENTIDADES ---
        
        // 1. Acesso Admin (Federa√ß√£o)
        const loginAdmin = () => { 
            setUser({ 
                type: 'ADMIN', 
                data: { id: 'admin', name: 'FEDERA√á√ÉO (ADM)', balance: 0, logo: null, stadiumLevel: 1, serie: 'ADM' } 
            }); 
            setScreen('HOME'); 
        };
       
    // --- FUN√á√ÉO: CRIAR TIME ---
        const createTeam = async (name, bal, serie, pass, logo) => { 
            // Verifica se o nome j√° existe (independente de mai√∫sculas/min√∫sculas)
            if(teams.find(t => t.name.toLowerCase() === name.toLowerCase())) {
                return alert("Nome em uso!"); 
            }

            // Salva no banco de dados com status inicial PENDING
            await db.collection('teams').add({ 
                name, 
                balance: parseFloat(bal), 
                serie, 
                password: pass, 
                stadiumLevel: 1, 
                logo: logo || null, 
                status: 'PENDING' 
            }); 

            alert("Criado! Aguarde aprova√ß√£o."); 
        };
        // --- FIM DA FUN√á√ÉO CRIAR TIME ---

    // --- FUN√á√ÉO: CRIAR JORNAL ---
        const createNewspaper = async (name, pass, owner) => { 
            // Adiciona o jornal √† cole√ß√£o 'newspapers' com status PENDING
            await db.collection('newspapers').add({ 
                name, 
                password: pass, 
                ownerName: owner, 
                status: 'PENDING' 
            }); 
            
            alert("Jornal criado! Aguarde Federa√ß√£o."); 
        };
        // --- FIM DA FUN√á√ÉO CRIAR JORNAL ---    

    // --- FUN√á√ÉO: CRIAR JORNALISTA ---
        const createJournalist = async (name, pass, paperId) => { 
            // Registra o jornalista vinculado a um ID de jornal espec√≠fico
            await db.collection('journalists').add({ 
                name, 
                password: pass, 
                newspaperId: paperId, 
                status: 'PENDING' 
            }); 
            
            alert("Conta criada! Aguarde a aprova√ß√£o do Diretor do Jornal."); 
        };
        // --- FIM DA FUN√á√ÉO CRIAR JORNALISTA ---
            
            // --- FUN√á√ÉO: CRIAR EMPRESA ---
        const createCompany = async (f) => {
            // Valida√ß√£o simples de campos obrigat√≥rios
            if(!f.n || !f.p) return alert("Preencha tudo!");

            // Adiciona a empresa ao banco de dados
            await db.collection('companies').add({ 
                name: f.n, 
                owner: f.owner, 
                password: f.p, 
                companyType: f.type, 
                balance: COMPANY_TYPES[f.type].start, // Define saldo inicial autom√°tico
                status: 'PENDING' 
            });

            alert("Solicita√ß√£o enviada! Aguarde a Federa√ß√£o.");
        };
        // --- FIM DA FUN√á√ÉO CRIAR EMPRESA ---
    
            // --- ETAPA 2: L√≥gica de Produtos ---
const saveProduct = async (p) => {
    const price = parseFloat(p.price);
    
    // Montagem do objeto que ser√° enviado ao banco de dados
    const payload = { 
        name: p.name, 
        price, 
        img: p.img, 
        desc: p.desc,
        cat: p.cat || 'CHUTEIRA', // Garante que sempre ter√° uma categoria
        companyId: user.data.id 
    };

    if (p.id) {
        // CASO 1: O produto j√° existe (EDI√á√ÉO)
        const old = products.find(x => x.id === p.id);
        
        // Verifica se baixou o pre√ßo para anunciar a promo√ß√£o
        if (old && price < old.price) { 
            postNews(`üö® **PROMO√á√ÉO!**\nA **${user.data.name}** baixou o pre√ßo de **${p.name}**!\nDe: ${fmt(old.price)} ‚ûù Por: ${fmt(price)}`, 'biz'); 
        }
        
        // Remove o ID da empresa do "pacote" por seguran√ßa, para n√£o trocar o dono original
        delete payload.companyId; 
        await db.collection('products').doc(p.id).update(payload);
    } else {
        // CASO 2: O produto √© novo (CRIA√á√ÉO)
        await db.collection('products').add(payload);
        postNews(`üõçÔ∏è **NOVIDADE**\nA **${user.data.name}** lan√ßou: **${p.name}** (${PROD_CATS[payload.cat]}) por ${fmt(price)}.`, 'biz');
    }
};
// --- FIM DO COMPONENTE saveProduct ---
    
            // --- ETAPA 3: L√≥gica de Shopping e Patroc√≠nio ---

// 1. Enviar pedido de patroc√≠nio do Clube para a Empresa
const requestSponsorship = async (companyId, val) => {
    // Verifica se j√° existe pedido pendente ou ativo com essa empresa para evitar duplicatas
    if (sps.find(s => s.companyId === companyId && s.teamId === user.data.id)) {
        return alert("J√° existe uma negocia√ß√£o ou contrato ativo com esta empresa.");
    }
    const comp = companies.find(c => c.id === companyId);
    await db.collection('sponsorships').add({ 
        companyId, 
        companyName: comp.name, 
        teamId: user.data.id, 
        teamName: user.data.name, 
        value: parseFloat(val), 
        status: 'PENDING' 
    });
    alert("Proposta enviada para a empresa!");
};

// 2. Empresa aceita, recusa ou cancela o patroc√≠nio
const processSponsorship = async (s, status) => {
    if (status === 'REJECTED' || status === 'CANCELLED') {
        if(confirm(status === 'REJECTED' ? "Recusar proposta?" : "Cancelar contrato?")) {
            await db.collection('sponsorships').doc(s.id).delete();
        }
    } else if (status === 'ACTIVE') {
        await db.collection('sponsorships').doc(s.id).update({ status: 'ACTIVE' });
        postNews(`ü§ù **NOVO PATROC√çNIO**\nA **${user.data.name}** agora patrocina o **${s.teamName}**!`, 'biz');
    }
};

// 3. Sistema de compra de produtos (Shopping Global)
const buyProduct = async (prod, seller) => {
    const currentBalance = user.data.balance || 0;
    
    if (currentBalance < prod.price) return alert("Saldo insuficiente!");
    if (!confirm(`Comprar ${prod.name} por ${fmt(prod.price)}?`)) return;

    const b = db.batch();
    
    // Desconta o dinheiro do comprador (seja Jogador ou Clube)
    if (user.type === 'PLAYER') {
        b.update(db.collection('players').doc(user.data.id), { balance: currentBalance - prod.price });
    } else {
        b.update(db.collection('teams').doc(user.data.id), { balance: currentBalance - prod.price });
    }

    // Paga a empresa vendedora
    b.update(db.collection('companies').doc(seller.id), { balance: (seller.balance || 0) + prod.price });
    
    // Registra a venda no hist√≥rico global
    const saleRef = db.collection('sales').doc();
    b.set(saleRef, { 
        companyId: seller.id, 
        productName: prod.name, 
        buyerName: user.data.name, 
        price: prod.price, 
        date: Date.now() 
    });
    
    await b.commit();
    alert("Compra realizada com sucesso!");
};
// --- FIM DA L√ìGICA DE SHOPPING E PATROC√çNIO ---

            // --- IN√çCIO DO BLOCO DE GEST√ÉO ADMINISTRATIVA ---

// 1. Aprovar Clube Pendente
const approveTeam = async (teamId, finalBalance) => { 
    await db.collection('teams').doc(teamId).update({ status: 'ACTIVE', balance: parseFloat(finalBalance) }); 
    const t = teams.find(x=>x.id===teamId); 
    postNews(`üõ°Ô∏è **NOVO CLUBE!**\nO **${t.name}** foi aprovado na S√©rie ${t.serie}.`, 'infra'); 
    alert("Aprovado!"); 
};

// 2. Excluir Time (Apaga o time e os jogadores vinculados)
const deleteTeam = async (teamId) => { 
    if(!confirm("‚ö†Ô∏è PERIGO: Excluir time e jogadores?")) return; 
    const batch = db.batch(); 
    batch.delete(db.collection('teams').doc(teamId)); 
    const snap = await db.collection('players').where('teamId', '==', teamId).get(); 
    snap.docs.forEach(doc => batch.delete(doc.ref)); 
    await batch.commit(); 
    postNews("üö´ **CLUBE EXTINTO**\nUm time encerrou atividades.", 'infra'); 
};

// 3. Excluir Jornal (Apaga o jornal e demite os jornalistas)
const deletePaper = async (id) => { 
    if(!confirm("Excluir Jornal e demitir jornalistas?")) return; 
    const batch = db.batch(); 
    batch.delete(db.collection('newspapers').doc(id)); 
    const js = await db.collection('journalists').where('newspaperId', '==', id).get(); 
    js.docs.forEach(d => batch.delete(d.ref)); 
    await batch.commit(); 
    alert("Jornal fechado!"); 
};

// 4. Demitir Jornalista
const deleteJournalist = async (id) => { 
    if(!confirm("Demitir Jornalista?")) return; 
    await db.collection('journalists').doc(id).delete(); 
    alert("Demitido!"); 
};

// 5. Atualizar Saldo de Time (Admin)
const updateBalance = async (teamId, newBal) => { 
    await db.collection('teams').doc(teamId).update({ balance: parseFloat(newBal) }); 
    alert("Atualizado!"); 
};

// 6. Retirar Dinheiro do Caixa (Clubes)
const withdrawMoney = async (amount, reason) => { 
    const val = parseFloat(amount.replace(',', '.')); 
    if(isNaN(val) || val <= 0) return alert("Valor inv√°lido!"); 
    if(user.data.balance < val) return alert("Saldo insuficiente!"); 
    await db.collection('teams').doc(user.data.id).update({ balance: firebase.firestore.FieldValue.increment(-val) }); 
    postNews(`üí∏ **SA√çDA DE CAIXA**\nO **${user.data.name}** retirou ${fmt(val)}.\nüìù Motivo: ${reason}`, 'money-minus'); 
    setModal(null); 
};

    // 7. Injetar Verba (Conecta com o bot√£o de Configura√ß√£o)
const requestFunds = async (teamId, amount) => {
    // Reutiliza a sua fun√ß√£o updateBalance para facilitar
    const team = teams.find(t => t.id === teamId);
    const newTotal = (team.balance || 0) + parseFloat(amount);
    await updateBalance(teamId, newTotal);
    postNews(`üí∞ **INJE√á√ÉO DE CAPITAL**\nO Federa√ß√£o injetou verbas no **${team.name}**.`, 'money-plus');
};

// 8. Retirar Verba (Conecta com o bot√£o de Configura√ß√£o)
const withdrawFunds = async (teamId, amount) => {
    const team = teams.find(t => t.id === teamId);
    const val = parseFloat(amount);
    if(team.balance < val) return alert("Saldo insuficiente no clube!");
    const newTotal = team.balance - val;
    await updateBalance(teamId, newTotal);
    postNews(`üí∏ **VERBA RECOLHIDA**\nRecolhimento de ${fmt(val)} do **${team.name}**.`, 'money-minus');
};

// 9. Expandir Est√°dio
const upgradeStadium = async (team) => {
    const currentLevel = team.stadiumLevel || 1;
    const nextLevel = currentLevel + 1;
    const cost = nextLevel * 2000000; // Custo base por n√≠vel

    if(team.balance < cost) return alert(`Saldo insuficiente! Expans√£o custa ${fmt(cost)}`);
    
    if(confirm(`Confirmar expans√£o para N√≠vel ${nextLevel} por ${fmt(cost)}?`)) {
        const batch = db.batch();
        batch.update(db.collection('teams').doc(team.id), {
            stadiumLevel: nextLevel,
            balance: team.balance - cost
        });
        await batch.commit();
        postNews(`üèóÔ∏è **REFORMAS**\nO **${team.name}** anunciou a expans√£o do seu est√°dio para o N√≠vel ${nextLevel}!`, 'infra');
        alert("Obra iniciada!");
        setModal(null);
    }
};
// --- FIM DO BLOCO DE GEST√ÉO ADMINISTRATIVA ---
    
           // --- FUN√á√ÉO DE SALVAR JOGADOR (CORRIGIDA) ---
const savePlayer = async (d) => {
    try {
        const isNew = !d.id;
        const ref = isNew ? db.collection('players').doc() : db.collection('players').doc(d.id);
        const old = isNew ? {} : (players.find(pl => pl.id === d.id) || {});

        // REGRA DE OURO: Define para qual time o jogador vai (USER ou ADMIN)
        let targetTeamId = d.teamId || old.teamId || 'FREE';
        if (user.type === 'USER') targetTeamId = user.data.id;
        if (user.type === 'ADMIN' && adminTeam) targetTeamId = adminTeam.id;
        if (d.forcedTeamId) targetTeamId = d.forcedTeamId;

        const data = {
            name: d.name || "Jogador Novo",
            position: d.position || "ATA",
            overall: Math.max(45, parseInt(d.overall) || 45),
            value: parseFloat(d.value) || 0,
            salary: parseFloat(d.salary) || 1000,
            clause: parseFloat(d.clause) || 1000000,
            contract: parseInt(d.contract) || 1,
            mood: d.mood || 'üòê',
            status: d.status || 'NAO_A_VENDA',
            teamId: targetTeamId,
            password: d.password || old.password || '1234',
            balance: parseFloat(d.balance || old.balance || 0),
            xp: parseInt(d.xp || old.xp || 0),
            energy: parseInt(d.energy || old.energy || 100),
            stats: d.stats || old.stats || { goals: 0, assists: 0, tackles: 0, saves: 0, yellows: 0, reds: 0 }
        };

        // Se o Admin mudar o overall manualmente, o XP reseta para evitar bugs de n√≠vel
        if (!isNew && data.overall !== old.overall) data.xp = 0;

        await ref.set(data, { merge: true });
        setModal(null);
        
        if (isNew) {
            const tName = teams.find(t => t.id === targetTeamId)?.name || "um clube";
            postNews(`üÜï **REFOR√áO**\nO **${tName}** contratou **${data.name}**!`, 'transfer');
        } else {
            alert("Jogador atualizado!");
        }
    } catch (e) {
        console.error(e);
        alert("Erro ao salvar! Verifique se digitou apenas n√∫meros nos campos de valor.");
    }
};
// Fun√ß√£o para abrir o modal de contraproposta
const handleCounterOffer = (offer) => {
    setModal({ 
        type: 'OFFER', 
        data: { 
            ...offer, 
            isCounter: true, // Identifica que n√£o √© uma oferta do zero
            originalOfferId: offer.id, // Refer√™ncia para desativar a oferta antiga depois
            
            // INVERS√ÉO DE PAP√âIS:
            // O targetId agora √© quem enviou a oferta original (buyerId)
            targetId: offer.buyerId, 
            playerName: offer.playerName,
            playerId: offer.playerId,
            
            // Dados de quem est√° contrapropondo (voc√™)
            buyerId: user.data.id,
            buyerName: user.data.name,
            
            // Sugest√£o de valores iniciais baseados na oferta recebida
            value: offer.value,
            contract: offer.contract
        } 
    });
};


    
// --- ATUALIZAR ESTAT√çSTICAS ---
const updateStats = async (pid, newStats) => { 
    await db.collection('players').doc(pid).update({ stats: newStats }); 
    alert("Stats Atualizados!"); 
    setModal(null); 
};
// --- FIM DO BLOCO DE JOGADORES ---

          // ============================================================
// SISTEMA DE NEGOCIA√á√ÉO: OFERTAS, ACEITES E RECUSAS
// ============================================================

const sendOffer = async (target, type, value, swapIds, con, meta, old) => {
    try {
        if (!user?.data?.id) throw new Error("Usu√°rio n√£o autenticado");
        
        const v = parseFloat(value) || 0;
        const years = parseInt(con) || 1;
        const pId = target?.id || old?.playerId;
        const pName = target?.name || old?.playerName;

        if (!pId) throw new Error("ID do jogador ausente");

        // L√≥gica de Destinat√°rio
        let recipientId = target?.teamId || old?.sellerId || 'FREE';
        if (old?.id) {
            recipientId = (user.data.id === old.buyerId) ? (old.sellerId || 'FREE') : old.buyerId;
        }

        const payload = {
            playerId: pId,
            playerName: pName,
            buyerId: old?.buyerId || user.data.id,
            buyerName: old?.buyerName || user.data.name,
            sellerId: target?.teamId || old?.sellerId || 'FREE',
            targetId: recipientId, 
            recipientId: recipientId,
            status: 'PENDING',
            type: type || 'TRANSFER√äNCIA',
            value: v,
            offerContract: years,
            date: Date.now(),
            description: `Taxa: ${fmt(v)}\nContrato: ${years} anos`,
            meta: meta || { installments: 1, newSalary: 0, role: 'RESERVA' }
        };

        const batch = db.batch();
        
        // Se for contraproposta, deletamos a anterior
        if (old?.id) {
            batch.delete(db.collection('offers').doc(old.id));
        }
        
        const newRef = db.collection('offers').doc();
        batch.set(newRef, payload);
        
        // O await agora funciona porque est√° dentro de uma fun√ß√£o async unificada
        await batch.commit(); 

        const msgHead = (old && old.id) ? "üîÑ CONTRAPROPOSTA" : "üíº NOVA OFERTA";
        postNews(`${msgHead}\nO **${user.data.name}** enviou termos por **${pName}**!`, 'transfer');
        
        setModal(null);
        alert("Proposta enviada com sucesso!");

    } catch (err) {
        console.error("ERRO NO ENVIO:", err);
        alert("Erro t√©cnico: " + err.message);
    }
};

// 2. ACEITAR OFERTA
const acceptOffer = async (o) => {
    try {
        const buy = teams.find(t => t.id === o.buyerId);
        const sel = teams.find(t => t.id === o.sellerId);
        const p = players.find(x => x.id === o.playerId);
        
        if (!buy || !p) return alert("Erro: Comprador ou Jogador n√£o encontrados.");
        
        const valorEntrada = o.meta?.installments > 1 ? (o.value / o.meta.installments) : o.value;
        if (buy.balance < valorEntrada) return alert("O comprador n√£o tem saldo para a entrada!");

        if (!confirm(`Confirmar transfer√™ncia de ${p.name} por ${fmt(o.value)}?`)) return;

        const b = db.batch();
        
        if (sel) { 
            b.update(db.collection('teams').doc(buy.id), { balance: buy.balance - valorEntrada });
            b.update(db.collection('teams').doc(sel.id), { balance: sel.balance + valorEntrada });
        }

        b.update(db.collection('players').doc(p.id), {
            teamId: buy.id,
            status: 'NAO_A_VENDA',
            contract: parseInt(o.offerContract) || 1,
            salary: parseFloat(o.meta?.newSalary) || p.salary,
            role: o.meta?.role || 'ROTACAO',
            history: firebase.firestore.FieldValue.arrayUnion({ 
                date: Date.now(), 
                from: sel?.name || 'LIVRE', 
                to: buy.name, 
                type: o.type, 
                value: o.value 
            })
        });

        b.delete(db.collection('offers').doc(o.id));
        await b.commit();
        
        postNews(`ü§ù **NEG√ìCIO FECHADO**\nO **${buy.name}** contratou **${p.name}**!`, 'transfer');
        alert("Transfer√™ncia conclu√≠da!");
    } catch (e) {
        console.error(e);
        alert("Erro ao aceitar.");
    }
};

// 3. RECUSAR OFERTA
const rejectOffer = async (o) => {
    try {
        if(!confirm("Recusar proposta por " + o.playerName + "?")) return;
        await db.collection('offers').doc(o.id).delete();
        postNews(`‚ùå **SEM ACORDO**\nAs conversas por **${o.playerName}** foram encerradas.`, 'transfer');
        alert("Recusada.");
    } catch (e) { console.error(e); }
};
    
    
      // --- IN√çCIO DO BLOCO: GEST√ÉO DE PERFORMANCE E TEMPO ---

// 1. Atualizar Tabela (Imprensa)
const updateTeamStats = async (tid, stats) => { 
    await db.collection('teams').doc(tid).update({ stats }); 
    alert("Tabela atualizada!"); 
};

// 2. Lan√ßar S√∫mula e Calcular M√©dia de Atua√ß√£o
const saveMatchStats = async (player, match, xpGained) => {
    if(!match.rating) return alert("D√™ uma nota para a atua√ß√£o!");
    
    const b = db.batch(); 
    const pRef = db.collection('players').doc(player.id);
    
    const newStats = { 
        goals: (player.stats?.goals||0) + match.goals, 
        assists: (player.stats?.assists||0) + match.assists, 
        tackles: (player.stats?.tackles||0) + match.tackles, 
        saves: (player.stats?.saves||0) + match.saves, 
        yellows: (player.stats?.yellows||0) + match.yellows, 
        reds: (player.stats?.reds||0) + match.reds 
    };

    const currentSum = player.pressRatingSum || 0;
    const currentCount = player.pressRatingCount || 0;
    const newSum = currentSum + parseFloat(match.rating);
    const newCount = currentCount + 1;
    const newAvg = newSum / newCount;
    
    b.update(pRef, { 
        stats: newStats, 
        pendingXP: (player.pendingXP || 0) + xpGained,
        pressRatingSum: newSum,
        pressRatingCount: newCount,
        pressRatingAvg: parseFloat(newAvg.toFixed(1))
    });
    
    await b.commit(); 
    alert(`S√∫mula lan√ßada! M√©dia: ${newAvg.toFixed(1)}`); 
    setModal(null);
};

// 3. A√ß√µes de Carreira (Pedidos do Jogador)
const handlePlayerActions = async (type, p) => {
    const team = teams.find(t => t.id === p.teamId);
    if (type === 'TRANSFER_REQUEST') {
        if (!team) return alert("J√° √©s um Agente Livre!");
        if (!confirm(`Pedir para sair do ${team.name}?`)) return;
        await db.collection('players').doc(p.id).update({ status: 'VENDA', mood: 'üò°' });
        postNews(`üí£ **CRISE!** ${p.name} pediu transfer√™ncia do ${team.name}!`, 'rumor');
    }
    if (type === 'ASK_RAISE') {
        if (!team) return alert("Sem clube!");
        postNews(`üí∞ **POL√âMICA**\n**${p.name}** quer aumento no ${team.name}.`, 'press');
        alert("Ponto de vista enviado √† imprensa!");
    }
};

// 4. A√á√ïES MESTRAS DO ADMIN (Virada de Semana e Temporada)
const adminAction = async (act, data) => {
    if(act==='MARKET') { 
        db.collection('config').doc('system').update({marketOpen: data}); 
    }
    
    if(act==='WEEK') { 
        if(!confirm("‚ö†Ô∏è PROCESSAR SEMANA?")) return;
        setLoading(true); 
        const b = db.batch(); 
        
        players.forEach(p => { 
            if(p.teamId && p.teamId !== 'FREE') { 
                const currentBal = parseFloat(p.balance) || 0;
                const salary = parseFloat(p.salary) || 0;
                const tax = currentBal * 0.03; // Imposto de Fortuna
                const xpTotal = (p.xp || 0) + (p.pendingXP || 0);

                b.update(db.collection('players').doc(p.id), { 
                    balance: (currentBal + salary) - tax,
                    energy: 100,
                    xp: xpTotal,
                    pendingXP: 0
                }); 
            }
        });

        teams.forEach(t => { 
            const wages = players.filter(p=>p.teamId===t.id).reduce((a,p)=>a+(parseFloat(p.salary)||0),0); 
            const income = sps.filter(s => s.teamId === t.id && s.status === 'ACTIVE').reduce((a,s) => a + parseFloat(s.value), 0); 
            b.update(db.collection('teams').doc(t.id), { balance: (t.balance || 0) + income - wages }); 
        });

        companies.forEach(c => { 
            if(c.status === 'ACTIVE') { 
                const tax = (COMPANY_TYPES[c.companyType || 'COMERCIO'] || {}).tax || 50000; 
                b.update(db.collection('companies').doc(c.id), { balance: (c.balance || 0) - tax }); 
            } 
        });
        
        await b.commit(); 
        setLoading(false); 
        alert("Semana Conclu√≠da!");
    }

    if(act==='SEASON') { 
        if(!confirm("‚ö†Ô∏è VIRAR TEMPORADA?")) return; 
        setLoading(true); 
        const b = db.batch(); 
        players.forEach(p => { 
            let u={}; 
            const res = calcNewLevel(p.overall || 45, p.xp || 0, 0); 
            u.overall = res.lvl; u.xp = res.xp;
            u.contract = Math.max(0, (parseInt(p.contract) || 0) - 1); 
            if (u.contract === 0) {
                if (p.preContract) {
                    u.teamId = p.preContract.teamId; u.contract = 1; u.preContract = firebase.firestore.FieldValue.delete();
                } else {
                    u.teamId = 'FREE'; u.status = 'VENDA';
                }
            }
            b.update(db.collection('players').doc(p.id), u); 
        }); 
        await b.commit(); 
        setLoading(false); 
        postNews("üåû **NOVA TEMPORADA INICIADA!**", 'season'); 
    }
};

// --- LOGICA DE RENDERIZA√á√ÉO ---
if(loading) return <div className="error-screen">Carregando...</div>;

if(!user) return (
    <LoginScreen 
        teams={teams} players={players} papers={papers} journalists={journalists} 
        companies={companies} onLogin={login} onCreateTeam={createTeam} 
        onCreatePaper={createNewspaper} onCreateJourno={createJournalist} 
        onCreateCompany={createCompany} onAdmin={loginAdmin} 
        onVisitor={()=>{setUser({type:'VISITOR'}); setScreen('RANKING');}} 
    />
);

return (
        <div className="main-app">
            {/* HEADER */}
           {/* HEADER ATUALIZADO COM SINO DE NOTIFICA√á√ïES */}
            <div className="header">
                <div style={{display:'flex', alignItems:'center', gap:10}}>
                    {user.type==='USER' && user.data.logo && <img src={user.data.logo} style={{width:35, height:35, borderRadius:'50%'}} />}
                    <div>
                        <div style={{fontWeight:'900', fontSize:14}}>{user.data?.name || user.type}</div>
                        <small style={{fontSize:9, color:'#666'}}>v1.91.4| Mato Real</small>
                    </div>
                </div>
                <div style={{display:'flex', gap:15, alignItems:'center'}}>
                    {/* SINO DE NOTIFICA√á√ïES */}
                    {(user.type === 'USER' || user.type === 'PLAYER') && (
                        <div style={{position: 'relative', cursor: 'pointer'}} onClick={() => setScreen('OFFERS')}>
                            <i className="fas fa-bell" style={{
                                fontSize: 18, 
                                color: offers.filter(o => o.targetId === user.data.id && o.status === 'PENDING').length > 0 ? 'var(--primary)' : 'white'
                            }}></i>
                            {offers.filter(o => o.targetId === user.data.id && o.status === 'PENDING').length > 0 && (
                                <span className="notification-badge"></span>
                            )}
                        </div>
                    )}

                    {(user.type==='USER' || user.type==='COMPANY') && <b style={{color:'var(--primary)'}}>{fmt(user.data.balance)}</b>}
                    <i className="fas fa-sign-out-alt" onClick={()=>window.location.reload()}></i>
                </div>
            </div>

            {/* TELAS PRINCIPAIS */}
            <div className="container">
                {screen === 'HOME' && user.type === 'ADMIN' && (
                    <AdminPanel 
                        teams={teams} papers={papers} journalists={journalists} companies={companies} 
                        reqs={reqs} config={conf} onAct={adminAction} onPost={postNews} 
                        onApproveTeam={approveTeam} onUpdateBal={updateBalance} onDeleteTeam={deleteTeam}
                        onConfig={(t) => setModal({ type: 'SETTINGS', team: t })} 
                        onEditT={(t) => setModal({ type: 'VIEW_SQUAD', team: t })} 
                    />
                )}
                {screen === 'HOME' && user.type === 'USER' && <TeamDashboard team={user.data} players={players.filter(p=>p.teamId===user.data.id)} onEdit={(p)=>setModal({type:'PLAYER', data:p})} onAdd={()=>setModal({type:'PLAYER'})} />}
                {screen === 'PRESS_DASH' && <div className="card"><h3>Imprensa</h3><button className="btn btn-blue" onClick={()=>setModal({type:'POST_NEWS'})}>NOT√çCIA</button><button className="btn btn-purple" onClick={()=>setModal({type:'MATCH_PERFORMANCE'})}>S√öMULA</button></div>}
                {screen === 'MARKET' && <Market me={user.data?.id} teams={teams} players={players} open={conf.marketOpen} onNeg={(p)=>setModal({type:'OFFER', data:p})} />}
                {screen === 'SHOPPING' && <ShoppingScreen products={products} companies={companies} onBuy={buyProduct} />}
                {screen === 'RANKING' && <Ranking teams={teams} players={players} />}
                {screen === 'NEWS' && <div><h3>Not√≠cias</h3>{news.slice(0,20).map(n=><div key={n.id} className={`news-card news-${n.type}`}>{n.text}</div>)}</div>}
                {screen === 'OFFERS' && (
    <OffersScreen 
        user={user} 
        offers={offers} 
        teams={teams} 
        onAccept={acceptOffer} 
        onReject={rejectOffer} 
        onCounter={handleCounterOffer} // Garante que o clique no bot√£o chame a fun√ß√£o acima
    />
)}
                {screen === 'PLAYER_DASH' && <PlayerDashboard player={players.find(p=>p.id===user.data.id)||user.data} team={teams.find(t=>t.id===user.data.teamId)} onAction={handlePlayerActions} onUpdatePassword={(p)=>db.collection('players').doc(user.data.id).update({password:p})} />}
                {screen === 'COMPANY_HOME' && <CompanyDashboard company={user.data} products={products.filter(p=>p.companyId===user.data.id)} sps={sps.filter(s=>s.companyId===user.data.id)} onSaveProd={saveProduct} onProcessSpons={processSponsorship} />}
            </div>

            {/* NAVEGA√á√ÉO INFERIOR */}
            <div className="bottom-nav">
                <div className={`nav-item ${['HOME','PLAYER_DASH','COMPANY_HOME'].includes(screen)?'active':''}`} onClick={()=>user.type==='PLAYER'?setScreen('PLAYER_DASH'):user.type==='COMPANY'?setScreen('COMPANY_HOME'):setScreen('HOME')}><i className="fas fa-home"></i>IN√çCIO</div>
                {user.type!=='COMPANY' && <div className={`nav-item ${screen==='MARKET'?'active':''}`} onClick={()=>setScreen('MARKET')}><i className="fas fa-globe"></i>MERCADO</div>}
                <div className={`nav-item ${screen==='SHOPPING'?'active':''}`} onClick={()=>setScreen('SHOPPING')}><i className="fas fa-shopping-bag"></i>SHOP</div>
                <div className={`nav-item ${screen==='RANKING'?'active':''}`} onClick={()=>setScreen('RANKING')}><i className="fas fa-trophy"></i>RANK</div>
                <div className={`nav-item ${screen==='NEWS'?'active':''}`} onClick={()=>setScreen('NEWS')}><i className="fas fa-newspaper"></i>NEWS</div>
            </div>

            {/* MODAIS GLOBAIS */}
            {modal && (
                <div className="modal-overlay" onClick={(e) => e.target === e.currentTarget && setModal(null)}>
                    <div className="modal-content">
                        {modal.type === 'PLAYER' && <PlayerForm initial={modal.data} onSave={savePlayer} teams={teams} isAdmin={user.type === 'ADMIN'} />}
                        {modal.type === 'OFFER' && <OfferForm target={modal.data} onSend={sendOffer} />}
                        {modal.type === 'MATCH_PERFORMANCE' && <MatchPerformanceForm players={players} teams={teams} onSaveStats={saveMatchStats} />}
                        {modal.type === 'POST_NEWS' && (
                            <div>
                                <input className="input-field" id="news-in" placeholder="T√≠tulo da Not√≠cia" />
                                <button className="btn btn-blue" onClick={() => { postNews(document.getElementById('news-in').value, 'press'); setModal(null); }}>POSTAR</button>
                            </div>
                        )}
                        {modal.type === 'SETTINGS' && (
                            <SettingsForm 
                                team={modal.team} 
                                isAdmin={user.type === 'ADMIN'} 
                                onUp={(updatedData) => { updateTeam(modal.team.id, updatedData); setModal(null); }} 
                                onUpgrade={() => upgradeStadium(modal.team)}
                                onReq={requestFunds}
                                onWithdraw={withdrawFunds}
                            />
                        )}
                        {modal.type === 'VIEW_SQUAD' && (
                            <TeamDashboard 
                                team={modal.team} 
                                players={players.filter(p => p.teamId === modal.team.id)} 
                                isVisitor={user.type === 'ADMIN' ? false : true} 
                                onEdit={(p) => setModal({ type: 'PLAYER', data: p })}
                                onAdd={() => setModal({ type: 'PLAYER', data: { teamId: modal.team.id } })}
                            />
                        )}
                    </div>
                </div>
            )}
        </div>
    );
};



        
        

     // ============================================================
// COMPONENTE: TELA DE LOGIN E CADASTRO
// ============================================================
const LoginScreen = ({ teams, players, papers, journalists, companies, onLogin, onCreateTeam, onCreatePaper, onCreateJourno, onCreateCompany, onAdmin, onVisitor }) => {
    const [tab, setTab] = React.useState('LOGIN'); 
    const [subTab, setSubTab] = React.useState('TEAM'); 
    const [f, setF] = React.useState({n:'', b:'10000000', s:'A', p:''}); 
    const [fc, setFC] = React.useState({n:'', owner:'', p:'', type:'COMERCIO'});
    const [sel, setSel] = React.useState(null); 
    const [selPaper, setSelPaper] = React.useState(null); 
    const [selTeamForPlayer, setSelTeamForPlayer] = React.useState(null); 
    const [lp, setLp] = React.useState('');

    const handleUpload = (e) => { 
        const file = e.target.files[0]; 
        const reader = new FileReader(); 
        reader.onloadend = () => setF({...f, l: reader.result}); 
        if(file) reader.readAsDataURL(file); 
    };
    
    const selectedTypeInfo = COMPANY_TYPES[fc.type] || {};

    return (
        <div style={{minHeight:'100vh', padding:20, textAlign:'center'}}>
            <h1 style={{color:'var(--primary)'}}>Gerenciador de Times<br/><span style={{color:'white'}}>de Mato Real</span></h1>
            <div className="dev-credits">Desenvolvido por: Nathan Reis | v1.91.7</div>
            
            {/* ABAS DE NAVEGA√á√ÉO SUPERIOR */}
            <div className="login-tabs">
                <div className={`tab ${tab==='LOGIN'?'active':''}`} onClick={()=>setTab('LOGIN')}>ENTRAR</div>
                <div className={`tab ${tab==='CREATE'?'active':''}`} onClick={()=>setTab('CREATE')}>CRIAR TIME</div>
                <div className={`tab ${tab==='PRESS'?'active':''}`} onClick={()=>setTab('PRESS')}>IMPRENSA</div>
                <div className={`tab ${tab==='COMPANY'?'active':''}`} onClick={()=>setTab('COMPANY')}>EMPRESAS</div>
            </div>

            {/* CONTE√öDO: LOGIN MULTI-USU√ÅRIO */}
            {tab==='LOGIN' && (
                <div>
                    <div style={{marginBottom:15, display:'flex', gap:10, justifyContent:'center'}}>
                        <button className={`btn ${subTab==='TEAM'?'btn-green':'btn-ghost'}`} style={{width:'auto'}} onClick={()=>setSubTab('TEAM')}>TIMES</button>
                        <button className={`btn ${subTab==='PLAYER'?'btn-blue':'btn-ghost'}`} style={{width:'auto'}} onClick={()=>{setSubTab('PLAYER'); setSelTeamForPlayer(null);}}>JOGADORES</button>
                        <button className={`btn ${subTab==='COMPANY'?'btn-purple':'btn-ghost'}`} style={{width:'auto'}} onClick={()=>setSubTab('COMPANY')}>EMPRESAS</button>
                    </div>

                    {subTab==='TEAM' && (teams||[]).filter(t=>t.status!=='PENDING').map(t=>(
                        <div key={t.id} className="card" onClick={()=>setSel({...t, type:'TEAM'})} style={{display:'flex', alignItems:'center', gap:10, cursor:'pointer'}}>
                            {t.logo ? <img src={t.logo} style={{width:40, height:40, borderRadius:'50%', objectFit:'cover'}}/> : <div style={{width:40, height:40, background:'#333', borderRadius:'50%'}}></div>}
                            <div style={{textAlign:'left'}}><b>{t.name}</b><br/><small style={{color:'#666'}}>S√©rie {t.serie}</small></div>
                        </div>
                    ))}
                    
                    {subTab==='PLAYER' && !selTeamForPlayer && (
                        <div>
                            <p style={{color:'#aaa', fontSize:12}}>Selecione o seu clube para encontrar seu perfil:</p>
                            {(teams||[]).filter(t=>t.status!=='PENDING').map(t=>(<div key={t.id} className="card" onClick={()=>setSelTeamForPlayer(t)} style={{cursor:'pointer'}}><b>{t.name}</b></div>))}
                        </div>
                    )}

                    {subTab==='PLAYER' && selTeamForPlayer && (
                        <div>
                            <button className="btn btn-ghost" style={{marginBottom:10}} onClick={()=>setSelTeamForPlayer(null)}>‚¨Ö VOLTAR PARA LISTA</button>
                            {(players||[]).filter(p => p.teamId === selTeamForPlayer.id).map(p => (
                                <div key={p.id} className="card" onClick={()=>setSel({...p, type:'PLAYER'})} style={{cursor:'pointer', borderLeft:'4px solid var(--secondary)'}}>üëü <b>{p.name}</b></div>
                            ))}
                        </div>
                    )}

                    {subTab==='COMPANY' && (companies||[]).filter(c=>c.status!=='PENDING').map(c=>(
                        <div key={c.id} className="card" onClick={()=>setSel({...c, type:'COMPANY'})} style={{cursor:'pointer', borderLeft:'4px solid var(--purple)'}}>üè¢ <b>{c.name}</b></div>
                    ))}
                    
                    <div style={{marginTop:20}}>
                        <button className="btn btn-blue" onClick={onVisitor}>ENTRAR COMO VISITANTE</button>
                        <button className="btn btn-ghost" onClick={()=> {if(prompt("Senha ADM:")==='2503') onAdmin()}}>ADMINISTRATIVO</button>
                    </div>
                </div>
            )}

            {/* CONTE√öDO: SOLICITAR CRIA√á√ÉO DE TIME */}
            {tab==='CREATE' && (
                <div>
                    <label style={{fontSize:11, color:'#888'}}>Escudo do Clube:</label>
                    <input type="file" className="input-field" onChange={handleUpload} />
                    <input className="input-field" placeholder="Nome do Clube" value={f.n} onChange={e=>setF({...f, n:e.target.value})} />
                    <select className="input-field" value={f.s} onChange={e=>setF({...f, s:e.target.value})}>
                        {['A','B','C','D'].map(s=><option key={s} value={s}>S√©rie {s}</option>)}
                    </select>
                    <input className="input-field" type="password" placeholder="Defina uma Senha" value={f.p} onChange={e=>setF({...f, p:e.target.value})} />
                    <button className="btn btn-green" onClick={()=>onCreateTeam(f.n, f.b, f.s, f.p, f.l)}>SOLICITAR AFILIA√á√ÉO</button>
                </div>
            )}

            {/* CONTE√öDO: IMPRENSA (Jornal e Jornalistas) */}
            {tab==='PRESS' && (
                <div>
                    <div style={{display:'flex', gap:10, marginBottom:10}}>
                        <button className="btn btn-ghost" onClick={()=>setSubTab('LOGIN_P')}>LOGIN</button>
                        <button className="btn btn-ghost" onClick={()=>setSubTab('NEW_PAPER')}>NOVO JORNAL</button>
                    </div>
                    {subTab==='LOGIN_P' && !selPaper && (
                        <div>{(papers||[]).filter(p=>p.status==='ACTIVE').map(p=><div key={p.id} className="card" onClick={()=>setSelPaper(p)}>üì∞ {p.name}</div>)}</div>
                    )}
                    {subTab==='LOGIN_P' && selPaper && (
                        <div>
                            <button className="btn btn-ghost" style={{marginBottom:10}} onClick={()=>setSelPaper(null)}>‚¨Ö VOLTAR</button>
                            <div className="card" onClick={()=>setSel({...selPaper, type:'PAPER'})} style={{border:'1px solid var(--primary)'}}>üëë {selPaper.ownerName} (Dono)</div>
                            {(journalists||[]).filter(j=>j.newspaperId===selPaper.id && j.status==='ACTIVE').map(j=><div key={j.id} className="card" onClick={()=>setSel({...j, type:'JOURNALIST'})}>‚úíÔ∏è {j.name}</div>)}
                        </div>
                    )}
                    {subTab==='NEW_PAPER' && (
                        <div>
                            <input className="input-field" placeholder="Nome do Ve√≠culo" id="pn" />
                            <input className="input-field" placeholder="Nome do Propriet√°rio" id="po" />
                            <input className="input-field" type="password" placeholder="Senha" id="pp" />
                            <button className="btn btn-green" onClick={()=>onCreatePaper(document.getElementById('pn').value, document.getElementById('pp').value, document.getElementById('po').value)}>CRIAR VE√çCULO</button>
                        </div>
                    )}
                </div>
            )}

            {/* CONTE√öDO: SOLICITAR ABERTURA DE EMPRESA */}
            {tab==='COMPANY' && (
                <div>
                    <input className="input-field" placeholder="Nome Fantasia" value={fc.n} onChange={e=>setFC({...fc, n:e.target.value})} />
                    <input className="input-field" placeholder="Nome do S√≥cio/Dono" value={fc.owner} onChange={e=>setFC({...fc, owner:e.target.value})} />
                    <select className="input-field" value={fc.type} onChange={e=>setFC({...fc, type:e.target.value})}>
                        <option value="COMERCIO">Com√©rcio Local</option>
                        <option value="MEDIA">M√©dia Empresa</option>
                        <option value="GRANDE">Grande Empresa</option>
                    </select>
                    <div className="card" style={{textAlign:'left', background:'rgba(0,0,0,0.2)'}}>
                        <div style={{display:'flex', justifyContent:'space-between', fontSize:12}}>
                            <span>üí∞ Capital: {fmt(selectedTypeInfo.start)}</span>
                            <span>üí∏ Imposto: {fmt(selectedTypeInfo.tax)}</span>
                        </div>
                        <p style={{fontSize:10, color:'#888', marginTop:5}}>"{selectedTypeInfo.desc}"</p>
                    </div>
                    <input className="input-field" type="password" placeholder="Senha de Acesso" value={fc.p} onChange={e=>setFC({...fc, p:e.target.value})} />
                    <button className="btn btn-purple" onClick={()=>onCreateCompany(fc)}>ABRIR EMPRESA</button>
                </div>
            )}
            
            {/* MODAL DE SEGURAN√áA (Senha) */}
            {sel && (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h3 style={{margin:0, color: 'var(--primary)'}}>{sel.name}</h3>
                        <p style={{fontSize:11, color:'#aaa', marginBottom:15}}>Digite sua senha de acesso</p>
                        <input className="input-field" type="password" placeholder="Senha" value={lp} onChange={e=>setLp(e.target.value)} autoFocus />
                        <div style={{display: 'flex', gap: 10}}>
                            <button className="btn btn-green" style={{flex: 2}} onClick={()=>onLogin(sel.id, lp, sel.type)}>CONECTAR</button>
                            <button className="btn btn-red" style={{flex: 1}} onClick={()=>{setSel(null); setLp('');}}>SAIR</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};
// --- FIM DO COMPONENTE LOGINSCREEN ---
        
        
        // --- COMPONENTE: PAINEL DE VISITANTE (RESUMO P√öBLICO) ---
const VisitorDashboard = ({ players, teams }) => {
    // Busca din√¢mica dos l√≠deres da temporada
    const topScorer = [...players].sort((a,b) => (b.stats?.goals || 0) - (a.stats?.goals || 0))[0];
    const topAssist = [...players].sort((a,b) => (b.stats?.assists || 0) - (a.stats?.assists || 0))[0];

    return (
        <div>
            {/* DESTAQUES DA TEMPORADA */}
            <div className="highlight-card">
                <h2 style={{ margin: 0, color: 'var(--primary)' }}>Jornal do Dia</h2>
                <small>Resumo Estat√≠stico da Temporada</small>
                
                <div style={{ marginTop: 15, textAlign: 'left' }}>
                    {/* Artilharia */}
                    <div style={{ marginBottom: 15 }}>
                        <span style={{ color: '#aaa', fontSize: 10, textTransform: 'uppercase', letterSpacing: 1 }}>Artilheiro</span>
                        <div style={{ fontWeight: 'bold', fontSize: 18 }}>
                            ‚öΩ {topScorer?.name || 'Nenhum registro'} 
                            <span style={{ color: 'var(--primary)', marginLeft: 8 }}>
                                {topScorer?.stats?.goals || 0} Gols
                            </span>
                        </div>
                        <small style={{ color: '#666' }}>
                            {teams.find(t => t.id === topScorer?.teamId)?.name || 'Agente Livre'}
                        </small>
                    </div>

                    {/* Assist√™ncias */}
                    <div>
                        <span style={{ color: '#aaa', fontSize: 10, textTransform: 'uppercase', letterSpacing: 1 }}>Rei das Assist√™ncias</span>
                        <div style={{ fontWeight: 'bold', fontSize: 18 }}>
                            üëü {topAssist?.name || 'Nenhum registro'} 
                            <span style={{ color: 'var(--secondary)', marginLeft: 8 }}>
                                {topAssist?.stats?.assists || 0} Assis
                            </span>
                        </div>
                        <small style={{ color: '#666' }}>
                            {teams.find(t => t.id === topAssist?.teamId)?.name || 'Agente Livre'}
                        </small>
                    </div>
                </div>
            </div>

            <div style={{ textAlign: 'center', color: '#666', padding: 20 }}>
                <i className="fas fa-info-circle" style={{ marginRight: 5 }}></i>
                Use o menu inferior para ver o Mercado ou Ranking completo.
            </div>
        </div>
    );
};
// --- FIM DO COMPONENTE VISITORDASHBOARD ---
        
        // --- COMPONENTE: PAINEL DE GEST√ÉO EMPRESARIAL ---
const CompanyDashboard = ({ company, products, sps, sales, teams, onSaveProd, onDeleteProd, onProcessSpons }) => {
    const [tab, setTab] = useState('PRODS'); 
    const [editP, setEditP] = useState(null); 
    
    return (
        <div>
            {/* NAVEGA√á√ÉO INTERNA */}
            <div style={{display:'flex', gap:10, marginBottom:15}}>
                <button className={`btn ${tab==='PRODS'?'btn-purple':'btn-ghost'}`} onClick={()=>setTab('PRODS')}>PRODUTOS</button>
                <button className={`btn ${tab==='FIN'?'btn-purple':'btn-ghost'}`} onClick={()=>setTab('FIN')}>FINAN√áAS & PATRO</button>
            </div>
            
            {/* ABA: GEST√ÉO DE PRODUTOS */}
            {tab==='PRODS' && <div>
                <button className="btn btn-green" onClick={()=>setEditP({name:'', price:'', img:'', desc:'', cat:'CHUTEIRA'})}>+ LAN√áAR NOVIDADE</button>
                
                {products.length === 0 && <p style={{color:'#666', textAlign:'center', marginTop:20}}>Sua vitrine est√° vazia.</p>}
                
                {products.map(p => (
                    <div key={p.id} className="card" style={{display:'flex', gap:10, textAlign:'left'}}>
                        <img src={p.img || 'https://via.placeholder.com/100'} style={{width:80, height:80, objectFit:'cover', borderRadius:6, border:'1px solid #333'}} />
                        <div style={{flex:1}}>
                            <span style={{fontSize:10, background:'#333', padding:'2px 6px', borderRadius:4, color:'var(--primary)', fontWeight:'bold'}}>{PROD_CATS[p.cat] || p.cat}</span>
                            <div style={{fontWeight:'bold', marginTop:2, fontSize:15}}>{p.name}</div>
                            <span style={{color:'var(--primary)', fontWeight:'bold'}}>{fmt(p.price)}</span>
                            <p style={{fontSize:11, color:'#aaa', margin:'5px 0', lineHeight:'1.2'}}>{p.desc}</p>
                        </div>
                        <div style={{display:'flex', flexDirection:'column', gap:5}}>
                            <button className="btn btn-blue" style={{width:'35px', padding:'5px'}} onClick={()=>setEditP(p)}>‚úèÔ∏è</button>
                            <button className="btn btn-red" style={{width:'35px', padding:'5px'}} onClick={()=>onDeleteProd(p.id)}>X</button>
                        </div>
                    </div>
                ))}
            </div>}

            {/* ABA: FINANCEIRO E PATROC√çNIOS */}
            {tab==='FIN' && <div>
                <div className="highlight-card">
                    <small style={{color:'rgba(255,255,255,0.7)'}}>Saldo em Conta</small>
                    <h2 style={{margin:'5px 0'}}>{fmt(company.balance)}</h2>
                    <div style={{fontSize:10, background:'rgba(0,0,0,0.2)', padding:5, borderRadius:4}}>
                        üìâ Custo Fixo Semanal (Imposto): <b>{fmt((COMPANY_TYPES[company.companyType] || {}).tax || 0)}</b>
                    </div>
                </div>

                <h4 style={{marginTop:20, color:'#ddd', borderLeft:'3px solid var(--primary)', paddingLeft:10}}>Hist√≥rico de Vendas</h4>
                <div style={{maxHeight:200, overflowY:'auto', background:'rgba(0,0,0,0.3)', padding:10, borderRadius:8, marginBottom:15, border:'1px solid #333'}}>
                    {(!sales || sales.filter(s => s.companyId === company.id).length === 0) ? (
                        <p style={{color:'#666', textAlign:'center', fontSize:11}}>Nenhuma venda realizada.</p>
                    ) : (
                        sales.filter(s => s.companyId === company.id).map((s, i) => (
                            <div key={i} style={{borderBottom:'1px solid #444', padding:'8px 0', fontSize:11}}>
                                <div style={{display:'flex', justifyContent:'space-between'}}>
                                    <b style={{color:'var(--primary)'}}>+ {fmt(s.price)}</b>
                                    <span style={{color:'#888'}}>{new Date(s.date).toLocaleDateString()}</span>
                                </div>
                                <div style={{marginTop:2}}>üë§ <b>{s.buyerName}</b> comprou <b>{s.productName}</b></div>
                            </div>
                        ))
                    )}
                </div>

                <h4>Propostas de Patroc√≠nio</h4>
                {sps.filter(s=>s.status==='PENDING').length === 0 && <small style={{color:'#666'}}>Nenhuma proposta pendente.</small>}
                {sps.filter(s=>s.status==='PENDING').map(s => (
                    <div key={s.id} className="card" style={{borderLeft:'4px solid var(--warning)'}}>
                        <b>{s.teamName}</b> quer patroc√≠nio!<br/>
                        Custo Semanal: <b style={{color:'var(--warning)'}}>{fmt(s.value)}</b>
                        <div style={{display:'flex', gap:5, marginTop:10}}>
                            <button className="btn btn-green" onClick={()=>onProcessSpons(s, 'ACTIVE')}>FECHAR ACORDO</button>
                            <button className="btn btn-red" onClick={()=>onProcessSpons(s, 'REJECTED')}>RECUSAR</button>
                        </div>
                    </div>
                ))}

                <h4 style={{marginTop:20}}>Contratos Ativos</h4>
                {sps.filter(s=>s.status==='ACTIVE').map(s => (
                    <div key={s.id} className="card" style={{display:'flex', justifyContent:'space-between', alignItems:'center', borderLeft:'4px solid var(--primary)'}}>
                        <div><b>{s.teamName}</b><br/><small>{fmt(s.value)}/sem</small></div>
                        <button className="btn btn-red" style={{width:'auto'}} onClick={()=>onProcessSpons(s, 'CANCELLED')}>ROMPER</button>
                    </div>
                ))}
            </div>}

            {/* MODAL DE EDI√á√ÉO DE PRODUTO */}
            {editP && (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h3>{editP.id ? 'Editar' : 'Cadastrar'} Produto</h3>
                        
                        <label style={{fontSize:11, color:'#aaa'}}>Tipo de Item</label>
                        <select className="input-field" value={editP.cat || 'CHUTEIRA'} onChange={e=>setEditP({...editP, cat:e.target.value})}>
                            {Object.keys(PROD_CATS).map(key => <option key={key} value={key}>{PROD_CATS[key]}</option>)}
                        </select>

                        <input className="input-field" placeholder="Nome do Produto" value={editP.name} onChange={e=>setEditP({...editP, name:e.target.value})} />
                        <input className="input-field" type="number" placeholder="Pre√ßo (‚Ç£)" value={editP.price} onChange={e=>setEditP({...editP, price:e.target.value})} />
                        <input className="input-field" placeholder="URL da Imagem" value={editP.img} onChange={e=>setEditP({...editP, img:e.target.value})} />
                        <textarea className="input-field" placeholder="Descri√ß√£o curta..." value={editP.desc} onChange={e=>setEditP({...editP, desc:e.target.value})} />
                        
                        <div style={{display:'flex', gap:10}}>
                            <button className="btn btn-green" onClick={()=>{onSaveProd(editP); setEditP(null);}}>GRAVAR</button>
                            <button className="btn btn-ghost" onClick={()=>setEditP(null)}>VOLTAR</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};
// --- FIM DO COMPONENTE COMPANYDASHBOARD ---

        // --- COMPONENTE: SHOPPING GLOBAL ---
const ShoppingScreen = ({ products, companies, userTeam, onBuy }) => {
    const [term, setTerm] = useState('');
    
    // Filtro de busca por nome
    const list = products.filter(p => p.name.toLowerCase().includes(term.toLowerCase()));
    
    return (
        <div>
            <h3 style={{ borderLeft: '4px solid var(--primary)', paddingLeft: 10 }}>Shopping Global</h3>
            
            {/* BARRA DE BUSCA */}
            <div style={{ position: 'relative', marginBottom: 15 }}>
                <input 
                    className="input-field" 
                    placeholder="O que voc√™ est√° procurando?" 
                    value={term} 
                    onChange={e => setTerm(e.target.value)} 
                    style={{ paddingLeft: 35 }}
                />
                <i className="fas fa-search" style={{ position: 'absolute', left: 12, top: 14, color: '#666' }}></i>
            </div>
            
            {/* GRID DE PRODUTOS */}
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 10 }}>
                {list.map(p => { 
                    const comp = companies.find(c => c.id === p.companyId); 
                    
                    // SEGURAN√áA: N√£o exibe itens de empresas inativas
                    if (comp?.status !== 'ACTIVE') return null; 
                    
                    return (
                        <div key={p.id} className="card" style={{ padding: 10, position: 'relative', display: 'flex', flexDirection: 'column' }}>
                            {/* BADGE DA EMPRESA VENDEDORA */}
                            <div style={{ 
                                fontSize: 9, 
                                background: 'var(--purple)', 
                                color: 'white',
                                position: 'absolute', 
                                top: 5, 
                                right: 5, 
                                padding: '2px 6px', 
                                borderRadius: 4, 
                                zIndex: 10,
                                fontWeight: 'bold',
                                boxShadow: '0 2px 4px rgba(0,0,0,0.3)'
                            }}>
                                {comp.name}
                            </div>
                            
                            {/* IMAGEM DO PRODUTO */}
                            <div style={{ width: '100%', height: 100, overflow: 'hidden', borderRadius: 4, background: '#000' }}>
                                <img 
                                    src={p.img || 'https://via.placeholder.com/150'} 
                                    style={{ width: '100%', height: '100%', objectFit: 'cover' }} 
                                    onError={(e) => { e.target.src = 'https://via.placeholder.com/150?text=Sem+Imagem'; }}
                                />
                            </div>
                            
                            {/* DETALHES */}
                            <div style={{ flex: 1, marginTop: 8 }}>
                                <span style={{ fontSize: 9, color: '#888', textTransform: 'uppercase', fontWeight: 'bold' }}>
                                    {PROD_CATS[p.cat] || 'Geral'}
                                </span>

                                <div style={{ fontWeight: 'bold', fontSize: 13, lineHeight: '1.2em', height: '2.4em', overflow: 'hidden', margin: '2px 0' }}>
                                    {p.name}
                                </div>
                                
                                <div style={{ color: 'var(--primary)', fontWeight: '900', fontSize: 15, marginTop: 5 }}>
                                    {fmt(p.price)}
                                </div>
                            </div>
                            
                            {/* BOT√ÉO DE COMPRA (Apenas se o usu√°rio puder comprar) */}
                            {userTeam && (
                                <button 
                                    className="btn btn-green" 
                                    style={{ marginTop: 10, marginBottom: 0, padding: '8px', fontSize: 10 }} 
                                    onClick={() => onBuy(p, comp)}
                                >
                                    <i className="fas fa-shopping-cart" style={{ marginRight: 5 }}></i> COMPRAR
                                </button>
                            )}
                        </div>
                    ); 
                })}
            </div>

            {/* FEEDBACK DE BUSCA VAZIA */}
            {list.length === 0 && (
                <div style={{ textAlign: 'center', padding: '40px 20px', color: '#666' }}>
                    <i className="fas fa-box-open" style={{ fontSize: 40, marginBottom: 10, display: 'block' }}></i>
                    Nenhum produto encontrado para "{term}".
                </div>
            )}
        </div>
    );
};
// --- FIM DO COMPONENTE SHOPPINGSCREEN ---

        // --- COMPONENTE: DASHBOARD DO TIME (ELENCO E FINAN√áAS) ---
const TeamDashboard = ({ team, players, isVisitor, onEdit, onAdd }) => {
    
    // C√ÅLCULO AUTOM√ÅTICO DA FOLHA SALARIAL (Soma de todos os sal√°rios do array players)
    const payroll = players.reduce((total, p) => total + (parseFloat(p.salary) || 0), 0);
    
    return (
        <div>
            {/* CABE√áALHO DO ELENCO */}
            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:15}}>
                <div>
                    <h3 style={{margin:0}}>Elenco ({players.length})</h3>
                    <small style={{color:'#ccc'}}>
                        Folha Semanal: <span style={{color:'var(--danger)', fontWeight:'bold'}}>{fmt(payroll)}</span>
                    </small>
                </div>
                {/* S√≥ mostra o bot√£o de adicionar se n√£o for um visitante olhando o time alheio */}
                {!isVisitor && (
                    <button className="btn btn-green" style={{width:'auto', padding:'5px 15px'}} onClick={onAdd}>
                        + JOGADOR
                    </button>
                )}
            </div>

            {/* AVISO DE ELENCO VAZIO */}
            {players.length === 0 && (
                <p style={{color:'#666', textAlign:'center', padding:20, border:'1px dashed #333', borderRadius:8}}>
                    Nenhum jogador contratado no momento.
                </p>
            )}
            
            {/* LISTA DE JOGADORES (Ordenados pelo Overall) */}
            {players.sort((a,b) => b.overall - a.overall).map(p => (
                <div 
                    key={p.id} 
                    className="card" 
                    onClick={() => !isVisitor && onEdit(p)} 
                    style={{cursor: isVisitor ? 'default' : 'pointer', borderLeft: `4px solid ${getPosColor(p.position)}`}}
                >
                    {/* LINHA PRINCIPAL: Nome e N√≠vel */}
                    <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                        <div>
                            <span className="badge-pos" style={{background: getPosColor(p.position), marginRight: 8}}>
                                {p.position}
                            </span>
                            <b style={{fontSize: 16}}>{p.name}</b>
                            {p.pressRatingAvg > 0 && (
                                <span style={{marginLeft: 8, fontSize: 11, color: 'var(--gold)'}}>
                                    ‚òÖ {p.pressRatingAvg}
                                </span>
                            )}
                        </div>
                        <span className="player-ov">{p.overall}</span>
                    </div>

                    {/* GRID DE DADOS FINANCEIROS/CONTRATUAIS */}
                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', fontSize:11, color:'#aaa', marginTop:8, gap: '2px 10px'}}>
                        <div>Sal√°rio: <span style={{color:'#eee'}}>{fmt(p.salary)}</span></div>
                        <div>Valor: <span style={{color:'#eee'}}>{fmt(p.value)}</span></div>
                        <div>Contrato: <span style={{color:'#eee'}}>{p.contract} Temp.</span></div>
                        <div>Multa: <span style={{color:'var(--warning)'}}>{fmt(p.clause)}</span></div>
                    </div>

                    {/* GRID DE ESTAT√çSTICAS (√çcones) */}
                    <div className="stats-grid" style={{marginTop: 10, paddingTop: 8, borderTop: '1px solid #333'}}>
                        <div className="stat-item"><span className="stat-lbl">‚öΩ</span><span className="stat-val">{p.stats?.goals||0}</span></div>
                        <div className="stat-item"><span className="stat-lbl">üëü</span><span className="stat-val">{p.stats?.assists||0}</span></div>
                        <div className="stat-item"><span className="stat-lbl">üõ°Ô∏è</span><span className="stat-val">{p.stats?.tackles||0}</span></div>
                        <div className="stat-item"><span className="stat-lbl">üß§</span><span className="stat-val">{p.stats?.saves||0}</span></div>
                        <div className="stat-item"><span className="stat-lbl">üü®</span><span className="stat-val">{p.stats?.yellows||0}</span></div>
                        <div className="stat-item"><span className="stat-lbl">üü•</span><span className="stat-val">{p.stats?.reds||0}</span></div>
                    </div>
                </div>
            ))}
        </div>
    );
};
// --- FIM DO COMPONENTE TEAMDASHBOARD ---
        
        // --- COMPONENTE: EDITOR MANUAL DE ESTAT√çSTICAS ACUMULADAS ---
const StatsEditor = ({ players, teams, onSave }) => {
    const [search, setSearch] = useState(''); 
    const [selP, setSelP] = useState(null); 
    const [s, setS] = useState({});

    // Filtra a lista de jogadores conforme a digita√ß√£o
    const filtered = players.filter(p => p.name.toLowerCase().includes(search.toLowerCase()));

    // TELA 2: FORMUL√ÅRIO DE EDI√á√ÉO (Aparece ap√≥s selecionar o jogador)
    if (selP) {
        return (
            <div>
                <h3 style={{color: 'var(--primary)'}}>Corrigir Stats: {selP.name}</h3>
                <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10, marginBottom: 15}}>
                    <div>
                        <label style={{fontSize:11, color:'#888'}}>Gols ‚öΩ</label>
                        <input className="input-field" type="number" value={s.goals} onChange={e=>setS({...s, goals:parseInt(e.target.value) || 0})} />
                    </div>
                    <div>
                        <label style={{fontSize:11, color:'#888'}}>Assist√™ncias üëü</label>
                        <input className="input-field" type="number" value={s.assists} onChange={e=>setS({...s, assists:parseInt(e.target.value) || 0})} />
                    </div>
                    <div>
                        <label style={{fontSize:11, color:'#888'}}>Desarmes üõ°Ô∏è</label>
                        <input className="input-field" type="number" value={s.tackles} onChange={e=>setS({...s, tackles:parseInt(e.target.value) || 0})} />
                    </div>
                    <div>
                        <label style={{fontSize:11, color:'#888'}}>Defesas üß§</label>
                        <input className="input-field" type="number" value={s.saves} onChange={e=>setS({...s, saves:parseInt(e.target.value) || 0})} />
                    </div>
                    <div>
                        <label style={{fontSize:11, color:'#888'}}>Amarelos üü®</label>
                        <input className="input-field" type="number" value={s.yellows} onChange={e=>setS({...s, yellows:parseInt(e.target.value) || 0})} />
                    </div>
                    <div>
                        <label style={{fontSize:11, color:'#888'}}>Vermelhos üü•</label>
                        <input className="input-field" type="number" value={s.reds} onChange={e=>setS({...s, reds:parseInt(e.target.value) || 0})} />
                    </div>
                </div>
                <button className="btn btn-green" onClick={() => onSave(selP.id, s)}>SALVAR TOTAIS</button>
                <button className="btn btn-ghost" onClick={() => setSelP(null)}>VOLTAR √Ä BUSCA</button>
            </div>
        );
    }

    // TELA 1: BUSCA DE JOGADOR
    return (
        <div>
            <h4 style={{marginBottom: 10}}>Localizar Atleta</h4>
            <div style={{position:'relative'}}>
                <input 
                    className="input-field" 
                    placeholder="Ex: Neymar, Messi..." 
                    value={search} 
                    onChange={e => setSearch(e.target.value)} 
                />
            </div>
            
            <div style={{maxHeight: 250, overflowY: 'auto', marginTop: 10, border: search.length > 0 ? '1px solid #333' : 'none', borderRadius: 8}}>
                {search.length > 0 && filtered.length === 0 && <p style={{padding:10, fontSize:12, color:'#666'}}>Nenhum jogador encontrado.</p>}
                
                {search.length > 0 && filtered.map(p => {
                    const playerTeam = teams.find(t => t.id === p.teamId);
                    return (
                        <div 
                            key={p.id} 
                            className="card" 
                            style={{margin: 5, cursor: 'pointer', padding: '10px'}}
                            onClick={() => {
                                setSelP(p); 
                                setS(p.stats || {goals:0, assists:0, tackles:0, saves:0, yellows:0, reds:0});
                            }}
                        >
                            <b>{p.name}</b> 
                            <span style={{fontSize: 10, marginLeft: 10, color: 'var(--primary)'}}>
                                ({playerTeam ? playerTeam.name : 'Agente Livre'})
                            </span>
                        </div>
                    );
                })}
            </div>
        </div>
    );
};
// --- FIM DO COMPONENTE STATSEDITOR ---
        
        // --- COMPONENTE: FORMUL√ÅRIO DE CRIA√á√ÉO E EDI√á√ÉO DE JOGADOR ---
const PlayerForm = ({ initial, onSave, onDelete, isAdmin, teams, onRenew, isOwner }) => {
    // Estado inicial com fallback para novos jogadores
    const [f, setF] = useState(initial || {
        name:'', position:'ATA', overall:'', value:'', salary:'', 
        clause:'', contract:'', mood:'üòê', status:'NAO_A_VENDA', 
        password:'', balance: 0, rating: '', 
        stats: {goals:0, assists:0, tackles:0, saves:0, yellows:0, reds:0}
    });
    
    return (
        <div className="modal-overlay">
            <div className="modal-content">
                <h3 style={{color: 'var(--primary)'}}>{initial ? 'Ficha do Atleta' : 'Novo Registro'}</h3>
                
                {/* DADOS B√ÅSICOS */}
                <label>Nome Completo</label>
                <input className="input-field" value={f.name} onChange={e=>setF({...f, name:e.target.value})} />
                
                <div style={{background:'rgba(255,255,255,0.05)', padding:10, borderRadius:5, marginBottom:10, border:'1px solid #444'}}>
                    <label style={{color:'var(--secondary)', fontSize:11}}>üîê Senha de Acesso do Jogador</label>
                    <input className="input-field" type="text" placeholder="Senha para o login do jogador" value={f.password || ''} onChange={e=>setF({...f, password:e.target.value})} />
                </div>

                {/* GEST√ÉO FINANCEIRA (VIS√çVEL PARA ADMIN) */}
                {isAdmin && (
                    <div style={{border:'1px solid var(--primary)', padding:8, borderRadius:5, marginBottom:10, background:'rgba(0,255,0,0.05)'}}>
                        <label style={{color:'var(--primary)', fontWeight:'bold'}}>üí∞ Carteira do Jogador (Admin)</label>
                        <input className="input-field" type="number" value={f.balance||0} onChange={e=>setF({...f, balance:parseFloat(e.target.value)})} />
                    </div>
                )}

                {/* ATRIBUTOS T√âCNICOS */}
                <div style={{display:'flex', gap:5}}>
                    <div style={{flex:1}}>
                        <label>Posi√ß√£o</label>
                        <select className="input-field" value={f.position} onChange={e=>setF({...f, position:e.target.value})}>
                            {POS.map(p=><option key={p} value={p}>{p}</option>)}
                        </select>
                    </div>
                    <div style={{flex:1}}>
                        <label>Overall</label>
                        <input className="input-field" type="number" value={f.overall} onChange={e=>setF({...f, overall:e.target.value})} disabled={!isAdmin && initial} />
                    </div>
                </div>

                {/* MERCADO E CONTRATO */}
                <div style={{display:'flex', gap:5}}>
                    <div style={{flex:1}}><label>Valor (‚Ç£)</label><input className="input-field" type="number" value={f.value} onChange={e=>setF({...f, value:e.target.value})} /></div>
                    <div style={{flex:1}}><label>Sal√°rio (‚Ç£)</label><input className="input-field" type="number" value={f.salary} onChange={e=>setF({...f, salary:e.target.value})} /></div>
                </div>
                <div style={{display:'flex', gap:5}}>
                    <div style={{flex:1}}><label>Multa (‚Ç£)</label><input className="input-field" type="number" value={f.clause} onChange={e=>setF({...f, clause:e.target.value})} /></div>
                    <div style={{flex:1}}><label>Contrato (Temp)</label><input className="input-field" type="number" value={f.contract} onChange={e=>setF({...f, contract:e.target.value})} /></div>
                </div>

                <div style={{display:'flex', gap:5}}>
                    <div style={{flex:2}}>
                        <label>Status de Mercado</label>
                        <select className="input-field" value={f.status} onChange={e=>setF({...f, status:e.target.value})}>
                            <option value="NAO_A_VENDA">N√£o Listado</option>
                            <option value="VENDA">√Ä Venda</option>
                            <option value="EMPRESTIMO">Empr√©stimo</option>
                            <option value="INTRANSFERIVEL">Intransfer√≠vel</option>
                        </select>
                    </div>
                    <div style={{flex:1}}>
                        <label>Humor</label>
                        <select className="input-field" value={f.mood} onChange={e=>setF({...f, mood:e.target.value})}><option>ü§©</option><option>üòê</option><option>üò°</option></select>
                    </div>
                </div>

                {/* NOTAS E PERFORMANCE (ADMIN) */}
                {isAdmin && (
                    <div style={{border:'1px solid var(--purple)', padding:8, borderRadius:5, margin:'10px 0'}}>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:5}}>
                            <label style={{color:'var(--purple)', fontWeight:'bold'}}>‚≠ê Nota da Partida (Admin)</label>
                            {initial?.pressRatingAvg && (
                                <span style={{fontSize:9, background:'#333', padding:'2px 5px', borderRadius:4}}>
                                    üì∞ Imprensa: {initial.pressRatingAvg}
                                </span>
                            )}
                        </div>
                        <input className="input-field" type="number" step="0.1" value={f.rating} onChange={e=>setF({...f, rating:e.target.value})} />
                    </div>
                )}

                {/* TRANSFER√äNCIA FOR√áADA (ADMIN) */}
                {isAdmin && (
                    <div style={{border:'1px solid gold', padding:8, borderRadius:5, marginTop:5}}>
                        <label style={{color:'gold', fontWeight:'bold', fontSize:11}}>Mover Time (Modo Deus)</label>
                        <select className="input-field" onChange={e=>setF({...f, forcedTeamId:e.target.value})}>
                            <option value="">-- Manter Atual --</option>
                            <option value="FREE">AGENTE LIVRE</option>
                            {teams.map(t=><option key={t.id} value={t.id}>{t.name}</option>)}
                        </select>
                    </div>
                )}

                {/* A√á√ïES FINAIS */}
                <div style={{display:'flex', gap:8, marginTop:20}}>
                    <button className="btn btn-green" style={{flex:2}} onClick={()=>onSave(f)}>SALVAR</button>
                    {isOwner && <button className="btn btn-blue" style={{flex:1}} onClick={()=>onRenew(initial)}>RENOVAR</button>}
                    {initial && <button className="btn btn-red" style={{width:'40px'}} onClick={()=>onDelete(initial.id)}><i className="fas fa-trash"></i></button>}
                    <button className="btn btn-ghost" style={{flex:1}} onClick={()=>setF(null)}>SAIR</button>
                </div>
            </div>
        </div>
    );
};
// --- FIM DO COMPONENTE PLAYERFORM ---

        // --- COMPONENTE: MERCADO DE TRANSFER√äNCIAS ---
const Market = ({ me, teams, players, open, isVis, onNeg, onPayClause, onPre }) => {
    const [view, setView] = React.useState('MENU'); 
    const [serie, setSerie] = React.useState('A'); 
    const [selT, setSelT] = React.useState(null); 
    const [filt, setFilt] = React.useState('VENDA');

    // --- TELA 1: MENU PRINCIPAL DO MERCADO ---
    if(view === 'MENU') return (
        <div>
            <h3 style={{ borderLeft: '4px solid var(--primary)', paddingLeft: 10 }}>
                Mercado de Atletas {open ? 'üü¢ (ABERTO)' : 'üî¥ (FECHADO)'}
            </h3>
            
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 10, marginBottom: 15 }}>
                <div className="card market-btn trf" onClick={() => { setFilt('VENDA'); setView('GLOBAL'); }}>
                    üõí LISTA TRF
                </div>
                <div className="card market-btn loan" onClick={() => { setFilt('EMPRESTIMO'); setView('GLOBAL'); }}>
                    üîÑ EMPR√âSTIMOS
                </div>
                <div className="card market-btn free" style={{ gridColumn: 'span 2' }} onClick={() => { setFilt('FREE'); setView('GLOBAL'); }}>
                    üÜì PASSES LIVRES (AGENTES)
                </div>
            </div>

            <h4 style={{ color: '#888', fontSize: 12, textTransform: 'uppercase' }}>Explorar por Divis√£o</h4>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 10 }}>
                {SERIES.map(s => (
                    <div key={s} className="card series-card" onClick={() => { setSerie(s); setView('LIST'); }}>
                        <b>S√©rie {s}</b>
                    </div>
                ))}
            </div>
        </div>
    );

    // --- L√ìGICA DE FILTRAGEM DE DADOS ---
    let list = []; 
    if(view === 'GLOBAL') {
        if(filt === 'FREE') {
            list = players.filter(p => p.teamId === 'FREE').sort((a,b) => b.overall - a.overall);
        } else {
            // Filtra jogadores listados para venda/empr√©stimo que n√£o s√£o do meu time
            list = players.filter(p => p.status === filt && p.teamId !== me && p.teamId !== 'FREE').sort((a,b) => b.overall - a.overall);
        }
    } else if(view === 'TEAM') {
        list = players.filter(p => p.teamId === selT.id).sort((a,b) => b.overall - a.overall);
    }

    // --- TELA 2: LISTA DE CLUBES DA S√âRIE SELECIONADA ---
    if(view === 'LIST') return (
        <div>
            <button className="btn btn-ghost" onClick={() => setView('MENU')}>‚¨Ö VOLTAR</button>
            <h3 style={{ marginTop: 10 }}>Clubes da S√©rie {serie}</h3>
            {teams.filter(t => t.serie === serie && t.status !== 'PENDING').map(t => (
                <div key={t.id} className="card team-market-card" onClick={() => { setSelT(t); setView('TEAM'); }}>
                    {t.logo ? <img src={t.logo} style={{ width: 30, height: 30, borderRadius: '50%', objectFit: 'cover' }} /> : <div className="team-logo-placeholder"></div>}
                    <b>{t.name}</b>
                    <i className="fas fa-chevron-right" style={{ marginLeft: 'auto', color: '#444' }}></i>
                </div>
            ))}
        </div>
    );
    
    // --- TELA 3: LISTAGEM DE JOGADORES (RESULTADO) ---
    return (
        <div>
            <button className="btn btn-ghost" onClick={() => setView(view === 'TEAM' ? 'LIST' : 'MENU')}>‚¨Ö VOLTAR</button>
            <h3 style={{ marginTop: 10, color: 'var(--primary)' }}>
                {view === 'GLOBAL' ? (filt === 'FREE' ? 'Agentes Livres' : `Lista de ${filt}`) : selT.name}
            </h3>

            {list.length === 0 && <p style={{ textAlign: 'center', color: '#666', marginTop: 40 }}>Nenhum atleta dispon√≠vel nesta categoria.</p>}

            {list.map(p => (
                <div key={p.id} className="card player-market-card">
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                            <span className="badge-pos" style={{ background: getPosColor(p.position) }}>{p.position}</span>
                            <b style={{ fontSize: 15 }}>{p.name}</b>
                            {p.pressRatingAvg > 0 && <span style={{ color: 'var(--gold)', fontSize: 10, marginLeft: 5 }}>‚òÖ {p.pressRatingAvg}</span>}
                        </div>
                        <span className="player-ov">{p.overall}</span>
                    </div>

                    <div style={{ fontSize: 11, color: '#aaa', marginTop: 8 }}>
                        {p.teamId !== 'FREE' ? 
                            <span>Clube: <b>{teams.find(t => t.id === p.teamId)?.name}</b></span> : 
                            <span style={{ color: 'var(--primary)', fontWeight: 'bold' }}>Dispon√≠vel para assinatura imediata</span>
                        }
                        <div style={{ marginTop: 2 }}>
                            Valor: {fmt(p.value)} | Contrato: {p.contract} {p.contract === 1 ? 'ano' : 'anos'}
                        </div>
                    </div>

                    {/* MINI-GRID DE ATRIBUTOS */}
                    <div className="stats-grid" style={{ marginTop: 10, opacity: 0.7 }}>
                        <div className="stat-item"><span>‚öΩ</span> {p.stats?.goals || 0}</div>
                        <div className="stat-item"><span>üëü</span> {p.stats?.assists || 0}</div>
                        <div className="stat-item"><span>üõ°Ô∏è</span> {p.stats?.tackles || 0}</div>
                        <div className="stat-item"><span>üß§</span> {p.stats?.saves || 0}</div>
                    </div>

                    {/* BOT√ïES DE A√á√ÉO (Escondidos para Visitantes) */}
                    {!isVis && (
                        <div style={{ marginTop: 12, display: 'flex', gap: 5 }}>
                            {(open || p.status === 'EMPRESTIMO' || p.teamId === 'FREE') && p.status !== 'INTRANSFERIVEL' ? (
                                <button className="btn btn-purple" style={{ flex: 1, padding: '10px' }} onClick={() => onNeg(p)}>
                                    <i className="fas fa-handshake"></i> PROPOSTA
                                </button>
                            ) : (
                                <button className="btn btn-ghost" style={{ flex: 1, cursor: 'not-allowed' }} disabled>
                                    MERCADO FECHADO
                                </button>
                            )}
                            
                            {/* Multa Rescis√≥ria (Opcional: se voc√™ quiser liberar compra direta no mercado) */}
                            {p.teamId !== 'FREE' && p.teamId !== me && p.clause > 0 && (
                                <button className="btn btn-gold" style={{ width: '45px' }} title="Pagar Multa" onClick={() => onPayClause(p)}>
                                    <i className="fas fa-gavel"></i>
                                </button>
                            )}
                        </div>
                    )}
                </div>
            ))}
        </div>
    );
};
// --- FIM DO COMPONENTE MARKET ---

        // --- COMPONENTE: FORMUL√ÅRIO DE NEGOCIA√á√ÉO E CONTRAPROPOSTA ---
const OfferForm = ({ target, myPlayers, onSend }) => {
    const old = target.oldOffer || {};
    const isCounter = !!old.id;

    // ESTADOS INICIAIS (Com blindagem para campos vazios)
    const [t, setT] = useState(old.type || 'COMPRA');
    const [v, setV] = useState(old.value || '');
    const [sal, setSal] = useState(old.meta?.newSalary || target.salary || 0);
    const [con, setCon] = useState(old.offerContract || '1');
    const [role, setRole] = useState(old.meta?.role || 'ROTACAO');
    const [meta, setMeta] = useState(old.meta || { sellOn: 0, installments: 1 });
    const [swaps, setSwaps] = useState(old.swapPlayerIds || []);

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '500px', borderTop: '4px solid var(--primary)'}}>
                <h3 style={{color:'var(--primary)', marginBottom: 5}}>
                    {isCounter ? 'üîÑ Contraproposta' : `üíº Negociar ${target.name}`}
                </h3>
                <p style={{fontSize: 11, color: '#666', marginBottom: 20}}>
                    Preencha os termos para enviar ao propriet√°rio.
                </p>
                
                {/* SE√á√ÉO 1: ACORDO ENTRE OS CLUBES */}
                <div style={{borderBottom: '1px solid #333', paddingBottom: 15, marginBottom: 15}}>
                    <label style={{fontSize: '10px', color: 'var(--gold)', fontWeight: 'bold', textTransform: 'uppercase'}}>
                        1. Acordo entre Clubes
                    </label>
                    
                    <div style={{display:'flex', gap:5, margin:'10px 0'}}>
                        {['COMPRA','EMPRESTIMO','TROCA'].map(x => (
                            <button 
                                key={x} 
                                className={`btn ${t === x ? 'btn-green' : 'btn-ghost'}`} 
                                onClick={() => setT(x)} 
                                style={{flex: 1, fontSize: 11}}
                            >
                                {x}
                            </button>
                        ))}
                    </div>

                    <label style={{fontSize: 12}}>Taxa de Transfer√™ncia (‚Ç£)</label>
                    <input className="input-field" type="number" placeholder="Valor total..." value={v} onChange={e => setV(e.target.value)} />

                    {t === 'COMPRA' && (
                        <div className="card" style={{background: 'rgba(255,255,255,0.03)', padding: '12px', marginTop: 10, border: '1px solid #333'}}>
                            <div style={{display:'flex', justifyContent:'space-between', marginBottom: 5}}>
                                <small>üì¶ PARCELAMENTO</small>
                                <b style={{color: 'var(--primary)'}}>{meta.installments}x</b>
                            </div>
                            <input type="range" min="1" max="12" value={meta.installments} onChange={e => setMeta({...meta, installments: parseInt(e.target.value)})} style={{width:'100%', accentColor: 'var(--primary)'}} />
                            
                            <div style={{display:'flex', justifyContent:'space-between', marginTop: 15, marginBottom: 5}}>
                                <small>üìà DIREITO DE REVENDA</small>
                                <b style={{color: 'var(--secondary)'}}>{meta.sellOn}%</b>
                            </div>
                            <input type="range" min="0" max="50" value={meta.sellOn} onChange={e => setMeta({...meta, sellOn: parseInt(e.target.value)})} style={{width:'100%', accentColor: 'var(--secondary)'}} />
                        </div>
                    )}
                </div>

                {/* SE√á√ÉO 2: ACORDO COM O JOGADOR */}
                <div>
                    <label style={{fontSize: '10px', color: 'var(--primary)', fontWeight: 'bold', textTransform: 'uppercase'}}>
                        2. V√≠nculo com o Atleta
                    </label>
                    
                    <div style={{marginTop: 10}}>
                        <label style={{fontSize: 12}}>Sal√°rio Semanal Sugerido (‚Ç£)</label>
                        <input className="input-field" type="number" value={sal} onChange={e => setSal(e.target.value)} />
                    </div>
                    
                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10}}>
                        <div>
                            <label style={{fontSize: 12}}>Dura√ß√£o (Anos)</label>
                            <input className="input-field" type="number" value={con} onChange={e => setCon(e.target.value)} />
                        </div>
                        <div>
                            <label style={{fontSize: 12}}>Papel no Elenco</label>
                            <select className="input-field" value={role} onChange={e => setRole(e.target.value)}>
                                <option value="CRUCIAL">‚≠ê Crucial</option>
                                <option value="TITULAR">‚úÖ Titular</option>
                                <option value="ROTACAO">üîÑ Rota√ß√£o</option>
                                <option value="RESERVA">üí§ Reserva</option>
                            </select>
                        </div>
                    </div>
                </div>

                {/* A√á√ïES */}
                <div style={{display:'flex', gap:10, marginTop:25}}>
                    <button className="btn btn-green" style={{flex: 2}} onClick={() => {
                        const finalV = parseFloat(v) || 0;
                        const finalSal = parseFloat(sal) || 0;
                        const finalCon = parseInt(con) || 1;
                        
                        onSend(target, t, finalV, swaps, finalCon, {
                            ...meta, 
                            newSalary: finalSal, 
                            role: role,
                            installments: parseInt(meta.installments) || 1,
                            sellOn: parseInt(meta.sellOn) || 0
                        }, old);
                    }}>
                        {isCounter ? 'ENVIAR RESPOSTA' : 'ENVIAR PROPOSTA'}
                    </button>
                    <button className="btn btn-ghost" style={{flex: 1}} onClick={() => setModal(null)}>SAIR</button>
                </div>
            </div>
        </div>
    );
};
// --- FIM DO COMPONENTE OFFERFORM ---

        // ============================================================
// 1. COMPONENTE: PAINEL MASTER (ADMIN)
// ============================================================
const AdminPanel = ({ onUpdateCompBal, teams, papers, journalists, companies, reqs, config, onAct, onPost, onApprove, onReject, onEditT, onApproveTeam, onUpdateBal, onDeleteTeam, onConfig, onApprovePaper, onDeletePaper, onDeleteJourno, onRejectPaper, onApproveComp, onDeleteComp }) => (
    <div>
        <h3 style={{color: 'var(--warning)', borderLeft: '4px solid var(--warning)', paddingLeft: 10}}>Painel Master</h3>
        <div className="card" style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 10}}>
            <button className={`btn ${config.marketOpen?'btn-red':'btn-green'}`} onClick={()=>onAct('MARKET', !config.marketOpen)}>{config.marketOpen?'FECHAR MERCADO':'ABRIR MERCADO'}</button>
            <button className="btn btn-purple" onClick={()=>onAct('WEEK')}>VIRAR SEMANA</button>
            <button className="btn btn-red" onClick={()=>onAct('SEASON')}>VIRAR TEMPORADA</button>
            <button className="btn btn-gold" onClick={()=>{ const t=prompt("T√≠tulo"); const b=prompt("Texto"); if(t)onPost(t,b,'admin'); }}>COMUNICADO</button>
        </div>

        {/* GEST√ÉO DE EMPRESAS PENDENTES */}
        {(companies||[]).some(c=>c.status==='PENDING') && <h4>Empresas Pendentes</h4>}
        {(companies||[]).filter(c=>c.status==='PENDING').map(c => (
            <div key={c.id} className="card" style={{borderLeft:'4px solid var(--purple)'}}>
                <b>{c.name}</b> ({(COMPANY_TYPES[c.companyType] || {}).label || 'Tipo Desconhecido'})<br/>
                Dono: {c.owner}
                <div style={{display:'flex', gap:5, marginTop:5}}>
                    <button className="btn btn-green" onClick={()=>onApproveComp(c.id)}>APROVAR</button>
                    <button className="btn btn-red" onClick={()=>onDeleteComp(c.id)}>X</button>
                </div>
            </div>
        ))}

        <h4>Gest√£o de Empresas</h4>
        {(companies||[]).filter(c=>c.status!=='PENDING').map(c => (
            <div key={c.id} className="card">
                <b>{c.name}</b> {c.status==='BLOCKED' && <span style={{color:'red'}}>(BLOQUEADA)</span>}<br/>
                Saldo: {fmt(c.balance)}
                <div style={{display:'flex', gap:5, marginTop:5}}>
                    <button className="btn btn-green" onClick={()=>{
                        const n = prompt("Novo Saldo da Empresa:", c.balance); 
                        if(n !== null) onUpdateCompBal(c.id, n);
                    }}>$</button>
                    <button className="btn btn-red" onClick={()=>onDeleteComp(c.id)}>EXCLUIR</button>
                </div>
            </div>
        ))}

        {/* GEST√ÉO DE CLUBES */}
        <h4>Gest√£o de Clubes</h4>
        {(teams||[]).filter(t=>t.status!=='PENDING').map(t=>(
            <div key={t.id} className="card" style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                <span><b>{t.name}</b></span>
                <div style={{display:'flex', gap:5}}>
                    <button className="btn btn-ghost" style={{width:'auto'}} onClick={()=>onConfig(t)}><i className="fas fa-cog"></i></button>
                    <button className="btn btn-green" style={{width:'auto'}} onClick={()=>{const n=prompt("Novo Saldo:", t.balance); if(n)onUpdateBal(t.id, n)}}>$</button>
                    <button className="btn btn-purple" style={{width:'auto'}} onClick={()=>onEditT(t)}>ELENCO</button>
                    <button className="btn btn-red" style={{width:'auto'}} onClick={()=>onDeleteTeam(t.id)}><i className="fas fa-trash"></i></button>
                </div>
            </div>
        ))}
    </div>
);

// ============================================================
// 2. COMPONENTE: CONFIGURA√á√ïES DO CLUBE (SETTINGSFORM)
// ============================================================
const SettingsForm = ({ team, isAdmin, onUp, onUpgrade, onReq, onWithdraw }) => {
    // 1. Inicializa o formul√°rio com os dados atuais do time
    const [form, setF] = React.useState({
        name: team.name || '',
        logo: team.logo || '',
        balance: team.balance || 0,
        serie: team.serie || 'A',
        stadiumLevel: team.stadiumLevel || 1
    });

    return (
        <div style={{textAlign:'center'}}>
            <h3 style={{margin:0, marginBottom:15}}>Configurar {team.name}</h3>

            <label style={{fontSize:11, color:'#888', display:'block', textAlign:'left'}}>Nome do Clube</label>
            <input 
                className="input-field" 
                value={form.name} 
                onChange={e => setF({...form, name: e.target.value})} 
            />
            
            <label style={{fontSize:11, color:'#888', display:'block', textAlign:'left'}}>URL do Escudo</label>
            <input 
                className="input-field" 
                value={form.logo} 
                onChange={e => setF({...form, logo: e.target.value})} 
            />
            
            {isAdmin && (
                <>
                    <label style={{fontSize:11, color:'#888', display:'block', textAlign:'left'}}>Saldo (ADM)</label>
                    <input 
                        className="input-field" 
                        type="number" 
                        value={form.balance} 
                        onChange={e => setF({...form, balance: parseFloat(e.target.value) || 0})} 
                    />
                    
                    <label style={{fontSize:11, color:'#888', display:'block', textAlign:'left'}}>Divis√£o / S√©rie</label>
                    <select 
                        className="input-field" 
                        value={form.serie} 
                        onChange={e => setF({...form, serie: e.target.value})}
                    >
                        <option value="A">S√©rie A</option>
                        <option value="B">S√©rie B</option>
                        <option value="C">S√©rie C</option>
                        <option value="D">S√©rie D</option>
                    </select>
                </>
            )}

            {/* O BOT√ÉO SALVAR AGORA ENVIA O OBJETO FORM COMPLETO */}
            <button 
                className="btn btn-blue" 
                onClick={() => {
                    console.log("Salvando dados:", form); // Para voc√™ testar no F12
                    onUp(form);
                }} 
                style={{marginTop:15}}
            >
                SALVAR ALTERA√á√ïES
            </button>
            
            <hr style={{borderColor:'#444', margin: '15px 0'}}/>
            
            <p style={{margin:0, fontSize:14}}>üèüÔ∏è Est√°dio N√≠vel {form.stadiumLevel}</p>
            <button className="btn btn-purple" onClick={onUpgrade} style={{marginTop:10}}>
                EVOLUIR (‚Ç£ {((form.stadiumLevel || 1) + 1) * 2000000})
            </button>
            
            <hr style={{borderColor:'#444', margin: '15px 0'}}/>
            
            <div style={{display:'flex', flexDirection:'column', gap:10}}>
                <button className="btn btn-green" onClick={() => {
                    const v = prompt("Valor:"); 
                    if(v) onReq(team.id, v);
                }}>PEDIR INJE√á√ÉO</button>
                
                <button className="btn btn-red" onClick={() => {
                    const v = prompt("Valor a retirar:"); 
                    if(v) onWithdraw(team.id, v);
                }}>RETIRAR DINHEIRO</button>
            </div>
        </div>
    );
};

// ============================================================
// 3. COMPONENTE: PAINEL DO JOGADOR (PLAYERDASHBOARD)
// ============================================================
const PlayerDashboard = ({ player, team, sales, onUpdatePassword, onAction }) => {
    const [newPass, setNewPass] = useState('');
    const [tab, setTab] = useState('PERFIL'); 

    const myItems = (sales||[]).filter(s => s.buyerName === player.name);
    const xpNeed = getXPNext(player.overall || 45);
    const energy = player.energy !== undefined ? player.energy : 100;
    const xpPerc = Math.min(100, Math.max(0, ((player.xp || 0) / xpNeed) * 100));

    const badges = (() => {
        const list = [];
        const s = player.stats || {};
        if (s.goals >= 1) list.push({icon:'‚öΩ', name:'Primeiro Gol', color:'#fff'});
        if (s.goals >= 10) list.push({icon:'üî•', name:'Artilheiro', color:'gold'});
        if (player.overall >= 80) list.push({icon:'‚≠ê', name:'Craque', color:'var(--purple)'});
        return list;
    })();

    return (
        <div>
            {/* CABE√áALHO DO JOGADOR */}
            <div className="highlight-card" style={{textAlign:'center', paddingBottom:30, position:'relative'}}>
                <h2 style={{margin:0}}>{player.name} {player.mood}</h2>
                <small style={{color:'#ccc'}}>{team?.name || 'Agente Livre'}</small>
                
                <div style={{display:'flex', justifyContent:'center', gap:30, marginTop:15}}>
                    <div>
                        <div style={{fontSize:40, fontWeight:'900', color:'var(--warning)', lineHeight:1}}>{player.overall}</div>
                        <span style={{fontSize:10, color:'#888'}}>N√çVEL</span>
                    </div>
                    <div>
                        <div style={{fontSize:40, fontWeight:'900', color: energy > 50 ? 'var(--primary)' : 'var(--danger)', lineHeight:1}}>{energy}%</div>
                        <span style={{fontSize:10, color:'#888'}}>ENERGIA</span>
                    </div>
                </div>

                <div style={{position:'absolute', bottom:0, left:0, right:0, height:8, background:'#333'}}>
                    <div style={{width:`${xpPerc}%`, height:'100%', background:'linear-gradient(90deg, var(--warning), gold)', transition:'1s'}}></div>
                </div>
            </div>

            {/* MENU DE ABAS */}
            <div style={{display:'flex', gap:10, margin:'15px 0', overflowX:'auto', paddingBottom:5}}>
                <button className={`btn ${tab==='PERFIL'?'btn-blue':'btn-ghost'}`} onClick={()=>setTab('PERFIL')}>PERFIL</button>
                <button className={`btn ${tab==='ACOES'?'btn-red':'btn-ghost'}`} onClick={()=>setTab('ACOES')}>A√á√ïES</button>
                <button className={`btn ${tab==='INV'?'btn-gold':'btn-ghost'}`} onClick={()=>setTab('INV')}>ITENS</button>
            </div>

            {/* CONTE√öDO DAS ABAS */}
            {tab==='PERFIL' && (
                <div>
                    <div className="card" style={{borderLeft:'4px solid var(--primary)'}}>
                        <h3 style={{marginTop:0, color:'var(--primary)'}}>üè¶ {fmt(player.balance)}</h3>
                        <small style={{color:'#aaa'}}>Sal√°rio: {fmt(player.salary)} | Valor: {fmt(player.value)}</small>
                    </div>
                    <div className="card">
                        <div className="stats-grid">
                            <div className="stat-item"><span>‚öΩ Gols</span> <b>{player.stats?.goals||0}</b></div>
                            <div className="stat-item"><span>üëü Assis</span> <b>{player.stats?.assists||0}</b></div>
                        </div>
                    </div>
                </div>
            )}

            {tab==='ACOES' && (
                <div className="card">
                    <button className="btn btn-gold" onClick={()=>onAction('ASK_RAISE', player)}>üí∞ PEDIR AUMENTO</button>
                    <button className="btn btn-red" style={{marginTop:10}} onClick={()=>onAction('TRANSFER_REQUEST', player)}>üò° PEDIR TRANSFER√äNCIA</button>
                    <hr style={{borderColor:'#333', margin:'15px 0'}}/>
                    <div style={{display:'flex', gap:5}}>
                        <input className="input-field" type="password" placeholder="Nova Senha" value={newPass} onChange={e=>setNewPass(e.target.value)} style={{marginBottom:0}} />
                        <button className="btn btn-purple" style={{width:'auto'}} onClick={()=>{ if(!newPass) return; onUpdatePassword(newPass); setNewPass(''); alert("Senha Alterada!"); }}>OK</button>
                    </div>
                </div>
            )}

            {tab==='INV' && (
                <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10}}>
                    {myItems.length === 0 ? <p style={{gridColumn:'span 2', textAlign:'center', color: '#666'}}>Mochila vazia.</p> : 
                    myItems.map((item, index) => (
                        <div key={index} className="card" style={{textAlign:'center'}}>
                            <div style={{fontSize:24}}>üì¶</div>
                            <b style={{fontSize: 12}}>{item.productName}</b>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};
// --- FIM DOS COMPONENTES ---

            
       // --- COMPONENTE: CAIXA DE ENTRADA DE NEGOCIA√á√ïES ---
const OffersScreen = ({ user, offers, teams, onAccept, onReject, onCounter }) => {
    // Filtra propostas destinadas ao usu√°rio atual (Time ou Jogador)
    // o.targetId refere-se ao ID de quem deve responder √† oferta
    const myOffers = (offers || []).filter(o => 
        (o.targetId === user.data.id || o.recipientId === user.data.id) && o.status === 'PENDING'
    );

    return (
        <div className="offers-container">
            <h3 style={{ borderLeft: '4px solid var(--primary)', paddingLeft: 10, marginBottom: 20 }}>
                Caixa de Entrada ({myOffers.length})
            </h3>
            
            {myOffers.length === 0 && (
                <div style={{ textAlign: 'center', marginTop: 50, color: '#666' }}>
                    <i className="fas fa-envelope-open" style={{ fontSize: 40, display: 'block', marginBottom: 10 }}></i>
                    Nenhuma proposta aguardando sua resposta.
                </div>
            )}

            {myOffers.map(o => (
                <div key={o.id} className="card" style={{ borderLeft: '4px solid gold', position: 'relative', marginBottom: 15 }}>
                    {/* CABE√áALHO DA OFERTA */}
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                        <div>
                            <b style={{ color: 'var(--primary)', fontSize: 18 }}>{o.playerName}</b>
                            <small style={{ display: 'block', color: '#aaa', marginTop: 2 }}>
                                Proposta de: <b>{o.buyerName || "Interessado"}</b>
                            </small>
                        </div>
                        <span style={{ 
                            fontSize: 10, 
                            background: 'rgba(255, 215, 0, 0.1)', 
                            color: 'gold', 
                            padding: '3px 8px', 
                            borderRadius: 4, 
                            fontWeight: 'bold',
                            border: '1px solid gold',
                            textTransform: 'uppercase'
                        }}>
                            {o.type || 'NEGOCIA√á√ÉO'}
                        </span>
                    </div>

                    {/* DETALHES T√âCNICOS */}
                    <div style={{ 
                        background: '#1a1a1a', 
                        padding: '12px', 
                        borderRadius: 8, 
                        whiteSpace: 'pre-wrap', 
                        fontSize: 12, 
                        border: '1px solid #333', 
                        lineHeight: '1.5',
                        marginTop: 12,
                        color: '#eee',
                        fontFamily: 'monospace'
                    }}>
                        {o.description || `Valor: ${fmt(o.value)}\nContrato: ${o.contract} anos`}
                    </div>

                    {/* BOT√ïES DE DECIS√ÉO */}
                    <div style={{ display: 'flex', gap: 8, marginTop: 15 }}>
                        <button 
                            className="btn btn-green" 
                            style={{ flex: 1, fontWeight: 'bold', fontSize: 11 }} 
                            onClick={() => onAccept(o)}
                        >
                            ACEITAR
                        </button>
                        
                        <button 
                            className="btn btn-blue" 
                            style={{ flex: 1, fontWeight: 'bold', fontSize: 11 }} 
                            onClick={() => onCounter(o)}
                        >
                            CONTRA
                        </button>
                        
                        <button 
                            className="btn btn-red" 
                            style={{ flex: 1, fontWeight: 'bold', fontSize: 11 }} 
                            onClick={() => onReject(o)}
                        >
                            RECUSAR
                        </button>
                    </div>
                    
                    {/* TIMESTAMP */}
                    <div style={{ textAlign: 'right', marginTop: 10 }}>
                        <small style={{ fontSize: 9, color: '#555' }}>
                            Recebida em: {o.date ? new Date(o.date).toLocaleString() : 'Data indispon√≠vel'}
                        </small>
                    </div>
                </div>
            ))}
        </div>
    );
};

        
        // --- COMPONENTE: RANKING DE CLUBES E ATLETAS ---
const Ranking = ({ teams, players }) => {
    const [view, setView] = React.useState('TEAMS');
    
    // Filtro para garantir que apenas jogadores ativos em times apare√ßam nos rankings
    const validPlayers = players.filter(p => p.teamId && p.teamId !== 'FREE' && p.name);

    // 1. Gerador do Ranking de Clubes (Poder Financeiro)
    const renderTeams = () => teams
        .filter(t => t.status !== 'PENDING')
        .map(t => {
            // Calcula o valor total do elenco do time
            const squadValue = validPlayers
                .filter(p => p.teamId === t.id)
                .reduce((a, b) => a + (parseFloat(b.value) || 0), 0);
            
            return { 
                ...t, 
                totalWealth: (parseFloat(t.balance) || 0) + squadValue, 
                squadValue 
            };
        })
        .sort((a, b) => b.totalWealth - a.totalWealth)
        .map((t, i) => (
            <div key={t.id} className="card" style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                <b style={{ fontSize: 18, color: '#666', width: 25 }}>{i + 1}¬∫</b>
                {t.logo ? 
                    <img src={t.logo} style={{ width: 35, height: 35, borderRadius: '50%', objectFit: 'cover', border: '1px solid #333' }} /> : 
                    <div style={{ width: 35, height: 35, background: '#222', borderRadius: '50%' }}></div>
                }
                <div style={{ flex: 1 }}>
                    <b style={{fontSize: 15}}>{t.name}</b><br />
                    <small style={{ color: 'var(--primary)', fontWeight: 'bold' }}>
                        Patrim√¥nio: {fmt(t.totalWealth)}
                    </small>
                </div>
                <div style={{textAlign: 'right'}}>
                    <small style={{fontSize: 9, color: '#666', display: 'block'}}>Saldo: {fmt(t.balance)}</small>
                </div>
            </div>
        ));

    // 2. Gerador do Ranking de Jogadores (Gols, Assist√™ncias, Sal√°rios, etc.)
    const renderPlayers = (sortKey, label, color, isStat = true) => {
        let sorted = [];
        if (isStat) {
            // Filtra quem tem pelo menos 1 na estat√≠stica para n√£o poluir o ranking
            sorted = validPlayers
                .filter(p => p.stats && p.stats[sortKey] > 0)
                .sort((a, b) => (b.stats[sortKey] || 0) - (a.stats[sortKey] || 0));
        } else {
            // Ordena√ß√£o por campos diretos (Overall ou Sal√°rio)
            sorted = [...validPlayers].sort((a, b) => (parseFloat(b[sortKey]) || 0) - (parseFloat(a[sortKey]) || 0));
        }

        return sorted.slice(0, 20).map((p, i) => (
            <div key={p.id} className="card" style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                <b style={{ fontSize: 18, color: '#666', width: 25 }}>{i + 1}¬∫</b>
                <div style={{ flex: 1 }}>
                    <b style={{fontSize: 15}}>{p.name}</b><br />
                    <small style={{color: '#888'}}>({teams.find(t => t.id === p.teamId)?.name || '???'})</small>
                </div>
                <div style={{ fontWeight: 'bold', fontSize: 14, color: color, background: 'rgba(0,0,0,0.2)', padding: '4px 8px', borderRadius: 4 }}>
                    {label} {isStat ? p.stats[sortKey] : (sortKey === 'salary' ? fmt(p[sortKey]) : p[sortKey])}
                </div>
            </div>
        ));
    };

    return (
        <div>
            <h3 style={{borderLeft: '4px solid var(--primary)', paddingLeft: 10}}>Lideran√ßas da Temporada</h3>
            
            {/* ABAS DE NAVEGA√á√ÉO DO RANKING */}
            <div className="rank-tabs" style={{overflowX: 'auto', display: 'flex', whiteSpace: 'nowrap', paddingBottom: 5}}>
                <div className={`rank-tab ${view === 'TEAMS' ? 'active' : ''}`} onClick={() => setView('TEAMS')}>üí∞ Clubes</div>
                <div className={`rank-tab ${view === 'OVERALL' ? 'active' : ''}`} onClick={() => setView('OVERALL')}>‚≠ê N√≠vel</div>
                <div className={`rank-tab ${view === 'SALARY' ? 'active' : ''}`} onClick={() => setView('SALARY')}>üí∏ Sal√°rios</div>
                <div className={`rank-tab ${view === 'GOALS' ? 'active' : ''}`} onClick={() => setView('GOALS')}>‚öΩ Gols</div>
                <div className={`rank-tab ${view === 'ASSIST' ? 'active' : ''}`} onClick={() => setView('ASSIST')}>üëü Assis</div>
                <div className={`rank-tab ${view === 'SAVES' ? 'active' : ''}`} onClick={() => setView('SAVES')}>üß§ Defesas</div>
                <div className={`rank-tab ${view === 'YEL' ? 'active' : ''}`} onClick={() => setView('YEL')}>üü® Amarelos</div>
                <div className={`rank-tab ${view === 'RED' ? 'active' : ''}`} onClick={() => setView('RED')}>üü• Vermelhos</div>
            </div>

            {/* RENDERIZA√á√ÉO DO CONTE√öDO */}
            <div style={{ marginTop: 15 }}>
                {view === 'TEAMS' && renderTeams()}
                {view === 'OVERALL' && renderPlayers('overall', 'OVR', 'var(--warning)', false)}
                {view === 'SALARY' && renderPlayers('salary', '', 'var(--primary)', false)}
                {view === 'GOALS' && renderPlayers('goals', '', '#fff')}
                {view === 'ASSIST' && renderPlayers('assists', '', '#fff')}
                {view === 'SAVES' && renderPlayers('saves', '', '#fff')}
                {view === 'YEL' && renderPlayers('yellows', '', 'yellow')}
                {view === 'RED' && renderPlayers('reds', '', 'red')}
            </div>

            {view !== 'TEAMS' && (validPlayers.length > 20) && (
                <p style={{textAlign: 'center', fontSize: 10, color: '#555', marginTop: 10}}>Exibindo apenas o Top 20</p>
            )}
        </div>
    );
};
// --- FIM DO COMPONENTE RANKING ---

        // ============================================================
// 1. COMPONENTE: FORMUL√ÅRIO DE S√öMULA E DESEMPENHO (XP)
// ============================================================
const MatchPerformanceForm = ({ players, teams, onSaveStats }) => {
    const [selP, setSelP] = React.useState(null);
    const [match, setMatch] = React.useState({ goals: 0, assists: 0, tackles: 0, saves: 0, yellows: 0, reds: 0, rating: '', result: 'NENHUM' });
    const [search, setSearch] = React.useState('');

    const calcMatchXP = () => {
        let xp = 0;
        const R = { GOAL: 150, ASSIST: 120, TACKLE: 80, SAVE: 100, WIN: 300, DRAW: 100, LOSS: -100, YELLOW: -50, RED: -200, RATING_MULT: 50 };
        xp += (match.goals || 0) * R.GOAL;
        xp += (match.assists || 0) * R.ASSIST;
        xp += (match.tackles || 0) * R.TACKLE;
        xp += (match.saves || 0) * R.SAVE;
        xp += (match.yellows || 0) * R.YELLOW;
        xp += (match.reds || 0) * R.RED;
        if (match.result === 'VITORIA') xp += R.WIN;
        if (match.result === 'EMPATE') xp += R.DRAW;
        if (match.result === 'DERROTA') xp += R.LOSS;
        xp += (parseFloat(match.rating) || 0) * R.RATING_MULT;
        return parseInt(xp);
    };

    const filtered = players.filter(p => p.name.toLowerCase().includes(search.toLowerCase()));

    // RETORNO A: Formul√°rio de Notas (Caso jogador esteja selecionado)
    if (selP) return (
        <div>
            <h3 style={{ color: 'var(--primary)' }}>S√∫mula: {selP.name}</h3>
            <div style={{ background: 'rgba(255,255,255,0.05)', padding: 10, borderRadius: 8, marginBottom: 10 }}>
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 10 }}>
                    <div><label>‚öΩ Gols</label><input className="input-field" type="number" value={match.goals} onChange={e => setMatch({ ...match, goals: parseInt(e.target.value) || 0 })} /></div>
                    <div><label>üëü Assist√™ncias</label><input className="input-field" type="number" value={match.assists} onChange={e => setMatch({ ...match, assists: parseInt(e.target.value) || 0 })} /></div>
                    <div><label>üõ°Ô∏è Desarmes</label><input className="input-field" type="number" value={match.tackles} onChange={e => setMatch({ ...match, tackles: parseInt(e.target.value) || 0 })} /></div>
                    <div><label>üß§ Defesas</label><input className="input-field" type="number" value={match.saves} onChange={e => setMatch({ ...match, saves: parseInt(e.target.value) || 0 })} /></div>
                    <div><label>üü® Amarelo</label><input className="input-field" type="number" value={match.yellows} onChange={e => setMatch({ ...match, yellows: parseInt(e.target.value) || 0 })} /></div>
                    <div><label>üü• Vermelho</label><input className="input-field" type="number" value={match.reds} onChange={e => setMatch({ ...match, reds: parseInt(e.target.value) || 0 })} /></div>
                </div>
                <hr style={{ borderColor: '#444', margin: '15px 0' }} />
                <label>‚≠ê Nota da Atua√ß√£o</label>
                <input className="input-field" type="number" step="0.1" value={match.rating} onChange={e => setMatch({ ...match, rating: e.target.value })} />
                <label>üö© Resultado</label>
                <select className="input-field" value={match.result} onChange={e => setMatch({ ...match, result: e.target.value })}>
                    <option value="NENHUM">Neutro</option>
                    <option value="VITORIA">Vit√≥ria</option>
                    <option value="EMPATE">Empate</option>
                    <option value="DERROTA">Derrota</option>
                </select>
            </div>
            <button className="btn btn-green" onClick={() => onSaveStats(selP, match, calcMatchXP())}>SALVAR DESEMPENHO</button>
            <button className="btn btn-ghost" style={{ marginTop: 5 }} onClick={() => setSelP(null)}>VOLTAR</button>
        </div>
    );

    // RETORNO B: Busca de Jogadores (Caso selP seja null)
    return (
        <div>
            <h3>Lan√ßar Desempenho</h3>
            <input className="input-field" placeholder="Buscar jogador..." value={search} onChange={e => setSearch(e.target.value)} />
            <div style={{ maxHeight: 300, overflowY: 'auto', marginTop: 10 }}>
                {search.length > 0 && filtered.map(p => (
                    <div key={p.id} className="card" style={{ cursor: 'pointer' }} onClick={() => {
                        setSelP(p);
                        setMatch({ goals: 0, assists: 0, tackles: 0, saves: 0, yellows: 0, reds: 0, rating: '', result: 'NENHUM' });
                    }}>
                        <b>{p.name}</b> <small>({teams.find(t => t.id === p.teamId)?.name || 'Sem Clube'})</small>
                    </div>
                ))}
            </div>
        </div>
    );
};

// ============================================================
// 2. COMPONENTE: EDITOR DE TABELA DE CLASSIFICA√á√ÉO
// ============================================================
const TeamStandingsEditor = ({ teams, onUpdateTeamStats }) => {
    return (
        <div>
            <h3 style={{ borderLeft: '4px solid var(--gold)', paddingLeft: 10 }}>Editar Tabela</h3>
            {teams.filter(t => t.status !== 'PENDING').map(t => (
                <div key={t.id} className="card" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <b>{t.name}</b>
                    <div style={{ display: 'flex', gap: 5, alignItems: 'center' }}>
                        <input className="input-field" type="number" style={{ width: 45, marginBottom: 0, textAlign: 'center' }} defaultValue={t.stats?.wins || 0} id={`w-${t.id}`} title="Vit√≥rias" />
                        <input className="input-field" type="number" style={{ width: 45, marginBottom: 0, textAlign: 'center' }} defaultValue={t.stats?.draws || 0} id={`d-${t.id}`} title="Empates" />
                        <input className="input-field" type="number" style={{ width: 45, marginBottom: 0, textAlign: 'center' }} defaultValue={t.stats?.losses || 0} id={`l-${t.id}`} title="Derrotas" />
                        <button className="btn btn-green" style={{ width: 'auto', padding: '10px' }} onClick={() => {
                            onUpdateTeamStats(t.id, {
                                wins: parseInt(document.getElementById(`w-${t.id}`).value) || 0,
                                draws: parseInt(document.getElementById(`d-${t.id}`).value) || 0,
                                losses: parseInt(document.getElementById(`l-${t.id}`).value) || 0
                            });
                        }}>üíæ</button>
                    </div>
                </div>
            ))}
        </div>
    );
};

// ============================================================
// 3. RENDERIZA√á√ÉO FINAL DO SISTEMA
// ============================================================
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
    <ErrorBoundary>
        <App />
    </ErrorBoundary>
);
</script>
</body>
</html>
