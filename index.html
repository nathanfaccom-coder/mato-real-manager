
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gerenciador de Times de Mato Real</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #121212; --bg-card: #1E1E1E; --bg-input: #2C2C2C;
            --primary: #00E676; --secondary: #2979FF; --danger: #FF1744; --warning: #FFC400; --purple: #D500F9;
            --text-main: #FFFFFF; --border: #333333;
        }
        body { background: var(--bg-dark); color: var(--text-main); font-family: 'Roboto', sans-serif; margin: 0; padding-bottom: 80px; -webkit-font-smoothing: antialiased; }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        .card { background: var(--bg-card); padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.4); position: relative; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; transition: 0.2s; margin-bottom: 5px; color: white; }
        .btn:active { transform: scale(0.98); }
        .btn-green { background: var(--primary); color: #000; }
        .btn-blue { background: var(--secondary); }
        .btn-red { background: var(--danger); }
        .btn-gold { background: var(--warning); color: #000; }
        .btn-purple { background: var(--purple); }
        .btn-ghost { background: transparent; border: 1px solid #666; color: #ccc; }
        .input-field { width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border); color: white; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-family: inherit; font-size: 14px; }
        .input-field:focus { outline: 2px solid var(--primary); border-color: transparent; }
        .header { background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px); padding: 15px; position: sticky; top: 0; z-index: 50; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .badge-pos { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 900; margin-right: 8px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        .player-ov { background: #003300; color: #00E676; border: 1px solid #00E676; padding: 2px 6px; border-radius: 4px; font-weight: 900; font-size: 14px; }
        .news-card { background: #262626; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #666; font-size: 13px; line-height: 1.4; white-space: pre-wrap; }
        .news-transfer { border-color: var(--secondary); background: linear-gradient(90deg, #1a1a2e, #16213e); }
        .news-money { border-color: var(--primary); }
        .news-money-minus { border-color: var(--danger); }
        .news-admin { border-color: var(--warning); background: #2a2000; }
        .news-press { border-color: #00bcd4; background: #003333; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; border-top: 1px solid var(--border); display: flex; padding-bottom: env(safe-area-inset-bottom); z-index: 100; }
        .nav-item { flex: 1; padding: 12px; text-align: center; color: #666; font-size: 9px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; display: block; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 999; display: grid; place-items: center; padding: 15px; backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-card); width: 100%; max-width: 450px; padding: 20px; border-radius: 12px; border: 1px solid var(--border); max-height: 90vh; overflow-y: auto; }
        .login-tabs { display: flex; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #666; font-weight: bold; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .rating-badge { color: var(--warning); font-weight: bold; font-size: 11px; margin-left: 5px; display: flex; align-items: center; gap: 2px; text-shadow: 0 1px 2px black; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 10px; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px; }
        .stat-item { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .stat-lbl { font-size: 14px; margin-bottom: 2px; }
        .stat-val { color: #fff; font-weight: 900; font-size: 11px; }
        .dev-credits { font-size: 10px; color: #666; margin-top: -5px; margin-bottom: 15px; text-align: center; display: block; width: 100%; }
        .error-screen { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #220000; color: #ff5555; padding: 20px; text-align: center; }
        .rank-tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .rank-tabs::-webkit-scrollbar { display: none; }
        .rank-tab { background: #333; border: 1px solid #444; color: #888; padding: 8px 16px; border-radius: 20px; font-size: 12px; white-space: nowrap; cursor: pointer; transition: 0.2s; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .rank-tab.active { background: var(--primary); color: #000; border-color: var(--primary); box-shadow: 0 0 10px rgba(0,230,118,0.3); }
        .rank-tab i { font-size: 14px; }
        .highlight-card { background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%); border: 1px solid var(--secondary); padding: 20px; text-align: center; margin-bottom: 15px; border-radius: 12px; position: relative; overflow: hidden; }
        .highlight-card::after { content: 'â˜…'; position: absolute; top: -10px; right: -10px; font-size: 100px; color: rgba(255,255,255,0.05); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Crash:", error, errorInfo); }
            render() { if (this.state.hasError) { return <div className="error-screen"><h2>Ocorreu um erro!</h2><p>O aplicativo encontrou um problema inesperado.</p><button className="btn btn-red" onClick={()=>{localStorage.clear(); window.location.reload();}}>REINICIAR APLICATIVO</button></div>; } return this.props.children; }
        }

        const firebaseConfig = { apiKey: "AIzaSyBrtJFfWAqT0AZYHlm4it-noB5h9jIPJEI", authDomain: "gerenciador-de-times-matoreal.firebaseapp.com", projectId: "gerenciador-de-times-matoreal", storageBucket: "gerenciador-de-times-matoreal.firebasestorage.app", messagingSenderId: "29096266740", appId: "1:29096266740:web:ec48e7225c18c20dbc07a1" };
        try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch (e) { console.error(e); }
        const db = firebase.firestore();
        const { useState, useEffect } = React;

        const POS = ['GOL', 'ZAG', 'LD', 'LE', 'VOL', 'MC', 'MEI', 'ATA'];
        const SERIES = ['A', 'B', 'C', 'D'];
        const COSTS = [0, 5000000, 20000000, 50000000, 100000000];
        const fmt = (v) => "â‚£ " + parseFloat(v||0).toLocaleString('pt-BR');
        const getPosColor = (p) => { if(!p) return '#555'; if(p==='GOL') return '#FFD700'; if(['ZAG','LD','LE'].some(x=>p.includes(x))) return '#2979FF'; if(['VOL','MC','MEI'].some(x=>p.includes(x))) return '#00E676'; return '#FF1744'; };

        // --- ETAPA 1: CONSTANTES DE EMPRESAS ---
        const COMPANY_TYPES = {
            'COMERCIO': { label: 'ComÃ©rcio Local', start: 2500000, tax: 50000, desc: 'Ideal para iniciantes. Imposto baixo.' },
            'MEDIA': { label: 'MÃ©dia Empresa', start: 20000000, tax: 350000, desc: 'Poder moderado. Imposto mÃ©dio.' },
            'GRANDE': { label: 'Grande Empresa', start: 100000000, tax: 2000000, desc: 'Gigante do mercado. Imposto alto.' }
        };
        const PROD_CATS = {
            'CHUTEIRA': 'ðŸ‘Ÿ Chuteira',
            'LUVAS': 'ðŸ§¤ Luvas/AcessÃ³rios',
            'CONSUMIVEL': 'âš¡ ConsumÃ­vel/Energia',
            'VEICULO': 'ðŸš— VeÃ­culo',
            'IMOVEL': 'ðŸ  ImÃ³vel',
            'TECNOLOGIA': 'ðŸ“± Tecnologia',
            'LUXO': 'ðŸ’Ž Luxo/Moda',
            'SAUDE': 'ðŸ’Š SaÃºde'
        };
        // --- SISTEMA DE RPG (NÃVEL, XP, ENERGIA) ---
        const MIN_LEVEL = 45;
        const MAX_LEVEL = 100;
        
        // FÃ³rmula: Quanto XP precisa para ir pro prÃ³ximo nÃ­vel?
        // Ex: NÃ­vel 45 precisa de 4500 XP. NÃ­vel 90 precisa de 9000 XP.
        const getXPNext = (lvl) => (lvl * 100); 

        // FunÃ§Ã£o para calcular ganho/perda de XP
        const calcNewLevel = (currentLvl, currentXP, change) => {
            let lvl = currentLvl;
            let xp = currentXP + change;
            
            // Subir de nÃ­vel (Level Up)
            while (xp >= getXPNext(lvl) && lvl < MAX_LEVEL) {
                xp -= getXPNext(lvl);
                lvl++;
            }
            
            // Cair de nÃ­vel (Level Down)
            while (xp < 0 && lvl > MIN_LEVEL) {
                lvl--;
                xp += getXPNext(lvl); // Recupera o XP do nÃ­vel anterior
            }
            
            // Limites
            if (lvl <= MIN_LEVEL && xp < 0) xp = 0;
            if (lvl >= MAX_LEVEL) xp = 0;

            return { lvl, xp };
        };

        const formatOfferDetails = (type, v, con, meta, swapIds, players) => {
            let details = [];
            if(v > 0) details.push(`ðŸ’° Valor: ${fmt(v)}`);
            if (meta.installments > 1) details.push(`ðŸ“… Parcelamento: ${meta.installments}x de ${fmt(v/meta.installments)}`);
            if (type !== 'TROCA') details.push(`ðŸ“ Contrato: ${con} Temporadas`);
            if (type === 'COMPRA' && meta.sellOn > 0) details.push(`ðŸ“ˆ Revenda: ${meta.sellOn}% futura venda`);
            if (type === 'EMPRESTIMO') { details.push(`ðŸ’¸ SalÃ¡rios: Comprador paga ${meta.wageSplit}%`); if (meta.buyOpt > 0) details.push(`ðŸ›’ OpÃ§Ã£o de Compra: ${fmt(meta.buyOpt)}`); }
            if (type === 'TROCA') {
                if (swapIds && swapIds.length > 0) { const swapNames = swapIds.map(id => players.find(p=>p.id===id)?.name).join(', '); details.push(`ðŸ”„ Troca por: ${swapNames}`); }
                if (v > 0) details.push(`ðŸ’µ Volta: ${meta.cashDir === 'PAY' ? 'Eu pago' : 'Eu recebo'} ${fmt(v)}`);
            }
            return details.join('\n');
        };

        
        function App() {
            const [user, setUser] = useState(null); 
            const [teams, setTeams] = useState([]);
            const [players, setPlayers] = useState([]);
            const [offers, setOffers] = useState([]);
            const [news, setNews] = useState([]);
            const [reqs, setReqs] = useState([]);
            const [conf, setConf] = useState({ marketOpen: true });
            const [papers, setPapers] = useState([]);
            const [journalists, setJournalists] = useState([]);
            const [companies, setCompanies] = useState([]);
            const [products, setProducts] = useState([]);
            const [sps, setSps] = useState([]);
            
            const [screen, setScreen] = useState('HOME');
            const [modal, setModal] = useState(null);
            const [loading, setLoading] = useState(true);
            const [newNews, setNewNews] = useState(false);
            const [adminTeam, setAdminTeam] = useState(null); 
            const [sales, setSales] = useState([]);

            useEffect(() => {
                const unsubs = [
                    db.collection('teams').onSnapshot(s => setTeams(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    db.collection('players').onSnapshot(s => setPlayers(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    db.collection('config').doc('system').onSnapshot(s => setConf(s.exists ? s.data() : {marketOpen:true})),
                    db.collection('financeRequests').onSnapshot(s => setReqs(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    db.collection('newspapers').onSnapshot(s => setPapers(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    db.collection('journalists').onSnapshot(s => setJournalists(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    
                    db.collection('companies').onSnapshot(s => setCompanies(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    db.collection('products').onSnapshot(s => setProducts(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    db.collection('sponsorships').onSnapshot(s => setSps(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    db.collection('sales').orderBy('date', 'desc').limit(50).onSnapshot(s => setSales(s.docs.map(d => d.data()))),
                    db.collection('news').orderBy('date', 'desc').limit(50).onSnapshot(s => { const list = s.docs.map(d => ({id:d.id, ...d.data()})); setNews(list); const lastRead = localStorage.getItem('lastRead'); if (list.length && (!lastRead || list[0].date > parseInt(lastRead))) setNewNews(true); setLoading(false); })
                ];
                return () => unsubs.forEach(u => u());
            }, []);

            // --- 1. LÃ“GICA DE LOGIN (ESSENCIAL PARA ENTRAR NO JOGO) ---
            const login = (id, pwd, type) => {
                const findAndLogin = (list, screenType, userRole, checkStatus = true) => {
                    const found = list.find(x => x.id === id);
                    const pass = found?.password || '1234';
                    if (found && pass === pwd) {
                        if (checkStatus && found.status === 'PENDING') return alert("â³ Aguarde a FederaÃ§Ã£o.");
                        setUser({type: userRole, data: found});
                        setScreen(screenType);
                    } else {
                        alert("ID ou Senha incorretos!");
                    }
                };
                if (type === 'TEAM') findAndLogin(teams, 'HOME', 'USER');
                else if (type === 'PAPER') findAndLogin(papers, 'PRESS_DASH', 'PRESS');
                else if (type === 'JOURNALIST') findAndLogin(journalists, 'PRESS_DASH', 'PRESS_WORKER');
                else if (type === 'COMPANY') findAndLogin(companies, 'COMPANY_HOME', 'COMPANY');
                else if (type === 'PLAYER') findAndLogin(players, 'PLAYER_DASH', 'PLAYER', false);
            };

            const fixPlayersData = async () => {
                if(!confirm("Deseja padronizar os contratos de todos os jogadores?")) return;
                const snapshot = await db.collection('players').get();
                const b = db.batch();
                snapshot.forEach(doc => {
                    const d = doc.data();
                    b.update(db.collection('players').doc(doc.id), {
                        salary: d.salary || 1000,
                        clause: d.clause || 1000000,
                        balance: d.balance || 0,
                        history: d.history || []
                    });
                });
                await b.commit();
                alert("Sistema FIFA inicializado!");
            };

    
            const loginAdmin = () => { setUser({ type: 'ADMIN', data: { id: 'admin', name: 'FEDERAÃ‡ÃƒO (ADM)', balance: 0, logo: null, stadiumLevel: 1, serie: 'ADM' } }); setScreen('HOME'); };
            const createTeam = async (name, bal, serie, pass, logo) => { if(teams.find(t=>t.name.toLowerCase()===name.toLowerCase())) return alert("Nome em uso!"); await db.collection('teams').add({ name, balance: parseFloat(bal), serie, password: pass, stadiumLevel: 1, logo: logo||null, status: 'PENDING' }); alert("Criado! Aguarde aprovaÃ§Ã£o."); };
            const createNewspaper = async (name, pass, owner) => { await db.collection('newspapers').add({ name, password: pass, ownerName: owner, status: 'PENDING' }); alert("Jornal criado! Aguarde FederaÃ§Ã£o."); };
            const createJournalist = async (name, pass, paperId) => { await db.collection('journalists').add({ name, password: pass, newspaperId: paperId, status: 'PENDING' }); alert("Conta criada! Aguarde seu Chefe."); };
            
            
            const createCompany = async (f) => {
                if(!f.n || !f.p) return alert("Preencha tudo!");
                await db.collection('companies').add({ name: f.n, owner: f.owner, password: f.p, companyType: f.type, balance: COMPANY_TYPES[f.type].start, status: 'PENDING' });
                alert("SolicitaÃ§Ã£o enviada! Aguarde a FederaÃ§Ã£o.");
            };
            // --- ETAPA 2: LÃ³gica de Produtos ---
            const saveProduct = async (p) => {
                const price = parseFloat(p.price);
                // Adicionei o campo "cat" no payload
                const payload = { 
                    name: p.name, 
                    price, 
                    img: p.img, 
                    desc: p.desc,
                    cat: p.cat || 'CHUTEIRA', // Salva a categoria
                    companyId: user.data.id 
                };

                if (p.id) {
                    const old = products.find(x=>x.id===p.id);
                    if (old && price < old.price) { postNews(`ðŸš¨ **PROMOÃ‡ÃƒO!**\nA **${user.data.name}** baixou o preÃ§o de **${p.name}**!\nDe: ${fmt(old.price)} âž Por: ${fmt(price)}`, 'biz'); }
                    // Remove companyId do update para seguranÃ§a, mas mantÃ©m o resto
                    delete payload.companyId; 
                    await db.collection('products').doc(p.id).update(payload);
                } else {
                    await db.collection('products').add(payload);
                    postNews(`ðŸ›ï¸ **NOVIDADE**\nA **${user.data.name}** lanÃ§ou: **${p.name}** (${PROD_CATS[payload.cat]}) por ${fmt(price)}.`, 'biz');
                }
            };
            // --- ETAPA 3: LÃ³gica de Shopping e PatrocÃ­nio ---
            const requestSponsorship = async (companyId, val) => {
                // Verifica se jÃ¡ existe pedido pendente ou ativo com essa empresa
                if (sps.find(s => s.companyId === companyId && s.teamId === user.data.id)) {
                    return alert("JÃ¡ existe uma negociaÃ§Ã£o ou contrato ativo com esta empresa.");
                }
                const comp = companies.find(c => c.id === companyId);
                await db.collection('sponsorships').add({ 
                    companyId, 
                    companyName: comp.name, 
                    teamId: user.data.id, 
                    teamName: user.data.name, 
                    value: parseFloat(val), 
                    status: 'PENDING' 
                });
                alert("Proposta enviada para a empresa!");
            };

            const processSponsorship = async (s, status) => {
                if (status === 'REJECTED' || status === 'CANCELLED') {
                    if(confirm(status === 'REJECTED' ? "Recusar proposta?" : "Cancelar contrato?")) {
                        await db.collection('sponsorships').doc(s.id).delete();
                    }
                } else if (status === 'ACTIVE') {
                    await db.collection('sponsorships').doc(s.id).update({ status: 'ACTIVE' });
                    postNews(`ðŸ¤ **NOVO PATROCÃNIO**\nA **${user.data.name}** agora patrocina o **${s.teamName}**!`, 'biz');
                }
            };

            const buyProduct = async (prod, seller) => {
                // Pega o saldo atual (se for jogador e nÃ£o tiver nada, assume 0)
                const currentBalance = user.data.balance || 0;
                
                if (currentBalance < prod.price) return alert("Saldo insuficiente!");
                if (!confirm(`Comprar ${prod.name} por ${fmt(prod.price)}?`)) return;

                const b = db.batch();
                
                // Verifica quem estÃ¡ comprando para descontar do lugar certo
                if (user.type === 'PLAYER') {
                    b.update(db.collection('players').doc(user.data.id), { balance: currentBalance - prod.price });
                } else {
                    b.update(db.collection('teams').doc(user.data.id), { balance: currentBalance - prod.price });
                }

                // Paga a empresa
                b.update(db.collection('companies').doc(seller.id), { balance: seller.balance + prod.price });
                
                // Registra a venda
                const saleRef = db.collection('sales').doc();
                b.set(saleRef, { 
                    companyId: seller.id, 
                    productName: prod.name, 
                    buyerName: user.data.name, 
                    price: prod.price, 
                    date: Date.now() 
                });
                
                await b.commit();
                alert("Compra realizada com sucesso!");
            };

            const approveTeam = async (teamId, finalBalance) => { await db.collection('teams').doc(teamId).update({ status: 'ACTIVE', balance: parseFloat(finalBalance) }); const t = teams.find(x=>x.id===teamId); postNews(`ðŸ›¡ï¸ **NOVO CLUBE!**\nO **${t.name}** foi aprovado na SÃ©rie ${t.serie}.`, 'infra'); alert("Aprovado!"); };
            const deleteTeam = async (teamId) => { if(!confirm("âš ï¸ PERIGO: Excluir time e jogadores?")) return; const batch = db.batch(); batch.delete(db.collection('teams').doc(teamId)); const snap = await db.collection('players').where('teamId', '==', teamId).get(); snap.docs.forEach(doc => batch.delete(doc.ref)); await batch.commit(); postNews("ðŸš« **CLUBE EXTINTO**\nUm time encerrou atividades.", 'infra'); };
            const deletePaper = async (id) => { if(!confirm("Excluir Jornal e demitir jornalistas?")) return; const batch = db.batch(); batch.delete(db.collection('newspapers').doc(id)); const js = await db.collection('journalists').where('newspaperId', '==', id).get(); js.docs.forEach(d => batch.delete(d.ref)); await batch.commit(); alert("Jornal fechado!"); };
            const deleteJournalist = async (id) => { if(!confirm("Demitir Jornalista?")) return; await db.collection('journalists').doc(id).delete(); alert("Demitido!"); };
            const updateBalance = async (teamId, newBal) => { await db.collection('teams').doc(teamId).update({ balance: parseFloat(newBal) }); alert("Atualizado!"); };
            const withdrawMoney = async (amount, reason) => { const val = parseFloat(amount.replace(',', '.')); if(isNaN(val) || val <= 0) return alert("Valor invÃ¡lido!"); if(user.data.balance < val) return alert("Saldo insuficiente!"); await db.collection('teams').doc(user.data.id).update({ balance: firebase.firestore.FieldValue.increment(-val) }); postNews(`ðŸ’¸ **SAÃDA DE CAIXA**\nO **${user.data.name}** retirou ${fmt(val)}.\nðŸ“ Motivo: ${reason}`, 'money-minus'); setModal(null); };
// --- NOVA VERSÃƒO DO SAVEPLAYER (SISTEMA FIFA) ---
            const savePlayer = async (p) => {
                const isNew = !p.id;
                const ref = isNew ? db.collection('players').doc() : db.collection('players').doc(p.id);
                const old = isNew ? {} : (players.find(pl => pl.id === p.id) || {});

                // REGRA DE SEGURANÃ‡A: Se vocÃª Ã© um time criando o jogador, o teamId DEVE ser o seu
                let targetTeamId = p.teamId || old.teamId || 'FREE';
                if (user.type === 'USER' && isNew) {
                    targetTeamId = user.data.id;
                }

                const data = {
                    ...p,
                    overall: Math.max(45, parseInt(p.overall || old.overall || 45)),
                    salary: parseFloat(p.salary || old.salary || 1000), 
                    clause: parseFloat(p.clause || old.clause || 1000000),
                    balance: parseFloat(p.balance || old.balance || 0),
                    history: p.history || old.history || [],
                    xp: p.xp !== undefined ? p.xp : (old.xp || 0),
                    energy: p.energy !== undefined ? p.energy : (old.energy || 100),
                    stats: p.stats || old.stats || { goals: 0, assists: 0, tackles: 0, saves: 0, yellows: 0, reds: 0 },
                    teamId: targetTeamId // <--- Aqui garante que ele apareÃ§a no seu Elenco
                };

                if (!isNew && data.overall !== old.overall) data.xp = 0;
                if (isNew) delete data.id;

                await ref.set(data, { merge: true });
                setModal(null);
                
                if (isNew) {
                    postNews(`ðŸ†• **REFORÃ‡O**\nO **${user.data.name}** anunciou a chegada de **${data.name}**!`, 'transfer');
                } else {
                    alert("Dados do jogador atualizados!");
                }
            };

            const updateStats = async (pid, newStats) => { await db.collection('players').doc(pid).update({ stats: newStats }); alert("EstatÃ­sticas Atualizadas!"); setModal(null); };
  
           // --- LÃ“GICA DE NEGOCIAÃ‡ÃƒO FIFA (SISTEMA DE TURNOS E FINANCEIRO) ---
            const sendOffer = async (target, type, value, swapIds, con, meta, old) => {
                try {
                    // LIMPEZA DE SEGURANÃ‡A: Garante que tudo seja nÃºmero puro para o banco nÃ£o recusar
                    const v = parseFloat(value) || 0;
                    const installments = parseInt(meta.installments) || 1;
                    const sellOn = parseInt(meta.sellOn) || 0;
                    const signingBonus = parseFloat(meta.signingBonus) || 0;
                    const newSalary = parseFloat(meta.newSalary) || 0;
                    const contractYears = parseInt(con) || 1;
                    
                    const isClause = type === 'COMPRA' && target.clause > 0 && v >= target.clause;
                    const actingTeamName = user.data.name;

                    // 1. FormataÃ§Ã£o dos Detalhes para o Card
                    let details = `ðŸ’° Taxa: ${fmt(v)}\n`;
                    if (type === 'TROCA') details = `ðŸ”„ Troca\n`;
                    if (installments > 1) details += `ðŸ“… Parcelas: ${installments}x\n`;
                    if (sellOn > 0) details += `ðŸ“ˆ Revenda: ${sellOn}%\n`;
                    details += `ðŸ“ Contrato: ${contractYears} anos\n`;
                    details += `ðŸ’µ SalÃ¡rio: ${fmt(newSalary)}/sem\n`;
                    if (signingBonus > 0) details += `ðŸ§¤ Luvas: ${fmt(signingBonus)}\n`;
                    details += `ðŸ‘” Papel: ${meta.role || 'ROTACAO'}`;

                    // 2. LÃ³gica de Status (Sistema de Turnos)
                    let status = 'WAITING_SELLER';
                    if (isClause) {
                        status = 'WAITING_PLAYER';
                    } else if (old && old.id) {
                        // Inverte o turno: se o dono respondeu, a bola volta para o comprador
                        status = (user.data.id === old.sellerId) ? 'WAITING_BUYER' : 'WAITING_SELLER';
                    }
                    if (old && old.status === 'WAITING_PLAYER') status = 'PLAYER_COUNTER'; 

                    const pl = {
                        playerId: target.id,
                        playerName: target.name,
                        buyerId: old?.buyerId || user.data.id, 
                        buyerName: old?.buyerName || user.data.name,
                        sellerId: target.teamId || old?.sellerId || 'FREE',
                        type,
                        value: v,
                        description: details,
                        status: status,
                        swapPlayerIds: swapIds || [],
                        meta: {
                            contract: contractYears,
                            newSalary: newSalary,
                            signingBonus: signingBonus,
                            role: meta.role || 'ROTACAO',
                            installments: installments,
                            sellOn: sellOn,
                            isClause: isClause
                        },
                        date: Date.now()
                    };

                    const b = db.batch();
                    if (old && old.id) b.delete(db.collection('offers').doc(old.id));
                    b.set(db.collection('offers').doc(), pl);
                    await b.commit();

                    let msg = `ðŸ’¼ **OFERTA**\nO **${actingTeamName}** enviou uma proposta por **${target.name}**.`;
                    if (isClause) msg = `ðŸš¨ **MULTA PAGA!**\nO **${actingTeamName}** pagou a multa de **${target.name}**!`;
                    
                    postNews(msg, 'transfer');
                    setModal(null); 
                    alert("Proposta enviada!");

                } catch (e) {
                    console.error("ERRO FIREBASE:", e);
                    alert("Erro ao enviar proposta. Verifique se nÃ£o digitou letras nos campos de preÃ§o.");
                }
            };

            const acceptOffer = async (o) => {
                const buy = teams.find(t=>t.id===o.buyerId); 
                const sel = teams.find(t=>t.id===o.sellerId); 
                const p = players.find(x=>x.id===o.playerId); 
                
                if (o.status === 'WAITING_SELLER' && user.type === 'USER' && user.data.id === o.sellerId) {
                    if (!confirm(`Aceitar vender ${p.name}? A bola passarÃ¡ para o jogador negociar o salÃ¡rio.`)) return;
                    await db.collection('offers').doc(o.id).update({ status: 'WAITING_PLAYER' });
                    alert("Aceite registrado! O jogador foi notificado.");
                    return;
                }

                let cost = parseFloat(o.value) || 0; 
                let luvas = parseFloat(o.meta?.signingBonus) || 0; 
                let totalCost = cost + luvas;

                if (buy.balance < totalCost) return alert(`Saldo insuficiente para Taxa + Luvas (${fmt(totalCost)})!`);

                const b = db.batch();
                
                if (cost > 0 && o.sellerId !== 'FREE') {
                    b.update(db.collection('teams').doc(buy.id), {balance: firebase.firestore.FieldValue.increment(-cost)});
                    b.update(db.collection('teams').doc(o.sellerId), {balance: firebase.firestore.FieldValue.increment(cost)});
                    
                    if (o.meta.installments > 1) {
                        const instVal = cost / o.meta.installments;
                        db.collection('debts').add({
                            buyerId: buy.id, buyerName: buy.name,
                            sellerId: o.sellerId, sellerName: sel?.name || 'Vendedor',
                            playerName: p.name, installmentVal: instVal,
                            weeksRemaining: o.meta.installments - 1, date: Date.now()
                        });
                    }
                }

                if (luvas > 0) {
                    b.update(db.collection('teams').doc(buy.id), {balance: firebase.firestore.FieldValue.increment(-luvas)});
                    b.update(db.collection('players').doc(p.id), {balance: firebase.firestore.FieldValue.increment(luvas)});
                }

                const historyEntry = { date: Date.now(), from: sel ? sel.name : 'Livre', to: buy.name, type: o.type, value: cost };
                
                b.update(db.collection('players').doc(p.id), {
                    teamId: buy.id,
                    status: 'NAO_A_VENDA',
                    salary: o.meta.newSalary,
                    contract: o.meta.contract,
                    role: o.meta.role,
                    history: firebase.firestore.FieldValue.arrayUnion(historyEntry)
                });

                b.delete(db.collection('offers').doc(o.id));
                await b.commit();
                
                postNews(`ðŸ¤ **OFICIAL: ${p.name.toUpperCase()} NO ${buy.name.toUpperCase()}!**`, 'transfer');
                alert("NegÃ³cio Fechado!");
            };

            const rejectOffer = async (o) => {
                if(!confirm("Recusar/Cancelar NegociaÃ§Ã£o?")) return;
                await db.collection('offers').doc(o.id).delete();
                postNews(`âŒ **NEGOCIAÃ‡ÃƒO ENCERRADA**\nAcordo por **${o.playerName}** nÃ£o foi atingido.`, 'transfer');
            };

            const renewContract = async (p) => {
                const cost = (parseFloat(p.value) || 1000000) * 0.10; 
                if(user.data.balance < cost) return alert(`Sem saldo para luvas (Custo: ${fmt(cost)})`);
                if(!confirm(`Renovar com ${p.name}?\nCusto: ${fmt(cost)}`)) return;
                const b = db.batch();
                b.update(db.collection('teams').doc(user.data.id), {balance: firebase.firestore.FieldValue.increment(-cost)});
                b.update(db.collection('players').doc(p.id), {
                    contract: (parseInt(p.contract)||0) + 1,
                    balance: firebase.firestore.FieldValue.increment(cost)
                });
                await b.commit();
                postNews(`ðŸ“ **RENOVAÃ‡ÃƒO**\n**${p.name}** renovou com o **${user.data.name}**.`, 'transfer');
                setModal(null);
            };
            
            // --- FUNÃ‡Ã•ES DE ESTATÃSTICAS E ADMIN (CORRIGIDAS) ---

            // 1. FunÃ§Ã£o para o Jornalista atualizar a tabela
            const updateTeamStats = async (tid, stats) => { 
                await db.collection('teams').doc(tid).update({ stats }); 
                alert("Tabela atualizada!"); 
            };

            // 2. FunÃ§Ã£o para lanÃ§ar SÃºmula (ATUALIZADA: CÃLCULO DA MÃ‰DIA)
            const saveMatchStats = async (player, match, xpGained) => {
                // ValidaÃ§Ã£o: NÃ£o deixa salvar sem nota
                if(match.rating === '' || match.rating === null) return alert("DÃª uma nota para a atuaÃ§Ã£o!");
                
                const b = db.batch(); 
                const pRef = db.collection('players').doc(player.id);
                
                // Soma os dados novos com os antigos
                const newStats = { 
                    goals: (player.stats?.goals||0) + match.goals, 
                    assists: (player.stats?.assists||0) + match.assists, 
                    tackles: (player.stats?.tackles||0) + match.tackles, 
                    saves: (player.stats?.saves||0) + match.saves, 
                    yellows: (player.stats?.yellows||0) + match.yellows, 
                    reds: (player.stats?.reds||0) + match.reds 
                };

                // --- CÃLCULO DA MÃ‰DIA DA IMPRENSA ---
                const currentSum = player.pressRatingSum || 0; // Soma acumulada
                const currentCount = player.pressRatingCount || 0; // Qtd de jogos
                const newSum = currentSum + parseFloat(match.rating);
                const newCount = currentCount + 1;
                const newAvg = newSum / newCount; // Nova mÃ©dia matemÃ¡tica
                
                // Salva tudo: Stats, XP Pendente e a MÃ©dia Atualizada
                b.update(pRef, { 
                    stats: newStats, 
                    pendingXP: (player.pendingXP || 0) + xpGained,
                    pressRatingSum: newSum,
                    pressRatingCount: newCount,
                    pressRatingAvg: parseFloat(newAvg.toFixed(1)) // Ex: 7.5
                });
                
                await b.commit(); 
                alert(`SÃºmula lanÃ§ada! MÃ©dia do jogador agora Ã©: ${newAvg.toFixed(1)}`); 
                setModal(null);
            };
// --- NOVA FUNÃ‡ÃƒO: AÃ‡Ã•ES DO JOGADOR (COMPLETA) ---
            // --- NOVA FUNÃ‡ÃƒO: AÃ‡Ã•ES DO JOGADOR (COMPLETA) ---
            const handlePlayerActions = async (type, p) => {
                const team = teams.find(t => t.id === p.teamId);
                
                // 1. PEDIR TRANSFERÃŠNCIA
                if (type === 'TRANSFER_REQUEST') {
                    if (!team) return alert("JÃ¡ Ã©s um Agente Livre!");
                    if (p.status === 'VENDA') return alert("JÃ¡ estÃ¡s na lista de transferÃªncias.");
                    if (!confirm(`Tens a certeza que queres pedir para sair do ${team.name}? O adepto nÃ£o vai gostar...`)) return;

                    await db.collection('players').doc(p.id).update({
                        status: 'VENDA',
                        mood: 'ðŸ˜¡'
                    });
                    postNews(`ðŸ’£ **CRISE NO ${team.name.toUpperCase()}!**\nO jogador **${p.name}** estÃ¡ insatisfeito e pediu para ser colocado na lista de transferÃªncias!`, 'rumor');
                    alert("O pedido foi feito. O teu humor piorou.");
                }

                // 2. PEDIR AUMENTO
                if (type === 'ASK_RAISE') {
                    if (!team) return alert("Precisas de um clube para pedir aumento.");
                    if (!confirm("Ir Ã  imprensa pedir um aumento salarial?")) return;

                    // Apenas lanÃ§a a notÃ­cia para pressionar o dono
                    postNews(`ðŸ’° **POLÃ‰MICA**\n**${p.name}** declara publicamente: "MereÃ§o ganhar mais no ${team.name}. Espero uma renovaÃ§Ã£o em breve."`, 'press');
                    alert("DeclaraÃ§Ã£o feita Ã  imprensa! O presidente foi notificado.");
                }

                // 3. DECLARAR FELICIDADE (NOVO)
                if (type === 'DECLARE_HAPPY') {
                    if (!team) return alert("Precisas de um clube para estar feliz!");
                    if (p.mood === 'ðŸ¤©') return alert("JÃ¡ estÃ¡s radiante com o clube!");
                    
                    if (!confirm(`Declarar amor ao ${team.name}?`)) return;

                    await db.collection('players').doc(p.id).update({
                        mood: 'ðŸ¤©'
                    });
                    postNews(`â¤ï¸ **AMOR Ã€ CAMISOLA**\n**${p.name}** declara: "Estou muito feliz no ${team.name} e quero fazer histÃ³ria aqui!"`, 'press');
                    alert("A torcida adorou a tua declaraÃ§Ã£o!");
                }
                
                // 4. MODO NEUTRO (NOVO)
                if (type === 'BECOME_NEUTRAL') {
                    if (!team) return;
                    if (p.mood === 'ðŸ˜') return alert("JÃ¡ estÃ¡s neutro.");
                    
                    await db.collection('players').doc(p.id).update({
                        mood: 'ðŸ˜'
                    });
                    alert("Decidiste focar apenas no futebol. Humor neutro.");
                }
            };
            
            // 3. FunÃ§Ã£o Mestra do Admin (COM IMPOSTO DE 3% NOS JOGADORES)
            const adminAction = async (act, data) => {
                if(act==='MARKET') { 
                    db.collection('config').doc('system').update({marketOpen: data}); 
                    postNews(data?"ðŸ“¢ JANELA ABERTA":"ðŸ”’ JANELA FECHADA", 'infra'); 
                }
                
                // VIRADA DE SEMANA
                if(act==='WEEK') { 
                    if(!confirm("âš ï¸ VIRAR SEMANA?\n\n1. Pagar SalÃ¡rios (+)\n2. Cobrar Imposto Jogador (3%)\n3. Recuperar Energia (100%)\n4. Empresas e XP")) return;
                    
                    setLoading(true); 
                    const b = db.batch(); 
                    
                    // 1. Jogadores: SalÃ¡rio (+) e Imposto de Fortuna (-)
                    players.forEach(p => { 
                        if(p.teamId) { 
                            if (teams.some(t => t.id === p.teamId)) {
                                const currentBal = parseFloat(p.balance) || 0;
                                const salary = parseFloat(p.salary) || 0;
                                
                                // CÃLCULO DO IMPOSTO DE 3% (NOVIDADE)
                                const tax = currentBal * 0.03; 
                                const finalBalance = (currentBal + salary) - tax;

                                // XP (Acumula para a temporada)
                                const xpTotal = (p.xp || 0) + (p.pendingXP || 0);

                                b.update(db.collection('players').doc(p.id), { 
                                    balance: finalBalance,
                                    energy: 100,
                                    xp: xpTotal,
                                    pendingXP: 0
                                }); 
                            }
                        }
                    });

                    // 2. Times: Pagam salÃ¡rios e Recebem PatrocÃ­nio
                    teams.forEach(t => { 
                        const currentBal = parseFloat(t.balance) || 0;
                        const wages = players.filter(p=>p.teamId===t.id).reduce((a,p)=>a+(parseFloat(p.salary)||0),0); 
                        const income = sps.filter(s => s.teamId === t.id && s.status === 'ACTIVE').reduce((a,s) => a + parseFloat(s.value), 0); 
                        
                        b.update(db.collection('teams').doc(t.id), {
                            balance: currentBal + income - wages
                        }); 
                    });

                    // 3. Empresas: Imposto Fixo (CorreÃ§Ã£o aplicada)
                    companies.forEach(c => { 
                        if(c.status === 'ACTIVE') { 
                            const currentBal = parseFloat(c.balance) || 0;
                            // Se nÃ£o tiver tipo, assume COMERCIO (50k) para nÃ£o bugar
                            const type = c.companyType || 'COMERCIO'; 
                            const tax = (COMPANY_TYPES[type] || {}).tax || 50000; 
                            
                            b.update(db.collection('companies').doc(c.id), { 
                                balance: currentBal - tax 
                            }); 
                        } 
                    });
                    
                    // 4. DÃ­vidas (ProteÃ§Ã£o contra times excluÃ­dos)
                    const ds = await db.collection('debts').get(); 
                    ds.docs.forEach(doc => { 
                        const d = doc.data(); 
                        const buyerExists = teams.some(t => t.id === d.buyerId);
                        const sellerExists = teams.some(t => t.id === d.sellerId);

                        if (!buyerExists || !sellerExists) {
                            b.delete(doc.ref); 
                        } else if (d.weeksRemaining > 0) { 
                            b.update(db.collection('teams').doc(d.buyerId), {balance: firebase.firestore.FieldValue.increment(-d.installmentVal)}); 
                            b.update(db.collection('teams').doc(d.sellerId), {balance: firebase.firestore.FieldValue.increment(d.installmentVal)}); 
                            
                            if (d.weeksRemaining - 1 === 0) { 
                                b.delete(doc.ref); 
                                postNews(`âœ… **DÃVIDA QUITADA**\n${d.buyerName} terminou de pagar ${d.playerName}.`, 'money'); 
                            } else { 
                                b.update(doc.ref, {weeksRemaining: d.weeksRemaining - 1}); 
                                postNews(`ðŸ’³ **PARCELA PAGA**\n${d.buyerName} pagou a parcela (${d.weeksRemaining}x) de ${d.playerName}.`, 'money-minus'); 
                            } 
                        } 
                    });
                    
                    try {
                        await b.commit(); 
                        alert("Semana processada! Impostos de 3% cobrados dos jogadores."); 
                    } catch (error) {
                        alert("Erro: " + error.message);
                    }
                    setLoading(false); 
                }
                
                // VIRADA DE TEMPORADA (Igual ao anterior)
                if(act==='SEASON') { 
                    if(!confirm("âš ï¸ VIRAR TEMPORADA?\n\n1. Evoluir NÃ­veis\n2. Envelhecer Contratos")) return; 
                    setLoading(true); 
                    const b = db.batch(); 
                    players.forEach(p => { 
                        let u={}; 
                        const currentLvl = p.overall || 45;
                        const currentXP = p.xp || 0;
                        const res = calcNewLevel(currentLvl, currentXP, 0); 
                        if (res.lvl !== currentLvl) { u.overall = res.lvl; u.xp = res.xp; }
                        let nc=(p.contract||0)-1; if(nc<0)nc=0; u.contract=nc; 
                        if((p.contract<=1||p.contract===0)&&p.preContract){ if (teams.some(t => t.id === p.preContract.teamId)) { u.teamId=p.preContract.teamId; u.contract=1; u.status='NAO_A_VENDA'; u.preContract=firebase.firestore.FieldValue.delete(); } } 
                        b.update(db.collection('players').doc(p.id), u); 
                    }); 
                    try { await b.commit(); alert("Temporada virada!"); } catch (e) { alert("Erro: "+e.message); }
                    setLoading(false); 
                    postNews("ðŸŒž **NOVA TEMPORADA**", 'season'); 
                }
            };
            // --- RENDER ---
            if(loading) return <div style={{display:'grid', placeItems:'center', height:'100vh'}}>Carregando...</div>;
            // CORREÃ‡ÃƒO: Adicionei "players={players}" logo depois de "teams={teams}"
            if(!user) return <LoginScreen teams={teams} players={players} papers={papers} journalists={journalists} companies={companies} onLogin={login} onCreateTeam={createTeam} onCreatePaper={createNewspaper} onCreateJourno={createJournalist} onCreateCompany={createCompany} onAdmin={loginAdmin} onVisitor={()=>{setUser({type:'VISITOR'}); setScreen('RANKING');}} />;

            return (
                <div>
                    <div className="header">
                        <div style={{display:'flex', alignItems:'center', gap:10}}>
                            {user.type==='USER' && user.data.logo && <img src={user.data.logo} style={{width:40, height:40, borderRadius:'50%', border:'2px solid var(--primary)', objectFit:'cover'}} />}
                            <div>
                                <div style={{fontWeight:'900', fontSize:16}}>{user.type==='USER' ? user.data.name : user.data?.name || user.type}</div>
                                <div className="dev-credits" style={{textAlign:'left', margin:0}}>Desenvolvido por: Nathan Reis |  v1.93</div>
                            </div>
                        </div>
                        <div style={{display:'flex', gap:15, alignItems:'center'}}>
                            {user.type==='USER' && <div onClick={()=>setScreen('OFFERS')}><i className="fas fa-bell" style={{color: offers.length ? 'var(--warning)' : '#555'}}></i>{offers.length > 0 && <span style={{position:'absolute', top:-5, right:-5, background:'red', borderRadius:'50%', width:8, height:8}} className="pulse"></span>}</div>}
                            {(user.type==='USER' || user.type==='COMPANY') && <div style={{color:'var(--primary)', fontWeight:'bold'}}>{fmt(user.data.balance)}</div>}
                            {user.type==='USER' && <i className="fas fa-cog" onClick={()=>setModal({type:'SETTINGS', data:user.data})}></i>}
                            <i className="fas fa-sign-out-alt" onClick={()=>window.location.reload()}></i>
                        </div>
                    </div>

                    <div className="container">
                       {screen === 'HOME' && user.type === 'ADMIN' && 
                            <AdminPanel 
                                teams={teams} 
                                papers={papers} 
                                journalists={journalists} 
                                companies={companies} 
                                reqs={reqs} 
                                config={conf} 
                                onAct={adminAction} 
                                fixPlayersData={fixPlayersData}
                                onPost={(t,b,tp)=>postNews(`ðŸ“¢ **${t}**\n${b}`, tp)} 
                                onApprove={async(r)=>{/*Fin logic*/}} 
                                onReject={(id)=>db.collection('financeRequests').doc(id).delete()} 
                                onEditT={(t)=>{setAdminTeam(t); setScreen('ADMIN_TEAM');}} 
                                onApproveTeam={approveTeam} 
                                onUpdateBal={updateBalance} 
                                onDeleteTeam={deleteTeam} 
                                onApprovePaper={async(id)=>{db.collection('newspapers').doc(id).update({status:'ACTIVE'});}} 
                                onDeletePaper={deletePaper} 
                                onDeleteJourno={deleteJournalist} 
                                onRejectPaper={(id)=>db.collection('newspapers').doc(id).delete()} 
                                onConfig={(t)=>setModal({type:'SETTINGS', data:t})} 
                                
                                onApproveComp={async(id)=>{await db.collection('companies').doc(id).update({status:'ACTIVE'}); alert("Empresa Aprovada!");}}
                                onDeleteComp={async(id)=>{if(confirm("Excluir Empresa?")) await db.collection('companies').doc(id).delete();}}
                                onUpdateCompBal={async(id, val)=>{ await db.collection('companies').doc(id).update({balance: parseFloat(val)}); alert("Saldo Alterado!"); }}
                            />
                        }
                          
                        {screen === 'HOME' && user.type === 'USER' && <TeamDashboard team={user.data} players={players.filter(p=>p.teamId===user.data.id)} isVisitor={false} onEdit={(p)=>setModal({type:'PLAYER', data:p})} onAdd={()=>setModal({type:'PLAYER'})} />}
                        {screen === 'HOME' && user.type === 'VISITOR' && <VisitorDashboard players={players} teams={teams} />}
{screen === 'PRESS_DASH' && (user.type==='PRESS' || user.type==='PRESS_WORKER') && (
                            <div>
                                <h3>Painel de Imprensa ({user.data.name})</h3>
                                <div className="card">
                                    <button className="btn btn-blue" onClick={()=>setModal({type:'POST_NEWS'})}>ESCREVER NOTÃCIA</button>
                                    
                                    {/* BotÃ£o Novo 1: SÃºmula com XP */}
                                    <button className="btn btn-purple" onClick={()=>setModal({type:'MATCH_PERFORMANCE'})}>LANÃ‡AR SÃšMULA (XP)</button>
                                    
                                    {/* BotÃ£o Novo 2: Editar Tabela */}
                                    <button className="btn btn-gold" onClick={()=>setModal({type:'TEAM_TABLE'})}>EDITAR TABELA</button>
                                </div>

                                {/* Lista de Jornalistas Pendentes (SÃ³ o dono vÃª) */}
                                {user.type==='PRESS' && journalists.filter(j=>j.newspaperId===user.data.id && j.status==='PENDING').map(j=>(
                                    <div key={j.id} className="card">
                                        {j.name}
                                        <button className="btn btn-green" onClick={()=>db.collection('journalists').doc(j.id).update({status:'ACTIVE'})}>APROVAR</button>
                                    </div>
                                ))}
                            </div>
                        )}                        {screen === 'ADMIN_TEAM' && adminTeam && <div><button className="btn" style={{background:'#333', marginBottom:10}} onClick={()=>{setAdminTeam(null); setScreen('HOME');}}>â¬… VOLTAR</button><h3 style={{color:'var(--purple)'}}>Editando: {adminTeam.name}</h3><TeamDashboard team={adminTeam} players={players.filter(p=>p.teamId===adminTeam.id)} isVisitor={false} onEdit={(p)=>setModal({type:'PLAYER', data:p})} onAdd={()=>setModal({type:'PLAYER'})} /></div>}
                        {screen === 'MARKET' && <Market me={user.data?.id} teams={teams} players={players} open={conf.marketOpen} isVis={user.type==='VISITOR'} onNeg={(p)=>setModal({type:'OFFER', data:p})} onPayClause={async(p)=>{/*Clause logic*/}} onPre={async(p)=>{/*Pre logic*/}} />}
                        {/* TELA: SHOPPING GLOBAL */}
                        {screen === 'SHOPPING' && <ShoppingScreen products={products} companies={companies} userTeam={user.type==='USER' || user.type==='PLAYER'} onBuy={buyProduct} />}
                        
                        {/* TELA: PATROCÃNIOS (Apenas para Times) */}
                        {screen === 'SPONSORSHIPS' && user.type === 'USER' && (
                            <div>
                                <h3>Buscar PatrocÃ­nio</h3>
                                <p style={{fontSize:11, color:'#aaa'}}>Envie propostas semanais para as empresas.</p>
                                {companies.filter(c=>c.status==='ACTIVE').map(c => (
                                    <div key={c.id} className="card">
                                        <b>{c.name}</b> <small>({(COMPANY_TYPES[c.companyType] || {}).label})</small>
                                        <div style={{display:'flex', gap:5, marginTop:5}}>
                                            <button className="btn btn-purple" onClick={()=>{const v=prompt("Valor Semanal pedido (â‚£):"); if(v) requestSponsorship(c.id, v);}}>PEDIR PATROCÃNIO</button>
                                        </div>
                                    </div>
                                ))}
                                
                                <hr style={{borderColor:'#333'}}/>
                                <h4>Meus Contratos</h4>
                                {sps.filter(s=>s.teamId===user.data.id).length === 0 && <p style={{color:'#666'}}>Sem contratos.</p>}
                                {sps.filter(s=>s.teamId===user.data.id).map(s => (
                                    <div key={s.id} className="card" style={{borderLeft:`4px solid ${s.status==='ACTIVE'?'var(--primary)':'#666'}`}}>
                                        <b>{s.companyName}</b><br/>
                                        Valor: {fmt(s.value)}/sem <small>({s.status === 'PENDING' ? 'Aguardando' : 'Ativo'})</small>
                                        {s.status==='ACTIVE' && <button className="btn btn-red" style={{width:'auto', marginTop:5}} onClick={()=>{if(confirm("Encerrar contrato de patrocÃ­nio?")) db.collection('sponsorships').doc(s.id).delete();}}>ENCERRAR</button>}
                                    </div>
                                ))}
                            </div>
                        )}
                        {screen === 'RANKING' && <Ranking teams={teams} players={players} />}
                        {screen === 'NEWS' && <div><h3>NotÃ­cias</h3>{news.map(n=><div key={n.id} className={`news-card news-${n.type}`}>{n.text}<br/><small style={{color:'#666'}}>{new Date(n.date).toLocaleString()}</small></div>)}</div>}
                        {screen === 'OFFERS' && <OffersScreen offers={offers} onAccept={acceptOffer} onReject={rejectOffer} onCounter={(o)=>setModal({type:'OFFER', data:{...players.find(p=>p.id===o.playerId), oldOffer:o}})} />}
                        
                        {/* ETAPA 1: Painel da Empresa (ATUALIZADO COM HISTÃ“RICO) */}
                       {/* ETAPA 3 e 4: Painel da Empresa (Com HistÃ³rico e PatrocÃ­nios) */}
                        {/* PAINEL DA EMPRESA (CORRIGIDO: V3) */}
                        {(screen === 'COMPANY_DASH' || screen === 'COMPANY_HOME') && user.type === 'COMPANY' && 
                            <CompanyDashboard 
                                company={user.data} 
                                products={products.filter(p => p.companyId === user.data.id)} 
                                sps={sps.filter(s => s.companyId === user.data.id)}
                                sales={sales || []} /* AQUI: O "|| []" impede a tela preta se sales falhar */
                                teams={teams}
                                onSaveProd={saveProduct} 
                                onDeleteProd={async(id)=>{if(confirm("Excluir produto?")) await db.collection('products').doc(id).delete();}}
                                onProcessSpons={processSponsorship} 
                            />
                        }
                        {screen === 'PLAYER_DASH' && user.type === 'PLAYER' && 
                            <PlayerDashboard 
                                player={players.find(p=>p.id===user.data.id) || user.data} 
                                team={teams.find(t=>t.id===user.data.teamId)} 
                                sales={sales || []} 
                                offers={offers} // <--- NOVO
                                onNeg={(o)=>setModal({type:'PLAYER_NEGOTIATION', data:o})} // <--- NOVO
                                onAction={handlePlayerActions}
                                onUpdatePassword={async(newP)=>{ await db.collection('players').doc(user.data.id).update({password: newP}); alert("Senha alterada!"); }} 
                            />
                        }
                    </div>

                    <div className="bottom-nav">
                        {/* AQUI ESTAVA O PROBLEMA: Atualizei a lÃ³gica do clique para incluir o PLAYER */}
                        <div 
                            className={`nav-item ${['HOME','COMPANY_HOME','COMPANY_DASH','PLAYER_DASH'].includes(screen)?'active':''}`} 
                            onClick={() => {
                                if(user.type.includes('PRESS')) setScreen('PRESS_DASH');
                                else if(user.type === 'COMPANY') setScreen('COMPANY_HOME');
                                else if(user.type === 'PLAYER') setScreen('PLAYER_DASH'); // <--- AGORA ELE SABE PARA ONDE IR!
                                else setScreen('HOME');
                            }}
                        >
                            <i className="fas fa-home"></i>INÃCIO
                        </div>

                        {/* BotÃ£o Mercado (esconde para empresa e jogador) */}
                        {user.type!=='COMPANY' && user.type!=='PLAYER' && <div className={`nav-item ${screen==='MARKET'?'active':''}`} onClick={()=>setScreen('MARKET')}><i className="fas fa-globe"></i>MERCADO</div>}
                        
                        {/* BotÃ£o Shopping (esconde para empresa e jogador) - Se quiser que jogador compre, tire o && user.type!=='PLAYER' */}
                        {user.type!=='COMPANY' && <div className={`nav-item ${screen==='SHOPPING'?'active':''}`} onClick={()=>setScreen('SHOPPING')}><i className="fas fa-shopping-bag"></i>SHOP</div>}
                        
                        {/* BotÃ£o PatrocÃ­nio (SÃ³ Times) */}
                        {user.type==='USER' && <div className={`nav-item ${screen==='SPONSORSHIPS'?'active':''}`} onClick={()=>setScreen('SPONSORSHIPS')}><i className="fas fa-handshake"></i>PATRO</div>}
                        
                        {/* Ranking (todos menos empresa veem) */}
                        {user.type!=='COMPANY' && <div className={`nav-item ${screen==='RANKING'?'active':''}`} onClick={()=>setScreen('RANKING')}><i className="fas fa-trophy"></i>RANK</div>}
                        
                        <div className={`nav-item ${screen==='NEWS'?'active':''}`} onClick={()=>{setScreen('NEWS'); setNewNews(false); localStorage.setItem('lastRead', Date.now());}}><i className="fas fa-newspaper"></i>NEWS</div>
                    </div>

                    {modal && <div className="modal-overlay" onClick={(e)=>e.target===e.currentTarget && setModal(null)}>
                        <div className="modal-content">
                            {modal.type==='PLAYER' && <PlayerForm initial={modal.data} onSave={savePlayer} onDelete={async(id)=>{db.collection('players').doc(id).delete(); setModal(null);}} isAdmin={user.type==='ADMIN'} teams={teams} onRenew={renewContract} isOwner={user.type==='USER' && modal.data?.teamId===user.data?.id} />}
                            {modal.type==='OFFER' && <OfferForm target={modal.data} myPlayers={players.filter(p=>p.teamId===user.data.id)} onSend={sendOffer} />}
                            {modal.type==='SETTINGS' && <SettingsForm team={modal.data || user.data} isAdmin={user.type==='ADMIN'} onUp={(d)=>{const tid=(modal.data?.id)||user.data.id; db.collection('teams').doc(tid).update(d); setModal(null);}} onUpgrade={()=>{/*Upgrade logic*/}} onReq={(t,a,d)=>{db.collection('financeRequests').add({teamId:user.data.id, teamName:user.data.name, type:t, amount:parseFloat(a), details:d, status:'PENDING'}); setModal(null); alert("Enviado!");}} onWithdraw={withdrawMoney} />}
                            {modal.type==='MATCH_PERFORMANCE' && <MatchPerformanceForm players={players} teams={teams} onSaveStats={saveMatchStats} />}
                            {modal.type==='TEAM_TABLE' && <TeamStandingsEditor teams={teams} onUpdateTeamStats={updateTeamStats} />}
                            {modal.type==='POST_NEWS' && <div><h3>Nova NotÃ­cia</h3><input className="input-field" placeholder="Manchete / Texto" id="news-body" /><button className="btn btn-blue" onClick={()=>{postNews(`ðŸ“° **${user.data.name}:**\n${document.getElementById('news-body').value}`, 'press'); setModal(null);}}>PUBLICAR</button></div>}
                            {modal.type==='STATS_SEARCH' && <StatsEditor players={players} teams={teams} onSave={updateStats} />}
                            
                            {/* --- AQUI ESTÃ A PARTE NOVA DA NEGOCIAÃ‡ÃƒO --- */}
                            {modal.type==='PLAYER_NEGOTIATION' && 
                                <PlayerNegotiationModal 
                                    offer={modal.data} 
                                    onClose={()=>setModal(null)}
                                    onAccept={acceptOffer} 
                                    onReject={rejectOffer}
                                    onCounter={sendOffer} 
                                />
                            }
                        </div>
                    </div>}
                </div> 
            ); 
        }

        // --- COMPONENTES AUXILIARES ---

        const PlayerNegotiationModal = ({ offer, onClose, onCounter, onAccept, onReject }) => {
            const [form, setForm] = useState({
                newSalary: offer.meta.newSalary,
                signingBonus: offer.meta.signingBonus,
                contract: offer.meta.contract,
                role: offer.meta.role
            });

            return (
                <div className="modal-bg" style={{zIndex:9999}}><div className="modal-content" style={{border:'2px solid gold'}}>
                    <h3>ðŸ“‹ Proposta do {offer.buyerName}</h3>
                    <div style={{background:'#222', padding:10, borderRadius:8, marginBottom:15}}>
                        <label>SalÃ¡rio Semanal</label>
                        <input className="input-field" type="number" value={form.newSalary} onChange={e=>setForm({...form, newSalary:e.target.value})} />
                        <label>Luvas (PrÃªmio)</label>
                        <input className="input-field" type="number" value={form.signingBonus} onChange={e=>setForm({...form, signingBonus:e.target.value})} />
                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10}}>
                            <div><label>Anos</label><input className="input-field" type="number" value={form.contract} onChange={e=>setForm({...form, contract:e.target.value})} /></div>
                            <div><label>Papel</label>
                                <select className="input-field" value={form.role} onChange={e=>setForm({...form, role:e.target.value})}>
                                    <option value="CRUCIAL">â­ Crucial</option>
                                    <option value="TITULAR">âœ… Titular</option>
                                    <option value="ROTACAO">ðŸ”„ RotaÃ§Ã£o</option>
                                    <option value="RESERVA">Reserva</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div style={{display:'flex', gap:5}}>
                        <button className="btn btn-green" onClick={()=>onAccept({...offer, meta: {...offer.meta, ...form}})}>âœ… ACEITAR</button>
                        <button className="btn btn-blue" onClick={()=>onCounter(offer, offer.type, offer.value, [], 0, form, offer)}>ðŸ’¬ NEGOCIAR</button>
                    </div>
                    <button className="btn btn-red" style={{marginTop:5}} onClick={()=>onReject(offer)}>âŒ RECUSAR</button>
                    <button className="btn btn-ghost" style={{marginTop:5}} onClick={onClose}>FECHAR</button>
                </div></div>
            );
        };
        
        const LoginScreen = ({ teams, players, papers, journalists, companies, onLogin, onCreateTeam, onCreatePaper, onCreateJourno, onCreateCompany, onAdmin, onVisitor }) => {
            const [tab, setTab] = useState('LOGIN'); 
            const [subTab, setSubTab] = useState('TEAM'); 
            const [f, setF] = useState({n:'', b:'10000000', s:'A', p:''}); 
            const [fc, setFC] = useState({n:'', owner:'', p:'', type:'COMERCIO'});
            const [sel, setSel] = useState(null); 
            const [selPaper, setSelPaper] = useState(null); 
            const [selTeamForPlayer, setSelTeamForPlayer] = useState(null); 
            const [lp, setLp] = useState('');

            const handleUpload = (e) => { const file=e.target.files[0]; const reader=new FileReader(); reader.onloadend=()=>setF({...f, l:reader.result}); if(file) reader.readAsDataURL(file); };
            
            // VariÃ¡vel auxiliar para pegar os dados do tipo selecionado
            const selectedTypeInfo = COMPANY_TYPES[fc.type] || {};

            return (
                <div style={{minHeight:'100vh', padding:20, textAlign:'center'}}>
                    <h1 style={{color:'var(--primary)'}}>Gerenciador de Times<br/><span style={{color:'white'}}>de Mato Real</span></h1>
                    <div className="dev-credits">Desenvolvido por: Nathan Reis | v1.93(Company Fix)</div>
                    
                    <div className="login-tabs">
                        <div className={`tab ${tab==='LOGIN'?'active':''}`} onClick={()=>setTab('LOGIN')}>ENTRAR</div>
                        <div className={`tab ${tab==='CREATE'?'active':''}`} onClick={()=>setTab('CREATE')}>CRIAR TIME</div>
                        <div className={`tab ${tab==='PRESS'?'active':''}`} onClick={()=>setTab('PRESS')}>IMPRENSA</div>
                        <div className={`tab ${tab==='COMPANY'?'active':''}`} onClick={()=>setTab('COMPANY')}>EMPRESAS</div>
                    </div>

                    {tab==='LOGIN' && <div>
                        <div style={{marginBottom:15, display:'flex', gap:10, justifyContent:'center'}}>
                            <button className={`btn ${subTab==='TEAM'?'btn-green':'btn-ghost'}`} style={{width:'auto'}} onClick={()=>setSubTab('TEAM')}>TIMES</button>
                            <button className={`btn ${subTab==='PLAYER'?'btn-blue':'btn-ghost'}`} style={{width:'auto'}} onClick={()=>{setSubTab('PLAYER'); setSelTeamForPlayer(null);}}>JOGADORES</button>
                            <button className={`btn ${subTab==='COMPANY'?'btn-purple':'btn-ghost'}`} style={{width:'auto'}} onClick={()=>setSubTab('COMPANY')}>EMPRESAS</button>
                        </div>

                        {subTab==='TEAM' && (teams||[]).filter(t=>t.status!=='PENDING').map(t=><div key={t.id} className="card" onClick={()=>setSel({...t, type:'TEAM'})} style={{display:'flex', alignItems:'center', gap:10, cursor:'pointer'}}>{t.logo ? <img src={t.logo} className="team-logo" style={{width:40, height:40, objectFit:'cover'}}/> : <div className="team-logo"></div>}<div><b>{t.name}</b><br/><small style={{color:'#666'}}>SÃ©rie {t.serie}</small></div></div>)}
                        
                        {subTab==='PLAYER' && !selTeamForPlayer && <div>
                            <p style={{color:'#aaa'}}>Selecione o clube onde vocÃª joga:</p>
                            {(teams||[]).filter(t=>t.status!=='PENDING').map(t=>(<div key={t.id} className="card" onClick={()=>setSelTeamForPlayer(t)} style={{cursor:'pointer'}}><b>{t.name}</b></div>))}
                        </div>}

                        {subTab==='PLAYER' && selTeamForPlayer && <div>
                            <button className="btn" style={{marginBottom:10, background:'#333'}} onClick={()=>setSelTeamForPlayer(null)}>â¬… VOLTAR PARA TIMES</button>
                            <h4 style={{color:'var(--secondary)'}}>Elenco do {selTeamForPlayer.name}:</h4>
                            {(players||[]).filter(p => p.teamId === selTeamForPlayer.id).length === 0 && <p style={{color:'#666'}}>Nenhum jogador encontrado neste time.</p>}
                            {(players||[]).filter(p => p.teamId === selTeamForPlayer.id).map(p => (<div key={p.id} className="card" onClick={()=>setSel({...p, type:'PLAYER'})} style={{cursor:'pointer', borderLeft:'4px solid var(--secondary)'}}>ðŸ‘Ÿ <b>{p.name}</b></div>))}
                        </div>}

                        {subTab==='COMPANY' && (companies||[]).filter(c=>c.status!=='PENDING').map(c=><div key={c.id} className="card" onClick={()=>setSel({...c, type:'COMPANY'})} style={{cursor:'pointer', borderLeft:'4px solid var(--purple)'}}>ðŸ¢ <b>{c.name}</b><br/><small>{(c.companyType)}</small></div>)}
                        
                        <div style={{marginTop:20}}><button className="btn btn-blue" onClick={onVisitor}>ENTRAR COMO VISITANTE</button><button className="btn btn-ghost" onClick={()=> {if(prompt("Senha:")==='2503') onAdmin()}}>ADMIN</button></div>
                    </div>}

                    {tab==='CREATE' && <div><input type="file" className="file-input" onChange={handleUpload} /><input className="input-field" placeholder="Nome" value={f.n} onChange={e=>setF({...f, n:e.target.value})} /><input className="input-field" type="number" placeholder="Saldo" value={f.b} onChange={e=>setF({...f, b:e.target.value})} /><select className="input-field" value={f.s} onChange={e=>setF({...f, s:e.target.value})}>{['A','B','C','D'].map(s=><option key={s} value={s}>SÃ©rie {s}</option>)}</select><input className="input-field" type="number" placeholder="Senha" value={f.p} onChange={e=>setF({...f, p:e.target.value})} /><button className="btn btn-green" onClick={()=>onCreateTeam(f.n, f.b, f.s, f.p, f.l)}>CRIAR</button></div>}
                    
                    {tab==='PRESS' && <div><div style={{display:'flex', gap:10, marginBottom:10}}><button className="btn btn-ghost" onClick={()=>setSubTab('LOGIN_P')}>LOGIN</button><button className="btn btn-ghost" onClick={()=>setSubTab('NEW_PAPER')}>CRIAR JORNAL</button><button className="btn btn-ghost" onClick={()=>setSubTab('NEW_JOURNO')}>SOU JORNALISTA</button></div>
                        {subTab==='LOGIN_P' && !selPaper && <div><h4>Selecione o Jornal</h4>{(papers||[]).filter(p=>p.status==='ACTIVE').map(p=><div key={p.id} className="card" onClick={()=>setSelPaper(p)}>ðŸ“° {p.name}</div>)}</div>}
                        {subTab==='LOGIN_P' && selPaper && <div><button className="btn" style={{marginBottom:10}} onClick={()=>setSelPaper(null)}>â¬… VOLTAR</button><h4>{selPaper.name} - Jornalistas</h4><div className="card" onClick={()=>setSel({...selPaper, type:'PAPER'})} style={{border:'1px solid var(--primary)'}}>ðŸ‘‘ {selPaper.ownerName} (Dono)</div>{(journalists||[]).filter(j=>j.newspaperId===selPaper.id && j.status==='ACTIVE').map(j=><div key={j.id} className="card" onClick={()=>setSel({...j, type:'JOURNALIST'})}>âœ’ï¸ {j.name}</div>)}</div>}
                        {subTab==='NEW_PAPER' && <div><input className="input-field" placeholder="Nome do Jornal" id="pn" /><input className="input-field" placeholder="Seu Nome (Dono)" id="po" /><input className="input-field" type="number" placeholder="Senha" id="pp" /><button className="btn btn-green" onClick={()=>onCreatePaper(document.getElementById('pn').value, document.getElementById('pp').value, document.getElementById('po').value)}>SOLICITAR CRIAÃ‡ÃƒO</button></div>}
                        {subTab==='NEW_JOURNO' && <div><input className="input-field" placeholder="Seu Nome" id="jn" /><select className="input-field" id="jp_id"><option value="">Selecione o Jornal</option>{(papers||[]).filter(p=>p.status==='ACTIVE').map(p=><option key={p.id} value={p.id}>{p.name}</option>)}</select><input className="input-field" type="number" placeholder="Senha" id="jp" /><button className="btn btn-green" onClick={()=>onCreateJourno(document.getElementById('jn').value, document.getElementById('jp').value, document.getElementById('jp_id').value)}>SOLICITAR EMPREGO</button></div>}</div>}
                    
                    {tab==='COMPANY' && <div>
                        <h3 style={{color:'var(--purple)'}}>Abrir Empresa</h3>
                        <input className="input-field" placeholder="Nome da Empresa" value={fc.n} onChange={e=>setFC({...fc, n:e.target.value})} />
                        <input className="input-field" placeholder="Nome do Dono" value={fc.owner} onChange={e=>setFC({...fc, owner:e.target.value})} />
                        
                        <label style={{textAlign:'left', display:'block', color:'#aaa', fontSize:12}}>Porte da Empresa</label>
                        <select className="input-field" value={fc.type} onChange={e=>setFC({...fc, type:e.target.value})}>
                            <option value="COMERCIO">ComÃ©rcio Local</option>
                            <option value="MEDIA">MÃ©dia Empresa</option>
                            <option value="GRANDE">Grande Empresa</option>
                        </select>

                        {/* NOVO: BLOCO DE INFORMAÃ‡Ã•ES FINANCEIRAS */}
                        <div style={{background: 'rgba(255, 255, 255, 0.05)', padding: 10, borderRadius: 5, marginBottom: 10, textAlign: 'left', border: '1px solid #444'}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: 5}}>
                                <span>ðŸ’° Capital Inicial:</span>
                                <span style={{color: 'var(--primary)', fontWeight: 'bold'}}>{fmt(selectedTypeInfo.start)}</span>
                            </div>
                            <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                <span>ðŸ’¸ Imposto Semanal:</span>
                                <span style={{color: 'var(--danger)', fontWeight: 'bold'}}>{fmt(selectedTypeInfo.tax)}</span>
                            </div>
                            <p style={{fontSize: 11, color: '#888', marginTop: 8, fontStyle: 'italic', borderTop:'1px solid #333', paddingTop:5}}>
                                "{selectedTypeInfo.desc}"
                            </p>
                        </div>
                        {/* -------------------------------------- */}

                        <input className="input-field" type="number" placeholder="Senha de Acesso" value={fc.p} onChange={e=>setFC({...fc, p:e.target.value})} />
                        <button className="btn btn-purple" onClick={()=>onCreateCompany(fc)}>SOLICITAR ABERTURA</button>
                    </div>}
                    
                    {sel && <div className="modal-overlay"><div className="modal-content"><h3>{sel.name}</h3><input className="input-field" type="password" placeholder="Senha" value={lp} onChange={e=>setLp(e.target.value)} /><button className="btn btn-green" onClick={()=>onLogin(sel.id, lp, sel.type)}>ENTRAR</button><button className="btn" onClick={()=>setSel(null)}>CANCELAR</button></div></div>}
                </div>
            );
        };

        const VisitorDashboard = ({ players, teams }) => {
            const topScorer = players.sort((a,b)=>(b.stats?.goals||0)-(a.stats?.goals||0))[0];
            const topAssist = players.sort((a,b)=>(b.stats?.assists||0)-(a.stats?.assists||0))[0];
            return (
                <div>
                    <div className="highlight-card"><h2 style={{margin:0, color:'var(--primary)'}}>Jornal do Dia</h2><small>Resumo da Temporada</small><div style={{marginTop:15, textAlign:'left'}}><div style={{marginBottom:10}}><span style={{color:'#aaa', fontSize:10, textTransform:'uppercase'}}>Artilheiro</span><div style={{fontWeight:'bold', fontSize:16}}>âš½ {topScorer?.name || 'NinguÃ©m'} <span style={{color:'var(--primary)'}}>{topScorer?.stats?.goals||0} Gols</span></div></div><div><span style={{color:'#aaa', fontSize:10, textTransform:'uppercase'}}>Rei das AssistÃªncias</span><div style={{fontWeight:'bold', fontSize:16}}>ðŸ‘Ÿ {topAssist?.name || 'NinguÃ©m'} <span style={{color:'var(--secondary)'}}>{topAssist?.stats?.assists||0} Assis</span></div></div></div></div>
                    <div style={{textAlign:'center', color:'#666'}}>Use o menu abaixo para navegar.</div>
                </div>
            );
        };
        // --- NOVO COMPONENTE: PAINEL DA EMPRESA ---
       // Painel da Empresa (Atualizado com PatrocÃ­nios)
       const CompanyDashboard = ({ company, products, sps, sales, teams, onSaveProd, onDeleteProd, onProcessSpons }) => {
            const [tab, setTab] = useState('PRODS'); 
            const [editP, setEditP] = useState(null); 
            
            return (
                <div>
                    <div style={{display:'flex', gap:10, marginBottom:15}}>
                        <button className={`btn ${tab==='PRODS'?'btn-purple':'btn-ghost'}`} onClick={()=>setTab('PRODS')}>PRODUTOS</button>
                        <button className={`btn ${tab==='FIN'?'btn-purple':'btn-ghost'}`} onClick={()=>setTab('FIN')}>FINANÃ‡AS</button>
                    </div>
                    
                    {tab==='PRODS' && <div>
                        {/* AQUI: Adicionei cat:'CHUTEIRA' no estado inicial */}
                        <button className="btn btn-green" onClick={()=>setEditP({name:'', price:'', img:'', desc:'', cat:'CHUTEIRA'})}>+ NOVO PRODUTO</button>
                        
                        {products.map(p => (
                            <div key={p.id} className="card" style={{display:'flex', gap:10, textAlign:'left'}}>
                                <img src={p.img || 'https://via.placeholder.com/100'} style={{width:80, height:80, objectFit:'cover', borderRadius:6}} />
                                <div style={{flex:1}}>
                                    <span style={{fontSize:10, background:'#333', padding:'2px 6px', borderRadius:4, color:'#aaa'}}>{PROD_CATS[p.cat] || p.cat}</span>
                                    <div style={{fontWeight:'bold', marginTop:2}}>{p.name}</div>
                                    <span style={{color:'var(--primary)', fontWeight:'bold'}}>{fmt(p.price)}</span>
                                    <p style={{fontSize:11, color:'#aaa', margin:'5px 0'}}>{p.desc}</p>
                                </div>
                                <div style={{display:'flex', flexDirection:'column', gap:5}}>
                                    <button className="btn btn-blue" style={{width:'auto', padding:'5px 10px'}} onClick={()=>setEditP(p)}>âœï¸</button>
                                    <button className="btn btn-red" style={{width:'auto', padding:'5px 10px'}} onClick={()=>onDeleteProd(p.id)}>X</button>
                                </div>
                            </div>
                        ))}
                    </div>}

                    {tab==='FIN' && <div>
                        <div className="highlight-card"><h3>Saldo: {fmt(company.balance)}</h3><small>Imposto Semanal: {fmt((COMPANY_TYPES[company.companyType] || {}).tax || 0)}</small></div>
                        <h4 style={{marginTop:20, color:'#ddd'}}>HistÃ³rico de Vendas</h4>
                        <div style={{maxHeight:200, overflowY:'auto', background:'rgba(0,0,0,0.3)', padding:10, borderRadius:8, marginBottom:15, border:'1px solid #333'}}>
                            {(!sales || sales.filter(s => s.companyId === company.id).length === 0) && <p style={{color:'#666', textAlign:'center', fontSize:11, margin:0}}>Nenhuma venda recente.</p>}
                            {(sales || []).filter(s => s.companyId === company.id).map((s, i) => (
                                <div key={i} style={{borderBottom:'1px solid #444', padding:'8px 0', fontSize:11, textAlign:'left'}}>
                                    <div style={{display:'flex', justifyContent:'space-between'}}><b style={{color:'var(--primary)'}}>+ {fmt(s.price)}</b><span style={{color:'#888'}}>{new Date(s.date).toLocaleDateString()}</span></div>
                                    <div style={{marginTop:2}}>ðŸ‘¤ <span style={{color:'#fff', fontWeight:'bold'}}>{s.buyerName}</span> comprou 1x <span style={{color:'var(--purple)'}}>{s.productName}</span></div>
                                </div>
                            ))}
                        </div>
                        <h4>SolicitaÃ§Ãµes</h4>{sps.filter(s=>s.status==='PENDING').length === 0 && <p style={{color:'#666'}}>Nenhuma.</p>}{sps.filter(s=>s.status==='PENDING').map(s => (<div key={s.id} className="card"><b>{s.teamName}</b> pede patrocÃ­nio.<br/>Valor: <span style={{color:'var(--warning)'}}>{fmt(s.value)}</span><br/><div style={{display:'flex', gap:5, marginTop:5}}><button className="btn btn-green" onClick={()=>onProcessSpons(s, 'ACTIVE')}>ACEITAR</button><button className="btn btn-red" onClick={()=>onProcessSpons(s, 'REJECTED')}>RECUSAR</button></div></div>))}
                        <h4>Contratos Ativos</h4>{sps.filter(s=>s.status==='ACTIVE').length === 0 && <p style={{color:'#666'}}>Nenhum.</p>}{sps.filter(s=>s.status==='ACTIVE').map(s => (<div key={s.id} className="card" style={{borderLeft:'4px solid var(--primary)'}}><b>{s.teamName}</b><br/>Pagamento: {fmt(s.value)}<button className="btn btn-red" style={{marginTop:5}} onClick={()=>onProcessSpons(s, 'CANCELLED')}>CANCELAR</button></div>))}
                    </div>}

                    {editP && <div className="modal-overlay"><div className="modal-content">
                        <h3>{editP.id ? 'Editar' : 'Novo'} Produto</h3>
                        
                        {/* NOVO: SELEÃ‡ÃƒO DE CATEGORIA */}
                        <label>Categoria</label>
                        <select className="input-field" value={editP.cat || 'CHUTEIRA'} onChange={e=>setEditP({...editP, cat:e.target.value})}>
                            {Object.keys(PROD_CATS).map(key => <option key={key} value={key}>{PROD_CATS[key]}</option>)}
                        </select>

                        <label>Nome</label><input className="input-field" value={editP.name} onChange={e=>setEditP({...editP, name:e.target.value})} />
                        <label>PreÃ§o</label><input className="input-field" type="number" value={editP.price} onChange={e=>setEditP({...editP, price:e.target.value})} />
                        <label>Imagem URL</label><input className="input-field" value={editP.img} onChange={e=>setEditP({...editP, img:e.target.value})} />
                        <label>DescriÃ§Ã£o</label><textarea className="input-field" value={editP.desc} onChange={e=>setEditP({...editP, desc:e.target.value})} />
                        
                        <div style={{display:'flex', gap:10}}>
                            <button className="btn btn-green" onClick={()=>{onSaveProd(editP); setEditP(null);}}>SALVAR</button>
                            <button className="btn" onClick={()=>setEditP(null)}>CANCELAR</button>
                        </div>
                    </div></div>}
                </div>
            );
        };

        // Novo Componente Shopping
        const ShoppingScreen = ({ products, companies, userTeam, onBuy }) => {
            const [term, setTerm] = useState('');
            const list = products.filter(p => p.name.toLowerCase().includes(term.toLowerCase()));
            
            return (
                <div>
                    <h3>Shopping Global</h3>
                    <input className="input-field" placeholder="Buscar produto..." value={term} onChange={e=>setTerm(e.target.value)} />
                    
                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10}}>
                        {list.map(p => { 
                            const comp = companies.find(c => c.id === p.companyId); 
                            if (comp?.status !== 'ACTIVE') return null; 
                            
                            return (
                                <div key={p.id} className="card" style={{padding:10, position:'relative'}}>
                                    {/* Nome da Empresa */}
                                    <div style={{fontSize:9, background:'var(--purple)', position:'absolute', top:5, right:5, padding:'2px 5px', borderRadius:4, zIndex:10}}>
                                        {comp.name}
                                    </div>
                                    
                                    <img src={p.img || 'https://via.placeholder.com/100'} className="prod-img" style={{width:'100%', height:100, objectFit:'cover', borderRadius:4}} />
                                    
                                    {/* Categoria Badge */}
                                    <span style={{fontSize:9, color:'#888', display:'block', marginTop:5}}>
                                        {PROD_CATS[p.cat] || 'Item'}
                                    </span>

                                    <div style={{fontWeight:'bold', fontSize:13, lineHeight:'1.2em'}}>{p.name}</div>
                                    <div style={{color:'var(--primary)', fontWeight:'900', fontSize:14}}>{fmt(p.price)}</div>
                                    
                                    {userTeam && <button className="btn btn-green" style={{marginTop:5, fontSize:10}} onClick={()=>onBuy(p, comp)}>COMPRAR</button>}
                                </div>
                            ); 
                        })}
                    </div>
                    {list.length === 0 && <p style={{textAlign:'center', color:'#666'}}>Nenhum produto encontrado.</p>}
                </div>
            );
        };

        const TeamDashboard = ({ team, players, isVisitor, onEdit, onAdd }) => {
            // CÃLCULO AUTOMÃTICO DA FOLHA SALARIAL
            const payroll = players.reduce((total, p) => total + (parseFloat(p.salary) || 0), 0);
            
            return (
                <div>
                    <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:15}}>
                        <div>
                            <h3 style={{margin:0}}>Elenco ({players.length})</h3>
                            {/* AQUI ESTÃ A CORREÃ‡ÃƒO: Exibe a Folha Salarial */}
                            <small style={{color:'#ccc'}}>
                                Folha: <span style={{color:'var(--danger)', fontWeight:'bold'}}>{fmt(payroll)}</span>/sem
                            </small>
                        </div>
                        {!isVisitor && <button className="btn btn-green" style={{width:'auto', padding:'5px 15px'}} onClick={onAdd}>+ JOGADOR</button>}
                    </div>

                    {players.length === 0 && <p style={{color:'#666', textAlign:'center'}}>Nenhum jogador contratado.</p>}
                    
                    {players.sort((a,b)=>b.overall-a.overall).map(p => (
                        <div key={p.id} className="card" onClick={()=>!isVisitor && onEdit(p)} style={{cursor: isVisitor?'default':'pointer'}}>
                            <div style={{display:'flex', justifyContent:'space-between'}}>
                                <div>
                                    <span className="badge-pos" style={{background:getPosColor(p.position)}}>{p.position}</span>
                                    <b>{p.name}</b> {p.rating > 0 && <span className="rating-badge">â˜… {p.rating}</span>}
                                </div>
                                <span className="player-ov">{p.overall}</span>
                            </div>
                            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', fontSize:11, color:'#aaa', marginTop:5}}>
                                <div>Sal: {fmt(p.salary)}</div>
                                <div>Val: {fmt(p.value)}</div>
                                <div>Con: {p.contract}</div>
                                <div>Mul: {fmt(p.clause)}</div>
                            </div>
                            <div className="stats-grid">
                                <div className="stat-item"><span className="stat-lbl">âš½</span><span className="stat-val">{p.stats?.goals||0}</span></div>
                                <div className="stat-item"><span className="stat-lbl">ðŸ‘Ÿ</span><span className="stat-val">{p.stats?.assists||0}</span></div>
                                <div className="stat-item"><span className="stat-lbl">ðŸ›¡ï¸</span><span className="stat-val">{p.stats?.tackles||0}</span></div>
                                <div className="stat-item"><span className="stat-lbl">ðŸ§¤</span><span className="stat-val">{p.stats?.saves||0}</span></div>
                                <div className="stat-item"><span className="stat-lbl">ðŸŸ¨</span><span className="stat-val">{p.stats?.yellows||0}</span></div>
                                <div className="stat-item"><span className="stat-lbl">ðŸŸ¥</span><span className="stat-val">{p.stats?.reds||0}</span></div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const StatsEditor = ({ players, teams, onSave }) => {
            const [search, setSearch] = useState(''); const [selP, setSelP] = useState(null); const [s, setS] = useState({});
            const filtered = players.filter(p => p.name.toLowerCase().includes(search.toLowerCase()));
            if (selP) return ( <div><h3>Editando: {selP.name}</h3><div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10}}><div><label>Gols</label><input className="input-field" type="number" value={s.goals} onChange={e=>setS({...s, goals:parseInt(e.target.value)})} /></div><div><label>AssistÃªncias</label><input className="input-field" type="number" value={s.assists} onChange={e=>setS({...s, assists:parseInt(e.target.value)})} /></div><div><label>Desarmes</label><input className="input-field" type="number" value={s.tackles} onChange={e=>setS({...s, tackles:parseInt(e.target.value)})} /></div><div><label>Defesas</label><input className="input-field" type="number" value={s.saves} onChange={e=>setS({...s, saves:parseInt(e.target.value)})} /></div><div><label>Amarelos</label><input className="input-field" type="number" value={s.yellows} onChange={e=>setS({...s, yellows:parseInt(e.target.value)})} /></div><div><label>Vermelhos</label><input className="input-field" type="number" value={s.reds} onChange={e=>setS({...s, reds:parseInt(e.target.value)})} /></div></div><button className="btn btn-green" onClick={()=>onSave(selP.id, s)}>SALVAR ESTATÃSTICAS</button><button className="btn" onClick={()=>setSelP(null)}>VOLTAR</button></div> );
            return (<div><input className="input-field" placeholder="Buscar jogador..." value={search} onChange={e=>setSearch(e.target.value)} /><div style={{maxHeight:300, overflowY:'auto'}}>{search.length > 0 && filtered.map(p => (<div key={p.id} className="card" onClick={()=>{setSelP(p); setS(p.stats || {goals:0,assists:0,tackles:0,saves:0,yellows:0,reds:0})}}><b>{p.name}</b> <small>({teams.find(t=>t.id===p.teamId)?.name})</small></div>))}</div></div>);
        };

        const PlayerForm = ({ initial, onSave, onDelete, isAdmin, teams, onRenew, isOwner }) => {
            // Adicionei 'balance' no estado inicial
            const [f, setF] = useState(initial || {name:'', position:'ATA', overall:'', value:'', salary:'', clause:'', contract:'', mood:'ðŸ˜', status:'NAO_A_VENDA', password:'', balance: 0, rating: '', stats: {goals:0, assists:0, tackles:0, saves:0, yellows:0, reds:0}});
            
            return (
                <div>
                    <div className="modal-bg"><div className="modal-content">
                    <h3>{initial ? 'Editar Jogador' : 'Novo Jogador'}</h3>
                    <label>Nome</label><input className="input-field" value={f.name} onChange={e=>setF({...f, name:e.target.value})} />
                    
                    <div style={{background:'rgba(255,255,255,0.05)', padding:10, borderRadius:5, marginBottom:10, border:'1px solid #444'}}>
                        <label style={{color:'var(--secondary)'}}>ðŸ” Senha de Acesso</label>
                        <input className="input-field" type="text" placeholder="Crie uma senha provisÃ³ria" value={f.password || ''} onChange={e=>setF({...f, password:e.target.value})} />
                    </div>

                    {/* NOVO: CAMPO DE SALDO (SÃ“ PARA ADMIN) */}
                    {isAdmin && (
                        <div style={{border:'1px solid var(--primary)', padding:8, borderRadius:5, marginBottom:10, background:'rgba(0,255,0,0.05)'}}>
                            <label style={{color:'var(--primary)'}}>ðŸ’° Saldo em Conta (Admin)</label>
                            <input className="input-field" type="number" value={f.balance||0} onChange={e=>setF({...f, balance:e.target.value})} />
                        </div>
                    )}

                    <div style={{display:'flex', gap:5}}><div style={{flex:1}}><label>PosiÃ§Ã£o</label><select className="input-field" value={f.position} onChange={e=>setF({...f, position:e.target.value})}>{POS.map(p=><option key={p} value={p}>{p}</option>)}</select></div><div style={{flex:1}}><label>Overall</label><input className="input-field" type="number" value={f.overall} onChange={e=>setF({...f, overall:e.target.value})} disabled={!isAdmin && initial} /></div></div>
                    <div style={{display:'flex', gap:5}}><div style={{flex:1}}><label>Valor</label><input className="input-field" type="number" value={f.value} onChange={e=>setF({...f, value:e.target.value})} /></div><div style={{flex:1}}><label>SalÃ¡rio</label><input className="input-field" type="number" value={f.salary} onChange={e=>setF({...f, salary:e.target.value})} /></div></div>
                    <div style={{display:'flex', gap:5}}><div style={{flex:1}}><label>Multa</label><input className="input-field" type="number" value={f.clause} onChange={e=>setF({...f, clause:e.target.value})} /></div><div style={{flex:1}}><label>Contrato</label><input className="input-field" type="number" value={f.contract} onChange={e=>setF({...f, contract:e.target.value})} /></div></div>
                    <label>Status</label><select className="input-field" value={f.status} onChange={e=>setF({...f, status:e.target.value})}><option value="NAO_A_VENDA">NÃ£o Listado</option><option value="VENDA">Ã€ Venda</option><option value="EMPRESTIMO">EmprÃ©stimo</option><option value="INTRANSFERIVEL">Bloqueado</option></select>
                    <label>Humor</label><select className="input-field" value={f.mood} onChange={e=>setF({...f, mood:e.target.value})}><option>ðŸ¤©</option><option>ðŸ˜</option><option>ðŸ˜¡</option></select>
                    
{isAdmin && (
                        <div style={{border:'1px solid var(--purple)', padding:8, borderRadius:5, margin:'5px 0'}}>
                            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:5}}>
                                <label style={{color:'var(--purple)', fontWeight:'bold'}}>Nota Oficial (Admin)</label>
                                
                                {/* AQUI: MOSTRA A MÃ‰DIA DA IMPRENSA COMO SUGESTÃƒO */}
                                {initial?.pressRatingAvg && (
                                    <span style={{fontSize:10, background:'#333', padding:'2px 6px', borderRadius:4, border:'1px solid #555'}}>
                                        ðŸ“° Imprensa: <span style={{color:'var(--warning)', fontWeight:'bold'}}>{initial.pressRatingAvg}</span> ({initial.pressRatingCount} jgs)
                                    </span>
                                )}
                            </div>
                            
                            <input className="input-field" type="number" step="0.1" min="0" max="10" value={f.rating} onChange={e=>setF({...f, rating:e.target.value})} />
                            <small style={{color:'#888', fontSize:10}}>O XP Ã© calculado com base NESTA nota, nÃ£o na da imprensa.</small>
                        </div>
                    )}                    
                    {isAdmin && <div style={{border:'1px solid var(--primary)', padding:8, borderRadius:8, marginTop:10}}>
                        <label style={{color:'var(--primary)', display:'block', marginBottom:5}}>EstatÃ­sticas (Admin)</label>
                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr 1fr', gap:5}}>
                            <div><span style={{fontSize:10, color:'#aaa'}}>âš½ Gols</span><input className="input-field" type="number" value={f.stats?.goals||0} onChange={e=>setF({...f, stats:{...f.stats, goals:e.target.value}})} /></div>
                            <div><span style={{fontSize:10, color:'#aaa'}}>ðŸ‘Ÿ Assis</span><input className="input-field" type="number" value={f.stats?.assists||0} onChange={e=>setF({...f, stats:{...f.stats, assists:e.target.value}})} /></div>
                            <div><span style={{fontSize:10, color:'#aaa'}}>ðŸ›¡ï¸ Desar</span><input className="input-field" type="number" value={f.stats?.tackles||0} onChange={e=>setF({...f, stats:{...f.stats, tackles:e.target.value}})} /></div>
                            <div><span style={{fontSize:10, color:'#aaa'}}>ðŸ§¤ Defes</span><input className="input-field" type="number" value={f.stats?.saves||0} onChange={e=>setF({...f, stats:{...f.stats, saves:e.target.value}})} /></div>
                            <div><span style={{fontSize:10, color:'#aaa'}}>ðŸŸ¨ Amar</span><input className="input-field" type="number" value={f.stats?.yellows||0} onChange={e=>setF({...f, stats:{...f.stats, yellows:e.target.value}})} /></div>
                            <div><span style={{fontSize:10, color:'#aaa'}}>ðŸŸ¥ Verm</span><input className="input-field" type="number" value={f.stats?.reds||0} onChange={e=>setF({...f, stats:{...f.stats, reds:e.target.value}})} /></div>
                        </div>
                    </div>}

                    {isAdmin && <div style={{border:'1px solid gold', padding:5, marginTop:5}}><label style={{color:'gold'}}>Mover Time (Adm)</label><select className="input-field" onChange={e=>setF({...f, forcedTeamId:e.target.value})}><option value="">-- Manter --</option>{teams.map(t=><option key={t.id} value={t.id}>{t.name}</option>)}</select></div>}
                    
                    <div style={{display:'flex', gap:10, marginTop:15}}>
                        <button className="btn btn-green" onClick={()=>onSave(f)}>SALVAR</button>
                        {isOwner && <button className="btn btn-blue" onClick={()=>onRenew(initial)}>RENOVAR</button>}
                        {initial && <button className="btn btn-red" onClick={()=>onDelete(initial.id)}>X</button>}
                        <button className="btn" onClick={()=>setF(null)}>CANCELAR</button>
                    </div>
                </div></div></div>
            );
        };

        const Market = ({ me, teams, players, open, isVis, onNeg, onPayClause, onPre }) => {
            const [view, setView] = useState('MENU'); const [serie, setSerie] = useState('A'); const [selT, setSelT] = useState(null); const [filt, setFilt] = useState('VENDA');
            if(view==='MENU') return <div><h3>Mercado {open?'ðŸŸ¢':'ðŸ”´'}</h3><div style={{display:'flex', gap:10}}><div className="card" style={{flex:1, textAlign:'center', cursor:'pointer', border:'1px solid var(--primary)'}} onClick={()=>{setFilt('VENDA'); setView('GLOBAL');}}>ðŸ›’ VENDA</div><div className="card" style={{flex:1, textAlign:'center', cursor:'pointer', border:'1px solid var(--secondary)'}} onClick={()=>{setFilt('EMPRESTIMO'); setView('GLOBAL');}}>ðŸ”„ EMP</div></div><h4>SÃ©ries</h4><div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10}}>{SERIES.map(s=><div key={s} className="card" style={{textAlign:'center', cursor:'pointer'}} onClick={()=>{setSerie(s); setView('LIST');}}><b>SÃ©rie {s}</b></div>)}</div></div>;
            let list = []; if(view==='GLOBAL') list = players.filter(p=>p.status===filt && p.teamId!==me).sort((a,b)=>b.overall-a.overall); else if(view==='TEAM') list = players.filter(p=>p.teamId===selT.id).sort((a,b)=>b.overall-a.overall);
            if(view==='LIST') return <div><button className="btn" onClick={()=>setView('MENU')}>Voltar</button><h3>Clubes SÃ©rie {serie}</h3>{teams.filter(t=>t.serie===serie && t.status!=='PENDING').map(t=><div key={t.id} className="card" onClick={()=>{setSelT(t); setView('TEAM');}} style={{display:'flex', alignItems:'center', gap:10, cursor:'pointer'}}>{t.logo?<img src={t.logo} style={{width:30, height:30, borderRadius:'50%', objectFit:'cover'}}/>:<div style={{width:30}}></div>}<b>{t.name}</b></div>)}</div>;
            
            return (
                <div>
                    <button className="btn" onClick={()=>setView('MENU')}>Voltar</button><h3>{view==='GLOBAL'?filt:selT.name}</h3>
                    {list.map(p => (
                        <div key={p.id} className="card">
                            <div style={{display:'flex', justifyContent:'space-between'}}><div><span className="badge-pos" style={{background:getPosColor(p.position)}}>{p.position}</span>{p.name} {p.rating>0 && <span className="rating-badge">â˜… {p.rating}</span>}</div><span className="player-ov">{p.overall}</span></div>
                            <div style={{fontSize:11, color:'#aaa', marginTop:5}}>{view==='GLOBAL' && <div>Time: {teams.find(t=>t.id===p.teamId)?.name}</div>}<div>Val: {fmt(p.value)} | Con: {p.contract}</div></div>
                            <div className="stats-grid"><div className="stat-item"><span className="stat-lbl">âš½</span><span className="stat-val">{p.stats?.goals||0}</span></div><div className="stat-item"><span className="stat-lbl">ðŸ‘Ÿ</span><span className="stat-val">{p.stats?.assists||0}</span></div><div className="stat-item"><span className="stat-lbl">ðŸ›¡ï¸</span><span className="stat-val">{p.stats?.tackles||0}</span></div><div className="stat-item"><span className="stat-lbl">ðŸ§¤</span><span className="stat-val">{p.stats?.saves||0}</span></div><div className="stat-item"><span className="stat-lbl">ðŸŸ¨</span><span className="stat-val">{p.stats?.yellows||0}</span></div><div className="stat-item"><span className="stat-lbl">ðŸŸ¥</span><span className="stat-val">{p.stats?.reds||0}</span></div></div>
                            {!isVis && <div style={{marginTop:5, display:'flex', gap:5}}>{(open || p.status==='EMPRESTIMO') && p.status!=='INTRANSFERIVEL' ? <button className="btn btn-purple" style={{width:'auto', flex:1}} onClick={()=>onNeg(p)}>NEGOCIAR</button> : <button className="btn btn-ghost" style={{width:'auto', flex:1}} disabled>BLOQUEADO</button>}{p.clause>0 && <button className="btn btn-gold" style={{width:'auto'}} onClick={()=>onPayClause(p)}>MULTA</button>}{p.contract<=1 && !p.preContract && <button className="btn btn-blue" style={{width:'auto'}} onClick={()=>onPre(p)}>PRÃ‰</button>}</div>}
                        </div>
                    ))}
                </div>
            );
        };

        const OfferForm = ({ target, myPlayers, onSend }) => {
  const old = target.oldOffer || {};
  const isCounter = !!old.id;

  // ===== ESTADOS (TODOS NUMÃ‰RICOS DE VERDADE) =====
  const [t, setT] = useState(old.type || 'COMPRA');
  const [v, setV] = useState(Number(old.value ?? target.value ?? 0));
  const [sal, setSal] = useState(Number(old.meta?.newSalary ?? target.salary ?? 0));
  const [con, setCon] = useState(Number(old.meta?.contract ?? 1));
  const [luv, setLuv] = useState(Number(old.meta?.signingBonus ?? 0));
  const [role, setRole] = useState(old.meta?.role || 'ROTACAO');

  const [meta, setMeta] = useState({
    sellOn: Number(old.meta?.sellOn ?? 0),
    wageSplit: Number(old.meta?.wageSplit ?? 50),
    buyOpt: old.meta?.buyOpt || '',
    cashDir: old.meta?.cashDir || 'PAY',
    installments: Number(old.meta?.installments ?? 1)
  });

  const [swaps, setSwaps] = useState(old.swapPlayerIds || []);

  const toggleSwap = (pid) => {
    if (swaps.includes(pid)) setSwaps(swaps.filter(id => id !== pid));
    else if (swaps.length < 3) setSwaps([...swaps, pid]);
  };

  return (
    <div className="modal-bg">
      <div className="modal-content" style={{ maxWidth: '500px', maxHeight: '90vh', overflowY: 'auto' }}>
        <h3 style={{ color: 'var(--primary)' }}>
          {isCounter ? 'Contraproposta' : `Negociar ${target.name}`}
        </h3>

        {/* ===== 1. ACORDO ENTRE CLUBES ===== */}
        <div style={{ borderBottom: '1px solid #444', paddingBottom: 15, marginBottom: 15 }}>
          <label style={{ fontSize: '11px', color: 'gold', fontWeight: 'bold', textTransform: 'uppercase' }}>
            1. Acordo entre Clubes
          </label>

          <div style={{ display: 'flex', gap: 5, margin: '10px 0' }}>
            {['COMPRA', 'EMPRESTIMO', 'TROCA'].map(x => (
              <button
                key={x}
                className={`btn ${t === x ? 'btn-green' : 'btn-ghost'}`}
                onClick={() => setT(x)}
                style={{ flex: 1 }}
              >
                {x}
              </button>
            ))}
          </div>

          <label>Valor da Taxa (â‚£)</label>
          <input
            className="input-field"
            type="number"
            value={v}
            min="0"
            onChange={e => setV(Number(e.target.value) || 0)}
          />

          {t === 'COMPRA' && (
            <div className="card" style={{ padding: 10, background: '#222', marginBottom: 10 }}>
              <small>Parcelamento: <b>{meta.installments}x</b></small>
              <input
                type="range"
                min="1"
                max="12"
                value={meta.installments}
                onChange={e => setMeta({ ...meta, installments: Number(e.target.value) })}
                style={{ width: '100%' }}
              />

              <small style={{ display: 'block', marginTop: 10 }}>
                ClÃ¡usula de Revenda: <b>{meta.sellOn}%</b>
              </small>
              <input
                type="range"
                min="0"
                max="50"
                value={meta.sellOn}
                onChange={e => setMeta({ ...meta, sellOn: Number(e.target.value) })}
                style={{ width: '100%' }}
              />
            </div>
          )}
        </div>

        {/* ===== 2. CONTRATO DO JOGADOR ===== */}
        <div>
          <label style={{ fontSize: '11px', color: 'cyan', fontWeight: 'bold', textTransform: 'uppercase' }}>
            2. Contrato do Jogador
          </label>

          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 10, marginTop: 10 }}>
            <div>
              <small>SalÃ¡rio Mensal</small>
              <input
                className="input-field"
                type="number"
                value={sal}
                min="0"
                onChange={e => setSal(Number(e.target.value) || 0)}
              />
            </div>

            <div>
              <small>Luvas (Assinatura)</small>
              <input
                className="input-field"
                type="number"
                value={luv}
                min="0"
                onChange={e => setLuv(Number(e.target.value) || 0)}
              />
            </div>
          </div>

          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 10 }}>
            <div>
              <small>DuraÃ§Ã£o (Anos)</small>
              <input
                className="input-field"
                type="number"
                min="1"
                value={con}
                onChange={e => setCon(Number(e.target.value) || 1)}
              />
            </div>

            <div>
              <small>Papel no Elenco</small>
              <select
                className="input-field"
                value={role}
                onChange={e => setRole(e.target.value)}
              >
                <option value="CRUCIAL">â­ Crucial</option>
                <option value="TITULAR">âœ… Titular</option>
                <option value="ROTACAO">ðŸ”„ RotaÃ§Ã£o</option>
                <option value="RESERVA">ðŸ’¤ Reserva</option>
              </select>
            </div>
          </div>
        </div>

        {/* ===== BOTÃ•ES ===== */}
        <div style={{ display: 'flex', gap: 10, marginTop: 20 }}>
          <button
            className="btn btn-green"
            style={{ flex: 2 }}
            onClick={() => {
              if ([v, sal, luv, con].some(n => isNaN(n))) {
                alert('Erro: valores invÃ¡lidos detectados.');
                return;
              }

              const cleanMeta = {
                ...meta,
                newSalary: sal,
                signingBonus: luv,
                contract: con,
                role
              };

              onSend(target, t, v, swaps, con, cleanMeta, old);
            }}
          >
            {isCounter ? 'ENVIAR CONTRAPROPOSTA' : 'ENVIAR OFERTA'}
          </button>

          <button
            className="btn btn-red"
            style={{ flex: 1 }}
            onClick={() => setModal(null)}
          >
            CANCELAR
          </button>
        </div>
      </div>
    </div>
  );
};

        const AdminPanel = ({ fixPlayersData, onUpdateCompBal, teams, papers, journalists, companies, reqs, config, onAct, onPost, onApprove, onReject, onEditT, onApproveTeam, onUpdateBal, onDeleteTeam, onConfig, onApprovePaper, onDeletePaper, onDeleteJourno, onRejectPaper, onApproveComp, onDeleteComp }) => (
            <div>
                <h3>Painel Master</h3>
                <div className="card">
                    <button className={`btn ${config.marketOpen?'btn-red':'btn-green'}`} onClick={()=>onAct('MARKET', !config.marketOpen)}>{config.marketOpen?'FECHAR MERCADO':'ABRIR MERCADO'}</button>
                    <button className="btn btn-purple" onClick={()=>onAct('WEEK')}>VIRAR SEMANA (Cobr. Impostos)</button>
                    <button className="btn btn-red" onClick={()=>onAct('SEASON')}>VIRAR TEMPORADA</button>
                    <button className="btn btn-ghost" onClick={fixPlayersData}>ðŸ”§ CORRIGIR DADOS FIFA</button>
                    <button className="btn btn-gold" onClick={()=>{ const t=prompt("TÃ­tulo"); const b=prompt("Texto"); if(t)onPost(t,b,'admin'); }}>COMUNICADO</button>
                </div>

                {/* Restante do seu cÃ³digo do AdminPanel... */}
                {(companies||[]).some(c=>c.status==='PENDING') && <h4>Empresas Pendentes</h4>}
                {(companies||[]).filter(c=>c.status==='PENDING').map(c => (
                    <div key={c.id} className="card" style={{borderLeft:'4px solid var(--purple)'}}>
                        <b>{c.name}</b> ({(COMPANY_TYPES[c.companyType] || {}).label || 'Tipo Desconhecido'})<br/>
                        Dono: {c.owner}
                        <div style={{display:'flex', gap:5, marginTop:5}}>
                            <button className="btn btn-green" onClick={()=>onApproveComp(c.id)}>APROVAR</button>
                            <button className="btn btn-red" onClick={()=>onDeleteComp(c.id)}>X</button>
                        </div>
                    </div>
                ))}

                <h4>GestÃ£o de Empresas</h4>
                {(companies||[]).filter(c=>c.status!=='PENDING').map(c => (
                    <div key={c.id} className="card">
                        <b>{c.name}</b> {c.status==='BLOCKED' && <span style={{color:'red'}}>(BLOQUEADA)</span>}<br/>
                        Saldo: {fmt(c.balance)}
                        <div style={{display:'flex', gap:5, marginTop:5}}>
                            <button className="btn btn-green" onClick={()=>{
                                const n = prompt("Novo Saldo da Empresa:", c.balance); 
                                if(n !== null) onUpdateCompBal(c.id, n);
                            }}>$</button>
                            <button className="btn btn-red" onClick={()=>onDeleteComp(c.id)}>EXCLUIR</button>
                        </div>
                    </div>
                ))}
                {/* Aqui continua o resto do cÃ³digo de Times, Jornais, etc que vocÃª jÃ¡ tem */}
                {(teams||[]).some(t=>t.status==='PENDING') && <h4>Times Pendentes</h4>}
                {(teams||[]).filter(t=>t.status==='PENDING').map(t=><div key={t.id} className="card" style={{borderLeft:'4px solid var(--warning)'}}><b>{t.name}</b><div style={{display:'flex', gap:5}}><input className="input-field" style={{marginBottom:0, width:100}} defaultValue={t.balance} id={`bal-${t.id}`} /><button className="btn btn-green" onClick={()=>onApproveTeam(t.id, document.getElementById(`bal-${t.id}`).value)}>V</button><button className="btn btn-red" onClick={()=>onDeleteTeam(t.id)}>X</button></div></div>)}
                
                {(papers||[]).some(p=>p.status==='PENDING') && <h4>Jornais Pendentes</h4>}
                {(papers||[]).filter(p=>p.status==='PENDING').map(p=><div key={p.id} className="card"><b>ðŸ“° {p.name}</b><br/><small>Dono: {p.ownerName}</small><button className="btn btn-green" onClick={()=>onApprovePaper(p.id)}>APROVAR</button><button className="btn btn-red" style={{marginLeft:5}} onClick={()=>onRejectPaper(p.id)}>X</button></div>)}
                
                <h4>GestÃ£o de Imprensa</h4>
                {(papers||[]).filter(p=>p.status==='ACTIVE').map(p=><div key={p.id} className="card" style={{display:'flex', justifyContent:'space-between'}}><span>ðŸ“° {p.name}</span><button className="btn btn-red" style={{width:'auto'}} onClick={()=>onDeletePaper(p.id)}>X</button></div>)}
                {(journalists||[]).map(j=><div key={j.id} className="card" style={{display:'flex', justifyContent:'space-between'}}><span>âœ’ï¸ {j.name}</span><button className="btn btn-red" style={{width:'auto'}} onClick={()=>onDeleteJourno(j.id)}>X</button></div>)}
                
                <h4>SolicitaÃ§Ãµes Financeiras</h4>
                {(reqs||[]).filter(r=>r.status==='PENDING').map(r=><div key={r.id} className="card"><b>{r.teamName}</b>: {fmt(r.amount)} ({r.type})<br/>{r.details}<br/><button className="btn-green" style={{width:'auto', marginRight:5}} onClick={()=>onApprove(r)}>V</button><button className="btn-red" style={{width:'auto'}} onClick={()=>onReject(r.id)}>X</button></div>)}
                
                <h4>Clubes</h4>
                {(teams||[]).filter(t=>t.status!=='PENDING').map(t=><div key={t.id} className="card" style={{display:'flex', justifyContent:'space-between'}}><span>{t.name}</span><div><button className="btn btn-ghost" style={{width:'auto', marginRight:5}} onClick={()=>onConfig(t)}><i className="fas fa-cog"></i></button><button className="btn btn-green" style={{width:'auto', marginRight:5}} onClick={()=>{const n=prompt("Novo Saldo:", t.balance); if(n)onUpdateBal(t.id, n)}}>$</button><button className="btn btn-purple" style={{width:'auto'}} onClick={()=>onEditT(t)}>ELENCO</button><button className="btn btn-red" style={{width:'auto', marginLeft:5}} onClick={()=>onDeleteTeam(t.id)}><i className="fas fa-trash"></i></button></div></div>)}
            </div>
        );

        const SettingsForm = ({ team, isAdmin, onUp, onUpgrade, onReq, onWithdraw }) => {
            const [form, setF] = useState({name: team.name, logo: team.logo, balance: team.balance, serie: team.serie});
            useEffect(() => { setF({name: team.name, logo: team.logo, balance: team.balance, serie: team.serie}); }, [team]);
            return <div><label>Nome</label><input className="input-field" value={form.name} onChange={e=>setF({...form, name:e.target.value})} /><label>Logo</label><input className="input-field" value={form.logo} onChange={e=>setF({...form, logo:e.target.value})} />{isAdmin && <label>Saldo (ADM)</label>} {isAdmin && <input className="input-field" type="number" value={form.balance} onChange={e=>setF({...form, balance:parseFloat(e.target.value)})} />}{isAdmin && <label>SÃ©rie (ADM)</label>}{isAdmin && <select className="input-field" value={form.serie} onChange={e=>setF({...form, serie:e.target.value})}>{SERIES.map(s=><option key={s} value={s}>{s}</option>)}</select>}<button className="btn btn-blue" onClick={()=>onUp(form)}>SALVAR</button><hr style={{borderColor:'#444'}}/><p>EstÃ¡dio NÃ­vel {team.stadiumLevel||1}</p><button className="btn btn-purple" onClick={onUpgrade}>EVOLUIR (â‚£ {fmt(COSTS[team.stadiumLevel]||0).replace('â‚£ ','')})</button><hr style={{borderColor:'#444'}}/><button className="btn btn-green" onClick={()=>{const v=prompt("Valor");const m=prompt("Motivo"); if(v)onReq('INJECTION',v,m)}}>PEDIR INJEÃ‡ÃƒO</button><button className="btn btn-gold" onClick={()=>{const v=prompt("Valor");const m=prompt("Empresa"); if(v)onReq('SPONSORSHIP',v,m)}}>PEDIR PATROCÃNIO</button><button className="btn btn-red" onClick={()=>{const v=prompt("Valor a retirar:"); if(v){ const m=prompt("Motivo:"); if(m) onWithdraw(v, m); }}}>RETIRAR DINHEIRO</button></div>;
        };

        const PlayerDashboard = ({ player, team, sales, onUpdatePassword, onAction, offers, onNeg }) => { 
            const [newPass, setNewPass] = useState('');
            const [tab, setTab] = useState('PERFIL'); 
            const myItems = (sales||[]).filter(s => s.buyerName === player.name);
            
            // Filtra ofertas para este jogador
            const myOffers = (offers||[]).filter(o => o.playerId === player.id && o.status === 'WAITING_PLAYER');

            // CÃ¡lculos de XP (Mantidos)
            const xpNeed = getXPNext(player.overall);
            const future = calcNewLevel(player.overall, (player.xp||0), (player.pendingXP||0));
            const diffLvl = future.lvl - player.overall;
            const xpPerc = Math.min(100, Math.max(0, ((player.xp || 0) / xpNeed) * 100));
            const energy = player.energy !== undefined ? player.energy : 100;
            
            // Conquistas (Mantido)
            const getAchievements = () => {
                const list = [];
                const s = player.stats || {};
                if (s.goals >= 1) list.push({icon:'âš½', name:'Primeiro Gol', color:'#fff'});
                if (s.goals >= 10) list.push({icon:'ðŸ”¥', name:'Artilheiro', color:'gold'});
                if (s.assists >= 10) list.push({icon:'ðŸŽ©', name:'Maestro', color:'var(--secondary)'});
                if (s.tackles >= 10) list.push({icon:'ðŸ§±', name:'ParedÃ£o', color:'#aaa'});
                if (player.overall >= 80) list.push({icon:'â­', name:'Craque', color:'var(--purple)'});
                return list;
            };
            const badges = getAchievements();

            return (
                <div>
                    {/* CABEÃ‡ALHO (MANTIDO) */}
                    <div className="highlight-card" style={{textAlign:'center', paddingBottom:30, position:'relative'}}>
                        <h2 style={{margin:0}}>{player.name} <span style={{fontSize:14}}>{player.mood}</span></h2>
                        <small style={{color:'#ccc'}}>{team?.name || 'Agente Livre'}</small>
                        <div style={{display:'flex', justifyContent:'center', gap:30, marginTop:15}}>
                            <div style={{textAlign:'center'}}>
                                <div style={{display:'flex', alignItems:'center', justifyContent:'center', gap:5}}>
                                    <div style={{fontSize:40, fontWeight:'900', color:'var(--warning)', lineHeight:1}}>{player.overall}</div>
                                    {diffLvl !== 0 && <span style={{fontSize: 16, fontWeight: 'bold', color: diffLvl > 0 ? '#00E676' : '#FF1744', animation: 'pulse 1.5s infinite'}}>{diffLvl > 0 ? '+' : ''}{diffLvl}</span>}
                                </div>
                                <span style={{fontSize:10, textTransform:'uppercase', color:'#888'}}>NÃ­vel Atual</span>
                            </div>
                            <div style={{textAlign:'center'}}>
                                <div style={{fontSize:40, fontWeight:'900', color: energy > 50 ? 'var(--primary)' : 'var(--danger)', lineHeight:1}}>{energy}%</div>
                                <span style={{fontSize:10, textTransform:'uppercase', color:'#888'}}>Energia</span>
                            </div>
                        </div>
                        <div style={{position:'absolute', bottom:0, left:0, right:0, height:8, background:'#333'}}>
                            <div style={{width:`${xpPerc}%`, height:'100%', background:'linear-gradient(90deg, var(--warning), gold)', transition:'1s'}}></div>
                        </div>
                        <div style={{position:'absolute', bottom:10, right:5, fontSize:9, color:'#fff', textShadow:'0 1px 2px black'}}>{player.xp||0} / {xpNeed} XP</div>
                    </div>

                    <div style={{display:'flex', gap:10, marginBottom:15, overflowX:'auto'}}>
                        <button className={`btn ${tab==='PERFIL'?'btn-blue':'btn-ghost'}`} onClick={()=>setTab('PERFIL')}>PERFIL</button>
                        <button className={`btn ${tab==='ACOES'?'btn-red':'btn-ghost'}`} onClick={()=>setTab('ACOES')}>AÃ‡Ã•ES</button>
                        <button className={`btn ${tab==='OFERTAS'?'btn-green':'btn-ghost'}`} onClick={()=>setTab('OFERTAS')}>OFERTAS {myOffers.length>0 && 'ðŸ”´'}</button>
                        <button className={`btn ${tab==='CARREIRA'?'btn-purple':'btn-ghost'}`} onClick={()=>setTab('CARREIRA')}>CARREIRA</button>
                        <button className={`btn ${tab==='INV'?'btn-gold':'btn-ghost'}`} onClick={()=>setTab('INV')}>MOCHILA</button>
                    </div>

                    {tab==='PERFIL' && <div>
                        <div className="card" style={{borderLeft:'4px solid var(--primary)', background:'linear-gradient(90deg, #1b2e1b, #1E1E1E)'}}><h3 style={{marginTop:0, color:'var(--primary)'}}>ðŸ¦ {fmt(player.balance)}</h3><small style={{color:'#aaa'}}>SalÃ¡rio: {fmt(player.salary)} | Passe: {fmt(player.value)}</small></div>
                        <div className="card"><h3>ðŸ“Š EstatÃ­sticas</h3><div className="stats-grid" style={{gridTemplateColumns:'1fr 1fr 1fr'}}><div className="stat-item"><span className="stat-lbl">âš½ Gols</span><span className="stat-val">{player.stats?.goals||0}</span></div><div className="stat-item"><span className="stat-lbl">ðŸ‘Ÿ Assis</span><span className="stat-val">{player.stats?.assists||0}</span></div><div className="stat-item"><span className="stat-lbl">ðŸ›¡ï¸ Desar</span><span className="stat-val">{player.stats?.tackles||0}</span></div><div className="stat-item"><span className="stat-lbl">ðŸ§¤ Defes</span><span className="stat-val">{player.stats?.saves||0}</span></div><div className="stat-item"><span className="stat-lbl">ðŸŸ¨ Amar</span><span className="stat-val">{player.stats?.yellows||0}</span></div><div className="stat-item"><span className="stat-lbl">ðŸŸ¥ Verm</span><span className="stat-val">{player.stats?.reds||0}</span></div></div></div>
                    </div>}

                    {tab === 'OFERTAS' && <div>
                        <h3>ðŸ“© Propostas de Contrato</h3>
                        {myOffers.length === 0 && <p style={{color:'#666', textAlign:'center'}}>Nenhuma proposta na mesa.</p>}
                        {myOffers.map(o => (
                            <div key={o.id} className="card" style={{borderLeft:'4px solid gold'}}>
                                <div style={{display:'flex', justifyContent:'space-between'}}>
                                    <b>{o.buyerName}</b>
                                    <span style={{color:'var(--primary)', fontWeight:'bold'}}>{fmt(o.meta.newSalary)}/sem</span>
                                </div>
                                <div style={{fontSize:11, color:'#aaa', margin:'5px 0'}}>
                                    Luvas: {fmt(o.meta.signingBonus)} | Contrato: {o.meta.contract} anos | Papel: {o.meta.role}
                                </div>
                                <button className="btn btn-blue" onClick={()=>onNeg(o)}>ANALISAR / NEGOCIAR</button>
                            </div>
                        ))}
                    </div>}

                    {tab==='ACOES' && <div><div className="card" style={{borderLeft:'4px solid var(--danger)'}}><h4>ðŸ“¢ O Gabinete</h4>{team ? (<div style={{display:'flex', gap:10, flexDirection:'column'}}><button className="btn btn-gold" onClick={()=>onAction('ASK_RAISE', player)}>ðŸ’° PEDIR AUMENTO</button><div style={{display:'flex', gap:5}}><button className="btn btn-green" style={{flex:1}} onClick={()=>onAction('DECLARE_HAPPY', player)}>ðŸ¤© ESTOU FELIZ</button><button className="btn btn-ghost" style={{flex:1}} onClick={()=>onAction('BECOME_NEUTRAL', player)}>ðŸ˜ FICAR NEUTRO</button></div><button className="btn btn-red" onClick={()=>onAction('TRANSFER_REQUEST', player)}>ðŸ˜¡ PEDIR TRANSFERÃŠNCIA</button></div>) : (<p style={{color:'var(--primary)', fontWeight:'bold'}}>EstÃ¡s livre no mercado!</p>)}</div><div className="card"><h4>ðŸ” SeguranÃ§a</h4><div style={{display:'flex', gap:5}}><input className="input-field" type="password" placeholder="Nova Senha" value={newPass} onChange={e=>setNewPass(e.target.value)} style={{marginBottom:0}} /><button className="btn btn-purple" style={{width:'auto'}} onClick={()=>{ if(!newPass) return alert("Digite uma senha!"); onUpdatePassword(newPass); setNewPass(''); }}>ALTERAR</button></div></div></div>}
                    
                    {tab==='CARREIRA' && <div><div className="card"><h3>ðŸ† Conquistas</h3>{badges.length === 0 && <p style={{color:'#666', fontSize:11}}>Joga para desbloquear.</p>}<div style={{display:'flex', flexWrap:'wrap', gap:8}}>{badges.map((b, i) => (<div key={i} style={{background:'#333', padding:'5px 10px', borderRadius:20, display:'flex', alignItems:'center', gap:5, border:`1px solid ${b.color}`}}><span>{b.icon}</span><span style={{fontSize:11, fontWeight:'bold', color:b.color}}>{b.name}</span></div>))}</div></div><div className="card" style={{borderLeft:'4px solid #fff'}}><h3>ðŸŒ HistÃ³rico</h3><div style={{display:'flex', flexDirection:'column-reverse', gap:10}}>{(player.history || []).map((h, i) => (<div key={i} style={{display:'flex', alignItems:'center', justifyContent:'space-between', background:'rgba(255,255,255,0.05)', padding:10, borderRadius:8}}><span style={{fontSize:9, color:'#aaa'}}>{h.from}</span><div style={{textAlign:'center'}}><div style={{color:'var(--primary)', fontSize:12}}>âž¡</div><div style={{fontSize:9, color:'#fff'}}>{h.value > 0 ? fmt(h.value) : 'GrÃ¡tis'}</div></div><span style={{fontSize:9, fontWeight:'bold'}}>{h.to}</span></div>))}</div></div></div>}
                    
                    {tab==='INV' && <div><h3>ðŸŽ’ Mochila</h3>{myItems.length === 0 && <p style={{color:'#666', textAlign:'center'}}>Vazia.</p>}{myItems.map((item, index) => (<div key={index} className="card" style={{border:'1px solid #444', textAlign:'center', padding:10}}><div style={{fontSize:24}}>ðŸ“¦</div><div style={{fontWeight:'bold', fontSize:12}}>{item.productName}</div><div style={{fontSize:10, color:'#aaa'}}>PreÃ§o: {fmt(item.price)}</div></div>))}</div>}
                </div>
            );
        };
        const OffersScreen = ({ offers, onAccept, onReject, onCounter }) => (
    <div>
        <h3>Propostas</h3>
        {offers.length === 0 && <p style={{color:'#666', textAlign:'center'}}>Nenhuma proposta pendente.</p>}
        {offers.map(o => {
            // TRAVA DE SEGURANÃ‡A:
            // Esconde botÃµes se:
            // 1. Eu sou o Comprador e o status Ã© WAITING_SELLER (bola com o dono)
            // 2. Eu sou o Vendedor (Dono) e o status Ã© WAITING_BUYER (bola com o comprador)
            const aguardandoOutraParte = 
                (user.data.id === o.buyerId && o.status === 'WAITING_SELLER') || 
                (user.data.id === o.sellerId && o.status === 'WAITING_BUYER');

            return (
                <div key={o.id} className="card" style={{borderLeft: '4px solid gold'}}>
                    <b style={{color:'var(--primary)'}}>{o.playerName}</b><br/>
                    <small>Envolvidos: {o.buyerName} â†”ï¸ {teams.find(t=>t.id===o.sellerId)?.name || 'Dono'}</small>
                    <p style={{background:'#333', padding:5, borderRadius:5, whiteSpace:'pre-wrap', fontSize:11}}>{o.description}</p>
                    
                    {aguardandoOutraParte ? (
                        <div style={{textAlign: 'center', color: '#aaa', padding: '10px', border: '1px dashed #444', fontSize: '12px', borderRadius: '5px'}}>
                            âŒ› Aguardando resposta do outro time...
                        </div>
                    ) : (
                        <div style={{display:'flex', gap:5}}>
                            <button className="btn btn-green" onClick={() => onAccept(o)}>ACEITAR</button>
                            <button className="btn btn-blue" onClick={() => onCounter(o)}>CONTRA</button>
                            <button className="btn btn-red" onClick={() => onReject(o)}>RECUSAR</button>
                        </div>
                    )}
                </div>
            );
        })}
    </div>
);
        const Ranking = ({ teams, players }) => {
    const [view, setView] = useState('TEAMS');
    
    const renderTeams = () => teams.filter(t=>t.status!=='PENDING').map(t=>{ 
        const sv = players.filter(p=>p.teamId===t.id).reduce((a,b)=>a+(b.value||0),0); 
        return {...t, w: t.balance+sv, sv}
    }).sort((a,b)=>b.w-a.w).map((t,i)=>(
        <div key={t.id} className="card" style={{display:'flex', alignItems:'center', gap:10}}>
            <b style={{fontSize:20, color:'#555', width:30}}>{i+1}</b>
            {t.logo ? <img src={t.logo} style={{width:30, height:30, borderRadius:'50%', objectFit:'cover'}}/> : <div style={{width:30}}></div>}
            <div style={{flex:1}}>
                <b>{t.name}</b><br/>
                <small style={{color:'var(--primary)'}}>PatrimÃ´nio: {fmt(t.w)}</small><br/>
                <small style={{fontSize:9, color:'#888'}}>Caixa: {fmt(t.balance)} | Elenco: {fmt(t.sv)}</small>
            </div>
        </div>
    ));

    const renderPlayers = (sortKey, label, color, isStat=true) => { 
        let sorted = []; 
        if(isStat) sorted = players.filter(p=>p.stats && p.stats[sortKey] > 0).sort((a,b)=>b.stats[sortKey]-a.stats[sortKey]); 
        else sorted = players.sort((a,b)=>b[sortKey]-a[sortKey]); 
        
        return sorted.map((p,i)=>(
            <div key={p.id} className="card" style={{display:'flex', alignItems:'center', gap:10}}>
                <b style={{fontSize:20, color:'#555', width:30}}>{i+1}</b>
                <div style={{flex:1}}>
                    <b>{p.name}</b> <small>({teams.find(t=>t.id===p.teamId)?.name})</small>
                </div>
                <div style={{fontWeight:'bold', fontSize:14, color:color}}>{label} {isStat ? p.stats[sortKey] : (sortKey==='salary' ? fmt(p[sortKey]) : p[sortKey])}</div>
            </div>
        )); 
    };

    return (
        <div>
            <h3>Ranking e EstatÃ­sticas</h3>
            <div className="rank-tabs">
                <div className={`rank-tab ${view==='TEAMS'?'active':''}`} onClick={()=>setView('TEAMS')}>ðŸ’° Clubes</div>
                <div className={`rank-tab ${view==='OVERALL'?'active':''}`} onClick={()=>setView('OVERALL')}>â­ Craques</div>
                <div className={`rank-tab ${view==='SALARY'?'active':''}`} onClick={()=>setView('SALARY')}>ðŸ’¸ SalÃ¡rios</div>
                <div className={`rank-tab ${view==='GOALS'?'active':''}`} onClick={()=>setView('GOALS')}>âš½ Artilheiros</div>
                <div className={`rank-tab ${view==='ASSIST'?'active':''}`} onClick={()=>setView('ASSIST')}>ðŸ‘Ÿ GarÃ§ons</div>
                <div className={`rank-tab ${view==='TACKLES'?'active':''}`} onClick={()=>setView('TACKLES')}>ðŸ›¡ï¸ Desarmes</div>
                <div className={`rank-tab ${view==='SAVES'?'active':''}`} onClick={()=>setView('SAVES')}>ðŸ§¤ ParedÃµes</div>
                <div className={`rank-tab ${view==='YEL'?'active':''}`} onClick={()=>setView('YEL')}>ðŸŸ¨ Amarelos</div>
                <div className={`rank-tab ${view==='RED'?'active':''}`} onClick={()=>setView('RED')}>ðŸŸ¥ Vermelhos</div>
            </div>
            {view==='TEAMS' && renderTeams()}
            {view==='OVERALL' && renderPlayers('overall', 'Ov:', 'var(--warning)', false)}
            {view==='SALARY' && renderPlayers('salary', '', 'var(--primary)', false)}
            {view==='GOALS' && renderPlayers('goals', 'âš½', '#fff')}
            {view==='ASSIST' && renderPlayers('assists', 'ðŸ‘Ÿ', '#fff')}
            {view==='TACKLES' && renderPlayers('tackles', 'ðŸ›¡ï¸', '#fff')}
            {view==='SAVES' && renderPlayers('saves', 'ðŸ§¤', '#fff')}
            {view==='YEL' && renderPlayers('yellows', 'ðŸŸ¨', 'yellow')}
            {view==='RED' && renderPlayers('reds', 'ðŸŸ¥', 'red')}
        </div>
    );
};

// --- COMPONENTES QUE FALTAVAM (SÃºmula e Tabela) ---

        const MatchPerformanceForm = ({ players, teams, onSaveStats }) => {
            const [selP, setSelP] = useState(null);
            const [match, setMatch] = useState({ goals:0, assists:0, tackles:0, saves:0, yellows:0, reds:0, rating:'', result:'NENHUM' }); 
            const [search, setSearch] = useState('');

            // Calcula XP (INTERNO - O JORNALISTA NÃƒO VÃŠ MAIS)
            const calcMatchXP = () => {
                let xp = 0;
                // Usa regras padrÃ£o se nÃ£o existirem
                const R = (typeof XP_RULES !== 'undefined') ? XP_RULES : { GOAL: 150, ASSIST: 120, TACKLE: 80, SAVE: 100, WIN: 300, DRAW: 100, LOSS: -100, YELLOW: -50, RED: -200, RATING_MULT: 50 };
                
                xp += (match.goals || 0) * R.GOAL;
                xp += (match.assists || 0) * R.ASSIST;
                xp += (match.tackles || 0) * R.TACKLE;
                xp += (match.saves || 0) * R.SAVE;
                xp += (match.yellows || 0) * R.YELLOW;
                xp += (match.reds || 0) * R.RED;
                
                if (match.result === 'VITORIA') xp += R.WIN;
                if (match.result === 'EMPATE') xp += R.DRAW;
                if (match.result === 'DERROTA') xp += R.LOSS;
                
                // IMPORTANTE: Usa a nota do ADMIN (selP.rating) para o cÃ¡lculo oficial do XP
                // Se o admin nÃ£o deu nota ainda, usa 0 (ou seja, sÃ³ ganha XP de scout por enquanto)
                xp += (parseFloat(selP.rating) || 0) * R.RATING_MULT;
                
                return parseInt(xp);
            };

            const filtered = players.filter(p => p.name.toLowerCase().includes(search.toLowerCase()));

            // TELA 1: Preenchendo a SÃºmula (Quando selecionou um jogador)
            if (selP) return (
                <div>
                    <h3 style={{color:'var(--primary)'}}>SÃºmula: {selP.name}</h3>
                    <div style={{background:'rgba(255,255,255,0.05)', padding:10, borderRadius:8, marginBottom:10}}>
                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10}}>
                            <div><label>âš½ Gols</label><input className="input-field" type="number" value={match.goals} onChange={e=>setMatch({...match, goals:parseInt(e.target.value)})} /></div>
                            <div><label>ðŸ‘Ÿ AssistÃªncias</label><input className="input-field" type="number" value={match.assists} onChange={e=>setMatch({...match, assists:parseInt(e.target.value)})} /></div>
                            <div><label>ðŸ›¡ï¸ Desarmes</label><input className="input-field" type="number" value={match.tackles} onChange={e=>setMatch({...match, tackles:parseInt(e.target.value)})} /></div>
                            <div><label>ðŸ§¤ Defesas</label><input className="input-field" type="number" value={match.saves} onChange={e=>setMatch({...match, saves:parseInt(e.target.value)})} /></div>
                            <div><label>ðŸŸ¨ Amarelo</label><input className="input-field" type="number" value={match.yellows} onChange={e=>setMatch({...match, yellows:parseInt(e.target.value)})} /></div>
                            <div><label>ðŸŸ¥ Vermelho</label><input className="input-field" type="number" value={match.reds} onChange={e=>setMatch({...match, reds:parseInt(e.target.value)})} /></div>
                        </div>
                        <hr style={{borderColor:'#444'}}/>
                        
                        {/* TRAVA DE SEGURANÃ‡A NA NOTA (MÃXIMO 10) */}
                        <label>â­ Nota da AtuaÃ§Ã£o (Jornalista)</label>
                        <input className="input-field" type="number" step="0.1" min="0" max="10" placeholder="0.0 a 10.0" 
                            value={match.rating} 
                            onChange={e=> {
                                let v = parseFloat(e.target.value);
                                if(v > 10) v = 10; // Trava em 10 se passar
                                if(v < 0) v = 0;
                                setMatch({...match, rating: v})
                            }} 
                        />
                        
                        <label>ðŸš© Resultado do Time</label>
                        <select className="input-field" value={match.result} onChange={e=>setMatch({...match, result:e.target.value})}>
                            <option value="NENHUM">-- Neutro --</option>
                            <option value="VITORIA">VitÃ³ria</option>
                            <option value="EMPATE">Empate</option>
                            <option value="DERROTA">Derrota</option>
                        </select>
                        
                        {/* AQUI NÃƒO MOSTRAMOS MAIS O XP PREVISTO (SEGREDO) */}
                    </div>
                    <div style={{display:'flex', gap:10}}>
                        <button className="btn btn-green" onClick={()=>onSaveStats(selP, match, calcMatchXP())}>LANÃ‡AR NA SÃšMULA</button>
                        <button className="btn" onClick={()=>setSelP(null)}>VOLTAR</button>
                    </div>
                </div>
            );

            // TELA 2: Buscando Jogador (Retorno Principal)
            return (
                <div>
                    <h3>LanÃ§ar Desempenho</h3>
                    <input className="input-field" placeholder="Buscar jogador..." value={search} onChange={e=>setSearch(e.target.value)} />
                    <div style={{maxHeight:300, overflowY:'auto'}}>
                        {search.length > 0 && filtered.map(p => (
                            <div key={p.id} className="card" onClick={()=>{setSelP(p); setMatch({goals:0, assists:0, tackles:0, saves:0, yellows:0, reds:0, rating:'', result:'NENHUM'});}}>
                                <b>{p.name}</b> <small>({teams.find(t=>t.id===p.teamId)?.name})</small>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const TeamStandingsEditor = ({ teams, onUpdateTeamStats }) => {
            return (
                <div>
                    <h3>Editar Tabela (Jornalista)</h3>
                    <div style={{maxHeight:400, overflowY:'auto'}}>
                        {teams.filter(t=>t.status!=='PENDING').map(t => (
                            <div key={t.id} className="card" style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                <div style={{width:'30%'}}><b>{t.name}</b></div>
                                <div style={{display:'flex', gap:5}}>
                                    <div style={{textAlign:'center'}}><small>V</small><input className="input-field" type="number" style={{width:40, padding:5, marginBottom:0}} defaultValue={t.stats?.wins||0} id={`w-${t.id}`} /></div>
                                    <div style={{textAlign:'center'}}><small>E</small><input className="input-field" type="number" style={{width:40, padding:5, marginBottom:0}} defaultValue={t.stats?.draws||0} id={`d-${t.id}`} /></div>
                                    <div style={{textAlign:'center'}}><small>D</small><input className="input-field" type="number" style={{width:40, padding:5, marginBottom:0}} defaultValue={t.stats?.losses||0} id={`l-${t.id}`} /></div>
                                    <button className="btn btn-green" style={{width:'auto', height:35, marginTop:18}} onClick={()=>{
                                        const w = parseInt(document.getElementById(`w-${t.id}`).value)||0;
                                        const d = parseInt(document.getElementById(`d-${t.id}`).value)||0;
                                        const l = parseInt(document.getElementById(`l-${t.id}`).value)||0;
                                        onUpdateTeamStats(t.id, {wins:w, draws:d, losses:l});
                                    }}>ðŸ’¾</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
