<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gerenciador de Times de Mato Real</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body { background: #121212; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding-bottom: 80px; margin: 0; }
        .container { padding: 15px; }
        
        .team-logo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #00E676; background: #333; }
        .rank-logo { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin-right: 10px; background: #333; }
        .login-logo-img { width: 120px; height: 120px; object-fit: contain; border-radius: 50%; border: 3px solid #00E676; margin: 0 auto 15px auto; display: block; background: #1e1e1e; }

        .card { background: #1E1E1E; padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #333; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .player-header { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .player-name { font-size: 16px; font-weight: bold; color: white; }
        
        .pos-badge { font-size: 10px; color: white; padding: 2px 5px; border-radius: 4px; font-weight: bold; margin-right: 5px; vertical-align: middle; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); }
        .mood-icon { font-size: 14px; margin-left: 5px; }

        .player-ov { font-size: 16px; font-weight: bold; color: #00E676; background: #003300; padding: 2px 6px; border-radius: 4px; }
        .player-details { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 11px; color: #aaa; }

        .news-card { background: #252525; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #888; font-size: 13px; line-height: 1.6; white-space: pre-line; }
        .news-money-plus { border-left-color: #00E676; } .news-money-minus { border-left-color: #d32f2f; } 
        .news-transfer { border-left-color: #2196F3; } .news-new-player { border-left-color: #FFD700; background: #2a2a20; } 
        .news-season { border-left-color: #FF5722; background: #2a1b1b; } .news-infra { border-left-color: #9C27B0; } 
        .news-admin { border-left-color: #ffffff; background: #333; }
        .news-date { font-size: 10px; color: #888; display: block; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 5px; }

        .rank-item { padding: 15px; border-bottom: 1px solid #333; background: #1E1E1E; margin-bottom: 5px; border-radius: 8px; }
        .rank-pos { font-size: 18px; font-weight: bold; color: #666; width: 30px; }
        .rank-1 { color: #FFD700; } .rank-2 { color: #C0C0C0; } .rank-3 { color: #CD7F32; }
        .rank-details { display: flex; justify-content: space-between; font-size: 11px; color: #aaa; margin-top: 5px; border-top: 1px solid #333; padding-top: 5px; }

        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; margin-top: 10px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        .btn-green { background: #00E676; color: black; } .btn-red { background: #d32f2f; color: white; }
        .btn-blue { background: #2196F3; color: white; } .btn-gold { background: #FFD700; color: black; }
        .btn-purple { background: #9C27B0; color: white; } .btn-orange { background: #FF5722; color: white; } 
        .btn-outline { background: transparent; border: 1px solid #666; color: #ccc; }
        
        .input-field { width: 100%; padding: 12px; background: #2C2C2C; border: 1px solid #333; color: white; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .file-input { width: 100%; padding: 10px; background: #333; color: #aaa; border-radius: 8px; margin-bottom: 10px; }
        
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: #1a1a1a; display: flex; padding: 10px 0; border-top: 1px solid #333; z-index: 100; }
        .nav-item { flex: 1; text-align: center; color: #888; font-size: 10px; position: relative; }
        .nav-item i { font-size: 18px; margin-bottom: 2px; display: block; }
        .nav-item.active { color: #00E676; }
        .header { background: #1E1E1E; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #333; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 99; display: flex; justify-content: center; align-items: center; }
        .modal-card { width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; background: #1E1E1E; padding: 20px; border-radius: 12px; border: 1px solid #333; box-sizing: border-box; }

        .login-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #333; }
        .tab { flex: 1; padding: 15px; text-align: center; color: #888; cursor: pointer; }
        .tab.active { color: #00E676; border-bottom: 2px solid #00E676; font-weight: bold; }
        .team-list-item { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        
        .badge-count { background: #d32f2f; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; position: absolute; top: -5px; right: -5px; }
        .news-badge { position: absolute; top: 5px; right: 28%; width: 10px; height: 10px; background: #FFD700; border-radius: 50%; border: 2px solid #1a1a1a; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .status-tag { font-size: 10px; padding: 2px 5px; border-radius: 3px; font-weight: bold; display: inline-block; margin-top: 5px;}
        .st-venda { background: #003300; color: #00E676; border: 1px solid #00E676; }
        .st-block { background: #333; color: #888; }
        .st-lock { background: #330000; color: #ff5252; border: 1px solid #ff5252; }
        .st-exp { background: #330000; color: #ff5252; border: 1px solid #ff5252; animation: blink 1s infinite; }
        .contract-tag { color: #2196F3; font-weight: bold; font-size: 11px; margin-left: 5px; }
        .expired-tag { color: #FF5722; font-weight: bold; font-size: 11px; margin-left: 5px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .dev-credits { text-align: center; font-size: 10px; color: #444; margin-top: 20px; padding: 10px; font-weight: bold; letter-spacing: 1px; }
        
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; vertical-align: middle; margin-left: 10px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #00E676; }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Filtros do Mercado */
        .market-filters { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; }
        .filter-btn { padding: 8px 12px; background: #333; color: #888; border-radius: 20px; font-size: 11px; white-space: nowrap; border: 1px solid #444; cursor: pointer; }
        .filter-btn.active { background: #00E676; color: black; border-color: #00E676; font-weight: bold; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURA√á√ÉO ---
        const firebaseConfig = {
            apiKey: "AIzaSyBrtJFfWAqT0AZYHlm4it-noB5h9jIPJEI",
            authDomain: "gerenciador-de-times-matoreal.firebaseapp.com",
            projectId: "gerenciador-de-times-matoreal",
            storageBucket: "gerenciador-de-times-matoreal.firebasestorage.app",
            messagingSenderId: "29096266740",
            appId: "1:29096266740:web:ec48e7225c18c20dbc07a1"
        };
        if (!firebase.apps.length) { try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error(e); } }
        const db = firebase.firestore();
        const { useState, useEffect } = React;

        const STADIUM_COSTS = [0, 5000000, 20000000, 50000000, 100000000];
        const STADIUM_NAMES = ["Campo de V√°rzea", "Est√°dio Pequeno", "Arena Moderna", "Arena Mundial", "Templo do Futebol"];
        const POSITIONS = ['GOL', 'ZAG', 'LD', 'LE', 'VOL', 'MC', 'MEI', 'ATA'];
        const POS_ORDER = { 'GOL': 1, 'ZAG': 2, 'LD': 3, 'LE': 4, 'VOL': 5, 'MC': 6, 'MEI': 7, 'ATA': 8 };

        const getPosColor = (pos) => {
            if(!pos) return '#777';
            if(pos === 'GOL') return '#FFD700'; 
            if(pos.includes('ZAG') || pos.includes('LD') || pos.includes('LE')) return '#2196F3'; 
            if(pos.includes('VOL') || pos.includes('MC') || pos.includes('MEI')) return '#4CAF50'; 
            if(pos.includes('ATA')) return '#F44336'; 
            return '#777';
        };

        function App() {
            const [userTeam, setUserTeam] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [isVisitor, setIsVisitor] = useState(false);
            const [teams, setTeams] = useState([]);
            const [players, setPlayers] = useState([]);
            const [offers, setOffers] = useState([]); 
            const [news, setNews] = useState([]); 
            const [financeRequests, setFinanceRequests] = useState([]); 
            const [screen, setScreen] = useState('HOME');
            const [loading, setLoading] = useState(true);
            const [showAdmin, setShowAdmin] = useState(false); 
            const [showNotif, setShowNotif] = useState(false); 
            const [offerModal, setOfferModal] = useState(null);
            const [hasNewNews, setHasNewNews] = useState(false);
            const [adminViewingTeam, setAdminViewingTeam] = useState(null); 
            const [systemConfig, setSystemConfig] = useState({ marketOpen: true }); 

            const fmt = (v) => "‚Ç£ " + parseFloat(v||0).toLocaleString();

            useEffect(() => {
                const unsubT = db.collection('teams').onSnapshot(snap => setTeams(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubP = db.collection('players').onSnapshot(snap => setPlayers(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubN = db.collection('news').onSnapshot(snap => {
                    const list = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    list.sort((a,b) => b.date - a.date); 
                    setNews(list);
                    setLoading(false);
                    if (list.length > 0) {
                        const lastRead = localStorage.getItem('lastReadNewsTime');
                        if (!lastRead || list[0].date > parseInt(lastRead)) { setHasNewNews(true); }
                    }
                });
                const unsubC = db.collection('config').doc('system').onSnapshot(snap => {
                    if(snap.exists) setSystemConfig(snap.data());
                    else db.collection('config').doc('system').set({ marketOpen: true });
                });
                const unsubF = db.collection('financeRequests').onSnapshot(snap => {
                    setFinanceRequests(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });

                return () => { unsubT(); unsubP(); unsubN(); unsubC(); unsubF(); }
            }, []);

            useEffect(() => {
                if(!userTeam || isAdmin || isVisitor) return; 
                const unsubO = db.collection('offers').where('sellerId', '==', userTeam.id).onSnapshot(snap => setOffers(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                const savedId = localStorage.getItem('myTeamId');
                if(savedId && teams.length > 0) {
                    const found = teams.find(t => t.id === savedId);
                    if(found) {
                        if(found.status !== 'APPROVED') { localStorage.removeItem('myTeamId'); } 
                        else { setUserTeam(found); }
                    } 
                }
                return () => unsubO && unsubO();
            }, [teams, userTeam?.id]); 

            const myPayroll = userTeam && !isAdmin && !isVisitor ? players
                .filter(p => p.teamId === userTeam.id)
                .reduce((total, p) => total + (p.salary || 0), 0) : 0;
            const fairPlayAlert = userTeam && myPayroll > 0 ? (userTeam.balance / myPayroll) < 3 : false;

            const handleImageUpload = (e, callback) => {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 200000) { alert("Imagem muito grande! Use uma menor (M√°x: 200KB)."); return; }
                const reader = new FileReader();
                reader.onloadend = () => { callback(reader.result); };
                reader.readAsDataURL(file);
            };
            const postNews = (text, type='normal') => db.collection('news').add({ text, type, date: Date.now() });

            const openNewsScreen = () => {
                setScreen('NEWS');
                setHasNewNews(false);
                if(news.length > 0) { localStorage.setItem('lastReadNewsTime', news[0].date.toString()); }
            };

            const toggleMarket = () => {
                const newState = !systemConfig.marketOpen;
                db.collection('config').doc('system').update({ marketOpen: newState });
                postNews(newState ? "üì¢ **COMUNICADO OFICIAL: JANELA ABERTA**\n\nA Federa√ß√£o anuncia que o mercado de transfer√™ncias est√° oficialmente ABERTO." : "üîí **JANELA FECHADA**\n\nA Federa√ß√£o encerrou o per√≠odo de registros.", 'infra');
            };

            const handleLogin = (team, inputPassword) => {
                if(team.status === 'PENDING') {
                    alert("üö´ TIME EM AN√ÅLISE!\n\nAguarde a autoriza√ß√£o da Federa√ß√£o (ADM) para acessar.");
                    return false;
                }
                if (inputPassword === team.password) {
                    localStorage.setItem('myTeamId', team.id);
                    setUserTeam(team);
                    setIsAdmin(false);
                    setIsVisitor(false);
                    return true;
                } else { alert("SENHA INCORRETA!"); return false; }
            };

            const handleAdminLogin = () => {
                const pass = prompt("Digite a Senha MESTRE (ADM):");
                if(pass === '2503') {
                    setUserTeam({ name: "SUPER ADMIN", id: "admin_user" });
                    setIsAdmin(true);
                    setIsVisitor(false);
                } else { alert("Acesso Negado."); }
            };

            const handleVisitorLogin = () => {
                setUserTeam({ name: "VISITANTE", id: "visitor_user" });
                setIsAdmin(false);
                setIsVisitor(true);
                setScreen('RANKING'); 
            };

            const handleCreateTeam = async (name, bal, serie, password, logo) => {
                const exist = teams.find(t => t.name.toLowerCase() === name.toLowerCase());
                if(exist) { alert(`J√° existe!`); return; }
                
                await db.collection('teams').add({ 
                    name, balance: parseFloat(bal), serie, password, stadiumLevel: 1, logo: logo || null, sponsorship: null, status: 'PENDING' 
                });
                
                alert("‚úÖ TIME CRIADO COM SUCESSO!\n\nAgora aguarde o ADM aprovar sua conta para voc√™ conseguir logar.");
            };

            const adminApproveTeam = async (team) => {
                if(!confirm(`Aprovar a entrada do ${team.name}?`)) return;
                await db.collection('teams').doc(team.id).update({ status: 'APPROVED' });
                postNews(`üõ°Ô∏è **NOVO CLUBE OFICIALIZADO!**\n\nA Federa√ß√£o aprovou a filia√ß√£o do **${team.name}** na S√©rie ${team.serie}.`, 'infra');
                alert("Time Aprovado!");
            };

            const requestFinance = async (type, amount, nameOrReason) => {
                if (!amount || !nameOrReason) return alert("Preencha todos os campos!");
                await db.collection('financeRequests').add({
                    teamId: userTeam.id,
                    teamName: userTeam.name,
                    type,
                    amount: parseFloat(amount),
                    details: nameOrReason,
                    status: 'PENDING',
                    date: Date.now()
                });
                alert("Solicita√ß√£o enviada para a Federa√ß√£o (ADM)!");
            };

            const userPayBill = async (amount, reason) => {
                const val = parseFloat(amount);
                if (!val || !reason) return alert("Preencha valor e motivo!");
                if (userTeam.balance < val) return alert("Saldo insuficiente!");
                
                if(!confirm(`Pagar ${fmt(val)} referente a "${reason}"?`)) return;

                const newBal = userTeam.balance - val;
                db.collection('teams').doc(userTeam.id).update({ balance: newBal });
                setUserTeam({...userTeam, balance: newBal});
                postNews(`üí∏ **DESPESA REGISTRADA**\n\nO **${userTeam.name}** realizou um pagamento de ${fmt(val)}.\nüìù Motivo: ${reason}`, 'minus');
                alert("Pagamento realizado!");
            };

            const handleFinanceRequest = async (req, action) => {
                if (action === 'REJECT') {
                    await db.collection('financeRequests').doc(req.id).update({ status: 'REJECTED' });
                    return;
                }
                const batch = db.batch();
                const teamRef = db.collection('teams').doc(req.teamId);
                const reqRef = db.collection('financeRequests').doc(req.id);

                if (req.type === 'INJECTION') {
                    const teamDoc = teams.find(t => t.id === req.teamId);
                    const newBal = (teamDoc ? teamDoc.balance : 0) + req.amount;
                    batch.update(teamRef, { balance: newBal });
                    postNews(`üí∞ **INJE√á√ÉO DE CAPITAL**\n\nO **${req.teamName}** recebeu um aporte de ${fmt(req.amount)}.\nüìù Motivo: ${req.details}`, 'plus');
                } else if (req.type === 'SPONSORSHIP') {
                    batch.update(teamRef, { sponsorship: { name: req.details, value: req.amount } });
                    postNews(`ü§ù **NOVO PATROC√çNIO**\n\nO **${req.teamName}** fechou contrato com **${req.details}**.\nüíµ Valor Semanal: ${fmt(req.amount)}`, 'infra');
                }
                
                batch.update(reqRef, { status: 'APPROVED' });
                await batch.commit();
                alert("Aprovado com sucesso!");
            };

            const processWeeklyFinances = async () => {
                if(!confirm("TEM CERTEZA? Isso vai pagar patroc√≠nios e COBRAR SAL√ÅRIOS de todos os times!")) return;
                setLoading(true);
                const batch = db.batch();
                teams.forEach(t => {
                    const teamPlayers = players.filter(p => p.teamId === t.id);
                    const totalSalary = teamPlayers.reduce((acc, p) => acc + (p.salary || 0), 0);
                    const sponsorIncome = t.sponsorship ? t.sponsorship.value : 0;
                    const netChange = sponsorIncome - totalSalary;
                    const newBalance = (t.balance || 0) + netChange;
                    const teamRef = db.collection('teams').doc(t.id);
                    batch.update(teamRef, { balance: newBalance });
                });
                await batch.commit();
                postNews(`üìÖ **VIRADA DE SEMANA FINANCEIRA**\n\n‚úÖ Patroc√≠nios pagos.\nüîª Sal√°rios debitados.\n\nConfiram seus caixas!`, 'admin');
                setLoading(false);
                alert("Semana processada com sucesso!");
            };

            const adminUpdateBalance = (team) => {
                const newVal = prompt(`Saldo Atual de ${team.name}: ${fmt(team.balance)}\n\nDigite o NOVO valor exato:`);
                if(newVal === null) return;
                db.collection('teams').doc(team.id).update({ balance: parseFloat(newVal) });
                alert("Saldo atualizado pelo ADMIN!");
            };

            const adminDeleteTeam = async (team) => {
                if(!confirm(`PERIGO! ‚õî\nIsso excluir√° o time ${team.name} e TODOS os seus jogadores.\nTem certeza absoluta?`)) return;
                const batch = db.batch();
                batch.delete(db.collection('teams').doc(team.id));
                const pSnap = await db.collection('players').where('teamId', '==', team.id).get();
                pSnap.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                alert("Time e Elenco Exclu√≠dos!");
            };

            const addPlayer = (name, pos, ov, val, sal, clause, seasons, mood) => {
                const targetTeamId = isAdmin && adminViewingTeam ? adminViewingTeam.id : userTeam.id;
                const targetTeamName = isAdmin && adminViewingTeam ? adminViewingTeam.name : userTeam.name;
                const s = parseInt(seasons);
                if(s < 1 || s > 10) return alert("Temporadas deve ser entre 1 e 10!");
                
                db.collection('players').add({ name, position: pos, overall: parseInt(ov), value: parseFloat(val), salary: parseFloat(sal), clause: parseFloat(clause), contract: s, mood: mood || 'üòê', status: 'NAO_A_VENDA', teamId: targetTeamId, loan: false }).then(() => {
                    postNews(`üÜï **REFOR√áO NO ${targetTeamName.toUpperCase()}!**\n\nüë§ **${name}** (${pos})\n‚≠ê Overall: ${ov}\nüí∞ Sal√°rio: ${fmt(sal)}`, 'new-player');
                });
            };

            const updatePlayer = (pid, st, pos, val, ov, sal, clause, seasons, forcedTeamId, mood) => {
                const s = parseInt(seasons);
                if(s < 1 || s > 10) return alert("Temporadas deve ser entre 1 e 10!");
                let updateData = { status: st, position: pos, value: parseFloat(val), overall: parseInt(ov), salary: parseFloat(sal), clause: parseFloat(clause), contract: s, mood: mood };
                if (isAdmin && forcedTeamId) {
                    updateData.teamId = forcedTeamId;
                    updateData.loan = false;
                    const destTeam = teams.find(t => t.id === forcedTeamId);
                    postNews(`üëÆ‚Äç‚ôÇÔ∏è **INTERVEN√á√ÉO DA FEDERA√á√ÉO**\n\nO jogador foi transferido compulsoriamente para o **${destTeam ? destTeam.name : 'Outro Time'}**.`, 'admin');
                }
                db.collection('players').doc(pid).update(updateData);
                if(isAdmin) alert("Dados atualizados!");
            };

            const deletePlayer = async (pid) => { if(confirm("Excluir jogador?")) await db.collection('players').doc(pid).delete(); };

            const updateClubData = (newName, newSerie, newLogo) => {
                const updateData = { name: newName, serie: newSerie };
                if(newLogo) updateData.logo = newLogo; 
                db.collection('teams').doc(userTeam.id).update(updateData);
                setUserTeam({...userTeam, ...updateData});
                alert("Atualizado!"); setShowAdmin(false);
            };

            const upgradeStadium = () => {
                const currentLvl = userTeam.stadiumLevel || 1;
                if(currentLvl >= 5) return alert("M√°ximo!");
                const cost = STADIUM_COSTS[currentLvl];
                if(userTeam.balance < cost) return alert("Sem saldo!");
                if(!confirm(`Pagar ${fmt(cost)}?`)) return;
                const newBal = userTeam.balance - cost;
                db.collection('teams').doc(userTeam.id).update({ balance: newBal, stadiumLevel: currentLvl + 1 });
                setUserTeam({...userTeam, balance: newBal, stadiumLevel: currentLvl + 1});
                postNews(`üèó **OBRAS NO ${userTeam.name.toUpperCase()}!**\n\nO clube inaugurou sua nova casa: N√≠vel ${currentLvl + 1}.`, 'infra');
                alert("Sucesso!"); setShowAdmin(false);
            };

            const advanceSeason = async () => {
                if(!confirm("TEM CERTEZA QUE DESEJA VIRAR A TEMPORADA?")) return;
                setLoading(true);
                const snapshot = await db.collection('players').get();
                const batch = db.batch();
                let moved = 0, expired = 0;
                snapshot.docs.forEach(doc => {
                    const p = doc.data();
                    let newContract = (p.contract || 0) - 1;
                    if(newContract < 0) newContract = 0;
                    if (newContract === 0 && p.preContract) {
                        batch.update(doc.ref, { contract: 1, teamId: p.preContract.teamId, status: 'NAO_A_VENDA', preContract: firebase.firestore.FieldValue.delete(), loan: false });
                        moved++;
                    } else {
                        let newStatus = p.status;
                        if(newContract === 0) { newStatus = 'EXPIRADO'; expired++; }
                        batch.update(doc.ref, { contract: newContract, status: newStatus });
                    }
                });
                await batch.commit();
                postNews(`üìÖ **TEMPORADA ENCERRADA!**\n\nUm novo ciclo come√ßa.\nüîÑ Jogadores transferidos: ${moved}\n‚ö† Contratos expirados: ${expired}`, 'season');
                setLoading(false); alert("Temporada conclu√≠da!");
            };

            const signPreContract = (player) => {
                if(player.contract > 1) return alert("Contrato longo demais!");
                if(!confirm(`Assinar PR√â-CONTRATO com ${player.name}?`)) return;
                db.collection('players').doc(player.id).update({ preContract: { teamId: userTeam.id, teamName: userTeam.name } });
                alert("Assinado!");
                postNews(`üìú **PR√â-CONTRATO ASSINADO!**\n\nO ${userTeam.name} se antecipou e garantiu **${player.name}** para a pr√≥xima temporada!`, 'transfer');
            };

            const buyViaClause = (player) => {
                if(userTeam.balance < player.clause) return alert("Sem dinheiro!");
                const c = parseInt(prompt("Novo Contrato (1-10):"));
                if(!c || c < 1 || c > 10) return;
                const seller = teams.find(t => t.id === player.teamId);
                const batch = db.batch();
                batch.update(db.collection('teams').doc(userTeam.id), { balance: userTeam.balance - player.clause });
                if(seller) batch.update(db.collection('teams').doc(seller.id), { balance: seller.balance + player.clause });
                batch.update(db.collection('players').doc(player.id), { teamId: userTeam.id, status: 'NAO_A_VENDA', loan: false, contract: c });
                batch.commit();
                postNews(`üí£ **MULTA PAGA!**\n\n${userTeam.name} depositou ${fmt(player.clause)} e tirou **${player.name}** do rival sem negocia√ß√£o!`, 'transfer');
                setUserTeam({...userTeam, balance: userTeam.balance - player.clause});
            };

            const sendComplexOffer = async (targetPlayer, type, value, swapPlayerId, seasons, oldOffer) => {
                let desc = "", swapPName = "";
                let offerValue = parseFloat(value || 0);
                
                if(type === 'COMPRA') desc = `Compra: ${fmt(offerValue)}\nüìÑ Contrato: ${seasons} T.`;
                if(type === 'EMPRESTIMO') {
                    let dur = seasons === '0.5' ? 'Meia Temporada' : seasons + ' Temporada(s)';
                    desc = `Empr√©stimo (Taxa: ${fmt(offerValue)})\n‚è≥ Dura√ß√£o: ${dur}`;
                }
                if(type === 'TROCA') {
                    const myP = players.find(p => p.id === swapPlayerId);
                    swapPName = myP.name;
                    desc = `Troca: ${fmt(offerValue)} + ${myP.name}\nüìÑ Contrato: ${seasons} T.`;
                }
                
                const batch = db.batch();
                if(oldOffer) batch.delete(db.collection('offers').doc(oldOffer.id)); 

                const newOfferRef = db.collection('offers').doc();
                let recipientId = oldOffer ? oldOffer.buyerId : targetPlayer.teamId;

                batch.set(newOfferRef, {
                    playerId: targetPlayer.id, playerName: targetPlayer.name,
                    buyerId: userTeam.id, buyerName: userTeam.name,
                    sellerId: recipientId,
                    type,
                    value: offerValue, swapPlayerId: swapPlayerId || null, swapPlayerName: swapPName || null,
                    offerContract: seasons, description: desc
                });

                await batch.commit();

                const recipientTeam = teams.find(t => t.id === recipientId);
                const recipientName = recipientTeam ? recipientTeam.name : "Rival";
                const title = oldOffer ? "üîÑ **R√âPLICA (CONTRAPROPOSTA)**" : "üö® **PLANT√ÉO URGENTE: PROPOSTA!**";
                const newsMsg = `${title}\n\nO **${userTeam.name}** enviou uma oferta oficial por **${targetPlayer.name}**!\n\nüìã **Detalhes:**\n${desc}\n\n‚è≥ A bola agora est√° com o **${recipientName}**!`;
                postNews(newsMsg, 'transfer');

                alert("Proposta enviada!"); setOfferModal(null); setShowNotif(false);
            };

            const acceptOffer = async (offer) => {
                const buyer = teams.find(t => t.id === offer.buyerId);
                const player = players.find(p => p.id === offer.playerId);
                
                if(!player || !buyer) { deleteOffer(offer); return; }
                const batch = db.batch();

                if(offer.type === 'COMPRA') {
                    if(buyer.balance < offer.value) return alert("Comprador sem saldo!");
                    batch.update(db.collection('teams').doc(buyer.id), { balance: buyer.balance - offer.value });
                    batch.update(db.collection('teams').doc(userTeam.id), { balance: userTeam.balance + offer.value });
                    batch.update(db.collection('players').doc(player.id), { teamId: buyer.id, status: 'NAO_A_VENDA', loan: false, contract: parseInt(offer.offerContract) });
                    postNews(`ü§ù **NEG√ìCIO FECHADO!**\n\nFim da novela! O **${userTeam.name}** ACEITOU a proposta.\n\n${buyer.name} contrata **${player.name}** por ${fmt(offer.value)}.`, 'transfer');
                } else if(offer.type === 'EMPRESTIMO') {
                    if(offer.value > 0) {
                        if(buyer.balance < offer.value) return alert("Comprador sem saldo para a taxa!");
                        batch.update(db.collection('teams').doc(buyer.id), { balance: buyer.balance - offer.value });
                        batch.update(db.collection('teams').doc(userTeam.id), { balance: userTeam.balance + offer.value });
                    }
                    batch.update(db.collection('players').doc(player.id), { teamId: buyer.id, status: 'NAO_A_VENDA', loan: true, loanFrom: userTeam.id });
                    postNews(`üîÑ **EMPR√âSTIMO ACEITO**\n\n${buyer.name} refor√ßa o elenco com **${player.name}** via empr√©stimo.`, 'transfer');
                } else if(offer.type === 'TROCA') {
                    if(buyer.balance < offer.value) return alert("Sem saldo!");
                    const swapP = players.find(p => p.id === offer.swapPlayerId);
                    batch.update(db.collection('teams').doc(buyer.id), { balance: buyer.balance - offer.value });
                    batch.update(db.collection('teams').doc(userTeam.id), { balance: userTeam.balance + offer.value });
                    batch.update(db.collection('players').doc(player.id), { teamId: buyer.id, status: 'NAO_A_VENDA', loan: false, contract: offer.offerContract });
                    batch.update(db.collection('players').doc(swapP.id), { teamId: userTeam.id, status: 'NAO_A_VENDA', loan: false });
                    postNews(`üîÄ **TROCA CONCLU√çDA**\n\nNeg√≥cio complexo finalizado!\n${buyer.name} leva: **${player.name}**\n${userTeam.name} leva: **${swapP.name}**`, 'transfer');
                }
                batch.delete(db.collection('offers').doc(offer.id));
                await batch.commit(); alert("Fechado!"); setShowNotif(false);
            };

            const deleteOffer = async (offer) => { 
                if(confirm("Recusar esta proposta?")) {
                    await db.collection('offers').doc(offer.id).delete();
                    postNews(`‚ùå **NEG√ìCIO MELADO!**\n\nO **${userTeam.name}** disse "N√ÉO" e RECUSOU a investida do **${offer.buyerName}** pelo jogador **${offer.playerName}**.`, 'minus');
                }
            };
            
            const handleCounterOffer = (offer) => {
                const p = players.find(pl => pl.id === offer.playerId);
                if(!p) return alert("Jogador n√£o encontrado!");
                setOfferModal({ ...p, isCounter: true, oldOffer: offer, oldVal: offer.value });
                setShowNotif(false);
            };

            const doLogout = () => { localStorage.removeItem('myTeamId'); window.location.reload(); };

            if(loading) return <div style={{padding:20}}>Carregando Manager...</div>;
            if(!userTeam) return <LoginScreen teams={teams} onLogin={handleLogin} onCreate={handleCreateTeam} onUpload={handleImageUpload} onAdminLogin={handleAdminLogin} onVisitorLogin={handleVisitorLogin} />;
            return (
                <div>
                    <div className="header">
                        <div style={{display:'flex', alignItems:'center', gap:10}}>
                            {!isAdmin && userTeam.logo && <img src={userTeam.logo} className="team-logo" alt="Logo" />}
                            <div>
                                <b>{userTeam.name}</b> {isAdmin && <span style={{color:'red'}}>(MODO DEUS)</span>} {isVisitor && <span style={{color:'#00E676'}}>(TORCIDA)</span>}
                                {!isAdmin && !isVisitor && <div style={{fontSize:10, color: fairPlayAlert ? '#ff5252' : '#888'}}>Folha: {fmt(myPayroll)} {fairPlayAlert && <b>(ALTO RISCO!)</b>}</div>}
                            </div>
                        </div>
                        <div style={{display:'flex', alignItems:'center', gap:15}}>
                            {!isAdmin && !isVisitor && (
                                <div style={{position:'relative', cursor:'pointer'}} onClick={()=>setShowNotif(true)}>
                                    <i className="fas fa-bell" style={{fontSize:20, color: offers.length > 0 ? '#ffeb3b' : '#888'}}></i>
                                    {offers.length > 0 && <span className="badge-count">{offers.length}</span>}
                                </div>
                            )}
                            {!isVisitor && (
                                <span style={{color: fairPlayAlert ? '#ff5252' : '#00E676', fontWeight:'bold'}}>{isAdmin ? '‚àû' : fmt(userTeam.balance)}</span>
                            )}
                            {!isVisitor && <i className="fas fa-cog" style={{fontSize:20, color:'#888'}} onClick={()=>setShowAdmin(true)}></i>}
                            {isVisitor && <i className="fas fa-sign-out-alt" style={{fontSize:20, color:'#888'}} onClick={doLogout}></i>}
                        </div>
                    </div>

                    <div className="container">
                        {screen === 'HOME' && (
                            <div>
                                {isAdmin ? (
                                    <div className="card">
                                        <h3>üëë PAINEL MASTER</h3>
                                        <p style={{color:'#888', fontSize:12}}>Gerencie o mundo do futebol.</p>
                                        
                                        <div style={{background:'#252525', padding:10, borderRadius:8, marginBottom:15, display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                            <span style={{color: systemConfig.marketOpen ? '#00E676' : '#FF5722', fontWeight:'bold'}}>
                                                {systemConfig.marketOpen ? 'üü¢ MERCADO ABERTO' : 'üî¥ MERCADO FECHADO'}
                                            </span>
                                            <button className="btn" style={{width:'auto', margin:0, padding:'5px 10px', background: systemConfig.marketOpen ? '#d32f2f' : '#00E676'}} onClick={toggleMarket}>
                                                {systemConfig.marketOpen ? 'FECHAR' : 'ABRIR'}
                                            </button>
                                        </div>

                                        {/* APROVA√á√ÉO DE TIMES PENDENTES */}
                                        <div style={{background:'#2a1b1b', padding:10, borderRadius:8, marginBottom:15, border:'1px solid #FF5722'}}>
                                            <h4 style={{margin:0, marginBottom:5, color:'#FF5722'}}>An√°lise de Novos Times</h4>
                                            {teams.filter(t => t.status === 'PENDING').length === 0 && <p style={{fontSize:12, color:'#666'}}>Nenhum time pendente.</p>}
                                            {teams.filter(t => t.status === 'PENDING').map(t => (
                                                <div key={t.id} style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginTop:5}}>
                                                    <div><b>{t.name}</b><br/><small>{fmt(t.balance)}</small></div>
                                                    <div>
                                                        <button className="btn-green" style={{padding:'2px 8px', fontSize:10, marginRight:5}} onClick={()=>adminUpdateBalance(t)}>EDITAR $</button>
                                                        <button className="btn-blue" style={{padding:'2px 8px', fontSize:10}} onClick={()=>adminApproveTeam(t)}>APROVAR</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        <div style={{background:'#252525', padding:10, borderRadius:8, marginBottom:15}}>
                                            <h4 style={{margin:0, marginBottom:10}}>Solicita√ß√µes Financeiras</h4>
                                            {financeRequests.filter(r => r.status === 'PENDING').length === 0 && <p style={{fontSize:12, color:'#666'}}>Nenhuma solicita√ß√£o.</p>}
                                            {financeRequests.filter(r => r.status === 'PENDING').map(req => (
                                                <div key={req.id} style={{borderBottom:'1px solid #444', paddingBottom:5, marginBottom:5}}>
                                                    <div style={{fontSize:12}}><b>{req.teamName}</b> pede {req.type === 'SPONSORSHIP' ? 'Patroc√≠nio' : 'Inje√ß√£o'}:</div>
                                                    <div style={{color:'#00E676'}}>{fmt(req.amount)}</div>
                                                    <div style={{fontSize:11, color:'#aaa'}}>"{req.details}"</div>
                                                    <div style={{display:'flex', gap:5, marginTop:5}}>
                                                        <button className="btn-green" style={{padding:'2px 8px', fontSize:10}} onClick={()=>handleFinanceRequest(req, 'APPROVE')}>‚úî APROVAR</button>
                                                        <button className="btn-red" style={{padding:'2px 8px', fontSize:10}} onClick={()=>handleFinanceRequest(req, 'REJECT')}>‚úñ NEGAR</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        <button className="btn btn-purple" style={{margin:0, fontSize:10}} onClick={processWeeklyFinances}>üìÖ VIRAR SEMANA (DOMINGO)</button>
                                        <button className="btn btn-red" style={{marginTop:15}} onClick={advanceSeason}>VIRAR TEMPORADA AGORA</button>
                                        <div style={{marginTop:15}}>
                                            {teams.filter(t => t.status !== 'PENDING').map(t => (
                                                <div key={t.id} style={{padding:10, borderBottom:'1px solid #333', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                                    <span>{t.name}</span>
                                                    <div>
                                                        <button className="btn btn-purple" style={{width:'auto', padding:'5px 10px', fontSize:10, marginRight:5}} onClick={()=>{setAdminViewingTeam(t); setScreen('ADMIN_SQUAD');}}>üë• ELENCO</button>
                                                        <button className="btn btn-green" style={{width:'auto', padding:'5px 10px', fontSize:10, marginRight:5}} onClick={()=>adminUpdateBalance(t)}>üí≤</button>
                                                        <button className="btn btn-red" style={{width:'auto', padding:'5px 10px', fontSize:10}} onClick={()=>adminDeleteTeam(t)}>üóë</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ) : isVisitor ? (
                                    <div style={{textAlign:'center', padding:20, color:'#888'}}>
                                        <h3>Bem-vindo, Torcedor!</h3>
                                        <p>Use o menu abaixo para ver o Ranking e os Elencos.</p>
                                    </div>
                                ) : (
                                    <div>
                                        <div className="card" style={{background: 'linear-gradient(45deg, #1a1a1a, #2c2c2c)', borderLeft:'4px solid #9C27B0'}}>
                                            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                                <div><small style={{color:'#9C27B0', fontWeight:'bold'}}>EST√ÅDIO (Nvl {userTeam.stadiumLevel || 1})</small><div style={{fontSize:16, fontWeight:'bold'}}>{STADIUM_NAMES[(userTeam.stadiumLevel || 1) - 1]}</div></div>
                                                <button className="btn btn-purple" style={{width:'auto', padding:'5px 10px', fontSize:10, marginTop:0}} onClick={()=>setShowAdmin(true)}>EVOLUIR <i className="fas fa-arrow-up"></i></button>
                                            </div>
                                            
                                            <div style={{marginTop:10, padding:10, background:'#252525', borderRadius:8, display:'flex', alignItems:'center', justifyContent:'space-between'}}>
                                                <span style={{fontSize:12, color: userTeam.allowOffers !== false ? '#00E676' : '#FF5722'}}>
                                                    {userTeam.allowOffers !== false ? 'üü¢ PROPOSTAS: ON' : 'üî¥ PROPOSTAS: OFF'}
                                                </span>
                                                <label className="switch">
                                                    <input type="checkbox" checked={userTeam.allowOffers !== false} onChange={() => { const ns = !userTeam.allowOffers; db.collection('teams').doc(userTeam.id).update({allowOffers: ns}); setUserTeam({...userTeam, allowOffers: ns}); }} />
                                                    <span className="slider"></span>
                                                </label>
                                            </div>
                                        </div>
                                        <MyTeam ps={players.filter(p => p.teamId === userTeam.id)} onAdd={addPlayer} onUpd={updatePlayer} onDel={deletePlayer} readOnly={false} isAdmin={false} allTeams={teams} />
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {screen === 'ADMIN_SQUAD' && isAdmin && adminViewingTeam && (
                            <div>
                                <button className="btn" style={{background:'#333', marginBottom:10}} onClick={()=>setScreen('HOME')}>‚¨Ö VOLTAR AO PAINEL</button>
                                <h3 style={{textAlign:'center', color:'#FFD700'}}>Editando: {adminViewingTeam.name}</h3>
                                <MyTeam ps={players.filter(p => p.teamId === adminViewingTeam.id)} onAdd={addPlayer} onUpd={updatePlayer} onDel={deletePlayer} readOnly={false} isAdmin={true} allTeams={teams} />
                            </div>
                        )}

                        {screen === 'MARKET' && <Market me={userTeam.id} teams={teams} ps={players} onOpenOffer={(p)=>setOfferModal(p)} onPayClause={buyViaClause} onPreContract={signPreContract} isVisitor={isVisitor || isAdmin} marketOpen={systemConfig.marketOpen} />}
                        {screen === 'RANKING' && <Ranking teams={teams} players={players} />}
                        {screen === 'NEWS' && (
                            <div>
                                <h3>Plant√£o de Not√≠cias üì∞</h3>
                                {news.map(n => <div key={n.id} className={`news-card ${n.type==='plus'?'news-money-plus':n.type==='minus'?'news-money-minus':n.type==='transfer'?'news-transfer':n.type==='season'?'news-season':n.type==='infra'?'news-infra':n.type==='admin'?'news-admin':'news-new-player'}`}><span className="news-date">{new Date(n.date).toLocaleDateString()}</span>{n.text}</div>)}
                            </div>
                        )}
                    </div>

                    <div className="bottom-nav">
                        <div className={`nav-item ${screen==='HOME'?'active':''}`} onClick={()=>setScreen('HOME')}><i className="fas fa-home"></i>{isAdmin ? 'ADMIN' : isVisitor ? 'IN√çCIO' : 'MEU TIME'}</div>
                        <div className={`nav-item ${screen==='MARKET'?'active':''}`} onClick={()=>setScreen('MARKET')}><i className="fas fa-globe"></i>MERCADO</div>
                        <div className={`nav-item ${screen==='RANKING'?'active':''}`} onClick={()=>setScreen('RANKING')}><i className="fas fa-trophy"></i>RANKING</div>
                        <div className={`nav-item ${screen==='NEWS'?'active':''}`} onClick={openNewsScreen}>
                            <i className="fas fa-newspaper"></i>
                            {hasNewNews && <span className="news-badge"></span>}
                            NOT√çCIAS
                        </div>
                    </div>

                    {showAdmin && !isAdmin && !isVisitor && <AdminModal currName={userTeam.name} currSerie={userTeam.serie} currLogo={userTeam.logo} stadiumLvl={userTeam.stadiumLevel || 1} onSaveData={updateClubData} onFinanceReq={requestFinance} onUserPay={userPayBill} onUpgradeStadium={upgradeStadium} onClose={()=>setShowAdmin(false)} onLogout={doLogout} onUpload={handleImageUpload} sponsorship={userTeam.sponsorship} />}
                    {showAdmin && isAdmin && <div className="modal-bg"><div className="modal-card"><button className="btn btn-red" onClick={doLogout}>SAIR DO MODO ADMIN</button><button className="btn" onClick={()=>setShowAdmin(false)}>FECHAR</button></div></div>}
                    
                    {showNotif && (
                        <div className="modal-bg">
                            <div className="modal-card">
                                <h3>Propostas ({offers.length})</h3>
                                {offers.map(o => (
                                    <div key={o.id} style={{background:'#252525', padding:10, marginBottom:10}}>
                                        <div style={{color:'#00E676'}}>{o.playerName}</div>
                                        <div style={{fontSize:12}}>De: <b>{o.buyerName}</b></div>
                                        <div style={{fontSize:14, margin:'5px 0'}}>{o.description}</div>
                                        <div style={{display:'flex', gap:10}}>
                                            <button className="btn btn-green" style={{fontSize:10}} onClick={()=>acceptOffer(o)}>ACEITAR</button>
                                            <button className="btn btn-blue" style={{fontSize:10}} onClick={()=>handleCounterOffer(o)}>üîÑ CONTRAPROPOSTA</button>
                                            <button className="btn btn-red" style={{fontSize:10}} onClick={()=>deleteOffer(o)}>RECUSAR</button>
                                        </div>
                                    </div>
                                ))}
                                <button className="btn" onClick={()=>setShowNotif(false)}>FECHAR</button>
                            </div>
                        </div>
                    )}
                    {offerModal && <OfferForm target={offerModal} myPlayers={players.filter(p => p.teamId === userTeam.id && !p.loan)} onSend={sendComplexOffer} onClose={()=>setOfferModal(null)} />}
                </div>
            );
        }

        // --- SUB-COMPONENTES ATUALIZADOS ---

        function Ranking({ teams, players }) {
            const list = teams.filter(t => t.status === 'APPROVED').map(t => {
                const teamPlayers = players.filter(p => p.teamId === t.id);
                const squadValue = teamPlayers.reduce((acc, p) => acc + (p.value || 0), 0);
                const payroll = teamPlayers.reduce((acc, p) => acc + (p.salary || 0), 0);
                const totalWealth = t.balance + squadValue;
                return { ...t, squadValue, payroll, totalWealth };
            }).sort((a,b) => b.totalWealth - a.totalWealth);
            return (
                <div>
                    <h3>üèÜ Ranking de Bilion√°rios</h3>
                    {list.map((t, i) => (
                        <div key={t.id} className="rank-item">
                            <div style={{display:'flex', alignItems:'center', gap:10}}>
                                <span className={`rank-pos rank-${i+1}`}>{i+1}¬∫</span>
                                {t.logo ? <img src={t.logo} className="rank-logo" /> : <div className="rank-logo" style={{background:'#555'}}></div>}
                                <div><div style={{fontWeight:'bold'}}>{t.name}</div><div style={{fontSize:12, color:'#00E676'}}>Patrim√¥nio: ‚Ç£ {t.totalWealth.toLocaleString()}</div></div>
                            </div>
                            <div className="rank-details">
                                <div>üí∞ Caixa: ‚Ç£ {t.balance.toLocaleString()}</div>
                                <div>üëï Elenco: ‚Ç£ {t.squadValue.toLocaleString()}</div>
                            </div>
                            <div className="rank-details" style={{borderTop:'none', paddingTop:0, color:'#FF5722'}}>
                                üìÑ Folha Salarial: ‚Ç£ {t.payroll.toLocaleString()} / m√™s
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        function AdminModal({ currName, currSerie, currLogo, stadiumLvl, onSaveData, onFinanceReq, onUserPay, onUpgradeStadium, onClose, onLogout, onUpload, sponsorship }) {
            const [tab, setTab] = useState('DATA'); 
            const [n, setN] = useState(currName); const [s, setS] = useState(currSerie); const [logo, setLogo] = useState(currLogo); 
            
            const [reqType, setReqType] = useState('INJECTION'); 
            const [reqAmount, setReqAmount] = useState('');
            const [reqDetails, setReqDetails] = useState('');

            // Novo: Estado para pagamento de despesas
            const [payAmount, setPayAmount] = useState('');
            const [payReason, setPayReason] = useState('');

            const nextCost = STADIUM_COSTS[stadiumLvl] || 0;
            const nextName = STADIUM_NAMES[stadiumLvl] || "M√°ximo";
            const isMax = stadiumLvl >= 5;
            
            return (
                <div className="modal-bg">
                    <div className="modal-card">
                        <h3 style={{textAlign:'center'}}>Gest√£o do Clube</h3>
                        <div className="login-tabs" style={{marginBottom:15}}><div className={`tab ${tab==='DATA'?'active':''}`} onClick={()=>setTab('DATA')}>DADOS</div><div className={`tab ${tab==='MONEY'?'active':''}`} onClick={()=>setTab('MONEY')}>FINAN√áAS</div></div>
                        
                        {tab === 'DATA' ? (
                            <div>{logo && <img src={logo} className="login-logo-img" style={{marginBottom:10}} />}<label>Alterar Escudo (Max 200KB)</label><input type="file" className="file-input" accept="image/*" onChange={(e) => onUpload(e, (base64) => setLogo(base64))} /><label>Nome do Clube</label><input className="input-field" value={n} onChange={e=>setN(e.target.value)} /><label>S√©rie</label><select className="input-field" value={s} onChange={e=>setS(e.target.value)}><option>A</option><option>B</option><option>C</option><option>D</option></select><button className="btn btn-blue" onClick={()=>onSaveData(n, s, logo)}>SALVAR DADOS</button><hr style={{borderColor:'#444', margin:'15px 0'}}/><div style={{background:'#2a1b2a', padding:10, borderRadius:8, border:'1px solid #9C27B0'}}><h4 style={{margin:'0 0 10px 0', color:'#9C27B0'}}>üèü Obras do Est√°dio</h4><p style={{fontSize:12}}>Atual: <b>{STADIUM_NAMES[stadiumLvl-1]}</b></p>{!isMax ? (<div><p style={{fontSize:12}}>Evoluir para: <b>{nextName}</b></p><button className="btn btn-purple" onClick={onUpgradeStadium}>PAGAR ‚Ç£ {nextCost.toLocaleString()}</button></div>) : <p style={{color:'#00E676', fontSize:12}}>N√≠vel M√°ximo Atingido!</p>}</div></div>
                        ) : (
                            <div>
                                <div style={{background:'#222', padding:10, borderRadius:5, marginBottom:15}}>
                                    <small style={{color:'#aaa'}}>Patroc√≠nio Atual:</small><br/>
                                    {sponsorship ? <span style={{color:'#00E676', fontWeight:'bold'}}>{sponsorship.name} (‚Ç£ {parseFloat(sponsorship.value).toLocaleString()}/sem)</span> : <span style={{color:'#666'}}>Nenhum.</span>}
                                </div>

                                <h4 style={{margin:'0 0 10px 0'}}>üí∞ Solicitar Verba (Entrada)</h4>
                                <select className="input-field" value={reqType} onChange={e=>setReqType(e.target.value)}>
                                    <option value="INJECTION">Inje√ß√£o R√°pida (Cai na hora)</option>
                                    <option value="SPONSORSHIP">Novo Patroc√≠nio (Semanal)</option>
                                </select>
                                <label>Valor (‚Ç£)</label>
                                <input className="input-field" type="number" placeholder="Ex: 500000" value={reqAmount} onChange={e=>setReqAmount(e.target.value)} />
                                <label>{reqType === 'SPONSORSHIP' ? 'Nome do Patrocinador' : 'Motivo da Inje√ß√£o'}</label>
                                <input className="input-field" placeholder={reqType === 'SPONSORSHIP' ? 'Ex: Nike' : 'Ex: Premia√ß√£o T√≠tulo'} value={reqDetails} onChange={e=>setReqDetails(e.target.value)} />
                                <button className="btn btn-green" onClick={()=>{onFinanceReq(reqType, reqAmount, reqDetails); onClose();}}>ENVIAR SOLICITA√á√ÉO</button>

                                <hr style={{borderColor:'#444', margin:'20px 0'}}/>

                                <h4 style={{margin:'0 0 10px 0', color:'#d32f2f'}}>üí∏ Pagar Despesa (Sa√≠da)</h4>
                                <label>Valor a Pagar (‚Ç£)</label>
                                <input className="input-field" type="number" placeholder="Ex: 50000" value={payAmount} onChange={e=>setPayAmount(e.target.value)} />
                                <label>Motivo do Pagamento</label>
                                <input className="input-field" placeholder="Ex: Cirurgia Jogador, Multa..." value={payReason} onChange={e=>setPayReason(e.target.value)} />
                                <button className="btn btn-red" onClick={()=>{onUserPay(payAmount, payReason); onClose();}}>PAGAR AGORA</button>
                            </div>
                        )}
                        <hr style={{borderColor:'#444', margin:'15px 0'}}/><button className="btn" style={{background:'#444', color:'white'}} onClick={onClose}>FECHAR</button><button className="btn btn-red" style={{marginTop:10}} onClick={onLogout}>SAIR (LOGOUT)</button>
                    </div>
                </div>
            );
        }

        function OfferForm({ target, myPlayers, onSend, onClose }) {
            const [type, setType] = useState('COMPRA'); 
            const [val, setVal] = useState(target.oldVal || ''); 
            const [swapId, setSwapId] = useState('');
            const [seas, setSeas] = useState('1');
            return (
                <div className="modal-bg">
                    <div className="modal-card">
                        <h3>{target.isCounter ? 'üîÑ Contraproposta' : 'Negociar'} {target.name}</h3>
                        <div style={{display:'flex', gap:5, marginBottom:15}}>
                            <button className="btn" style={{background: type==='COMPRA'?'#00E676':'#333', color: type==='COMPRA'?'black':'white', padding:8, fontSize:10}} onClick={()=>setType('COMPRA')}>COMPRA</button>
                            <button className="btn" style={{background: type==='EMPRESTIMO'?'#00E676':'#333', color: type==='EMPRESTIMO'?'black':'white', padding:8, fontSize:10}} onClick={()=>setType('EMPRESTIMO')}>EMPR√âSTIMO</button>
                            <button className="btn" style={{background: type==='TROCA'?'#00E676':'#333', color: type==='TROCA'?'black':'white', padding:8, fontSize:10}} onClick={()=>setType('TROCA')}>TROCA</button>
                        </div>
                        
                        {type === 'COMPRA' && <div><label>Valor (‚Ç£):</label><input className="input-field" type="number" value={val} onChange={e=>setVal(e.target.value)} /></div>}
                        
                        {type === 'EMPRESTIMO' && (
                            <div>
                                <label style={{color:'#00E676'}}>Valor pelo Empr√©stimo (Taxa):</label>
                                <input className="input-field" type="number" placeholder="Ex: 50000 (Opcional)" value={val} onChange={e=>setVal(e.target.value)} />
                                <label>Dura√ß√£o do Empr√©stimo:</label>
                                <select className="input-field" value={seas} onChange={e=>setSeas(e.target.value)}>
                                    <option value="0.5">Meia Temporada (1/2)</option>
                                    <option value="1">1 Temporada Completa</option>
                                    <option value="2">2 Temporadas</option>
                                </select>
                            </div>
                        )}

                        {type === 'TROCA' && <div><label>Volta em Dinheiro:</label><input className="input-field" type="number" value={val} onChange={e=>setVal(e.target.value)} /><label>Seu Jogador:</label><select className="input-field" value={swapId} onChange={e=>setSwapId(e.target.value)}><option value="">Selecione...</option>{myPlayers.map(p => <option key={p.id} value={p.id}>{p.name} (Ov: {p.overall})</option>)}</select></div>}
                        
                        {type !== 'EMPRESTIMO' && (<div><label style={{color:'#2196F3'}}>Tempo de Contrato (1-10 Anos):</label><input className="input-field" type="number" value={seas} onChange={e=>setSeas(e.target.value)} /></div>)}
                        
                        <button className="btn btn-green" onClick={()=>onSend(target, type, val, swapId, seas, target.oldOffer)}>ENVIAR {target.isCounter ? 'CONTRAPROPOSTA' : 'PROPOSTA'}</button>
                        <button className="btn" style={{background:'#d32f2f', color:'white'}} onClick={onClose}>CANCELAR</button>
                    </div>
                </div>
            );
        }

        function Market({ me, teams, ps, onOpenOffer, onPayClause, onPreContract, isVisitor, marketOpen }) {
            const [viewMode, setViewMode] = useState('SERIES'); 
            const [serie, setSerie] = useState(''); 
            const [selTeam, setSelTeam] = useState(null);
            const [filter, setFilter] = useState('ALL');
            
            const isUserAdminOrVisitor = me === 'admin_user' || me === 'visitor_user';
            const POS_ORDER = { 'GOL': 1, 'ZAG': 2, 'LD': 3, 'LE': 4, 'VOL': 5, 'MC': 6, 'MEI': 7, 'ATA': 8 };

            if(viewMode === 'SERIES' && !serie) return (
                <div>
                    <h3>Mercado</h3>
                    <button className="btn btn-blue" onClick={()=>setViewMode('GLOBAL')}>üåé VER TODOS OS JOGADORES (Geral)</button>
                    <hr style={{borderColor:'#333', margin:'15px 0'}}/>
                    <p style={{textAlign:'center', color:'#888'}}>Ou navegue por S√©rie:</p>
                    {['A','B','C','D'].map(s => <div key={s} className="card" onClick={()=>setSerie(s)}><b>S√©rie {s}</b></div>)}
                </div>
            );

            if(viewMode === 'SERIES' && !selTeam) {
                const list = teams.filter(t => t.serie === serie && t.status === 'APPROVED' && (isUserAdminOrVisitor || t.id !== me));
                return (
                    <div>
                        <button className="btn" style={{background:'#333', color:'white', marginBottom:10}} onClick={()=>setSerie('')}>Voltar</button>
                        <h3>Clubes S√©rie {serie}</h3>
                        {list.map(t => (
                            <div key={t.id} className="card" onClick={()=>setSelTeam(t)}>
                                <div style={{display:'flex', alignItems:'center', gap:10}}>
                                    {t.logo ? <img src={t.logo} className="rank-logo" /> : <div className="rank-logo" style={{background:'#555'}}></div>}
                                    <div><b>{t.name}</b><br/><small>‚Ç£ {t.balance.toLocaleString()}</small></div>
                                </div>
                            </div>
                        ))}
                        {list.length === 0 && <p style={{textAlign:'center', color:'#666'}}>Sem rivais aqui.</p>}
                    </div>
                );
            }

            let playersToShow = [];
            let headerTitle = "";
            let backAction = null;

            if (viewMode === 'GLOBAL') {
                const validTeamsIds = teams.filter(t => t.status === 'APPROVED' && (isUserAdminOrVisitor || t.id !== me)).map(t => t.id);
                playersToShow = ps.filter(p => validTeamsIds.includes(p.teamId));
                headerTitle = "üåé Mercado Global";
                backAction = () => setViewMode('SERIES');
            } else {
                playersToShow = ps.filter(p => p.teamId === selTeam.id);
                headerTitle = selTeam.name;
                backAction = () => setSelTeam(null);
            }

            if (filter === 'VENDA') playersToShow = playersToShow.filter(p => p.status === 'VENDA');
            if (filter === 'EMPRESTIMO') playersToShow = playersToShow.filter(p => p.status === 'EMPRESTIMO');
            if (filter === 'BLOQUEADO') playersToShow = playersToShow.filter(p => p.status === 'INTRANSFERIVEL');
            
            playersToShow = playersToShow.sort((a,b) => (POS_ORDER[a.position]||99) - (POS_ORDER[b.position]||99));

            return (
                <div>
                    <button className="btn" style={{background:'#333', color:'white', marginBottom:10}} onClick={backAction}>Voltar</button>
                    <h3>{headerTitle} {marketOpen ? '' : '(üö´ FECHADO)'}</h3>
                    
                    <div className="market-filters">
                        <div className={`filter-btn ${filter==='ALL'?'active':''}`} onClick={()=>setFilter('ALL')}>Todos</div>
                        <div className={`filter-btn ${filter==='VENDA'?'active':''}`} onClick={()=>setFilter('VENDA')}>Venda</div>
                        <div className={`filter-btn ${filter==='EMPRESTIMO'?'active':''}`} onClick={()=>setFilter('EMPRESTIMO')}>Empr√©stimo</div>
                        <div className={`filter-btn ${filter==='BLOQUEADO'?'active':''}`} onClick={()=>setFilter('BLOQUEADO')}>Bloqueados</div>
                    </div>

                    {playersToShow.slice(0, 100).map(p => (
                        <div key={p.id} className="card">
                            <div className="player-header">
                                <span className="player-name">
                                    <span className="pos-badge" style={{background: getPosColor(p.position)}}>{p.position || '??'}</span>
                                    {p.name} {p.loan && <span className="loan-tag">(EMP)</span>} <span className="mood-icon">{p.mood || 'üòê'}</span>
                                    {viewMode === 'GLOBAL' && <small style={{fontSize:10, color:'#888', display:'block'}}>{teams.find(t=>t.id===p.teamId)?.name}</small>}
                                </span>
                                <span className="player-ov">{p.overall}</span>
                            </div>
                            <div className="player-details"><div className="detail-item">üí∞ Sal: ‚Ç£ {parseFloat(p.salary||0).toLocaleString()}</div><div className="detail-item">üíµ Pas: ‚Ç£ {parseFloat(p.value||0).toLocaleString()}</div><div className="detail-item">{p.status === 'EXPIRADO' || p.contract === 0 ? <span className="expired-tag">‚ö† EXPIRADO</span> : <span>üìÑ Con: {p.contract} T.</span>}</div><div className="detail-item">üîí Mul: {p.clause > 0 ? '‚Ç£ '+parseFloat(p.clause).toLocaleString() : '--'}</div></div>
                            
                            {!isVisitor && (
                                <div style={{marginTop:8}}>
                                    {p.clause > 0 && <button className="btn btn-gold" style={{marginBottom:5}} onClick={()=>onPayClause(p)}><i className="fas fa-bolt"></i> PAGAR MULTA</button>}
                                    {(p.contract <= 1 && !p.preContract) && <button className="btn btn-orange" style={{marginBottom:5}} onClick={()=>onPreContract(p)}>ASSINAR PR√â-CONTRATO</button>}
                                    
                                    {marketOpen && p.status !== 'INTRANSFERIVEL' ? (
                                        <button className="btn btn-purple" onClick={()=>onOpenOffer(p)}>NEGOCIAR</button>
                                    ) : (
                                        <button className="btn btn-outline" style={{color:'#666', cursor:'not-allowed'}}>‚õî BLOQUEADO</button>
                                    )}
                                </div>
                            )}
                        </div>
                    ))}
                    {playersToShow.length === 0 && <p style={{textAlign:'center', marginTop:20, color:'#666'}}>Nenhum jogador encontrado.</p>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
