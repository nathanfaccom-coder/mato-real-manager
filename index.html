<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gerenciador de Times de Mato Real</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #121212; --bg-card: #1E1E1E; --bg-input: #2C2C2C;
            --primary: #00E676; --secondary: #2979FF; --danger: #FF1744; --warning: #FFC400; --purple: #D500F9;
            --text-main: #FFFFFF; --border: #333333;
        }
        body { background: var(--bg-dark); color: var(--text-main); font-family: 'Roboto', sans-serif; margin: 0; padding-bottom: 80px; -webkit-font-smoothing: antialiased; }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        .card { background: var(--bg-card); padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.4); position: relative; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; transition: 0.2s; margin-bottom: 5px; color: white; }
        .btn:active { transform: scale(0.98); }
        .btn-green { background: var(--primary); color: #000; }
        .btn-blue { background: var(--secondary); }
        .btn-red { background: var(--danger); }
        .btn-gold { background: var(--warning); color: #000; }
        .btn-purple { background: var(--purple); }
        .btn-ghost { background: transparent; border: 1px solid #666; color: #ccc; }
        .input-field { width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border); color: white; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-family: inherit; font-size: 14px; }
        .input-field:focus { outline: 2px solid var(--primary); border-color: transparent; }
        .header { background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px); padding: 15px; position: sticky; top: 0; z-index: 50; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .badge-pos { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 900; margin-right: 8px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        .player-ov { background: #003300; color: #00E676; border: 1px solid #00E676; padding: 2px 6px; border-radius: 4px; font-weight: 900; font-size: 14px; }
        .news-card { background: #262626; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #666; font-size: 13px; line-height: 1.4; }
        .news-transfer { border-color: var(--secondary); background: linear-gradient(90deg, #1a1a2e, #16213e); }
        .news-money { border-color: var(--primary); }
        .news-admin { border-color: var(--warning); background: #2a2000; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; border-top: 1px solid var(--border); display: flex; padding-bottom: env(safe-area-inset-bottom); z-index: 100; }
        .nav-item { flex: 1; padding: 12px; text-align: center; color: #666; font-size: 9px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; display: block; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 999; display: grid; place-items: center; padding: 15px; backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-card); width: 100%; max-width: 450px; padding: 20px; border-radius: 12px; border: 1px solid var(--border); max-height: 90vh; overflow-y: auto; }
        .login-tabs { display: flex; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #666; font-weight: bold; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIG ---
        const firebaseConfig = { apiKey: "AIzaSyBrtJFfWAqT0AZYHlm4it-noB5h9jIPJEI", authDomain: "gerenciador-de-times-matoreal.firebaseapp.com", projectId: "gerenciador-de-times-matoreal", storageBucket: "gerenciador-de-times-matoreal.firebasestorage.app", messagingSenderId: "29096266740", appId: "1:29096266740:web:ec48e7225c18c20dbc07a1" };
        try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch (e) { console.error(e); }
        const db = firebase.firestore();
        const { useState, useEffect } = React;

        const STADIUMS = ["V√°rzea", "Est√°dio Municipal", "Arena Moderna", "Arena Mundial", "Templo do Futebol"];
        const COSTS = [0, 5000000, 20000000, 50000000, 100000000];
        const POS = ['GOL', 'ZAG', 'LD', 'LE', 'VOL', 'MC', 'MEI', 'ATA'];
        const SERIES = ['A', 'B', 'C', 'D'];

        const fmt = (v) => "‚Ç£ " + parseFloat(v||0).toLocaleString('pt-BR');
        const getPosColor = (p) => { if(!p) return '#555'; if(p==='GOL') return '#FFD700'; if(['ZAG','LD','LE'].some(x=>p.includes(x))) return '#2979FF'; if(['VOL','MC','MEI'].some(x=>p.includes(x))) return '#00E676'; return '#FF1744'; };

        // --- APP ---
        function App() {
            const [user, setUser] = useState(null); 
            const [teams, setTeams] = useState([]);
            const [players, setPlayers] = useState([]);
            const [offers, setOffers] = useState([]);
            const [news, setNews] = useState([]);
            const [reqs, setReqs] = useState([]);
            const [conf, setConf] = useState({ marketOpen: true });
            
            const [screen, setScreen] = useState('HOME');
            const [modal, setModal] = useState(null);
            const [loading, setLoading] = useState(true);
            const [newNews, setNewNews] = useState(false);
            const [adminTeam, setAdminTeam] = useState(null); 

            useEffect(() => {
                const unsubs = [
                    db.collection('teams').onSnapshot(s => setTeams(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    db.collection('players').onSnapshot(s => setPlayers(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    db.collection('config').doc('system').onSnapshot(s => setConf(s.exists ? s.data() : {marketOpen:true})),
                    db.collection('financeRequests').onSnapshot(s => setReqs(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    db.collection('news').orderBy('date', 'desc').limit(50).onSnapshot(s => {
                        const list = s.docs.map(d => ({id:d.id, ...d.data()}));
                        setNews(list);
                        const lastRead = localStorage.getItem('lastRead');
                        if (list.length && (!lastRead || list[0].date > parseInt(lastRead))) setNewNews(true);
                        setLoading(false);
                    })
                ];
                return () => unsubs.forEach(u => u());
            }, []);

            useEffect(() => {
                if (user?.type === 'USER') {
                    const me = teams.find(t => t.id === user.data.id);
                    if (me) setUser(prev => ({...prev, data: me}));
                    return db.collection('offers').where('sellerId', '==', user.data.id).onSnapshot(s => setOffers(s.docs.map(d => ({id:d.id, ...d.data()}))));
                }
            }, [teams, user?.data?.id]);

            // --- FUNCTIONS ---
            const postNews = (text, type='normal') => db.collection('news').add({ text, type, date: Date.now() });

            const login = (id, pwd) => {
                const t = teams.find(x => x.id === id);
                if (t) {
                    if (t.password === pwd) {
                        if (t.status === 'PENDING') {
                            alert("‚è≥ Aguarde! Seu time ainda est√° sendo analisado pela Federa√ß√£o.");
                        } else {
                            setUser({type:'USER', data:t}); 
                            setScreen('HOME');
                        }
                    } else alert("Senha incorreta!");
                } else alert("Time n√£o encontrado.");
            };

            const createTeam = async (name, bal, serie, pass, logo) => {
                if(teams.find(t=>t.name.toLowerCase()===name.toLowerCase())) return alert("Nome em uso!");
                const ref = await db.collection('teams').add({ 
                    name, balance: parseFloat(bal), serie, password: pass, 
                    stadiumLevel: 1, logo: logo||null, status: 'PENDING' 
                });
                alert("Time criado com sucesso! Aguarde a aprova√ß√£o da Federa√ß√£o para entrar.");
                // N√£o loga automaticamente, volta pra tela de login
            };

            const approveTeam = async (teamId, finalBalance) => {
                await db.collection('teams').doc(teamId).update({
                    status: 'ACTIVE',
                    balance: parseFloat(finalBalance)
                });
                const t = teams.find(x=>x.id===teamId);
                postNews(`üõ°Ô∏è **NOVO CLUBE!**\nO **${t.name}** foi aprovado na S√©rie ${t.serie}.`, 'infra');
                alert("Time aprovado!");
            };

            const updateBalance = async (teamId, newBal) => {
                await db.collection('teams').doc(teamId).update({ balance: parseFloat(newBal) });
                alert("Saldo atualizado!");
            };

            const savePlayer = async (d) => {
                const targetTeamId = (user.type==='ADMIN' && adminTeam) ? adminTeam.id : user.data.id;
                const payload = {
                    name: d.name, position: d.position, overall: parseInt(d.overall), value: parseFloat(d.value),
                    salary: parseFloat(d.salary), clause: parseFloat(d.clause), contract: parseInt(d.contract),
                    mood: d.mood, status: d.status, teamId: d.teamId || targetTeamId, loan: false
                };
                if(d.id) {
                    const old = players.find(p=>p.id===d.id);
                    if(user.type==='ADMIN' && d.forcedTeamId && d.forcedTeamId !== old.teamId) {
                        payload.teamId = d.forcedTeamId; payload.futureTransfer = firebase.firestore.FieldValue.delete();
                        postNews(`üëÆ‚Äç‚ôÇÔ∏è **INTERVEN√á√ÉO**\nTransfer√™ncia for√ßada de **${d.name}**!`, 'admin');
                    }
                    await db.collection('players').doc(d.id).update(payload);
                } else {
                    await db.collection('players').add(payload);
                    postNews(`üÜï **REFOR√áO**\n${(teams.find(t=>t.id===payload.teamId)||{}).name} contrata **${d.name}**.`, 'transfer');
                }
                setModal(null);
            };

            const sendOffer = async (target, type, val, swapId, con, old) => {
                const v = parseFloat(val||0);
                let desc = type==='COMPRA' ? `Compra: ${fmt(v)} | ${con} Anos` : type==='EMPRESTIMO' ? `Emp (Taxa: ${fmt(v)}) | ${con} Temp` : `Troca: ${fmt(v)} + Player`;
                if(type==='TROCA') { const sp = players.find(p=>p.id===swapId); desc = `Troca: ${fmt(v)} + ${sp.name}`; }
                
                const pl = {
                    playerId: target.id, playerName: target.name, buyerId: user.data.id, buyerName: user.data.name,
                    sellerId: old ? old.buyerId : target.teamId, type, value: v, swapPlayerId: swapId||null,
                    offerContract: con, description: desc, date: Date.now()
                };
                const b = db.batch();
                if(old) b.delete(db.collection('offers').doc(old.id));
                b.set(db.collection('offers').doc(), pl);
                await b.commit();
                postNews(`üö® **PROPOSTA**\n${user.data.name} enviou oferta por **${target.name}**.\n${desc}`, 'transfer');
                setModal(null); alert("Enviada!");
            };

            const acceptOffer = async (o) => {
                const buy = teams.find(t=>t.id===o.buyerId); const sel = teams.find(t=>t.id===user.data.id);
                const p = players.find(x=>x.id===o.playerId);
                if(buy.balance < o.value) return alert("Sem saldo!");
                
                const b = db.batch();
                if(o.value>0) {
                    b.update(db.collection('teams').doc(buy.id), {balance: buy.balance - o.value});
                    b.update(db.collection('teams').doc(sel.id), {balance: sel.balance + o.value});
                }

                if(o.type==='COMPRA') {
                    if(conf.marketOpen) {
                        b.update(db.collection('players').doc(p.id), {teamId: buy.id, status:'NAO_A_VENDA', loan:false, contract: parseInt(o.offerContract)});
                        postNews(`ü§ù **NEG√ìCIO FECHADO**\n${buy.name} comprou **${p.name}**!`, 'transfer');
                    } else {
                        b.update(db.collection('players').doc(p.id), {status:'VENDIDO', futureTransfer:{teamId: buy.id, contract: parseInt(o.offerContract)}});
                        postNews(`ü§ù **PR√â-ACORDO**\n${p.name} ir√° para o ${buy.name} na pr√≥xima temporada.`, 'transfer');
                    }
                } else if(o.type==='EMPRESTIMO') {
                    b.update(db.collection('players').doc(p.id), {teamId: buy.id, status:'NAO_A_VENDA', loan:true, loanFrom: sel.id});
                    postNews(`üîÑ **EMPR√âSTIMO**\n${buy.name} pegou **${p.name}**.`, 'transfer');
                } else if(o.type==='TROCA') {
                    if(!conf.marketOpen) return alert("Troca s√≥ com janela aberta!");
                    const sp = players.find(x=>x.id===o.swapPlayerId);
                    b.update(db.collection('players').doc(p.id), {teamId: buy.id, status:'NAO_A_VENDA', contract: parseInt(o.offerContract)});
                    b.update(db.collection('players').doc(sp.id), {teamId: sel.id, status:'NAO_A_VENDA'});
                    postNews(`üîÄ **TROCA**\n${p.name} (‚Üî) ${sp.name}`, 'transfer');
                }
                b.delete(db.collection('offers').doc(o.id));
                await b.commit();
            };

            const adminAction = async (act, data) => {
                if(act==='MARKET') { db.collection('config').doc('system').update({marketOpen: data}); postNews(data?"üì¢ JANELA ABERTA":"üîí JANELA FECHADA", 'infra'); }
                if(act==='WEEK') {
                    if(!confirm("Processar pagamentos semanais?")) return;
                    setLoading(true); const b = db.batch();
                    teams.forEach(t => {
                        const wage = players.filter(p=>p.teamId===t.id).reduce((acc,p)=>acc+(p.salary||0),0);
                        const spon = t.sponsorship ? t.sponsorship.value : 0;
                        b.update(db.collection('teams').doc(t.id), {balance: (t.balance||0) + spon - wage});
                    });
                    await b.commit(); setLoading(false); postNews("üìÖ **VIRADA DE SEMANA**\nSal√°rios pagos e patroc√≠nios recebidos.", 'infra'); alert("Semana Virada!");
                }
                if(act==='SEASON') {
                    if(!confirm("Virar temporada?")) return;
                    setLoading(true); const b = db.batch(); let m=0;
                    players.forEach(p => {
                        let up = {};
                        if(p.futureTransfer) { up.teamId=p.futureTransfer.teamId; up.contract=p.futureTransfer.contract; up.status='NAO_A_VENDA'; up.futureTransfer=firebase.firestore.FieldValue.delete(); up.loan=false; m++; }
                        else if((p.contract<=1||p.contract===0) && p.preContract) { up.teamId=p.preContract.teamId; up.contract=1; up.status='NAO_A_VENDA'; up.preContract=firebase.firestore.FieldValue.delete(); up.loan=false; m++; }
                        else { let nc=(p.contract||0)-1; if(nc<0)nc=0; up.contract=nc; if(nc===0)up.status='EXPIRADO'; }
                        b.update(db.collection('players').doc(p.id), up);
                    });
                    await b.commit(); setLoading(false); postNews(`üåû **NOVA TEMPORADA**\n${m} transfer√™ncias realizadas.`, 'season'); alert("Virada!");
                }
            };

            // --- RENDER ---
            if(loading) return <div style={{display:'grid', placeItems:'center', height:'100vh'}}>Carregando...</div>;
            if(!user) return <LoginScreen teams={teams} onLogin={login} onCreate={createTeam} onAdmin={()=>setUser({type:'ADMIN'})} onVisitor={()=>{setUser({type:'VISITOR'}); setScreen('RANKING');}} />;

            return (
                <div>
                    <div className="header">
                        <div style={{display:'flex', alignItems:'center', gap:10}}>
                            {user.type==='USER' && user.data.logo && <img src={user.data.logo} style={{width:40, height:40, borderRadius:'50%', border:'2px solid var(--primary)', objectFit:'cover'}} />}
                            <div>
                                <div style={{fontWeight:'900', fontSize:16}}>{user.type==='USER' ? user.data.name : user.type}</div>
                                {user.type==='ADMIN' && <span style={{color:'gold', fontSize:10}}>MASTER</span>}
                            </div>
                        </div>
                        <div style={{display:'flex', gap:15, alignItems:'center'}}>
                            {user.type==='USER' && (
                                <div style={{position:'relative'}} onClick={()=>setScreen('OFFERS')}>
                                    <i className="fas fa-bell" style={{color: offers.length ? 'var(--warning)' : '#555'}}></i>
                                    {offers.length > 0 && <span style={{position:'absolute', top:-5, right:-5, background:'red', borderRadius:'50%', width:8, height:8}} className="pulse"></span>}
                                </div>
                            )}
                            {user.type==='USER' && <div style={{color:'var(--primary)', fontWeight:'bold'}}>{fmt(user.data.balance)}</div>}
                            {user.type==='USER' && <i className="fas fa-cog" onClick={()=>setModal({type:'SETTINGS'})}></i>}
                            <i className="fas fa-sign-out-alt" onClick={()=>window.location.reload()}></i>
                        </div>
                    </div>

                    <div className="container">
                        {screen === 'HOME' && (
                            user.type === 'ADMIN' ? 
                            <AdminPanel teams={teams} reqs={reqs} config={conf} onAct={adminAction} onPost={(t,b,tp)=>postNews(`üì¢ **${t}**\n${b}`, tp)} onApprove={async(r)=>{const b=db.batch(); if(r.type==='INJECTION')b.update(db.collection('teams').doc(r.teamId),{balance:(teams.find(t=>t.id===r.teamId).balance||0)+r.amount}); else b.update(db.collection('teams').doc(r.teamId),{sponsorship:{name:r.details,value:r.amount}}); b.delete(db.collection('financeRequests').doc(r.id)); await b.commit();}} onReject={(rid)=>db.collection('financeRequests').doc(rid).delete()} onEditT={(t)=>{setAdminTeam(t); setScreen('ADMIN_TEAM');}} onApproveTeam={approveTeam} onUpdateBal={updateBalance} /> 
                            : user.type === 'VISITOR' ? <div style={{textAlign:'center', marginTop:50, color:'#888'}}><h3>Bem-vindo, Visitante!</h3>Use o menu abaixo para navegar.</div>
                            : <TeamDashboard team={user.data} players={players.filter(p=>p.teamId===user.data.id)} isVisitor={user.type==='VISITOR'} onEdit={(p)=>setModal({type:'PLAYER', data:p})} onAdd={()=>setModal({type:'PLAYER'})} />
                        )}

                        {screen === 'ADMIN_TEAM' && adminTeam && (
                            <div>
                                <button className="btn" style={{background:'#333', marginBottom:10}} onClick={()=>{setAdminTeam(null); setScreen('HOME');}}>‚¨Ö VOLTAR</button>
                                <h3 style={{color:'var(--purple)'}}>Editando: {adminTeam.name}</h3>
                                <TeamDashboard team={adminTeam} players={players.filter(p=>p.teamId===adminTeam.id)} isVisitor={false} onEdit={(p)=>setModal({type:'PLAYER', data:p})} onAdd={()=>setModal({type:'PLAYER'})} />
                            </div>
                        )}

                        {screen === 'MARKET' && <Market me={user.data?.id} teams={teams} players={players} open={conf.marketOpen} isVis={user.type==='VISITOR'} onNeg={(p)=>setModal({type:'OFFER', data:p})} onPayClause={(p)=>{ if(user.data.balance<p.clause)return alert("Sem saldo"); const b=db.batch(); b.update(db.collection('teams').doc(user.data.id),{balance:user.data.balance-p.clause}); b.update(db.collection('teams').doc(p.teamId),{balance:(teams.find(t=>t.id===p.teamId).balance||0)+p.clause}); b.update(db.collection('players').doc(p.id),{teamId:user.data.id, contract:3, status:'NAO_A_VENDA', loan:false}); b.commit(); postNews(`üí£ **MULTA PAGA**\n${user.data.name} roubou ${p.name}!`, 'transfer'); }} onPre={(p)=>{ if(confirm("Pr√©-contrato?")) { db.collection('players').doc(p.id).update({preContract:{teamId:user.data.id}}); postNews(`üìú **ASSINOU**\n${p.name} vai pro ${user.data.name}.`,'transfer'); } }} />}

                        {screen === 'RANKING' && <Ranking teams={teams} players={players} />}
                        {screen === 'NEWS' && <div><h3>Not√≠cias</h3>{news.map(n=><div key={n.id} className={`news-card news-${n.type}`}>{n.text}<br/><small style={{color:'#666'}}>{new Date(n.date).toLocaleString()}</small></div>)}</div>}
                        {screen === 'OFFERS' && <OffersScreen offers={offers} onAccept={acceptOffer} onReject={(oid)=>db.collection('offers').doc(oid).delete()} onCounter={(o)=>setModal({type:'OFFER', data:{...players.find(p=>p.id===o.playerId), oldOffer:o}})} />}
                    </div>

                    <div className="bottom-nav">
                        <div className={`nav-item ${screen==='HOME'||screen==='ADMIN_TEAM'?'active':''}`} onClick={()=>setScreen('HOME')}><i className="fas fa-home"></i>{user.type==='ADMIN'?'ADM':'CLUBE'}</div>
                        <div className={`nav-item ${screen==='MARKET'?'active':''}`} onClick={()=>setScreen('MARKET')}><i className="fas fa-globe"></i>MERCADO</div>
                        <div className={`nav-item ${screen==='RANKING'?'active':''}`} onClick={()=>setScreen('RANKING')}><i className="fas fa-trophy"></i>RANK</div>
                        <div className={`nav-item ${screen==='NEWS'?'active':''}`} onClick={()=>{setScreen('NEWS'); setNewNews(false); localStorage.setItem('lastRead', Date.now());}}><i className="fas fa-newspaper"></i>{newNews && <span style={{color:'red'}}>‚óè</span>} NEWS</div>
                    </div>

                    {modal && <div className="modal-overlay" onClick={(e)=>e.target===e.currentTarget && setModal(null)}>
                        <div className="modal-content">
                            {modal.type==='PLAYER' && <PlayerForm initial={modal.data} onSave={savePlayer} onDelete={(id)=>{if(confirm("Excluir?"))db.collection('players').doc(id).delete(); setModal(null);}} isAdmin={user.type==='ADMIN'} teams={teams} />}
                            {modal.type==='OFFER' && <OfferForm target={modal.data} myPlayers={players.filter(p=>p.teamId===user.data.id)} onSend={sendOffer} />}
                            {modal.type==='SETTINGS' && <SettingsForm team={user.data} isAdmin={user.type==='ADMIN'} onUp={(d)=>{db.collection('teams').doc(user.data.id).update(d); setUser(p=>({...p, data:{...p.data, ...d}})); setModal(null);}} onUpgrade={()=>{ const c=COSTS[user.data.stadiumLevel]; if(user.data.balance<c)return alert("Sem grana"); if(confirm("Pagar?")) { db.collection('teams').doc(user.data.id).update({balance:user.data.balance-c, stadiumLevel:user.data.stadiumLevel+1}); postNews(`üèó **OBRAS**\n${user.data.name} evoluiu est√°dio.`,'infra'); setModal(null); } }} onReq={(t,a,d)=>{db.collection('financeRequests').add({teamId:user.data.id, teamName:user.data.name, type:t, amount:parseFloat(a), details:d, status:'PENDING'}); setModal(null); alert("Enviado!");}} />}
                        </div>
                    </div>}
                </div>
            );
        }

        // --- COMPONENTS ---
        const LoginScreen = ({ teams, onLogin, onCreate, onAdmin, onVisitor }) => {
            const [tab, setTab] = useState('LOGIN'); const [f, setF] = useState({n:'', b:'10000000', s:'A', p:''}); const [sel, setSel] = useState(null); const [lp, setLp] = useState('');
            const handleUpload = (e) => { const file=e.target.files[0]; const reader=new FileReader(); reader.onloadend=()=>setF({...f, l:reader.result}); if(file) reader.readAsDataURL(file); };
            return (
                <div style={{minHeight:'100vh', padding:20, textAlign:'center'}}>
                    <h1 style={{color:'var(--primary)'}}>Gerenciador de Times<br/><span style={{color:'white'}}>de Mato Real</span></h1>
                    <div className="login-tabs"><div className={`tab ${tab==='LOGIN'?'active':''}`} onClick={()=>setTab('LOGIN')}>ENTRAR</div><div className={`tab ${tab==='CREATE'?'active':''}`} onClick={()=>setTab('CREATE')}>CRIAR</div></div>
                    {tab==='LOGIN' ? <div>{teams.filter(t=>t.status!=='PENDING').map(t=><div key={t.id} className="card" onClick={()=>setSel(t)} style={{display:'flex', alignItems:'center', gap:10, cursor:'pointer'}}>{t.logo ? <img src={t.logo} className="team-logo" style={{width:40, height:40, objectFit:'cover'}}/> : <div className="team-logo"></div>}<div><b>{t.name}</b><br/><small style={{color:'#666'}}>S√©rie {t.serie}</small></div></div>)}<div style={{marginTop:20}}><button className="btn btn-blue" onClick={onVisitor}>ENTRAR COMO VISITANTE</button><button className="btn btn-ghost" onClick={()=> {if(prompt("Senha:")==='2503') onAdmin()}}>ADMIN</button></div></div> 
                    : <div><input type="file" className="file-input" onChange={handleUpload} /><input className="input-field" placeholder="Nome" value={f.n} onChange={e=>setF({...f, n:e.target.value})} /><input className="input-field" type="number" placeholder="Saldo" value={f.b} onChange={e=>setF({...f, b:e.target.value})} /><select className="input-field" value={f.s} onChange={e=>setF({...f, s:e.target.value})}>{SERIES.map(s=><option key={s} value={s}>S√©rie {s}</option>)}</select><input className="input-field" type="number" placeholder="Senha" value={f.p} onChange={e=>setF({...f, p:e.target.value})} /><button className="btn btn-green" onClick={()=>onCreate(f.n, f.b, f.s, f.p, f.l)}>CRIAR</button></div>}
                    {sel && <div className="modal-overlay"><div className="modal-content"><h3>{sel.name}</h3><input className="input-field" type="password" placeholder="Senha" value={lp} onChange={e=>setLp(e.target.value)} /><button className="btn btn-green" onClick={()=>onLogin(sel.id, lp)}>ENTRAR</button><button className="btn" onClick={()=>setSel(null)}>CANCELAR</button></div></div>}
                </div>
            );
        };

        const TeamDashboard = ({ team, players, isVisitor, onEdit, onAdd }) => (
            <div>
                <div style={{display:'flex', justifyContent:'space-between', marginBottom:10}}><h3>Elenco ({players.length})</h3>{!isVisitor && <button className="btn btn-green" style={{width:'auto'}} onClick={onAdd}>+ JOGADOR</button>}</div>
                {players.sort((a,b)=>b.overall-a.overall).map(p => (
                    <div key={p.id} className="card" onClick={()=>!isVisitor && onEdit(p)} style={{cursor: isVisitor?'default':'pointer'}}>
                        <div style={{display:'flex', justifyContent:'space-between'}}><div><span className="badge-pos" style={{background:getPosColor(p.position)}}>{p.position}</span><b>{p.name}</b> {p.loan && <small style={{color:'var(--secondary)'}}>(EMP)</small>}</div><span className="player-ov">{p.overall}</span></div>
                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', fontSize:11, color:'#aaa', marginTop:5}}><div>Sal: {fmt(p.salary)}</div><div>Val: {fmt(p.value)}</div><div>Con: {p.contract}</div><div>Mul: {fmt(p.clause)}</div></div>
                        <div style={{marginTop:5, display:'flex', justifyContent:'space-between', fontSize:10}}><span style={{color: p.status==='VENDA'?'var(--primary)':p.status==='INTRANSFERIVEL'?'var(--danger)':'#666'}}>{p.status}</span><span>{p.mood}</span></div>
                    </div>
                ))}
            </div>
        );

        const PlayerForm = ({ initial, onSave, onDelete, isAdmin, teams }) => {
            const [f, setF] = useState(initial || {name:'', position:'ATA', overall:'', value:'', salary:'', clause:'', contract:'', mood:'üòê', status:'NAO_A_VENDA'});
            return (
                <div>
                    <label>Nome</label><input className="input-field" value={f.name} onChange={e=>setF({...f, name:e.target.value})} />
                    <div style={{display:'flex', gap:5}}>
                        <div style={{flex:1}}><label>Posi√ß√£o</label><select className="input-field" value={f.position} onChange={e=>setF({...f, position:e.target.value})}>{POS.map(p=><option key={p} value={p}>{p}</option>)}</select></div>
                        <div style={{flex:1}}><label>Overall</label><input className="input-field" type="number" value={f.overall} onChange={e=>setF({...f, overall:e.target.value})} disabled={!isAdmin && initial} /></div>
                    </div>
                    {/* Campos edit√°veis para Dono e Admin */}
                    <div style={{display:'flex', gap:5}}>
                        <div style={{flex:1}}><label>Valor</label><input className="input-field" type="number" value={f.value} onChange={e=>setF({...f, value:e.target.value})} /></div>
                        <div style={{flex:1}}><label>Sal√°rio</label><input className="input-field" type="number" value={f.salary} onChange={e=>setF({...f, salary:e.target.value})} /></div>
                    </div>
                    <div style={{display:'flex', gap:5}}>
                        <div style={{flex:1}}><label>Multa</label><input className="input-field" type="number" value={f.clause} onChange={e=>setF({...f, clause:e.target.value})} /></div>
                        <div style={{flex:1}}><label>Contrato</label><input className="input-field" type="number" value={f.contract} onChange={e=>setF({...f, contract:e.target.value})} /></div>
                    </div>
                    <label>Status</label><select className="input-field" value={f.status} onChange={e=>setF({...f, status:e.target.value})}><option value="NAO_A_VENDA">N√£o Listado</option><option value="VENDA">√Ä Venda</option><option value="EMPRESTIMO">Empr√©stimo</option><option value="INTRANSFERIVEL">Bloqueado</option></select>
                    <label>Humor</label><select className="input-field" value={f.mood} onChange={e=>setF({...f, mood:e.target.value})}><option>ü§©</option><option>üòê</option><option>üò°</option></select>
                    {isAdmin && <div style={{border:'1px solid gold', padding:5, marginTop:5}}><label style={{color:'gold'}}>Mover Time (Adm)</label><select className="input-field" onChange={e=>setF({...f, forcedTeamId:e.target.value})}><option value="">-- Manter --</option>{teams.map(t=><option key={t.id} value={t.id}>{t.name}</option>)}</select></div>}
                    <div style={{display:'flex', gap:10, marginTop:15}}><button className="btn btn-green" onClick={()=>onSave(f)}>SALVAR</button>{initial && <button className="btn btn-red" onClick={()=>onDelete(initial.id)}>X</button>}</div>
                </div>
            );
        };

        const Market = ({ me, teams, players, open, isVis, onNeg, onPayClause, onPre }) => {
            const [view, setView] = useState('MENU'); const [serie, setSerie] = useState('A'); const [selT, setSelT] = useState(null); const [filt, setFilt] = useState('VENDA');
            if(view==='MENU') return (
                <div>
                    <h3>Mercado {open?'üü¢':'üî¥'}</h3>
                    <div style={{display:'flex', gap:10}}><div className="card" style={{flex:1, textAlign:'center', cursor:'pointer', border:'1px solid var(--primary)'}} onClick={()=>{setFilt('VENDA'); setView('GLOBAL');}}>üõí VENDA</div><div className="card" style={{flex:1, textAlign:'center', cursor:'pointer', border:'1px solid var(--secondary)'}} onClick={()=>{setFilt('EMPRESTIMO'); setView('GLOBAL');}}>üîÑ EMP</div></div>
                    <h4>S√©ries</h4><div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10}}>{SERIES.map(s=><div key={s} className="card" style={{textAlign:'center', cursor:'pointer'}} onClick={()=>{setSerie(s); setView('LIST');}}><b>S√©rie {s}</b></div>)}</div>
                </div>
            );
            
            let list = [];
            if(view==='GLOBAL') list = players.filter(p=>p.status===filt && p.teamId!==me).sort((a,b)=>b.overall-a.overall);
            else if(view==='TEAM') list = players.filter(p=>p.teamId===selT.id).sort((a,b)=>b.overall-a.overall);

            if(view==='LIST') return <div><button className="btn" onClick={()=>setView('MENU')}>Voltar</button><h3>Clubes S√©rie {serie}</h3>{teams.filter(t=>t.serie===serie && t.status!=='PENDING').map(t=><div key={t.id} className="card" onClick={()=>{setSelT(t); setView('TEAM');}} style={{display:'flex', alignItems:'center', gap:10, cursor:'pointer'}}>{t.logo?<img src={t.logo} style={{width:30, height:30, borderRadius:'50%', objectFit:'cover'}}/>:<div style={{width:30}}></div>}<b>{t.name}</b></div>)}</div>;

            return (
                <div>
                    <button className="btn" onClick={()=>setView('MENU')}>Voltar</button><h3>{view==='GLOBAL'?filt:selT.name}</h3>
                    {list.map(p => {
                        const owner = teams.find(t=>t.id===p.teamId);
                        return (
                            <div key={p.id} className="card">
                                <div style={{display:'flex', justifyContent:'space-between'}}><div><span className="badge-pos" style={{background:getPosColor(p.position)}}>{p.position}</span>{p.name}</div><span className="player-ov">{p.overall}</span></div>
                                <div style={{fontSize:11, color:'#aaa', marginTop:5}}>{view==='GLOBAL' && <div>Time: {owner?.name}</div>}<div>Val: {fmt(p.value)} | Con: {p.contract}</div><div>Mul: {fmt(p.clause)}</div></div>
                                {!isVis && <div style={{marginTop:5, display:'flex', gap:5}}>
                                    {(open || p.status==='EMPRESTIMO') && p.status!=='INTRANSFERIVEL' ? <button className="btn btn-purple" style={{width:'auto', flex:1}} onClick={()=>onNeg(p)}>NEGOCIAR</button> : <button className="btn btn-ghost" style={{width:'auto', flex:1}} disabled>BLOQUEADO</button>}
                                    {p.clause>0 && <button className="btn btn-gold" style={{width:'auto'}} onClick={()=>onPayClause(p)}>MULTA</button>}
                                    {p.contract<=1 && !p.preContract && <button className="btn btn-blue" style={{width:'auto'}} onClick={()=>onPre(p)}>PR√â</button>}
                                </div>}
                            </div>
                        );
                    })}
                </div>
            );
        };

        const OfferForm = ({ target, myPlayers, onSend }) => {
            const [t, setT] = useState('COMPRA'); const [v, setV] = useState(target.oldVal||''); const [s, setS] = useState('1'); const [sw, setSw] = useState('');
            return (
                <div>
                    <div style={{display:'flex', gap:5, marginBottom:10}}>{['COMPRA','EMPRESTIMO','TROCA'].map(x=><button key={x} className={`btn ${t===x?'btn-green':'btn-ghost'}`} onClick={()=>setT(x)}>{x}</button>)}</div>
                    <input className="input-field" type="number" placeholder={t==='TROCA'?'Volta em Dinheiro':'Valor'} value={v} onChange={e=>setV(e.target.value)} />
                    {t==='TROCA' && <select className="input-field" onChange={e=>setSw(e.target.value)}><option value="">Seu Jogador...</option>{myPlayers.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}</select>}
                    <label>{t==='EMPRESTIMO'?'Dura√ß√£o':'Contrato'}</label>
                    {t==='EMPRESTIMO' ? <select className="input-field" onChange={e=>setS(e.target.value)}><option value="0.5">Meia Temp</option><option value="1">1 Temp</option></select> : <input className="input-field" type="number" value={s} onChange={e=>setS(e.target.value)} />}
                    <button className="btn btn-green" onClick={()=>onSend(target, t, v, sw, s, target.oldOffer)}>ENVIAR</button>
                </div>
            );
        };

        const AdminPanel = ({ teams, reqs, config, onAct, onPost, onApprove, onReject, onEditT, onApproveTeam, onUpdateBal }) => (
            <div>
                <h3>Painel Master</h3>
                <div className="card">
                    <button className={`btn ${config.marketOpen?'btn-red':'btn-green'}`} onClick={()=>onAct('MARKET', !config.marketOpen)}>{config.marketOpen?'FECHAR MERCADO':'ABRIR MERCADO'}</button>
                    <button className="btn btn-purple" onClick={()=>onAct('WEEK')}>VIRAR SEMANA</button>
                    <button className="btn btn-red" onClick={()=>onAct('SEASON')}>VIRAR TEMPORADA</button>
                    <button className="btn btn-gold" onClick={()=>{ const t=prompt("T√≠tulo"); const b=prompt("Texto"); if(t)onPost(t,b,'admin'); }}>COMUNICADO</button>
                </div>
                
                {/* Pending Teams Section */}
                <h4>Aprova√ß√µes Pendentes ({teams.filter(t=>t.status==='PENDING').length})</h4>
                {teams.filter(t=>t.status==='PENDING').map(t=>(
                    <div key={t.id} className="card" style={{borderLeft:'4px solid var(--warning)'}}>
                        <b>{t.name}</b><br/>S√©rie {t.serie}<br/>
                        <div style={{display:'flex', gap:5, marginTop:5}}>
                            <input className="input-field" style={{marginBottom:0, width:100}} defaultValue={t.balance} id={`bal-${t.id}`} />
                            <button className="btn btn-green" style={{marginBottom:0}} onClick={()=>onApproveTeam(t.id, document.getElementById(`bal-${t.id}`).value)}>APROVAR</button>
                        </div>
                    </div>
                ))}

                <h4>Solicita√ß√µes Financeiras</h4>
                {reqs.filter(r=>r.status==='PENDING').map(r=><div key={r.id} className="card"><b>{r.teamName}</b>: {fmt(r.amount)} ({r.type})<br/>{r.details}<br/><button className="btn-green" style={{width:'auto', marginRight:5}} onClick={()=>onApprove(r)}>V</button><button className="btn-red" style={{width:'auto'}} onClick={()=>onReject(r.id)}>X</button></div>)}
                
                <h4>Clubes Ativos</h4>
                {teams.filter(t=>t.status!=='PENDING').map(t=>(
                    <div key={t.id} className="card" style={{display:'flex', justifyContent:'space-between'}}>
                        <span>{t.name}</span>
                        <div>
                            <button className="btn btn-green" style={{width:'auto', marginRight:5}} onClick={()=>{const n=prompt("Novo Saldo:", t.balance); if(n)onUpdateBal(t.id, n)}}>$</button>
                            <button className="btn btn-purple" style={{width:'auto'}} onClick={()=>onEditT(t)}>ELENCO</button>
                        </div>
                    </div>
                ))}
            </div>
        );

        const SettingsForm = ({ team, isAdmin, onUp, onUpgrade, onReq }) => (
            <div>
                <label>Nome</label><input className="input-field" defaultValue={team.name} id="edit-n" />
                <label>Logo (URL)</label><input className="input-field" defaultValue={team.logo} id="edit-l" />
                {isAdmin && <label>Saldo (ADM)</label>} {isAdmin && <input className="input-field" type="number" defaultValue={team.balance} id="edit-b" />}
                <button className="btn btn-blue" onClick={()=>{ const u={name:document.getElementById('edit-n').value, logo:document.getElementById('edit-l').value}; if(isAdmin)u.balance=parseFloat(document.getElementById('edit-b').value); onUp(u); }}>SALVAR</button>
                <hr style={{borderColor:'#444'}}/>
                <p>Est√°dio N√≠vel {team.stadiumLevel||1}</p><button className="btn btn-purple" onClick={onUpgrade}>EVOLUIR (‚Ç£ {fmt(COSTS[team.stadiumLevel]||0).replace('‚Ç£ ','')})</button>
                <hr style={{borderColor:'#444'}}/>
                <button className="btn btn-green" onClick={()=>{const v=prompt("Valor");const m=prompt("Motivo"); if(v)onReq('INJECTION',v,m)}}>PEDIR INJE√á√ÉO</button>
                <button className="btn btn-gold" onClick={()=>{const v=prompt("Valor");const m=prompt("Empresa"); if(v)onReq('SPONSORSHIP',v,m)}}>PEDIR PATROC√çNIO</button>
            </div>
        );

        const OffersScreen = ({ offers, onAccept, onReject, onCounter }) => (
            <div><h3>Propostas</h3>{offers.map(o=><div key={o.id} className="card" style={{borderLeft:'4px solid gold'}}><b style={{color:'var(--primary)'}}>{o.playerName}</b><br/><small>De: {o.buyerName}</small><p style={{background:'#333', padding:5, borderRadius:5}}>{o.description}</p><div style={{display:'flex', gap:5}}><button className="btn btn-green" onClick={()=>onAccept(o)}>ACEITAR</button><button className="btn btn-blue" onClick={()=>onCounter(o)}>CONTRA</button><button className="btn btn-red" onClick={()=>onReject(o.id)}>RECUSAR</button></div></div>)}</div>
        );

        const Ranking = ({ teams, players }) => (
            <div><h3>Ranking</h3>{teams.filter(t=>t.status!=='PENDING').map(t=>{ const sv=players.filter(p=>p.teamId===t.id).reduce((a,b)=>a+(b.value||0),0); return {...t, w: t.balance+sv, sv}}).sort((a,b)=>b.w-a.w).map((t,i)=><div key={t.id} className="card" style={{display:'flex', alignItems:'center', gap:10}}><b style={{fontSize:20, color:'#555', width:30}}>{i+1}</b>{t.logo?<img src={t.logo} style={{width:30, height:30, borderRadius:'50%', objectFit:'cover'}}/>:<div style={{width:30}}></div>}<div style={{flex:1}}><b>{t.name}</b><br/><small style={{color:'var(--primary)'}}>Patrim√¥nio: {fmt(t.w)}</small><br/><small style={{fontSize:9, color:'#888'}}>Caixa: {fmt(t.balance)} | Elenco: {fmt(t.sv)}</small></div></div>)}</div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
