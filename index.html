<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mato Real Manager - Fixed</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body { background: #121212; color: #e0e0e0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; padding-bottom: 80px; margin: 0; }
        .container { padding: 15px; max-width: 800px; margin: 0 auto; }
        
        .team-logo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #00E676; background: #333; }
        .rank-logo { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin-right: 10px; background: #333; }
        .login-logo-img { width: 120px; height: 120px; object-fit: contain; border-radius: 50%; border: 3px solid #00E676; margin: 0 auto 15px auto; display: block; background: #1e1e1e; }

        .card { background: #1E1E1E; padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #333; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .card:active { transform: scale(0.99); }
        .player-header { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .player-name { font-size: 16px; font-weight: bold; color: white; display: flex; align-items: center; }
        
        .pos-badge { font-size: 10px; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 6px; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); }
        .player-ov { font-size: 14px; font-weight: bold; color: #00E676; background: #003300; padding: 2px 6px; border-radius: 4px; border: 1px solid #00E676; }
        .player-details { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 11px; color: #aaa; }

        .news-card { background: #252525; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #888; font-size: 13px; line-height: 1.5; white-space: pre-line; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .news-money-plus { border-left-color: #00E676; } .news-money-minus { border-left-color: #d32f2f; } 
        .news-transfer { border-left-color: #2196F3; background: linear-gradient(90deg, #1E1E1E, #222); } 
        .news-season { border-left-color: #FF5722; background: #2a1b1b; border: 1px solid #FF5722; } 
        .news-infra { border-left-color: #9C27B0; } 
        .news-admin { border-left-color: #FFD700; background: #332b00; border: 1px solid #FFD700; }
        .news-date { font-size: 10px; color: #888; display: block; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 5px; text-transform: uppercase; }

        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: bold; margin-top: 10px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; font-size: 11px; }
        .btn-green { background: #00E676; color: black; } .btn-red { background: #d32f2f; color: white; }
        .btn-blue { background: #2196F3; color: white; } .btn-gold { background: #FFD700; color: black; }
        .btn-purple { background: #9C27B0; color: white; } .btn-outline { background: transparent; border: 1px solid #666; color: #ccc; }
        
        .input-field { width: 100%; padding: 12px; background: #2C2C2C; border: 1px solid #333; color: white; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-family: inherit; }
        .file-input { width: 100%; padding: 10px; background: #333; color: #aaa; border-radius: 8px; margin-bottom: 10px; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #1a1a1a; display: flex; padding: 10px 0; border-top: 1px solid #333; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.5); }
        .nav-item { flex: 1; text-align: center; color: #888; font-size: 10px; position: relative; cursor: pointer; }
        .nav-item i { font-size: 18px; margin-bottom: 4px; display: block; }
        .nav-item.active { color: #00E676; }
        .header { background: #1E1E1E; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #333; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        
        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 99; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-card { width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; background: #1E1E1E; padding: 20px; border-radius: 12px; border: 1px solid #333; box-sizing: border-box; position: relative; }

        .login-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #333; }
        .tab { flex: 1; padding: 15px; text-align: center; color: #888; cursor: pointer; transition: 0.3s; }
        .tab.active { color: #00E676; border-bottom: 2px solid #00E676; font-weight: bold; }
        
        .status-tag { font-size: 9px; padding: 2px 4px; border-radius: 3px; font-weight: bold; display: inline-block; margin-top: 5px; text-transform: uppercase;}
        .st-venda { background: #003300; color: #00E676; border: 1px solid #00E676; }
        .st-sold { background: #FFD700; color: black; border: 1px solid #FFD700; animation: pulse 2s infinite; }
        
        /* Error Boundary Style */
        .error-screen { padding: 20px; text-align: center; background: #330000; height: 100vh; display: flex; flexDirection: column; justify-content: center; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Crash:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="error-screen">
                            <h2 style={{color:'#ff5252'}}>Opa! Deu erro.</h2>
                            <p style={{color:'#ccc'}}>Copie o erro abaixo e mande pro suporte:</p>
                            <pre style={{background:'black', padding:10, borderRadius:5, overflow:'auto', fontSize:10, textAlign:'left'}}>{this.state.error?.toString()}</pre>
                            <button className="btn btn-outline" onClick={()=>{localStorage.clear(); window.location.reload();}}>LIMPAR E REINICIAR</button>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBrtJFfWAqT0AZYHlm4it-noB5h9jIPJEI",
            authDomain: "gerenciador-de-times-matoreal.firebaseapp.com",
            projectId: "gerenciador-de-times-matoreal",
            storageBucket: "gerenciador-de-times-matoreal.firebasestorage.app",
            messagingSenderId: "29096266740",
            appId: "1:29096266740:web:ec48e7225c18c20dbc07a1"
        };
        try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch(e) { console.error("Firebase Init Error", e); }
        const db = firebase.firestore();
        const { useState, useEffect } = React;

        // --- CONSTANTES ---
        const STADIUM_COSTS = [0, 5000000, 20000000, 50000000, 100000000];
        const STADIUM_NAMES = ["V√°rzea", "Est√°dio Municipal", "Arena Moderna", "Arena Mundial", "Templo do Futebol"];
        const POSITIONS = ['GOL', 'ZAG', 'LD', 'LE', 'VOL', 'MC', 'MEI', 'ATA'];
        const getPosColor = (pos) => {
            if(!pos) return '#777';
            if(pos === 'GOL') return '#FFD700'; 
            if(['ZAG','LD','LE'].some(x=>pos.includes(x))) return '#2196F3'; 
            if(['VOL','MC','MEI'].some(x=>pos.includes(x))) return '#4CAF50'; 
            if(pos.includes('ATA')) return '#F44336'; 
            return '#777';
        };
        const fmt = (v) => "‚Ç£ " + parseFloat(v||0).toLocaleString('pt-BR');

        // --- APP PRINCIPAL ---
        function App() {
            const [userTeam, setUserTeam] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [isVisitor, setIsVisitor] = useState(false);
            const [teams, setTeams] = useState([]);
            const [players, setPlayers] = useState([]);
            const [offers, setOffers] = useState([]); 
            const [news, setNews] = useState([]); 
            const [financeRequests, setFinanceRequests] = useState([]); 
            const [systemConfig, setSystemConfig] = useState({ marketOpen: true }); 
            const [screen, setScreen] = useState('HOME');
            const [loading, setLoading] = useState(true);
            const [showAdmin, setShowAdmin] = useState(false); 
            const [showNotif, setShowNotif] = useState(false); 
            const [offerModal, setOfferModal] = useState(null);
            const [hasNewNews, setHasNewNews] = useState(false);
            const [adminViewingTeam, setAdminViewingTeam] = useState(null);

            useEffect(() => {
                const unsubT = db.collection('teams').onSnapshot(snap => setTeams(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubP = db.collection('players').onSnapshot(snap => setPlayers(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubN = db.collection('news').orderBy('date', 'desc').limit(50).onSnapshot(snap => {
                    const list = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    setNews(list);
                    const lastRead = localStorage.getItem('lastReadNews');
                    if(list.length > 0 && (!lastRead || (list[0].date && list[0].date > parseInt(lastRead)))) setHasNewNews(true);
                    setLoading(false);
                });
                const unsubC = db.collection('config').doc('system').onSnapshot(snap => {
                    if(snap.exists) setSystemConfig(snap.data()); else db.collection('config').doc('system').set({marketOpen:true});
                });
                const unsubF = db.collection('financeRequests').onSnapshot(snap => setFinanceRequests(snap.docs.map(d=>({id:d.id, ...d.data()}))));
                return () => { unsubT(); unsubP(); unsubN(); unsubC(); unsubF(); }
            }, []);

            useEffect(() => {
                if(userTeam && !isAdmin && !isVisitor) {
                    const me = teams.find(t => t.id === userTeam.id);
                    if(me) setUserTeam(me);
                    const unsubO = db.collection('offers').where('sellerId', '==', userTeam.id).onSnapshot(snap => setOffers(snap.docs.map(d=>({id:d.id, ...d.data()}))));
                    return () => unsubO && unsubO();
                }
            }, [teams, userTeam?.id]);

            const postNews = (text, type='normal') => db.collection('news').add({ text, type, date: Date.now() });

            // FUN√á√ïES DE A√á√ÉO
            const createTeam = async (name, bal, serie, pass, logo) => {
                const exist = teams.find(t=>t.name.toLowerCase()===name.toLowerCase());
                if(exist) return alert("Nome j√° existe!");
                const ref = await db.collection('teams').add({ name, balance: parseFloat(bal), serie, password: pass, stadiumLevel: 1, logo: logo||null, allowOffers: true });
                postNews(`üõ°Ô∏è **NOVO CLUBE!**\nO **${name}** acaba de ser fundado na S√©rie ${serie}.`, 'infra');
                localStorage.setItem('myTeamId', ref.id);
                setUserTeam({id:ref.id, name, balance:parseFloat(bal), serie, password:pass, stadiumLevel:1, logo:logo||null});
            };

            // *** AQUI ESTAVA O ERRO: Certificando que upgradeStadium est√° definido e acess√≠vel ***
            const upgradeStadium = () => {
                const currentLvl = userTeam?.stadiumLevel || 1;
                if(currentLvl >= 5) return alert("M√°ximo!");
                const cost = STADIUM_COSTS[currentLvl];
                if(userTeam.balance < cost) return alert("Sem saldo!");
                if(!confirm(`Pagar ${fmt(cost)}?`)) return;
                
                const newBal = userTeam.balance - cost;
                db.collection('teams').doc(userTeam.id).update({ balance: newBal, stadiumLevel: currentLvl + 1 });
                // Atualiza localmente para feedback instant√¢neo
                setUserTeam({...userTeam, balance: newBal, stadiumLevel: currentLvl + 1});
                
                postNews(`üèó **OBRAS!** ${userTeam.name} evoluiu est√°dio para N√≠vel ${currentLvl + 1}.`, 'infra'); 
                alert("Sucesso!"); 
                setShowAdmin(false);
            };

            const addPlayer = (name, pos, ov, val, sal, clause, con, mood) => {
                const target = isAdmin && adminViewingTeam ? adminViewingTeam : userTeam;
                db.collection('players').add({
                    name, position: pos, overall: parseInt(ov), value: parseFloat(val), salary: parseFloat(sal),
                    clause: parseFloat(clause), contract: parseInt(con), mood: mood||'üòê', status: 'NAO_A_VENDA',
                    teamId: target.id, loan: false
                });
                postNews(`üÜï **REFOR√áO!**\n${target.name} apresenta **${name}** (${pos}).\n‚≠ê Overall: ${ov}`, 'new-player');
            };

            const updatePlayer = (pId, name, st, pos, val, ov, sal, clause, con, forcedTeamId, mood) => {
                let data = { name, status: st, position: pos, value: parseFloat(val), overall: parseInt(ov), salary: parseFloat(sal), clause: parseFloat(clause), contract: parseInt(con), mood };
                if (isAdmin && forcedTeamId && forcedTeamId !== 'current') {
                    const newTeam = teams.find(t => t.id === forcedTeamId);
                    data.teamId = forcedTeamId; data.loan = false;
                    data.futureTransfer = firebase.firestore.FieldValue.delete();
                    postNews(`üëÆ‚Äç‚ôÇÔ∏è **INTERVEN√á√ÉO**\nA Federa√ß√£o determinou a transfer√™ncia imediata de **${name}** para o **${newTeam?.name || 'Novo Time'}**!`, 'admin');
                }
                db.collection('players').doc(pId).update(data);
                if(isAdmin) alert("Dados Atualizados!");
            };

            const deletePlayer = (pId) => { if(confirm("Apagar jogador?")) db.collection('players').doc(pId).delete(); };

            const requestFinance = async (type, amount, nameOrReason) => {
                if (!amount || !nameOrReason) return alert("Preencha todos os campos!");
                await db.collection('financeRequests').add({ teamId: userTeam.id, teamName: userTeam.name, type, amount: parseFloat(amount), details: nameOrReason, status: 'PENDING', date: Date.now() });
                alert("Solicita√ß√£o enviada para a Federa√ß√£o (ADM)!");
            };

            const updateClubData = (newName, newSerie, newLogo) => {
                const updateData = { name: newName, serie: newSerie };
                if(newLogo) updateData.logo = newLogo; 
                db.collection('teams').doc(userTeam.id).update(updateData);
                setUserTeam({...userTeam, ...updateData}); alert("Atualizado!"); setShowAdmin(false);
            };

            // L√≥gica de Login
            const handleLogin = (team, pwd) => {
                if(pwd === team.password) { localStorage.setItem('myTeamId', team.id); setUserTeam(team); setIsAdmin(false); setIsVisitor(false); }
                else alert("Senha incorreta!");
            };
            const handleAdminLogin = () => { if(prompt("Senha Master:") === '2503') { setUserTeam({name:"FEDERA√á√ÉO (ADM)", id:"admin"}); setIsAdmin(true); } else alert("Erro."); };
            const handleVisitorLogin = () => { setUserTeam({name:"Visitante", id:"visitor"}); setIsVisitor(true); setScreen('RANKING'); };

            // Admin Actions
            const toggleMarket = () => {
                const open = !systemConfig.marketOpen;
                db.collection('config').doc('system').update({ marketOpen: open });
                postNews(open ? "üì¢ **JANELA ABERTA!**" : "üîí **JANELA FECHADA!**", 'infra');
            };
            const processWeek = async () => {
                if(!confirm("Virar Semana?")) return;
                setLoading(true); const batch = db.batch();
                teams.forEach(t => {
                    const folha = players.filter(p=>p.teamId===t.id).reduce((a,b)=>a+(b.salary||0),0);
                    const pat = t.sponsorship ? t.sponsorship.value : 0;
                    batch.update(db.collection('teams').doc(t.id), { balance: (t.balance||0) + pat - folha });
                });
                await batch.commit(); postNews("üìÖ **VIRADA DE SEMANA**", 'infra'); setLoading(false); alert("Feito!");
            };
            const processSeason = async () => {
                if(!confirm("‚ö†Ô∏è VIRAR TEMPORADA?")) return;
                setLoading(true); const batch = db.batch(); const allP = await db.collection('players').get();
                allP.docs.forEach(doc => {
                    const p = doc.data(); let updates = {};
                    if (p.futureTransfer) {
                        updates.teamId = p.futureTransfer.teamId; updates.contract = p.futureTransfer.contract; updates.status = 'NAO_A_VENDA'; updates.futureTransfer = firebase.firestore.FieldValue.delete(); updates.loan = false;
                    } else if ((p.contract <= 1 || p.contract === 0) && p.preContract) {
                        updates.teamId = p.preContract.teamId; updates.contract = 1; updates.status = 'NAO_A_VENDA'; updates.preContract = firebase.firestore.FieldValue.delete(); updates.loan = false;
                    } else {
                        let nc = (p.contract || 0) - 1; if(nc < 0) nc = 0; updates.contract = nc; if(nc === 0) updates.status = 'EXPIRADO';
                    }
                    batch.update(doc.ref, updates);
                });
                await batch.commit(); postNews(`üåû **NOVA TEMPORADA!**`, 'season'); setLoading(false); alert("Virada!");
            };
            const handleFinanceRequest = async (req, action) => {
                if (action === 'REJECT') { await db.collection('financeRequests').doc(req.id).update({ status: 'REJECTED' }); return; }
                const batch = db.batch();
                if (req.type === 'INJECTION') {
                    const teamDoc = teams.find(t => t.id === req.teamId);
                    batch.update(db.collection('teams').doc(req.teamId), { balance: (teamDoc.balance || 0) + req.amount });
                    postNews(`üí∞ **INJE√á√ÉO**\n${req.teamName} +${fmt(req.amount)}`, 'plus');
                } else {
                    batch.update(db.collection('teams').doc(req.teamId), { sponsorship: { name: req.details, value: req.amount } });
                    postNews(`ü§ù **PATROC√çNIO**\n${req.teamName} +${fmt(req.amount)}/sem`, 'infra');
                }
                batch.update(db.collection('financeRequests').doc(req.id), { status: 'APPROVED' }); await batch.commit(); alert("Aprovado!");
            };
            const adminPostCustomNews = () => {
                const title = prompt("T√≠tulo:"); const body = prompt("Texto:"); const type = prompt("Tipo (admin, transfer):", "admin");
                if(title) postNews(`üì¢ **${title.toUpperCase()}**\n${body}`, type);
            };
            const adminUpdateBalance = (team) => { const n = prompt("Novo Saldo:"); if(n) db.collection('teams').doc(team.id).update({ balance: parseFloat(n) }); };
            const adminDeleteTeam = (team) => { if(confirm("Deletar time?")) { db.collection('teams').doc(team.id).delete(); } };

            // Negocia√ß√µes (simplificado para caber sem erro)
            const sendOffer = async (target, type, val, swapId, seas, oldOffer) => {
                let v = parseFloat(val||0); let desc = type==='COMPRA' ? `Compra: ${fmt(v)}` : type==='EMPRESTIMO' ? `Empr√©stimo: ${fmt(v)}` : `Troca`;
                await db.collection('offers').add({ playerId: target.id, playerName: target.name, buyerId: userTeam.id, buyerName: userTeam.name, sellerId: target.teamId, type, value: v, swapPlayerId: swapId||null, offerContract: seas, description: desc, date: Date.now() });
                postNews(`üö® **PROPOSTA**\n${userTeam.name} > ${target.name}`, 'transfer'); alert("Enviada!"); setOfferModal(null);
            };
            const acceptOffer = async (offer) => {
                // L√≥gica de aceite simplificada para garantir funcionamento
                const buyer = teams.find(t=>t.id===offer.buyerId); const seller = teams.find(t=>t.id===userTeam.id); const player = players.find(p=>p.id===offer.playerId);
                const batch = db.batch();
                batch.update(db.collection('teams').doc(buyer.id), { balance: buyer.balance - offer.value });
                if(seller) batch.update(db.collection('teams').doc(seller.id), { balance: seller.balance + offer.value });
                
                if (systemConfig.marketOpen || offer.type==='EMPRESTIMO') {
                    batch.update(db.collection('players').doc(player.id), { teamId: buyer.id, status: 'NAO_A_VENDA', loan: offer.type==='EMPRESTIMO', contract: parseInt(offer.offerContract) });
                    postNews(`ü§ù **FECHADO**\n${buyer.name} contratou ${player.name}`, 'transfer');
                } else {
                    batch.update(db.collection('players').doc(player.id), { status: 'VENDIDO', futureTransfer: { teamId: buyer.id, contract: parseInt(offer.offerContract) } });
                    postNews(`ü§ù **PR√â-ACORDO**\n${player.name} ir√° para ${buyer.name} na pr√≥xima temp.`, 'transfer');
                }
                batch.delete(db.collection('offers').doc(offer.id)); await batch.commit(); alert("Feito!"); setShowNotif(false);
            };
            const payClause = (player) => {
                if(userTeam.balance < player.clause) return alert("Sem saldo");
                const batch = db.batch();
                batch.update(db.collection('teams').doc(userTeam.id), { balance: userTeam.balance - player.clause });
                batch.update(db.collection('teams').doc(player.teamId), { balance: (teams.find(t=>t.id===player.teamId)?.balance||0) + player.clause });
                batch.update(db.collection('players').doc(player.id), { teamId: userTeam.id, status:'NAO_A_VENDA', contract:3, loan:false });
                batch.commit(); postNews(`üí£ **MULTA**\n${userTeam.name} pagou a multa de ${player.name}`, 'transfer');
            };
            const preContract = (player) => {
                if(!confirm("Assinar pr√©-contrato?")) return;
                db.collection('players').doc(player.id).update({ preContract: { teamId: userTeam.id } }); postNews(`üìú **ASSINOU**\n${player.name} pr√©-contratado por ${userTeam.name}`, 'transfer');
            };

            // --- RENDER ---
            if(loading) return <div style={{padding:50,textAlign:'center'}}>Carregando...</div>;
            if(!userTeam) return <LoginScreen teams={teams} onLogin={handleLogin} onCreate={createTeam} onAdminLogin={handleAdminLogin} onVisitor={handleVisitorLogin} onUpload={handleImageUpload} />;

            return (
                <div>
                    <div className="header">
                        <div style={{display:'flex', alignItems:'center', gap:10}}>{!isAdmin && userTeam.logo && <img src={userTeam.logo} className="team-logo"/>}<b>{userTeam.name}</b></div>
                        <div style={{display:'flex', gap:15, alignItems:'center'}}>
                            {!isAdmin && !isVisitor && (<i className="fas fa-bell" style={{color:offers.length?'gold':'#888'}} onClick={()=>setShowNotif(true)}></i>)}
                            {!isVisitor && <span style={{color:'#00E676'}}>{isAdmin?'ADM':fmt(userTeam.balance)}</span>}
                            {!isVisitor && <i className="fas fa-cog" onClick={()=>setShowAdmin(true)}></i>}
                            {isVisitor && <i className="fas fa-sign-out-alt" onClick={()=>window.location.reload()}></i>}
                        </div>
                    </div>

                    <div className="container">
                        {screen === 'HOME' && (
                            <div>
                                {isAdmin ? (
                                    <div className="card">
                                        <h3>PAINEL ADMIN</h3>
                                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10}}>
                                            <button className="btn" style={{background: systemConfig.marketOpen?'#d32f2f':'#00E676'}} onClick={toggleMarket}>{systemConfig.marketOpen?'FECHAR JANELA':'ABRIR JANELA'}</button>
                                            <button className="btn btn-gold" onClick={adminPostCustomNews}>COMUNICADO</button>
                                            <button className="btn btn-purple" onClick={processWeek}>VIRAR SEMANA</button>
                                            <button className="btn btn-red" onClick={processSeason}>VIRAR TEMPORADA</button>
                                        </div>
                                        <h4>Pedidos ({financeRequests.filter(r=>r.status==='PENDING').length})</h4>
                                        {financeRequests.filter(r=>r.status==='PENDING').map(r=><div key={r.id} style={{borderBottom:'1px solid #333', padding:5}}><b>{r.teamName}</b>: {fmt(r.amount)}<button onClick={()=>handleFinanceRequest(r,'APPROVE')}>‚úî</button> <button onClick={()=>handleFinanceRequest(r,'REJECT')}>‚úñ</button></div>)}
                                        <h4>Times</h4>
                                        {teams.map(t=><div key={t.id} style={{padding:5, display:'flex', justifyContent:'space-between'}}><span>{t.name}</span><div><button onClick={()=>{setAdminViewingTeam(t); setScreen('ADMIN_SQUAD');}}>Elenco</button> <button onClick={()=>adminUpdateBalance(t)}>$</button> <button onClick={()=>adminDeleteTeam(t)}>X</button></div></div>)}
                                    </div>
                                ) : isVisitor ? <div style={{textAlign:'center', marginTop:50}}>Bem-vindo!</div> : (
                                    <div>
                                        <div className="card" style={{borderLeft:'4px solid #9C27B0', display:'flex', justifyContent:'space-between'}}>
                                            <div><small>EST√ÅDIO (Nvl {userTeam.stadiumLevel||1})</small><div>{STADIUM_NAMES[(userTeam.stadiumLevel||1)-1]}</div></div>
                                            <button className="btn-purple" style={{width:'auto'}} onClick={()=>setShowAdmin(true)}>OBRAS</button>
                                        </div>
                                        <MyTeam ps={players.filter(p=>p.teamId===userTeam.id)} onAdd={addPlayer} onUpd={updatePlayer} onDel={deletePlayer} isAdmin={false} allTeams={teams} />
                                    </div>
                                )}
                            </div>
                        )}
                        {screen === 'ADMIN_SQUAD' && isAdmin && adminViewingTeam && <div><button onClick={()=>setScreen('HOME')}>Voltar</button><h3>Editando: {adminViewingTeam.name}</h3><MyTeam ps={players.filter(p=>p.teamId===adminViewingTeam.id)} onAdd={addPlayer} onUpd={updatePlayer} onDel={deletePlayer} isAdmin={true} allTeams={teams} /></div>}
                        {screen === 'MARKET' && <Market me={userTeam.id} teams={teams} ps={players} isVisitor={isVisitor||isAdmin} marketOpen={systemConfig.marketOpen} onOffer={(p)=>setOfferModal(p)} onPayClause={payClause} onPreContract={preContract} />}
                        {screen === 'RANKING' && <Ranking teams={teams} players={players} />}
                        {screen === 'NEWS' && <div><h3>Not√≠cias</h3>{news.map(n=><div key={n.id} className={`news-card news-${n.type}`}>{n.text}</div>)}</div>}
                    </div>

                    <div className="bottom-nav">
                        <div className="nav-item" onClick={()=>setScreen('HOME')}>TIME</div>
                        <div className="nav-item" onClick={()=>setScreen('MARKET')}>MERCADO</div>
                        <div className="nav-item" onClick={()=>setScreen('RANKING')}>RANK</div>
                        <div className="nav-item" onClick={()=>{setScreen('NEWS'); setHasNewNews(false); localStorage.setItem('lastReadNews', Date.now());}}>NEWS {hasNewNews && 'üî¥'}</div>
                    </div>

                    {showAdmin && !isAdmin && !isVisitor && <AdminModal team={userTeam} onClose={()=>setShowAdmin(false)} onUpdate={updateClubData} onReq={requestFinance} onUpgrade={upgradeStadium} onUpload={handleImageUpload} />}
                    {showAdmin && isAdmin && <div className="modal-bg"><div className="modal-card"><button className="btn-red" onClick={()=>window.location.reload()}>SAIR DO MODO ADMIN</button><br/><button className="btn" onClick={()=>setShowAdmin(false)}>FECHAR</button></div></div>}
                    {offerModal && <OfferForm p={offerModal} myPs={players.filter(p=>p.teamId===userTeam.id)} onSend={sendOffer} onClose={()=>setOfferModal(null)} />}
                    {showNotif && <div className="modal-bg"><div className="modal-card"><h3>Propostas</h3>{offers.map(o=><div key={o.id} style={{background:'#222', padding:5, margin:5}}><b>{o.playerName}</b> de {o.buyerName}<br/><button onClick={()=>acceptOffer(o)}>Aceitar</button> <button onClick={()=>{db.collection('offers').doc(o.id).delete(); setShowNotif(false);}}>Recusar</button></div>)}<button onClick={()=>setShowNotif(false)}>Fechar</button></div></div>}
                </div>
            );
        }

        // --- SUB-COMPONENTES ---
        function AdminModal({ team, onClose, onUpdate, onReq, onUpgrade, onUpload }) {
            const [tab, setTab] = useState(1);
            const [n, setN] = useState(team?.name); const [s, setS] = useState(team?.serie); const [l, setL] = useState(team?.logo);
            const [ra, setRa] = useState(''); const [rd, setRd] = useState(''); const [rt, setRt] = useState('INJECTION');
            return (
                <div className="modal-bg"><div className="modal-card">
                    <div className="login-tabs"><div className={`tab ${tab===1?'active':''}`} onClick={()=>setTab(1)}>DADOS</div><div className={`tab ${tab===2?'active':''}`} onClick={()=>setTab(2)}>FINAN√áAS</div></div>
                    {tab===1 ? (
                        <div>{l && <img src={l} className="login-logo-img"/>}<input type="file" className="file-input" onChange={e=>onUpload(e, setL)} /><input className="input-field" value={n} onChange={e=>setN(e.target.value)} /><select className="input-field" value={s} onChange={e=>setS(e.target.value)}><option>A</option><option>B</option><option>C</option></select><button className="btn-blue" onClick={()=>{onUpdate({name:n, serie:s, logo:l}); onClose();}}>SALVAR</button><div style={{marginTop:15, borderTop:'1px solid #444', paddingTop:10}}><p>Est√°dio N√≠vel {team?.stadiumLevel}</p><button className="btn-purple" onClick={onUpgrade}>EVOLUIR (‚Ç£ {STADIUM_COSTS[team?.stadiumLevel]?.toLocaleString()})</button></div></div>
                    ) : (
                        <div><select className="input-field" value={rt} onChange={e=>setRt(e.target.value)}><option value="INJECTION">Inje√ß√£o</option><option value="SPONSORSHIP">Patroc√≠nio</option></select><input className="input-field" type="number" placeholder="Valor" value={ra} onChange={e=>setRa(e.target.value)} /><input className="input-field" placeholder="Motivo" value={rd} onChange={e=>setRd(e.target.value)} /><button className="btn-green" onClick={()=>{onReq(rt, ra, rd); onClose();}}>ENVIAR</button></div>
                    )}
                    <button className="btn" style={{marginTop:10}} onClick={onClose}>FECHAR</button>
                </div></div>
            )
        }

        function Market({ me, teams, ps, isVisitor, marketOpen, onOffer, onPayClause, onPreContract }) {
            const [mode, setMode] = useState('MENU'); const [serie, setSerie] = useState('A'); const [selTeam, setSelTeam] = useState(null); const [globalType, setGlobalType] = useState(null);
            if(mode === 'MENU') return <div><h3>Mercado {marketOpen?'üü¢':'üî¥'}</h3><div style={{display:'flex', gap:10, marginBottom:20}}><div className="card" onClick={()=>{setGlobalType('VENDA'); setMode('GLOBAL');}} style={{flex:1, textAlign:'center'}}>üõí<br/>VENDA</div><div className="card" onClick={()=>{setGlobalType('EMPRESTIMO'); setMode('GLOBAL');}} style={{flex:1, textAlign:'center'}}>üîÑ<br/>EMP</div></div><h4>S√©ries</h4><div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10}}>{['A','B','C','D'].map(s=><div key={s} className="card" onClick={()=>{setSerie(s); setMode('SERIE');}} style={{textAlign:'center'}}><b>S√©rie {s}</b></div>)}</div></div>;
            if(mode === 'GLOBAL') { const list = ps.filter(p=>p.teamId!==me && p.status===globalType).sort((a,b)=>b.overall-a.overall); return <div><button onClick={()=>setMode('MENU')}>VOLTAR</button><h3>{globalType}</h3>{list.map(p=><PlayerCard key={p.id} p={p} ownerName={teams.find(t=>t.id===p.teamId)?.name} marketOpen={marketOpen} isVisitor={isVisitor} onOffer={onOffer} onPayClause={onPayClause} />)}</div> }
            if(mode === 'SERIE') { if(!selTeam) return <div><button onClick={()=>setMode('MENU')}>VOLTAR</button><h3>S√©rie {serie}</h3>{teams.filter(t=>t.serie===serie && (isVisitor || t.id!==me)).map(t=><div key={t.id} className="card" onClick={()=>setSelTeam(t)}><b>{t.name}</b></div>)}</div>; return <div><button onClick={()=>setSelTeam(null)}>VOLTAR</button><h3>{selTeam.name}</h3>{ps.filter(p=>p.teamId===selTeam.id).map(p=><PlayerCard key={p.id} p={p} marketOpen={marketOpen} isVisitor={isVisitor} onOffer={onOffer} onPayClause={onPayClause} onPre={onPreContract} />)}</div> }
        }

        function PlayerCard({ p, ownerName, marketOpen, isVisitor, onOffer, onPayClause, onPre }) {
            return <div className="card"><div className="player-header"><span className="player-name"><span className="pos-badge" style={{background: getPosColor(p.position)}}>{p.position}</span>{p.name}</span><span className="player-ov">{p.overall}</span></div><div className="player-details"><div>{ownerName}</div><div>üí∞ {fmt(p.value)}</div><div>üìÑ {p.contract} Anos</div></div>{!isVisitor && <div style={{marginTop:10}}>{p.clause>0 && <button className="btn-gold" onClick={()=>onPayClause(p)}>MULTA</button>} {marketOpen ? <button className="btn-purple" onClick={()=>onOffer(p)}>NEGOCIAR</button> : <small>FECHADO</small>}</div>}</div>
        }

        function MyTeam({ ps, onAdd, onUpd, onDel, isAdmin, allTeams }) {
            const [editP, setEditP] = useState(null); const [add, setAdd] = useState(false); const [np, setNp] = useState({n:'', p:'GOL', o:'', v:'', s:'', c:'', m:'', k:'3'}); const [ep, setEp] = useState({});
            return <div><button className="btn" onClick={()=>setAdd(!add)}>{add?'CANCELAR':'+ JOGADOR'}</button>
                {add && <div className="card"><input className="input-field" placeholder="Nome" value={np.n} onChange={e=>setNp({...np, n:e.target.value})} /><button className="btn-green" onClick={()=>{onAdd(np.n, np.p, np.o, np.v, np.s, np.m, np.k); setAdd(false);}}>CRIAR</button></div>}
                {editP && <div className="modal-bg"><div className="modal-card"><h3>Editar {editP.name}</h3><label>Nome:</label><input className="input-field" value={ep.n} onChange={e=>setEp({...ep, n:e.target.value})} /><label>Status:</label><select className="input-field" value={ep.s} onChange={e=>setEp({...ep, s:e.target.value})}><option value="NAO_A_VENDA">Normal</option><option value="VENDA">Venda</option><option value="EMPRESTIMO">Emp</option></select><input className="input-field" value={ep.v} onChange={e=>setEp({...ep, v:e.target.value})} placeholder="Valor" /><input className="input-field" value={ep.cl} onChange={e=>setEp({...ep, cl:e.target.value})} placeholder="Multa" />{isAdmin && <div style={{border:'1px solid gold', padding:5}}><label style={{color:'gold'}}>MUDAR TIME (ADM)</label><select className="input-field" value={ep.team} onChange={e=>setEp({...ep, team:e.target.value})}><option value="current">-- Manter --</option>{allTeams.map(t=><option key={t.id} value={t.id}>{t.name}</option>)}</select></div>}<button className="btn-green" onClick={()=>{onUpd(editP.id, ep.n, ep.s, ep.pos, ep.v, ep.o, ep.sal, ep.cl, ep.con, ep.team, ep.mood); setEditP(null);}}>SALVAR</button><button className="btn-red" onClick={()=>{onDel(editP.id); setEditP(null);}}>EXCLUIR</button><button className="btn" onClick={()=>setEditP(null)}>CANCELAR</button></div></div>}
                {ps.sort((a,b)=>b.overall-a.overall).map(p=><div key={p.id} className="card" onClick={()=>{setEditP(p); setEp({n:p.name, s:p.status, pos:p.position, v:p.value, o:p.overall, sal:p.salary, cl:p.clause, con:p.contract, mood:p.mood, team:'current'});}}><div className="player-header"><span className="player-name">{p.name}</span><span className="player-ov">{p.overall}</span></div><div className="player-details"><div>{p.position}</div><div>{fmt(p.value)}</div></div></div>)}
            </div>
        }

        function LoginScreen({ teams, onLogin, onCreate, onAdminLogin, onVisitor, onUpload }) {
            const [mode, setMode] = useState('LOGIN'); const [n, setN] = useState(''); const [b, setB] = useState('10000000'); const [s, setS] = useState('A'); const [p, setP] = useState(''); const [l, setL] = useState(null); const [sel, setSel] = useState(null); const [lp, setLp] = useState('');
            return <div style={{padding:20, textAlign:'center'}}><h1 style={{color:'#00E676'}}>Manager</h1><div className="login-tabs"><div className={`tab ${mode==='LOGIN'?'active':''}`} onClick={()=>setMode('LOGIN')}>ENTRAR</div><div className={`tab ${mode==='CREATE'?'active':''}`} onClick={()=>setMode('CREATE')}>CRIAR</div></div>
            {mode === 'LOGIN' ? <div>{teams.map(t=><div key={t.id} className="card" onClick={()=>setSel(t)}><b>{t.name}</b></div>)}<button className="btn-outline" onClick={onAdminLogin}>ADM</button></div> : <div><input type="file" className="file-input" onChange={e=>handleImageUpload(e, setL)} /><input className="input-field" placeholder="Nome" value={n} onChange={e=>setN(e.target.value)} /><input className="input-field" type="number" placeholder="Saldo" value={b} onChange={e=>setB(e.target.value)} /><input className="input-field" type="number" placeholder="Senha" value={p} onChange={e=>setP(e.target.value)} /><button className="btn-green" onClick={()=>onCreate(n,b,s,p,l)}>CRIAR</button></div>}
            {sel && <div className="modal-bg"><div className="modal-card"><h3>{sel.name}</h3><input className="input-field" type="password" placeholder="Senha" value={lp} onChange={e=>setLp(e.target.value)} /><button className="btn-green" onClick={()=>onLogin(sel, lp)}>ENTRAR</button><button className="btn" onClick={()=>setSel(null)}>CANCELAR</button></div></div>}</div>
        }
        function Ranking({ teams, players }) {
            const list = teams.map(t => ({ ...t, wealth: (t.balance||0) + players.filter(p => p.teamId === t.id).reduce((acc, p) => acc + (p.value || 0), 0) })).sort((a,b) => b.wealth - a.wealth);
            return <div><h3>Ranking</h3>{list.map((t, i) => <div key={t.id} className="card"><b>{i+1}. {t.name}</b> - {fmt(t.wealth)}</div>)}</div>
        }
        function OfferForm({ p, myPs, onSend, onClose }) {
            const [t, setT] = useState('COMPRA'); const [v, setV] = useState(p.oldVal||''); const [s, setS] = useState('1'); 
            return <div className="modal-bg"><div className="modal-card"><h3>Negociar {p.name}</h3><div style={{display:'flex', gap:5}}><button onClick={()=>setT('COMPRA')}>Compra</button><button onClick={()=>setT('EMPRESTIMO')}>Emp</button></div><input className="input-field" value={v} onChange={e=>setV(e.target.value)} placeholder="Valor" /><button className="btn-green" onClick={()=>onSend(p, t, v, null, s, p.oldOffer)}>ENVIAR</button><button className="btn" onClick={onClose}>CANCELAR</button></div></div>
        }
        function handleImageUpload(e, callback) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onloadend = () => callback(reader.result); reader.readAsDataURL(file); }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
