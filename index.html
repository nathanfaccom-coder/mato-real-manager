<!DOCTYPE html>
<html lang="pt-BR">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gerenciador de Times de Mato Real</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #121212; --bg-card: #1E1E1E; --bg-input: #2C2C2C;
            --primary: #00E676; --secondary: #2979FF; --danger: #FF1744; --warning: #FFC400; --purple: #D500F9;
            --text-main: #FFFFFF; --border: #333333;
        }
        body { background: var(--bg-dark); color: var(--text-main); font-family: 'Roboto', sans-serif; margin: 0; padding-bottom: 80px; -webkit-font-smoothing: antialiased; }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        .card { background: var(--bg-card); padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.4); position: relative; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; transition: 0.2s; margin-bottom: 5px; color: white; }
        .btn:active { transform: scale(0.98); }
        .btn-green { background: var(--primary); color: #000; }
        .btn-blue { background: var(--secondary); }
        .btn-red { background: var(--danger); }
        .btn-gold { background: var(--warning); color: #000; }
        .btn-purple { background: var(--purple); }
        .btn-ghost { background: transparent; border: 1px solid #666; color: #ccc; }
        .input-field { width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border); color: white; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-family: inherit; font-size: 14px; }
        .input-field:focus { outline: 2px solid var(--primary); border-color: transparent; }
        .header { background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px); padding: 15px; position: sticky; top: 0; z-index: 50; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .badge-pos { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 900; margin-right: 8px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        .player-ov { background: #003300; color: #00E676; border: 1px solid #00E676; padding: 2px 6px; border-radius: 4px; font-weight: 900; font-size: 14px; }
        .news-card { background: #262626; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #666; font-size: 13px; line-height: 1.4; white-space: pre-wrap; }
        .news-transfer { border-color: var(--secondary); background: linear-gradient(90deg, #1a1a2e, #16213e); }
        .news-money { border-color: var(--primary); }
        .news-money-minus { border-color: var(--danger); }
        .news-admin { border-color: var(--warning); background: #2a2000; }
        .news-press { border-color: #00bcd4; background: #003333; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; border-top: 1px solid var(--border); display: flex; padding-bottom: env(safe-area-inset-bottom); z-index: 100; }
        .nav-item { flex: 1; padding: 12px; text-align: center; color: #666; font-size: 9px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; display: block; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 999; display: grid; place-items: center; padding: 15px; backdrop-filter: blur(5px); }
        .modal-content { background: var(--bg-card); width: 100%; max-width: 450px; padding: 20px; border-radius: 12px; border: 1px solid var(--border); max-height: 90vh; overflow-y: auto; }
        .login-tabs { display: flex; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #666; font-weight: bold; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .rating-badge { color: var(--warning); font-weight: bold; font-size: 11px; margin-left: 5px; display: flex; align-items: center; gap: 2px; text-shadow: 0 1px 2px black; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 10px; margin-top: 10px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 8px; }
        .stat-item { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .stat-lbl { font-size: 14px; margin-bottom: 2px; }
        .stat-val { color: #fff; font-weight: 900; font-size: 11px; }
        .dev-credits { font-size: 10px; color: #666; margin-top: -5px; margin-bottom: 15px; text-align: center; display: block; width: 100%; }
        .error-screen { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #220000; color: #ff5555; padding: 20px; text-align: center; }
        .rank-tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .rank-tabs::-webkit-scrollbar { display: none; }
        .rank-tab { background: #333; border: 1px solid #444; color: #888; padding: 8px 16px; border-radius: 20px; font-size: 12px; white-space: nowrap; cursor: pointer; transition: 0.2s; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .rank-tab.active { background: var(--primary); color: #000; border-color: var(--primary); box-shadow: 0 0 10px rgba(0,230,118,0.3); }
        .rank-tab i { font-size: 14px; }
        .highlight-card { background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%); border: 1px solid var(--secondary); padding: 20px; text-align: center; margin-bottom: 15px; border-radius: 12px; position: relative; overflow: hidden; }
        .highlight-card::after { content: '‚òÖ'; position: absolute; top: -10px; right: -10px; font-size: 100px; color: rgba(255,255,255,0.05); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Crash:", error, errorInfo); }
            render() { if (this.state.hasError) { return <div className="error-screen"><h2>Ocorreu um erro!</h2><p>O aplicativo encontrou um problema inesperado.</p><button className="btn btn-red" onClick={()=>{localStorage.clear(); window.location.reload();}}>REINICIAR APLICATIVO</button></div>; } return this.props.children; }
        }

        const firebaseConfig = { apiKey: "AIzaSyBrtJFfWAqT0AZYHlm4it-noB5h9jIPJEI", authDomain: "gerenciador-de-times-matoreal.firebaseapp.com", projectId: "gerenciador-de-times-matoreal", storageBucket: "gerenciador-de-times-matoreal.firebasestorage.app", messagingSenderId: "29096266740", appId: "1:29096266740:web:ec48e7225c18c20dbc07a1" };
        try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch (e) { console.error(e); }
        const db = firebase.firestore();
        const { useState, useEffect } = React;

        const POS = ['GOL', 'ZAG', 'LD', 'LE', 'VOL', 'MC', 'MEI', 'ATA'];
        const SERIES = ['A', 'B', 'C', 'D'];
        const COSTS = [0, 5000000, 20000000, 50000000, 100000000];
        const fmt = (v) => "‚Ç£ " + parseFloat(v||0).toLocaleString('pt-BR');
        const getPosColor = (p) => { if(!p) return '#555'; if(p==='GOL') return '#FFD700'; if(['ZAG','LD','LE'].some(x=>p.includes(x))) return '#2979FF'; if(['VOL','MC','MEI'].some(x=>p.includes(x))) return '#00E676'; return '#FF1744'; };

        // --- CONSTANTES DE EMPRESAS ---
        const COMPANY_TYPES = {
            'COMERCIO': { label: 'Com√©rcio Local', start: 2500000, tax: 50000, desc: 'Ideal para iniciantes. Imposto baixo.' },
            'MEDIA': { label: 'M√©dia Empresa', start: 20000000, tax: 350000, desc: 'Poder moderado. Imposto m√©dio.' },
            'GRANDE': { label: 'Grande Empresa', start: 100000000, tax: 2000000, desc: 'Gigante do mercado. Imposto alto.' }
        };
        const PROD_CATS = {
            'CHUTEIRA': 'üëü Chuteira',
            'LUVAS': 'üß§ Luvas/Acess√≥rios',
            'CONSUMIVEL': '‚ö° Consum√≠vel/Energia',
            'VEICULO': 'üöó Ve√≠culo',
            'IMOVEL': 'üè† Im√≥vel',
            'TECNOLOGIA': 'üì± Tecnologia',
            'LUXO': 'üíé Luxo/Moda',
            'SAUDE': 'üíä Sa√∫de'
        };

// FIM DO BLOCO INICIAL

      // --- SISTEMA DE ATRIBUTOS REALISTA (v1.54.1) ---
// (Substitui o antigo Sistema de RPG)

const ATTR_LABELS = {
    // F√≠sico
    balance: '‚öñÔ∏è Equil√≠brio', stamina: 'üîã Resist√™ncia', speed: '‚ö° Veloc. M√°x.',
    accel: 'üöÄ Acelera√ß√£o', agility: 'ü§∏ Agilidade', jump: 'ü¶ò Impuls√£o', condition: 'üí™ Cond. F√≠sica',
    // T√©cnica
    attack: '‚öîÔ∏è Ataque', dribble: '‚öΩ Drible', dribbleSpd: 'üèÉüí® Drib. Veloc.',
    shortPass: 'üéØ Passe Curto', shortPassSpd: '‚è© P. Curto Vel.',
    longPass: 'üì° Passe Longo', longPassSpd: 'üöÄ P. Longo Vel.',
    shot: 'üî´ Finaliza√ß√£o', shotPower: 'üí£ For√ßa Chute', shotTech: 'üé® T√©c. Chute',
    freeKick: 'üéØ Falta', curve: 'üçå Efeito', header: 'ü§ï Cabeceio', tech: '‚ú® T√©cnica',
    weakFootAcc: 'ü¶∂ Pior P√© Prec.', weakFootFreq: 'üîÑ Pior P√© Freq.',
    // Mental/Defesa
    defense: 'üõ°Ô∏è Defesa', response: 'üß† Resposta', aggression: 'üò° Agressividade',
    mentality: 'üß† Atitude', teamwork: 'ü§ù Trabalho Eq.',
    // Goleiro
    gk: 'üß§ Hab. Goleiro'
};

const getAttrColor = (val) => {
    if (val >= 90) return '#2979FF'; // Azul (Craque/Lenda)
    if (val >= 75) return '#00E676'; // Verde (Bom)
    if (val >= 60) return '#FFC400'; // Amarelo (M√©dio)
    return '#FF1744';                // Vermelho (Baixo)
};

// Gerador de Atributos V3 (Realista e Contido)
const generateAttributes = (pos, targetOv) => {
    const ov = parseInt(targetOv) || 50;
    const attrs = {};
    const keys = Object.keys(ATTR_LABELS);

    // Defini√ß√£o de prioridades
    let primary = [], secondary = [];

    if (pos === 'GOL') {
        primary = ['gk', 'response', 'jump', 'longPass'];
        secondary = ['balance', 'strength', 'mentality', 'defense'];
    } else if (pos.includes('ZAG')) {
        primary = ['defense', 'header', 'balance', 'jump', 'aggression'];
        secondary = ['stamina', 'response', 'shortPass', 'longPass'];
    } else if (pos.includes('LAT') || pos.includes('LD') || pos.includes('LE')) {
        primary = ['speed', 'accel', 'stamina', 'shortPass', 'dribble'];
        secondary = ['defense', 'longPass', 'curve', 'attack'];
    } else if (pos.includes('VOL') || pos.includes('MC')) {
        primary = ['shortPass', 'stamina', 'teamwork', 'defense', 'balance'];
        secondary = ['longPass', 'tech', 'shotPower', 'vision'];
    } else if (pos.includes('MEI') || pos.includes('MAT')) {
        primary = ['dribble', 'shortPass', 'vision', 'tech', 'curve', 'agility'];
        secondary = ['shot', 'speed', 'attack', 'freeKick'];
    } else if (pos.includes('ATA') || pos.includes('SA') || pos.includes('PNT')) {
        primary = ['shot', 'attack', 'header', 'speed', 'accel', 'shotPower'];
        secondary = ['dribble', 'agility', 'balance', 'reaction'];
    }

    // 1. Gera√ß√£o Base Mais Conservadora
    keys.forEach(k => {
        let base = ov;
        
        // Em vez de somar +12, somamos menos para manter perto da m√©dia real
        if (primary.includes(k)) {
            base += Math.floor(Math.random() * 6) + 2; // +2 a +8 (Forte, mas n√£o absurdo)
        } else if (secondary.includes(k)) {
            base -= Math.floor(Math.random() * 4); // -0 a -4 (Levemente abaixo da m√©dia)
        } else {
            base -= Math.floor(Math.random() * 10) + 5; // -5 a -15 (Fraco, mas n√£o in√∫til)
        }

        // Ajustes fixos para Goleiro/Linha (mantidos, mas suavizados)
        if (pos !== 'GOL' && k === 'gk') base = 10; 
        if (pos === 'GOL' && ['shot', 'attack', 'dribble', 'curve', 'freeKick'].includes(k)) base = Math.max(15, base - 20);

        // Trava de seguran√ßa: Se o Overall for baixo (<80), evita passar de 90
        if (ov < 80 && base > 88) base = 88;
        
        if (base > 99) base = 99;
        if (base < 1) base = 1;
        
        attrs[k] = base;
    });

    // 2. Normaliza√ß√£o Precisa
    const relevantKeys = keys.filter(k => {
        if (pos === 'GOL') return !['shot', 'attack', 'dribble', 'curve', 'freeKick', 'weakFootAcc', 'weakFootFreq'].includes(k);
        return k !== 'gk';
    });
    
    let sum = 0;
    relevantKeys.forEach(k => sum += attrs[k]);
    const currentAvg = sum / relevantKeys.length;
    const diff = ov - currentAvg; // Quanto falta para atingir o Overall
    
    // Distribui a diferen√ßa
    relevantKeys.forEach(k => {
        // Se a diferen√ßa for positiva (precisa aumentar), prioriza quem j√° √© atributo prim√°rio
        let boost = diff;
        
        // Se o atributo j√° for muito alto (>90) e o overall meta for baixo (<85), n√£o aumenta mais
        if (attrs[k] > 90 && ov < 85 && diff > 0) boost = 0;

        let newVal = attrs[k] + boost;
        
        if (newVal > 99) newVal = 99;
        if (newVal < 1) newVal = 1;
        attrs[k] = Math.round(newVal);
    });

    return attrs;
};

// Componente Visualizador de Atributos
const AttributeGrid = ({ attrs, pendingXP }) => {
    if (!attrs) return <small>Atributos n√£o gerados.</small>;
    
    const pointsToAdd = pendingXP ? Math.floor(pendingXP / 100) : 0;
    const projectionText = pointsToAdd !== 0 ? (pointsToAdd > 0 ? ` (+${pointsToAdd} pts)` : ` (${pointsToAdd} pts)`) : '';
    const projectionColor = pointsToAdd > 0 ? '#00E676' : (pointsToAdd < 0 ? '#FF1744' : '#666');

    return (
        <div style={{marginTop: 10}}>
            <div style={{display:'flex', justifyContent:'space-between', marginBottom:5}}>
                <small style={{color:'#aaa'}}>Atributos</small>
                <small style={{color: projectionColor, fontWeight:'bold'}}>Evolu√ß√£o Prevista: {projectionText}</small>
            </div>
            <div style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '4px'}}>
                {Object.entries(attrs).map(([key, val]) => (
                    <div key={key} style={{background: 'rgba(0,0,0,0.3)', padding: '4px', borderRadius: '4px', fontSize: '9px', display:'flex', justifyContent:'space-between'}}>
                        <span style={{color:'#ccc', overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap', marginRight:3}} title={ATTR_LABELS[key]}>
                            {ATTR_LABELS[key] || key}
                        </span>
                        <b style={{color: getAttrColor(val)}}>{val}</b>
                    </div>
                ))}
            </div>
        </div>
    );
};
        

const formatOfferDetails = (type, v, con, meta, swapIds, players) => {
    let details = [];
    if(v > 0) details.push(`üí∞ Valor: ${fmt(v)}`);
    if (meta.installments > 1) details.push(`üìÖ Parcelamento: ${meta.installments}x de ${fmt(v/meta.installments)}`);
    if (type !== 'TROCA') details.push(`üìù Contrato: ${con} Temporadas`);
    if (type === 'COMPRA' && meta.sellOn > 0) details.push(`üìà Revenda: ${meta.sellOn}% futura venda`);
    if (type === 'EMPRESTIMO') { details.push(`üí∏ Sal√°rios: Comprador paga ${meta.wageSplit}%`); if (meta.buyOpt > 0) details.push(`üõí Op√ß√£o de Compra: ${fmt(meta.buyOpt)}`); }
    if (type === 'TROCA') {
        if (swapIds && swapIds.length > 0) { const swapNames = swapIds.map(id => players.find(p=>p.id===id)?.name).join(', '); details.push(`üîÑ Troca por: ${swapNames}`); }
        if (v > 0) details.push(`üíµ Volta: ${meta.cashDir === 'PAY' ? 'Eu pago' : 'Eu recebo'} ${fmt(v)}`);
    }
    return details.join('\n');
};
// FIM DO SISTEMA DE RPG E FORMATADOR DE OFERTAS



       // ... continua√ß√£o do c√≥digo anterior
        function App() {
            const [user, setUser] = useState(null); 
            const [teams, setTeams] = useState([]);
            const [players, setPlayers] = useState([]);
            const [offers, setOffers] = useState([]);
            const [news, setNews] = useState([]);
            const [reqs, setReqs] = useState([]);
            const [conf, setConf] = useState({ marketOpen: true });
            const [papers, setPapers] = useState([]);
            const [journalists, setJournalists] = useState([]);
            const [companies, setCompanies] = useState([]);
            const [products, setProducts] = useState([]);
            const [sps, setSps] = useState([]);
            
            const [screen, setScreen] = useState('HOME');
            const [modal, setModal] = useState(null);
            const [loading, setLoading] = useState(true);
            const [newNews, setNewNews] = useState(false);
            const [adminTeam, setAdminTeam] = useState(null); 
            const [sales, setSales] = useState([]);

            useEffect(() => {
                const unsubs = [
                    db.collection('teams').onSnapshot(s => setTeams(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    db.collection('players').onSnapshot(s => setPlayers(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    db.collection('config').doc('system').onSnapshot(s => setConf(s.exists ? s.data() : {marketOpen:true})),
                    db.collection('financeRequests').onSnapshot(s => setReqs(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    db.collection('newspapers').onSnapshot(s => setPapers(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    db.collection('journalists').onSnapshot(s => setJournalists(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    
                    db.collection('companies').onSnapshot(s => setCompanies(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    db.collection('products').onSnapshot(s => setProducts(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    db.collection('sponsorships').onSnapshot(s => setSps(s.docs.map(d => ({id:d.id, ...d.data()})))),
                    db.collection('sales').orderBy('date', 'desc').limit(50).onSnapshot(s => setSales(s.docs.map(d => d.data()))),
                    db.collection('news').orderBy('date', 'desc').limit(50).onSnapshot(s => { const list = s.docs.map(d => ({id:d.id, ...d.data()})); setNews(list); const lastRead = localStorage.getItem('lastRead'); if (list.length && (!lastRead || list[0].date > parseInt(lastRead))) setNewNews(true); setLoading(false); })
                ];
                return () => unsubs.forEach(u => u());
            }, []);

            useEffect(() => {
                let unsubOffers = () => {};

                // Se for um Time (USER) ou um Jogador (PLAYER)
                if (user?.type === 'USER' || user?.type === 'PLAYER') {
                    // Sincroniza os dados do perfil logado (evita dados obsoletos ao trocar de tela)
                    const me = user.type === 'USER' 
                        ? teams.find(t => t.id === user.data.id)
                        : players.find(p => p.id === user.data.id);
                    
                    if (me) setUser(prev => ({...prev, data: me}));
                    
                    // --- CANAL DE PROPOSTAS REAL-TIME (CORRIGIDO) ---
                    // Escuta global de ofertas. Quando o Clube Vendedor aceita, 
                    // o recipientId muda no banco e o sino do jogador brilha na hora.
                    unsubOffers = db.collection('offers').onSnapshot(s => {
                        setOffers(s.docs.map(d => ({id: d.id, ...d.data()})));
                    }, (err) => console.error("Erro na escuta de ofertas:", err));
                }
                
                // L√≥gica para Empresas (COMPANY)
                if (user?.type === 'COMPANY') {
                    const me = companies.find(c => c.id === user.data.id);
                    if (me) {
                        if (me.status === 'BLOCKED') { 
                            alert("üö´ Sua empresa foi bloqueada ou faliu."); 
                            window.location.reload(); 
                        } else {
                            setUser(prev => ({...prev, data: me}));
                        }
                    }
                }

                // LIMPEZA: S√≥ desativa a escuta quando o componente App for destru√≠do
                return () => unsubOffers();
            }, [teams, players, companies, user?.data?.id, user?.type]); 

            // Fun√ß√£o centralizada para postagem de not√≠cias
            const postNews = (text, type = 'normal') => {
                return db.collection('news').add({ 
                    text, 
                    type, 
                    date: Date.now() 
                });
            };

            const login = (id, pwd, type) => {
                if (type === 'TEAM') { 
                    const t = teams.find(x => x.id === id); 
                    if (t && t.password === pwd) { 
                        if (t.status === 'PENDING') alert("‚è≥ Aguarde a aprova√ß√£o da Federa√ß√£o."); 
                        else { setUser({type:'USER', data:t}); setScreen('HOME'); } 
                    } else alert("Senha ou ID incorretos!"); 
                } 
                else if (type === 'PAPER') { 
                    const p = papers.find(x => x.id === id); 
                    if (p && p.password === pwd) { 
                        if (p.status === 'PENDING') alert("‚è≥ Jornal aguardando aprova√ß√£o."); 
                        else { setUser({type:'PRESS', data:p}); setScreen('PRESS_DASH'); } 
                    } else alert("Erro no login da Imprensa!"); 
                } 
                else if (type === 'JOURNALIST') { 
                    const j = journalists.find(x => x.id === id); 
                    if (j && j.password === pwd) { 
                        if (j.status === 'PENDING') alert("‚è≥ Pe√ßa ao dono do jornal para aprovar seu acesso."); 
                        else { setUser({type:'PRESS_WORKER', data:j}); setScreen('PRESS_DASH'); } 
                    } else alert("Erro no login do Jornalista!"); 
                }
                else if (type === 'COMPANY') { 
                    const c = companies.find(x => x.id === id); 
                    if (c && c.password === pwd) { 
                        if (c.status === 'PENDING') alert("‚è≥ Empresa aguardando alvar√° da Federa√ß√£o."); 
                        else if (c.status === 'BLOCKED') alert("üö´ Esta empresa est√° bloqueada."); 
                        else { setUser({type:'COMPANY', data:c}); setScreen('COMPANY_HOME'); } 
                    } else alert("Senha da Empresa incorreta!"); 
                }
                else if (type === 'PLAYER') { 
                     const pl = players.find(x => x.id === id); 
                     const pass = pl.password || '1234'; 
                     if (pl && pass === pwd) { 
                         setUser({type:'PLAYER', data:pl}); 
                         setScreen('PLAYER_DASH'); 
                     } else alert("Senha do Jogador incorreta!"); 
                }
            };

// FIM DA FUN√á√ÉO LOGIN E IN√çCIO DO COMPONENTE APP

           // ... continua√ß√£o do c√≥digo anterior
            const loginAdmin = () => { setUser({ type: 'ADMIN', data: { id: 'admin', name: 'FEDERA√á√ÉO (ADM)', balance: 0, logo: null, stadiumLevel: 1, serie: 'ADM' } }); setScreen('HOME'); };

            const createTeam = async (name, bal, serie, pass, logo) => { if(teams.find(t=>t.name.toLowerCase()===name.toLowerCase())) return alert("Nome em uso!"); await db.collection('teams').add({ name, balance: parseFloat(bal), serie, password: pass, stadiumLevel: 1, logo: logo||null, status: 'PENDING' }); alert("Criado! Aguarde aprova√ß√£o."); };

            const createNewspaper = async (name, pass, owner) => { await db.collection('newspapers').add({ name, password: pass, ownerName: owner, status: 'PENDING' }); alert("Jornal criado! Aguarde Federa√ß√£o."); };

            const createJournalist = async (name, pass, paperId) => { await db.collection('journalists').add({ name, password: pass, newspaperId: paperId, status: 'PENDING' }); alert("Conta criada! Aguarde seu Chefe."); };

// FIM DAS FUN√á√ïES DE CRIA√á√ÉO E ACESSO ADMIN
// --- COLE ISSO DENTRO DA FUNCTION APP(), ANTES DO RETURN ---

        const adminAction = async (act, data) => {
            if (act === 'MARKET') {
                db.collection('config').doc('system').update({ marketOpen: data });
                postNews(data ? "üì¢ JANELA ABERTA" : "üîí JANELA FECHADA", 'infra');
            }

            // --- VIRADA DE SEMANA ---
            if (act === 'WEEK') {
                if (!confirm("‚ö†Ô∏è VIRAR SEMANA?\n\n1. Pagar Sal√°rios (+)\n2. Cobrar Imposto Jogador (3%)\n3. Recuperar Energia (100%)\n4. Empresas e XP")) return;

                setLoading(true);
                const b = db.batch();

                players.forEach(p => {
                    if (p.teamId && p.teamId !== 'FREE') {
                        if (teams.some(t => t.id === p.teamId)) {
                            const currentBal = parseFloat(p.balance) || 0;
                            const salary = parseFloat(p.salary) || 0;
                            const tax = currentBal * 0.03;
                            const finalBalance = (currentBal + salary) - tax;
                            const xpTotal = (p.xp || 0) + (p.pendingXP || 0);

                            b.update(db.collection('players').doc(p.id), {
                                balance: finalBalance,
                                energy: 100,
                                xp: xpTotal,
                                pendingXP: 0
                            });
                        }
                    }
                });

                teams.forEach(t => {
                    const currentBal = parseFloat(t.balance) || 0;
                    const wages = players.filter(p => p.teamId === t.id).reduce((a, p) => a + (parseFloat(p.salary) || 0), 0);
                    const income = sps.filter(s => s.teamId === t.id && s.status === 'ACTIVE').reduce((a, s) => a + parseFloat(s.value), 0);
                    b.update(db.collection('teams').doc(t.id), {
                        balance: currentBal + income - wages
                    });
                });

                companies.forEach(c => {
                    if (c.status === 'ACTIVE') {
                        const currentBal = parseFloat(c.balance) || 0;
                        const type = c.companyType || 'COMERCIO';
                        const tax = (COMPANY_TYPES[type] || {}).tax || 50000;
                        b.update(db.collection('companies').doc(c.id), {
                            balance: currentBal - tax
                        });
                    }
                });

                const ds = await db.collection('debts').get();
                ds.docs.forEach(doc => {
                    const d = doc.data();
                    const buyerExists = teams.some(t => t.id === d.buyerId);
                    const sellerExists = teams.some(t => t.id === d.sellerId);

                    if (!buyerExists || !sellerExists) {
                        b.delete(doc.ref);
                    } else if (d.weeksRemaining > 0) {
                        b.update(db.collection('teams').doc(d.buyerId), { balance: firebase.firestore.FieldValue.increment(-d.installmentVal) });
                        b.update(db.collection('teams').doc(d.sellerId), { balance: firebase.firestore.FieldValue.increment(d.installmentVal) });
                        if (d.weeksRemaining - 1 === 0) {
                            b.delete(doc.ref);
                            postNews(`‚úÖ **D√çVIDA QUITADA**\n${d.buyerName} terminou de pagar ${d.playerName}.`, 'money');
                        } else {
                            b.update(doc.ref, { weeksRemaining: d.weeksRemaining - 1 });
                            postNews(`üí≥ **PARCELA PAGA**\n${d.buyerName} pagou a parcela (${d.weeksRemaining}x) de ${d.playerName}.`, 'money-minus');
                        }
                    }
                });

                try {
                    await b.commit();
                    alert("Semana processada!");
                } catch (error) {
                    alert("Erro: " + error.message);
                }
                setLoading(false);
            }

            // --- VIRADA DE TEMPORADA (ATRIBUTOS REALISTAS v1.54.1) ---
            if (act === 'SEASON') {
                if (!confirm("‚ö†Ô∏è VIRAR TEMPORADA?\n\n1. Evoluir Atributos (XP)\n2. Envelhecer Contratos\n3. Processar Retornos")) return;

                setLoading(true);
                const b = db.batch();

                players.forEach(p => {
                    let u = {};

                    // 1. SISTEMA DE EVOLU√á√ÉO DE ATRIBUTOS (NOVO)
                    const totalXP = (p.xp || 0) + (p.pendingXP || 0);
                    const pointsToDistribute = Math.floor(totalXP / 100); // 100 XP = 1 Ponto
                    const remainderXP = totalXP % 100;

                    if (p.attributes && pointsToDistribute !== 0) {
                        let newAttrs = { ...p.attributes };
                        const keys = Object.keys(newAttrs);
                        const absPoints = Math.abs(pointsToDistribute);
                        const isPositive = pointsToDistribute > 0;

                        // Distribui pontos aleatoriamente
                        for (let i = 0; i < absPoints; i++) {
                            const randomKey = keys[Math.floor(Math.random() * keys.length)];
                            if (isPositive) {
                                if (newAttrs[randomKey] < 99) newAttrs[randomKey]++;
                            } else {
                                if (newAttrs[randomKey] > 1) newAttrs[randomKey]--;
                            }
                        }

                        u.attributes = newAttrs;
                        // Recalcula Overall (M√©dia)
                        const vals = Object.values(newAttrs);
                        const newOverall = Math.round(vals.reduce((acc, curr) => acc + curr, 0) / vals.length);
                        
                        u.overall = newOverall;
                        u.xp = remainderXP;
                        u.pendingXP = 0;
                    } 
                    // Fallback para jogadores antigos sem atributos (apenas zera o XP)
                    else {
                        u.xp = 0;
                        u.pendingXP = 0;
                    }

                    // 2. ENVELHECIMENTO DE CONTRATOS
                    let nc = (parseInt(p.contract) || 0) - 1;
                    if (nc < 0) nc = 0;
                    u.contract = nc;

                    // 3. L√ìGICA DE FIM DE V√çNCULO / EMPR√âSTIMO
                    if (nc === 0 && p.loanMeta && p.loanMeta.ownerId) {
                        const ownerId = p.loanMeta.ownerId;
                        const ownerTeam = teams.find(t => t.id === ownerId);
                        
                        if (p.loanMeta.hasBuyOption && p.loanMeta.buyOpt > 0) {
                            // Tem op√ß√£o de compra: gera oferta
                            const currentTeam = teams.find(t => t.id === p.teamId);
                            const offerRef = db.collection('offers').doc();
                            b.set(offerRef, {
                                type: 'COMPRA_DEFINITIVA',
                                playerId: p.id,
                                playerName: p.name,
                                buyerId: p.teamId,
                                buyerName: currentTeam?.name || 'Clube Atual',
                                sellerId: ownerId,
                                recipientId: p.teamId, 
                                value: p.loanMeta.buyOpt,
                                status: 'PENDING',
                                description: `üèÅ **FIM DE EMPR√âSTIMO**\nDeseja exercer a op√ß√£o de compra de **${p.name}** por ${fmt(p.loanMeta.buyOpt)}?\nCaso recuse, o jogador retornar√° ao clube de origem.`,
                                date: Date.now(),
                                isLoanOption: true 
                            });
                            u.status = 'INTRANSFERIVEL'; 
                        } else {
                            // Sem op√ß√£o: verifica contrato original
                            let contractWithDonoRemaining = (parseInt(p.loanMeta.originalContract) || 1) - 1;

                            if (contractWithDonoRemaining <= 0) {
                                const renewalReqRef = db.collection('offers').doc();
                                b.set(renewalReqRef, {
                                    type: 'RENOVACAO_URGENTE',
                                    playerId: p.id,
                                    playerName: p.name,
                                    buyerId: ownerId,
                                    buyerName: ownerTeam?.name || 'Clube de Origem',
                                    sellerId: 'SISTEMA',
                                    recipientId: ownerId,
                                    status: 'PENDING',
                                    description: `‚ö†Ô∏è **URGENTE: FIM DE V√çNCULO**\nO empr√©stimo de **${p.name}** acabou e ele est√° sem contrato com voc√™.`,
                                    date: Date.now()
                                });
                                u.teamId = ownerId;
                                u.contract = 0;
                                u.status = 'INTRANSFERIVEL';
                            } else {
                                u.teamId = ownerId;
                                u.contract = contractWithDonoRemaining;
                                u.status = 'NAO_A_VENDA';
                                
                                const notifRef = db.collection('offers').doc();
                                b.set(notifRef, {
                                    type: 'NOTIFICACAO',
                                    playerId: p.id,
                                    playerName: p.name,
                                    buyerName: 'Sistema',
                                    recipientId: ownerId,
                                    status: 'PENDING',
                                    description: `üîô **RETORNO DE EMPR√âSTIMO**\nO jogador **${p.name}** retornou ao seu elenco.\n\nüìÑ Contrato Restante: ${contractWithDonoRemaining} temporada(s).`,
                                    date: Date.now()
                                });
                                postNews(`üîô **RETORNO**\n${p.name} voltou ao ${ownerTeam?.name} (${contractWithDonoRemaining} anos rest.).`, 'transfer');
                            }
                            u.loanMeta = firebase.firestore.FieldValue.delete(); 
                        }
                    } 
                    // PR√â-CONTRATO / AGENTE LIVRE
                    else if (nc === 0 && (!p.loanMeta || !p.loanMeta.ownerId)) {
                        if (p.preContract && teams.some(t => t.id === p.preContract.teamId)) {
                            u.teamId = p.preContract.teamId;
                            u.contract = 2;
                            u.status = 'NAO_A_VENDA';
                            u.preContract = firebase.firestore.FieldValue.delete();
                        } else {
                            u.teamId = 'FREE';
                            u.status = 'VENDA';
                            u.mood = 'üòê';
                            u.loanMeta = firebase.firestore.FieldValue.delete();
                        }
                    }

                    b.update(db.collection('players').doc(p.id), u);
                });

                try {
                    await b.commit();
                    alert("Temporada virada! Atributos evolu√≠dos.");
                } catch (e) {
                    alert("Erro: " + e.message);
                }
                setLoading(false);
                postNews("üí™ **PR√â-TEMPORADA**\nOs jogadores treinaram e seus atributos foram atualizados!", 'season');
            }
        };
            
            const createCompany = async (f) => {
                if(!f.n || !f.p) return alert("Preencha tudo!");
                await db.collection('companies').add({ name: f.n, owner: f.owner, password: f.p, companyType: f.type, balance: COMPANY_TYPES[f.type].start, status: 'PENDING' });
                alert("Solicita√ß√£o enviada! Aguarde a Federa√ß√£o.");
            };

            // --- ETAPA 2: L√≥gica de Produtos ---
            const saveProduct = async (p) => {
                const price = parseFloat(p.price);
                const payload = { 
                    name: p.name, 
                    price, 
                    img: p.img, 
                    desc: p.desc,
                    cat: p.cat || 'CHUTEIRA', 
                    companyId: user.data.id 
                };

                if (p.id) {
                    const old = products.find(x=>x.id===p.id);
                    if (old && price < old.price) { postNews(`üö® **PROMO√á√ÉO!**\nA **${user.data.name}** baixou o pre√ßo de **${p.name}**!\nDe: ${fmt(old.price)} ‚ûù Por: ${fmt(price)}`, 'biz'); }
                    delete payload.companyId; 
                    await db.collection('products').doc(p.id).update(payload);
                } else {
                    await db.collection('products').add(payload);
                    postNews(`üõçÔ∏è **NOVIDADE**\nA **${user.data.name}** lan√ßou: **${p.name}** (${PROD_CATS[payload.cat]}) por ${fmt(price)}.`, 'biz');
                }
            };

            // --- ETAPA 3: L√≥gica de Shopping e Patroc√≠nio ---
            const requestSponsorship = async (companyId, val) => {
                if (sps.find(s => s.companyId === companyId && s.teamId === user.data.id)) {
                    return alert("J√° existe uma negocia√ß√£o ou contrato ativo com esta empresa.");
                }
                const comp = companies.find(c => c.id === companyId);
                await db.collection('sponsorships').add({ 
                    companyId, 
                    companyName: comp.name, 
                    teamId: user.data.id, 
                    teamName: user.data.name, 
                    value: parseFloat(val), 
                    status: 'PENDING' 
                });
                alert("Proposta enviada para a empresa!");
            };

            const processSponsorship = async (s, status) => {
                if (status === 'REJECTED' || status === 'CANCELLED') {
                    if(confirm(status === 'REJECTED' ? "Recusar proposta?" : "Cancelar contrato?")) {
                        await db.collection('sponsorships').doc(s.id).delete();
                    }
                } else if (status === 'ACTIVE') {
                    await db.collection('sponsorships').doc(s.id).update({ status: 'ACTIVE' });
                    postNews(`ü§ù **NOVO PATROC√çNIO**\nA **${user.data.name}** agora patrocina o **${s.teamName}**!`, 'biz');
                }
            };

            const buyProduct = async (prod, seller) => {
                const currentBalance = user.data.balance || 0;
                if (currentBalance < prod.price) return alert("Saldo insuficiente!");
                if (!confirm(`Comprar ${prod.name} por ${fmt(prod.price)}?`)) return;

                const b = db.batch();
                if (user.type === 'PLAYER') {
                    b.update(db.collection('players').doc(user.data.id), { balance: currentBalance - prod.price });
                } else {
                    b.update(db.collection('teams').doc(user.data.id), { balance: currentBalance - prod.price });
                }

                b.update(db.collection('companies').doc(seller.id), { balance: seller.balance + prod.price });

                const saleRef = db.collection('sales').doc();
                b.set(saleRef, { 
                    companyId: seller.id, 
                    productName: prod.name, 
                    buyerName: user.data.name, 
                    price: prod.price, 
                    date: Date.now() 
                });
                
                await b.commit();
                alert("Compra realizada com sucesso!");
            };
// --- FUN√á√ÉO DE RESETAR O BANCO DE DADOS (DENTRO DO APP) ---
            const resetDatabase = async () => {
                const senha = prompt("‚ö†Ô∏è PERIGO: Isso apagar√° TODOS os dados do jogo. Digite a senha master para confirmar:");
                if (senha !== '2503') return; 

                if (!confirm("TEM CERTEZA? Todos os times, jogadores e finan√ßas sumir√£o para sempre!")) return;

                setLoading(true);
                const collections = ['teams', 'players', 'news', 'offers', 'sponsorships', 'sales', 'debts', 'financeRequests', 'products', 'companies', 'journalists', 'newspapers'];
                
                try {
                    for (const col of collections) {
                        const snapshot = await db.collection(col).get();
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                    }
                    alert("üí• BANCO DE DADOS RESETADO! O sistema ir√° reiniciar.");
                    window.location.reload();
                } catch (e) {
                    alert("Erro ao resetar: " + e.message);
                }
                setLoading(false);
            };
// FIM DA L√ìGICA DE EMPRESAS E SHOPPING

// --- COMPONENTS QUE FICAM FORA DO APP ---

const AdminPanel = ({ onReset, onUpdateCompBal, teams, papers, journalists, companies, reqs, config, onAct, onPost, onApprove, onReject, onEditT, onApproveTeam, onUpdateBal, onDeleteTeam, onConfig, onApprovePaper, onDeletePaper, onDeleteJourno, onRejectPaper, onApproveComp, onDeleteComp, onGenAttrs }) => (
    <div>
        <h3>Painel Master</h3>
        <div className="card" style={{border: '1px solid var(--danger)'}}>
            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10, marginBottom:10}}>
                <button className={`btn ${config.marketOpen?'btn-red':'btn-green'}`} onClick={()=>onAct('MARKET', !config.marketOpen)}>{config.marketOpen?'FECHAR MERCADO':'ABRIR MERCADO'}</button>
                <button className="btn btn-purple" onClick={()=>onAct('WEEK')}>VIRAR SEMANA</button>
            </div>
            <button className="btn btn-red" onClick={()=>onAct('SEASON')}>VIRAR TEMPORADA</button>
            <button className="btn btn-gold" onClick={()=>{ const t=prompt("T√≠tulo"); const b=prompt("Texto"); if(t)onPost(t,b,'admin'); }}>COMUNICADO</button>
            
            {/* NOVO BOT√ÉO DE MANUTEN√á√ÉO DE ATRIBUTOS */}
            <button className="btn" style={{background:'#333', border:'1px solid #666', marginTop:10}} onClick={onGenAttrs}>
                üé≤ GERAR ATRIBUTOS (ALL)
            </button>
            
            <button 
                className="btn" 
                style={{background: 'black', color: 'red', border: '1px solid red', marginTop: 15}} 
                onClick={onReset}
            >
                <i className="fas fa-bomb"></i> RESETAR TODO O GAME
            </button>
        </div>

        {(companies||[]).some(c=>c.status==='PENDING') && <h4>Empresas Pendentes</h4>}
        {(companies||[]).filter(c=>c.status==='PENDING').map(c => (
            <div key={c.id} className="card" style={{borderLeft:'4px solid var(--purple)'}}>
                <b>{c.name}</b> ({(COMPANY_TYPES[c.companyType] || {}).label || 'Tipo Desconhecido'})<br/>
                Dono: {c.owner}
                <div style={{display:'flex', gap:5, marginTop:5}}>
                    <button className="btn btn-green" onClick={()=>onApproveComp(c.id)}>APROVAR</button>
                    <button className="btn btn-red" onClick={()=>onDeleteComp(c.id)}>X</button>
                </div>
            </div>
        ))}

        <h4>Gest√£o de Empresas</h4>
        {(companies||[]).filter(c=>c.status!=='PENDING').map(c => (
            <div key={c.id} className="card">
                <b>{c.name}</b> {c.status==='BLOCKED' && <span style={{color:'red'}}>(BLOQUEADA)</span>}<br/>
                Saldo: {fmt(c.balance)}
                <div style={{display:'flex', gap:5, marginTop:5}}>
                    <button className="btn btn-green" onClick={()=>{
                        const n = prompt("Novo Saldo da Empresa:", c.balance); 
                        if(n !== null) onUpdateCompBal(c.id, n);
                    }}>$</button>
                    <button className="btn btn-red" onClick={()=>onDeleteComp(c.id)}>EXCLUIR</button>
                </div>
            </div>
        ))}

        {(teams||[]).some(t=>t.status==='PENDING') && <h4>Times Pendentes</h4>}
        {(teams||[]).filter(t=>t.status==='PENDING').map(t=><div key={t.id} className="card" style={{borderLeft:'4px solid var(--warning)'}}><b>{t.name}</b><div style={{display:'flex', gap:5}}><input className="input-field" style={{marginBottom:0, width:100}} defaultValue={t.balance} id={`bal-${t.id}`} /><button className="btn btn-green" onClick={()=>onApproveTeam(t.id, document.getElementById(`bal-${t.id}`).value)}>V</button><button className="btn btn-red" onClick={()=>onDeleteTeam(t.id)}>X</button></div></div>)}
        
        {(papers||[]).some(p=>p.status==='PENDING') && <h4>Jornais Pendentes</h4>}
        {(papers||[]).filter(p=>p.status==='PENDING').map(p=><div key={p.id} className="card"><b>üì∞ {p.name}</b><br/><small>Dono: {p.ownerName}</small><button className="btn btn-green" onClick={()=>onApprovePaper(p.id)}>APROVAR</button><button className="btn btn-red" style={{marginLeft:5}} onClick={()=>onRejectPaper(p.id)}>X</button></div>)}
        
        <h4>Gest√£o de Imprensa</h4>
        {(papers||[]).filter(p=>p.status==='ACTIVE').map(p=><div key={p.id} className="card" style={{display:'flex', justifyContent:'space-between'}}><span>üì∞ {p.name}</span><button className="btn btn-red" style={{width:'auto'}} onClick={()=>onDeletePaper(p.id)}>X</button></div>)}
        {(journalists||[]).map(j=><div key={j.id} className="card" style={{display:'flex', justifyContent:'space-between'}}><span>‚úíÔ∏è {j.name}</span><button className="btn btn-red" style={{width:'auto'}} onClick={()=>onDeleteJourno(j.id)}>X</button></div>)}
        
        <h4>Solicita√ß√µes Financeiras</h4>
        {(reqs||[]).filter(r=>r.status==='PENDING').map(r=><div key={r.id} className="card"><b>{r.teamName}</b>: {fmt(r.amount)} ({r.type})<br/>{r.details}<br/><button className="btn-green" style={{width:'auto', marginRight:5}} onClick={()=>onApprove(r)}>V</button><button className="btn-red" style={{width:'auto'}} onClick={()=>onReject(r.id)}>X</button></div>)}
        
        <h4>Clubes</h4>
        {(teams||[]).filter(t=>t.status!=='PENDING').map(t=><div key={t.id} className="card" style={{display:'flex', justifyContent:'space-between'}}><span>{t.name}</span><div><button className="btn btn-ghost" style={{width:'auto', marginRight:5}} onClick={()=>onConfig(t)}><i className="fas fa-cog"></i></button><button className="btn btn-green" style={{width:'auto', marginRight:5}} onClick={()=>{const n=prompt("Novo Saldo:", t.balance); if(n)onUpdateBal(t.id, n)}}>$</button><button className="btn btn-purple" style={{width:'auto'}} onClick={()=>onEditT(t)}>ELENCO</button><button className="btn btn-red" style={{width:'auto', marginLeft:5}} onClick={()=>onDeleteTeam(t.id)}><i className="fas fa-trash"></i></button></div></div>)}
    </div>
);

const SettingsForm = ({ team, isAdmin, onUp, onUpgrade, onReq, onWithdraw }) => {
    const [form, setF] = useState({name: team.name, logo: team.logo, balance: team.balance, serie: team.serie});
    useEffect(() => { setF({name: team.name, logo: team.logo, balance: team.balance, serie: team.serie}); }, [team]);
    return <div><label>Nome</label><input className="input-field" value={form.name} onChange={e=>setF({...form, name:e.target.value})} /><label>Logo</label><input className="input-field" value={form.logo} onChange={e=>setF({...form, logo:e.target.value})} />{isAdmin && <label>Saldo (ADM)</label>} {isAdmin && <input className="input-field" type="number" value={form.balance} onChange={e=>setF({...form, balance:parseFloat(e.target.value)})} />}{isAdmin && <label>S√©rie (ADM)</label>}{isAdmin && <select className="input-field" value={form.serie} onChange={e=>setF({...form, serie:e.target.value})}>{SERIES.map(s=><option key={s} value={s}>{s}</option>)}</select>}<button className="btn btn-blue" onClick={()=>onUp(form)}>SALVAR</button><hr style={{borderColor:'#444'}}/><p>Est√°dio N√≠vel {team.stadiumLevel||1}</p><button className="btn btn-purple" onClick={onUpgrade}>EVOLUIR (‚Ç£ {fmt(COSTS[team.stadiumLevel]||0).replace('‚Ç£ ','')})</button><hr style={{borderColor:'#444'}}/><button className="btn btn-green" onClick={()=>{const v=prompt("Valor");const m=prompt("Motivo"); if(v)onReq('INJECTION',v,m)}}>PEDIR INJE√á√ÉO</button><button className="btn btn-gold" onClick={()=>{const v=prompt("Valor");const m=prompt("Empresa"); if(v)onReq('SPONSORSHIP',v,m)}}>PEDIR PATROC√çNIO</button><button className="btn btn-red" onClick={()=>{const v=prompt("Valor a retirar:"); if(v){ const m=prompt("Motivo:"); if(m) onWithdraw(v, m); }}}>RETIRAR DINHEIRO</button></div>;
};
            //fim

            
        // ... continua√ß√£o do c√≥digo anterior
    const approveTeam = async (teamId, finalBalance) => { await db.collection('teams').doc(teamId).update({ status: 'ACTIVE', balance: parseFloat(finalBalance) }); const t = teams.find(x=>x.id===teamId); postNews(`üõ°Ô∏è **NOVO CLUBE!**\nO **${t.name}** foi aprovado na S√©rie ${t.serie}.`, 'infra'); alert("Aprovado!"); };

            const deleteTeam = async (teamId) => { if(!confirm("‚ö†Ô∏è PERIGO: Excluir time e jogadores?")) return; const batch = db.batch(); batch.delete(db.collection('teams').doc(teamId)); const snap = await db.collection('players').where('teamId', '==', teamId).get(); snap.docs.forEach(doc => batch.delete(doc.ref)); await batch.commit(); postNews("üö´ **CLUBE EXTINTO**\nUm time encerrou atividades.", 'infra'); };

            const deletePaper = async (id) => { if(!confirm("Excluir Jornal e demitir jornalistas?")) return; const batch = db.batch(); batch.delete(db.collection('newspapers').doc(id)); const js = await db.collection('journalists').where('newspaperId', '==', id).get(); js.docs.forEach(d => batch.delete(d.ref)); await batch.commit(); alert("Jornal fechado!"); };

            const deleteJournalist = async (id) => { if(!confirm("Demitir Jornalista?")) return; await db.collection('journalists').doc(id).delete(); alert("Demitido!"); };

            const updateBalance = async (teamId, newBal) => { await db.collection('teams').doc(teamId).update({ balance: parseFloat(newBal) }); alert("Atualizado!"); };

            const withdrawMoney = async (amount, reason) => { const val = parseFloat(amount.replace(',', '.')); if(isNaN(val) || val <= 0) return alert("Valor inv√°lido!"); if(user.data.balance < val) return alert("Saldo insuficiente!"); await db.collection('teams').doc(user.data.id).update({ balance: firebase.firestore.FieldValue.increment(-val) }); postNews(`üí∏ **SA√çDA DE CAIXA**\nO **${user.data.name}** retirou ${fmt(val)}.\nüìù Motivo: ${reason}`, 'money-minus'); setModal(null); };

            // --- FUN√á√ÉO DE SALVAR JOGADOR (CORRIGIDA) ---
           const savePlayer = async (p) => {
                try {
                    // Garante que estamos salvando o objeto completo, incluindo 'attributes'
                    const payload = { ...p };
                    
                    if (p.id) {
                        await db.collection('players').doc(p.id).update(payload);
                    } else {
                        // Se for cria√ß√£o e por acaso vier sem atributos, gera aqui (seguran√ßa)
                        if (!payload.attributes) {
                             payload.attributes = generateAttributes(payload.position || 'ATA', payload.overall || 60);
                        }
                        await db.collection('players').add(payload);
                    }
                    setModal(null);
                } catch (e) {
                    console.error(e);
                    alert("Erro ao salvar jogador: " + e.message);
                }
            };

// FIM DA GEST√ÉO ADMINISTRATIVA E SALVAR JOGADOR

// --- SISTEMA DE NEGOCIA√á√ÉO E MERCADO (VERS√ÉO REALISTA 3.3 - FINAL BLINDADA) ---
const sendOffer = async (target, type, value, swapIds, con, meta, old) => {
    try {
        const v = parseFloat(value) || 0;
        const contractYears = parseInt(con) || 1;
        const actingTeamName = user.data.name;
        const targetPlayerName = target.name;
        const finalSal = parseFloat(meta.newSalary) || 0;
        const role = meta.role || 'ROTACAO';

        let details = `üí∞ Taxa: ${fmt(v)}\n`;
        if (meta.installments > 1) details += `üìÖ Parcelamento: ${meta.installments}x de ${fmt(v / meta.installments)}\n`;
        if (meta.sellOn > 0) details += `üìà Revenda: ${meta.sellOn}%\n`;

        // --- AJUSTE VISUAL: SE FOR PR√â-CONTRATO ---
        if (type === 'PRE_CONTRATO') {
            details = `‚öñÔ∏è **LEI BOSMAN (PR√â-CONTRATO)**\nO jogador vir√° a custo zero no in√≠cio da pr√≥xima temporada.\n`;
        }

        details += `üìù Contrato: ${contractYears} anos\n`;
        details += `üíµ Sal√°rio Sugerido: ${fmt(finalSal)}/sem\n`;
        details += `üëî Papel: ${role}`;

        // --- L√ìGICA DE DESTINAT√ÅRIO INTELIGENTE ---
        let recipientId; 

        if (old && old.id) {
            // CASO ESPECIAL 1: CONTRAPROPOSTA DE RENOVA√á√ÉO URGENTE
            if (old.type === 'RENOVACAO_URGENTE') {
                recipientId = old.playerId;
            } 
            // CASO ESPECIAL 2: ACORDO ENTRE CLUBES J√Å SELADO
            else if (old.sellerAccepted === true) {
                recipientId = (user.data.id === old.buyerId) ? old.playerId : old.buyerId;
            } 
            // CASO NORMAL: NEGOCIA√á√ÉO FINANCEIRA (ENTRE CLUBES)
            else {
                if (user.data.id === old.buyerId) {
                    recipientId = (old.sellerId === 'FREE' || !old.sellerId) ? old.playerId : old.sellerId;
                } else {
                    recipientId = old.buyerId;
                }
            }
        } else {
            // OFERTA NOVA (Primeiro contato)
            
            // >>> CORRE√á√ÉO V1.52.10: SE FOR PR√â-CONTRATO, VAI DIRETO PRO JOGADOR <<<
            if (type === 'PRE_CONTRATO') {
                recipientId = target.id; 
            } else {
                // Se n√£o for pr√©-contrato, segue a regra normal:
                // Se tem time, vai pro time. Se √© Free, vai pro jogador.
                recipientId = (target.teamId === 'FREE' || !target.teamId || target.teamId === '') 
                    ? target.id 
                    : target.teamId;
            }
        }

        const pl = {
            playerId: target.id,
            playerName: targetPlayerName,
            buyerId: old?.buyerId || user.data.id,
            buyerName: old?.buyerName || actingTeamName,
            sellerId: target.teamId || old?.sellerId || 'FREE',
            recipientId: recipientId,
            type: (old?.type === 'RENOVACAO_URGENTE') ? 'RENOVACAO' : type,
            value: v,
            offerContract: contractYears,
            description: details,
            status: 'PENDING',
            sellerAccepted: old ? (old.sellerAccepted || false) : false,
            meta: {
                ...meta,
                newSalary: finalSal,
                signingBonus: parseFloat(meta.signingBonus) || 0,
                role: role,
                installments: parseInt(meta.installments) || 1,
                sellOn: parseInt(meta.sellOn) || 0,
                hasBuyOption: meta.hasBuyOption || false
            },
            date: Date.now()
        };

        const b = db.batch();
        if (old && old.id) b.delete(db.collection('offers').doc(old.id));
        
        b.set(db.collection('offers').doc(), pl);
        await b.commit();

        // T√≠tulo da not√≠cia ajustado
        const msgHead = (old && old.id) ? "üîÑ CONTRAPROPOSTA" : (type === 'PRE_CONTRATO' ? "‚öñÔ∏è PR√â-CONTRATO" : "üíº NOVA OFERTA");
        
        postNews(`${msgHead}\n**${actingTeamName}** enviou uma proposta para **${targetPlayerName}**!\n\n${details}`, 'transfer');
        
        setModal(null); 
        alert("Enviado com sucesso! Aguarde a resposta.");
    } catch (e) {
        console.error("Erro no Firebase:", e);
        alert("Erro t√©cnico ao gravar no banco de dados.");
    }
};

const acceptOffer = async (o) => {
    try {
        // --- 1. L√ìGICA DE NOTIFICA√á√ÉO (APENAS LEITURA) ---
        if (o.type === 'NOTIFICACAO') {
            await db.collection('offers').doc(o.id).delete();
            alert('Confirmado!');
            return;
        }

        // --- 2. L√ìGICA DE PR√â-CONTRATO (V1.52.9) ---
        // (Mantido para n√£o perder a funcionalidade de assinar com jogadores em fim de contrato)
        if (o.type === 'PRE_CONTRATO') {
            if (!confirm(`Confirmar assinatura de Pr√©-Contrato com ${o.buyerName}?\nVoc√™ se juntar√° a eles na pr√≥xima temporada.`)) return;
            
            const b = db.batch();
            
            // Grava o pr√©-contrato no perfil do jogador
            b.update(db.collection('players').doc(o.playerId), {
                preContract: {
                    teamId: o.buyerId,
                    teamName: o.buyerName,
                    salary: o.meta.newSalary,
                    date: Date.now()
                },
                mood: 'ü§©'
            });

            b.delete(db.collection('offers').doc(o.id));
            await b.commit();
            
            postNews(`üìù **PR√â-CONTRATO ASSINADO**\n**${o.playerName}** assinou com o **${o.buyerName}** e se apresentar√° na pr√≥xima temporada!`, 'transfer');
            alert("Pr√©-contrato assinado com sucesso!");
            return;
        }

        const buy = teams.find(t => t.id === o.buyerId);
        const p = players.find(x => x.id === o.playerId);
        const isFreeAgent = !o.sellerId || o.sellerId === 'FREE';
        const sel = isFreeAgent ? null : teams.find(t => t.id === o.sellerId);

        // --- 3. CASO ESPECIAL: COMPRA DEFINITIVA (EXERCER OP√á√ÉO DE EMPR√âSTIMO) ---
        if (o.type === 'COMPRA_DEFINITIVA') {
            if (!buy || !p) return alert("Erro: Dados incompletos.");
            if (buy.balance < o.value) return alert(`Saldo insuficiente! Necess√°rio: ${fmt(o.value)}`);
            if (!confirm(`Exercer op√ß√£o de compra de ${p.name} por ${fmt(o.value)}?`)) return;

            const b = db.batch();
            b.update(db.collection('teams').doc(buy.id), { balance: buy.balance - o.value });
            if (sel) b.update(db.collection('teams').doc(sel.id), { balance: sel.balance + o.value });

            b.update(db.collection('players').doc(p.id), {
                teamId: buy.id,
                loanMeta: firebase.firestore.FieldValue.delete(), 
                status: 'NAO_A_VENDA',
                contract: 3, 
                history: firebase.firestore.FieldValue.arrayUnion({ 
                    date: Date.now(), from: sel ? sel.name : 'EMPR√âSTIMO', to: buy.name, type: 'COMPRA_DEFINITIVA', value: o.value 
                })
            });
            b.delete(db.collection('offers').doc(o.id));
            await b.commit();
            postNews(`‚úÖ **OP√á√ÉO EXERCIDA**\nO **${buy.name}** contratou **${p.name}** em definitivo!`, 'transfer');
            alert("Compra realizada!");
            return;
        }

        // =================================================================================
        // L√ìGICA DE NEGOCIA√á√ÉO INTELIGENTE (ACEITE BIDIRECIONAL)
        // =================================================================================

        const iAmBuyer = user.type === 'USER' && user.data.id === o.buyerId;
        const iAmSeller = user.type === 'USER' && user.data.id === o.sellerId;
        const iAmPlayer = user.type === 'PLAYER' || (isFreeAgent && !iAmBuyer);

        // --- FASE 1: ACORDO ENTRE CLUBES ---
        if (!isFreeAgent && !o.sellerAccepted && (iAmSeller || iAmBuyer)) {
            if (iAmBuyer) {
                if (!confirm(`Aceitar a pedida do clube vendedor (${fmt(o.value)}) e negociar com o jogador?`)) return;
            } else {
                if (!confirm("Aceitar os valores propostos? O jogador decidir√° o contrato agora.")) return;
            }
            
            await db.collection('offers').doc(o.id).update({
                recipientId: o.playerId, 
                sellerAccepted: true,     
                status: 'PENDING'
            });
            
            postNews(`üí∞ **ACORDO ENTRE CLUBES**\n${buy.name} e ${sel.name} chegaram a um acordo por **${p.name}**. Falta o "Sim" do atleta!`, 'transfer');
            alert("Acordo financeiro selado! A proposta foi enviada para o jogador.");
            return;
        }

        // --- FASE 2: ACORDO FINAL ---
        const readyForContract = isFreeAgent || o.sellerAccepted;

        if (readyForContract && (iAmPlayer || iAmBuyer)) {
            if (!buy || !p) return alert("Erro: Dados incompletos.");

            const valorEntrada = o.meta?.installments > 1 ? (o.value / o.meta.installments) : o.value;
            const luvas = parseFloat(o.meta?.signingBonus) || 0;
            const custoTotalImediato = valorEntrada + luvas;

            if (buy.balance < custoTotalImediato) {
                return alert(`Saldo insuficiente no caixa do comprador!\nNecess√°rio: ${fmt(custoTotalImediato)}`);
            }

            if (iAmBuyer) {
                if (!confirm(`Aceitar a pedida salarial do jogador e fechar a contrata√ß√£o?\nCusto Imediato: ${fmt(custoTotalImediato)}`)) return;
            } else {
                if (!confirm(`Deseja assinar com o ${buy.name}?`)) return;
            }

            // --- EXECU√á√ÉO DA TRANSFER√äNCIA ---
            const b = db.batch();
            
            // 1. Paga o Clube Vendedor (se houver) E processa cl√°usula de revenda ANTIGA
            if (sel) {
                let valorParaVendedor = valorEntrada;

                // >>>> L√ìGICA DE REVENDA (SELL-ON FEE) AUTOM√ÅTICA <<<<
                // Se o jogador tem uma cl√°usula salva, calcula a parte do antigo dono
                if (p.sellOnClause && p.sellOnClause.percentage > 0) {
                    const beneficiaryId = p.sellOnClause.beneficiaryId;
                    
                    // S√≥ executa se o benefici√°rio ainda existir e n√£o for o mesmo que est√° comprando
                    if (beneficiaryId && beneficiaryId !== buy.id) {
                        const shareAmount = (valorEntrada * p.sellOnClause.percentage) / 100;
                        
                        // Desconta do vendedor atual
                        valorParaVendedor -= shareAmount;
                        
                        // Paga ao dono original (Benefici√°rio)
                        b.update(db.collection('teams').doc(beneficiaryId), { 
                            balance: firebase.firestore.FieldValue.increment(shareAmount) 
                        });
                    }
                }

                // Paga o vendedor (j√° descontado a revenda, se houve)
                b.update(db.collection('teams').doc(sel.id), { balance: sel.balance + valorParaVendedor });

                // Cria d√≠vida se parcelado
                if (o.meta?.installments > 1) {
                    const debtRef = db.collection('debts').doc();
                    b.set(debtRef, {
                        buyerId: buy.id, buyerName: buy.name,
                        sellerId: sel.id, sellerName: sel.name,
                        playerName: p.name, installmentVal: valorEntrada,
                        weeksRemaining: parseInt(o.meta.installments) - 1, date: Date.now()
                    });
                }
            }

            // 2. Desconta do Comprador
            b.update(db.collection('teams').doc(buy.id), { balance: buy.balance - custoTotalImediato });

            // 3. Paga Luvas ao Jogador
            if (luvas > 0) {
                b.update(db.collection('players').doc(p.id), { balance: firebase.firestore.FieldValue.increment(luvas) });
            }

            // 4. Atualiza o Jogador (Move de time e Grava NOVA Cl√°usula)
            
            // Prepara a NOVA cl√°usula se foi negociada agora (0 a 80%)
            const newSellOnClause = (o.meta && o.meta.sellOn > 0 && sel) ? {
                beneficiaryId: sel.id,
                percentage: o.meta.sellOn
            } : firebase.firestore.FieldValue.delete(); // Se n√£o tem revenda nova, apaga a antiga para limpar o hist√≥rico

            b.update(db.collection('players').doc(p.id), {
                teamId: buy.id,
                status: 'NAO_A_VENDA',
                contract: o.type === 'EMPRESTIMO' ? (parseInt(o.meta.loanDuration) || 1) : (parseInt(o.offerContract) || 1),
                salary: parseFloat(o.meta?.newSalary) || p.salary,
                role: o.meta?.role || 'ROTACAO',
                loanMeta: o.type === 'EMPRESTIMO' ? { 
                    ownerId: sel?.id, 
                    salarySplit: o.meta.salarySplit || 100,
                    hasBuyOption: o.meta.hasBuyOption || false,
                    buyOpt: o.meta.buyOpt || 0,
                    originalContract: p.contract 
                } : null,
                // AQUI GRAVA A NOVA CL√ÅUSULA NO JOGADOR
                sellOnClause: newSellOnClause,
                history: firebase.firestore.FieldValue.arrayUnion({ 
                    date: Date.now(), from: isFreeAgent ? 'AGENTE LIVRE' : (sel ? sel.name : 'Desconhecido'), to: buy.name, type: o.type, value: o.value 
                })
            });

            // 5. Apaga a oferta e notifica
            b.delete(db.collection('offers').doc(o.id));
            await b.commit();
            
            const newsMsg = isFreeAgent 
                ? `‚úçÔ∏è **ASSINOU!**\nO Agente Livre **${p.name}** √© o novo refor√ßo do **${buy.name}**!`
                : `ü§ù **TRANSFER√äNCIA CONCLU√çDA**\n**${p.name}** assinou com o **${buy.name}**!`;
            
            postNews(newsMsg, 'transfer');
            
            // Notifica√ß√£o extra se houve repasse de revenda
            if (sel && p.sellOnClause && p.sellOnClause.percentage > 0) {
                 postNews(`üí∏ **CL√ÅUSULA DE REVENDA**\nUma parte da venda de **${p.name}** (${p.sellOnClause.percentage}%) foi repassada ao seu antigo clube formador.`, 'money');
            }

            alert("Neg√≥cio fechado com sucesso!");
        }

    } catch (e) {
        console.error(e);
        alert("Erro ao processar o aceite: " + e.message);
    }
};

const rejectOffer = async (o) => {
    try {
        // --- CASO 1: RECUSA DE OP√á√ÉO DE COMPRA (FIM DE EMPR√âSTIMO) ---
        if (o.type === 'COMPRA_DEFINITIVA' && o.isLoanOption) {
            const p = players.find(x => x.id === o.playerId);
            const ownerId = o.sellerId; 
            const ownerTeam = teams.find(t => t.id === ownerId);

            if (!confirm("Deseja recusar a compra? O jogador retornar√° ao clube de origem.")) return;

            const b = db.batch();
            const pRef = db.collection('players').doc(p.id);

            // --- CORRE√á√ÉO DE SEGURAN√áA PARA DADOS ANTIGOS ---
            let originalDuration = 0;
            
            if (p.loanMeta && p.loanMeta.originalContract) {
                originalDuration = parseInt(p.loanMeta.originalContract);
            } else {
                console.warn("Contrato original n√£o encontrado. Usando fallback de 6 anos.");
                originalDuration = 6; 
            }
            
            let remainingContract = originalDuration - 1;
            if (remainingContract < 0) remainingContract = 0;

            if (remainingContract <= 0) {
                const renewalReqRef = db.collection('offers').doc();
                b.set(renewalReqRef, {
                    type: 'RENOVACAO_URGENTE',
                    playerId: p.id,
                    playerName: p.name,
                    buyerId: ownerId, 
                    buyerName: ownerTeam?.name || 'Clube de Origem',
                    sellerId: 'SISTEMA',
                    recipientId: ownerId,
                    status: 'PENDING',
                    description: `‚ö†Ô∏è **URGENTE: FIM DE CONTRATO**\nO empr√©stimo de **${p.name}** acabou e o contrato dele com voc√™ expirou.\n\nRenove ou libere para os passes livres.`,
                    date: Date.now()
                });

                b.update(pRef, {
                    teamId: ownerId,
                    loanMeta: firebase.firestore.FieldValue.delete(),
                    status: 'INTRANSFERIVEL',
                    contract: 0
                });

                postNews(`üîô **RETORNO CR√çTICO**\nO empr√©stimo de ${p.name} acabou e o contrato expirou!`, 'rumor');
            } else {
                const notifRef = db.collection('offers').doc();
                b.set(notifRef, {
                    type: 'NOTIFICACAO',
                    playerId: p.id,
                    playerName: p.name,
                    buyerName: 'Sistema',
                    recipientId: ownerId,
                    status: 'PENDING',
                    description: `üîô **RETORNO DE EMPR√âSTIMO**\nA op√ß√£o de compra foi recusada.\n**${p.name}** voltou ao seu elenco.\n\nüìÑ Contrato Restante: ${remainingContract} temporada(s).`,
                    date: Date.now()
                });

                b.update(pRef, {
                    teamId: ownerId,
                    loanMeta: firebase.firestore.FieldValue.delete(),
                    status: 'NAO_A_VENDA',
                    contract: remainingContract 
                });
                
                postNews(`üîô **RETORNO**\n${p.name} retornou ao ${ownerTeam?.name} (${remainingContract} anos rest.).`, 'transfer');
            }

            b.delete(db.collection('offers').doc(o.id));
            await b.commit();
            alert("Op√ß√£o recusada. Jogador devolvido ao clube de origem.");
            return;
        }

        // --- CASO 2: RECUSA DE RENOVA√á√ÉO URGENTE ---
        if (o.type === 'RENOVACAO_URGENTE') {
            if (!confirm("Tem certeza? O jogador perder√° o v√≠nculo com o clube e ir√° para os Agentes Livres.")) return;
            
            const b = db.batch();
            b.update(db.collection('players').doc(o.playerId), {
                teamId: 'FREE',
                status: 'VENDA',
                mood: 'üòê',
                contract: 0
            });
            b.delete(db.collection('offers').doc(o.id));
            await b.commit();
            
            postNews(`üÜì **AGENTE LIVRE**\nO v√≠nculo de **${o.playerName}** expirou e ele est√° livre no mercado!`, 'transfer');
            alert("Jogador enviado para os Agentes Livres.");
            return;
        }

        // --- CASO 3: RECUSA NORMAL DE PROPOSTAS ---
        if (!confirm("Deseja recusar e encerrar esta negocia√ß√£o?")) return;
        await db.collection('offers').doc(o.id).delete();
        
        if (o.type !== 'NOTIFICACAO') {
            postNews(`‚ùå **NEGOCIA√á√ÉO ENCERRADA**\nO acordo por **${o.playerName}** n√£o avan√ßou.`, 'transfer');
        }

    } catch (e) {
        console.error(e);
        alert("Erro t√©cnico ao processar a recusa.");
    }
};

const renewContract = async (p) => {
    if (!p.teamId || p.teamId === 'FREE') return alert("Jogadores livres assinam novos contratos, n√£o renovam!");
    
    const cost = (parseFloat(p.value) || 1000000) * 0.10; 
    if(user.data.balance < cost) return alert(`Saldo insuficiente para b√¥nus de renova√ß√£o (Custo: ${fmt(cost)})`);
    
    if(!confirm(`Renovar com ${p.name}?\nCusto: ${fmt(cost)} (Este valor ir√° para o saldo do jogador)`)) return;

    try {
        const b = db.batch();
        b.update(db.collection('teams').doc(user.data.id), {balance: firebase.firestore.FieldValue.increment(-cost)});
        b.update(db.collection('players').doc(p.id), {
            contract: (parseInt(p.contract)||0) + 1,
            balance: firebase.firestore.FieldValue.increment(cost),
            status: 'NAO_A_VENDA' 
        });
        await b.commit();
        postNews(`üìù **RENOVA√á√ÉO**\nO **${user.data.name}** renovou com **${p.name}**!`, 'transfer');
        setModal(null);
    } catch (e) {
        alert("Erro ao renovar: " + e.message);
    }
};
            //FIM

            // ... continua√ß√£o do c√≥digo anterior

            // 1. Fun√ß√£o para o Jornalista atualizar a tabela
            const updateTeamStats = async (tid, stats) => { 
                await db.collection('teams').doc(tid).update({ stats }); 
                alert("Tabela atualizada!"); 
            };

            // 2. Fun√ß√£o para lan√ßar S√∫mula (ATUALIZADA: C√ÅLCULO DA M√âDIA)
            const saveMatchStats = async (player, match, xpGained) => {
                if(match.rating === '' || match.rating === null) return alert("D√™ uma nota para a atua√ß√£o!");
                
                const b = db.batch(); 
                const pRef = db.collection('players').doc(player.id);
                
                const newStats = { 
                    goals: (player.stats?.goals||0) + match.goals, 
                    assists: (player.stats?.assists||0) + match.assists, 
                    tackles: (player.stats?.tackles||0) + match.tackles, 
                    saves: (player.stats?.saves||0) + match.saves, 
                    yellows: (player.stats?.yellows||0) + match.yellows, 
                    reds: (player.stats?.reds||0) + match.reds 
                };

                // --- C√ÅLCULO DA M√âDIA DA IMPRENSA ---
                const currentSum = player.pressRatingSum || 0; 
                const currentCount = player.pressRatingCount || 0; 
                const newSum = currentSum + parseFloat(match.rating);
                const newCount = currentCount + 1;
                const newAvg = newSum / newCount; 
                
                b.update(pRef, { 
                    stats: newStats, 
                    pendingXP: (player.pendingXP || 0) + xpGained,
                    pressRatingSum: newSum,
                    pressRatingCount: newCount,
                    pressRatingAvg: parseFloat(newAvg.toFixed(1)) 
                });
                
                await b.commit(); 
                alert(`S√∫mula lan√ßada! M√©dia do jogador agora √©: ${newAvg.toFixed(1)}`); 
                setModal(null);
            };

// FIM DA L√ìGICA DE IMPRENSA E S√öMULAS
            
// --- NOVA FUN√á√ÉO: A√á√ïES DE CARREIRA DO JOGADOR ---
            const handlePlayerActions = async (type, p) => {
                const team = teams.find(t => t.id === p.teamId);
                
                // 1. PEDIR TRANSFER√äNCIA
                if (type === 'TRANSFER_REQUEST') {
                    if (!team) return alert("J√° √©s um Agente Livre!");
                    if (p.status === 'VENDA') return alert("J√° est√°s na lista de transfer√™ncias.");
                    if (!confirm(`Tens a certeza que queres pedir para sair do ${team.name}? O adepto n√£o vai gostar...`)) return;

                    await db.collection('players').doc(p.id).update({
                        status: 'VENDA',
                        mood: 'üò°'
                    });
                    postNews(`üí£ **CRISE NO ${team.name.toUpperCase()}!**\nO jogador **${p.name}** est√° insatisfeito e pediu para ser colocado na lista de transfer√™ncias!`, 'rumor');
                    alert("O pedido foi feito. O teu humor piorou.");
                }

                // 2. PEDIR AUMENTO
                if (type === 'ASK_RAISE') {
                    if (!team) return alert("Precisas de um clube para pedir aumento.");
                    if (!confirm("Ir √† imprensa pedir um aumento salarial?")) return;

                    // Apenas lan√ßa a not√≠cia para pressionar o dono
                    postNews(`üí∞ **POL√âMICA**\n**${p.name}** declara publicamente: "Mere√ßo ganhar mais no ${team.name}. Espero uma renova√ß√£o em breve."`, 'press');
                    alert("Declara√ß√£o feita √† imprensa! O presidente foi notificado.");
                }
            };
            
            // 3. Fun√ß√£o Mestra do Admin (COM REGRA DE AGENTES LIVRES)
     // 3. Fun√ß√£o Mestra do Admin (COM REGRA DE AGENTES LIVRES E RETORNO CORRIGIDO)
         // --- RENDER ---
            if(loading) return <div style={{display:'grid', placeItems:'center', height:'100vh'}}>Carregando...</div>;
            if(!user) return <LoginScreen teams={teams} players={players} papers={papers} journalists={journalists} companies={companies} onLogin={login} onCreateTeam={createTeam} onCreatePaper={createNewspaper} onCreateJourno={createJournalist} onCreateCompany={createCompany} onAdmin={loginAdmin} onVisitor={()=>{setUser({type:'VISITOR'}); setScreen('RANKING');}} />;

            return (
                <div>
                    <div className="header">
                        <div style={{display:'flex', alignItems:'center', gap:10}}>
                            {user.type==='USER' && user.data.logo && <img src={user.data.logo} style={{width:40, height:40, borderRadius:'50%', border:'2px solid var(--primary)', objectFit:'cover'}} />}
                            <div>
                                <div style={{fontWeight:'900', fontSize:16}}>{user.type==='USER' ? user.data.name : user.data?.name || user.type}</div>
                                <div className="dev-credits" style={{textAlign:'left', margin:0}}>Desenvolvido por: Nathan Reis |  v1.54.1</div>
                            </div>
                        </div>
                        
                        <div style={{display:'flex', gap:15, alignItems:'center'}}>
                            {/* √çCONE DE NOTIFICA√á√ÉO (SINO) */}
                            {(user.type === 'USER' || user.type === 'PLAYER') && (
                                <div onClick={() => setScreen('OFFERS')} style={{ position: 'relative', cursor: 'pointer', padding: '5px', display: 'flex', alignItems: 'center' }}>
                                    <i className="fas fa-bell" style={{ fontSize: '20px', color: (offers || []).filter(o => o.recipientId === user.data.id && o.status === 'PENDING').length > 0 ? 'var(--warning)' : '#666', transition: '0.3s' }}></i>
                                    {(offers || []).filter(o => o.recipientId === user.data.id && o.status === 'PENDING').length > 0 && (
                                        <span className="pulse" style={{ position: 'absolute', top: '2px', right: '2px', background: 'red', borderRadius: '50%', width: '10px', height: '10px', border: '2px solid var(--bg-card)' }}></span>
                                    )}
                                </div>
                            )}

                            {/* SALDO EM DINHEIRO */}
                            {(user.type === 'USER' || user.type === 'COMPANY' || user.type === 'PLAYER') && (
                                <div style={{color:'var(--primary)', fontWeight:'bold', marginLeft:10}}>
                                    {fmt(user.data.balance)}
                                </div>
                            )}

                            {/* CONFIGURA√á√ïES */}
                            {user.type === 'USER' && (
                                <i className="fas fa-cog" style={{cursor:'pointer', marginLeft:10}} onClick={()=>setModal({type:'SETTINGS', data:user.data})}></i>
                            )}

                            {/* BOT√ÉO DE SAIR */}
                            <i className="fas fa-sign-out-alt" style={{cursor:'pointer', marginLeft:10}} onClick={()=>window.location.reload()}></i>
                        </div>
                    </div>

                    <div className="container">
                        {screen === 'HOME' && user.type === 'ADMIN' && 
                            <AdminPanel 
                                teams={teams} papers={papers} journalists={journalists} companies={companies} reqs={reqs} config={conf} onAct={adminAction} onPost={(t,b,tp)=>postNews(`üì¢ **${t}**\n${b}`, tp)} onApprove={async(r)=>{/*Fin*/}} onReject={(id)=>db.collection('financeRequests').doc(id).delete()} onEditT={(t)=>{setAdminTeam(t); setScreen('ADMIN_TEAM');}} onApproveTeam={approveTeam} onUpdateBal={updateBalance} onDeleteTeam={deleteTeam} onApprovePaper={async(id)=>{db.collection('newspapers').doc(id).update({status:'ACTIVE'});}} onDeletePaper={deletePaper} onDeleteJourno={deleteJournalist} onRejectPaper={(id)=>db.collection('newspapers').doc(id).delete()} onConfig={(t)=>setModal({type:'SETTINGS', data:t})} onReset={resetDatabase} onApproveComp={async(id)=>{await db.collection('companies').doc(id).update({status:'ACTIVE'}); alert("Empresa Aprovada!");}} onDeleteComp={async(id)=>{if(confirm("Excluir Empresa?")) await db.collection('companies').doc(id).delete();}} onUpdateCompBal={async(id, val)=>{ await db.collection('companies').doc(id).update({balance: parseFloat(val)}); alert("Saldo Alterado!"); }}
                                onGenAttrs={async () => {
                                    if(!confirm("Isso vai gerar atributos para TODOS os jogadores que n√£o t√™m. Continuar?")) return;
                                    setLoading(true);
                                    const b = db.batch();
                                    let count = 0;
                                    players.forEach(p => {
                                        if (!p.attributes) {
                                            const newAttrs = generateAttributes(p.position || 'ATA', p.overall || 60);
                                            b.update(db.collection('players').doc(p.id), { attributes: newAttrs });
                                            count++;
                                        }
                                    });
                                    await b.commit();
                                    setLoading(false);
                                    alert(`Atributos gerados para ${count} jogadores!`);
                                }}
                            />
                        }
                        
                        {screen === 'HOME' && user.type === 'USER' && 
                            <TeamDashboard team={user.data} players={players.filter(p=>p.teamId===user.data.id)} isVisitor={false} onEdit={(p)=>setModal({type:'PLAYER', data:p})} onAdd={()=>setModal({type:'PLAYER', data: { teamId: user.data.id } })} />
                        }
                        
                        {screen === 'HOME' && user.type === 'VISITOR' && <VisitorDashboard players={players} teams={teams} />}
                        
                        {screen === 'PRESS_DASH' && (user.type==='PRESS' || user.type==='PRESS_WORKER') && (
                            <div>
                                <h3>Painel de Imprensa ({user.data.name})</h3>
                                <div className="card">
                                    <button className="btn btn-blue" onClick={()=>setModal({type:'POST_NEWS'})}>ESCREVER NOT√çCIA</button>
                                    <button className="btn btn-purple" onClick={()=>setModal({type:'MATCH_PERFORMANCE'})}>LAN√áAR S√öMULA (XP)</button>
                                    <button className="btn btn-gold" onClick={()=>setModal({type:'TEAM_TABLE'})}>EDITAR TABELA</button>
                                </div>
                                {user.type==='PRESS' && journalists.filter(j=>j.newspaperId===user.data.id && j.status==='PENDING').map(j=>(
                                    <div key={j.id} className="card">
                                        {j.name}
                                        <button className="btn btn-green" onClick={()=>db.collection('journalists').doc(j.id).update({status:'ACTIVE'})}>APROVAR</button>
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {screen === 'ADMIN_TEAM' && adminTeam && <div><button className="btn" style={{background:'#333', marginBottom:10}} onClick={()=>{setAdminTeam(null); setScreen('HOME');}}>‚¨Ö VOLTAR</button><h3 style={{color:'var(--purple)'}}>Editando: {adminTeam.name}</h3><TeamDashboard team={adminTeam} players={players.filter(p=>p.teamId===adminTeam.id)} isVisitor={false} onEdit={(p)=>setModal({type:'PLAYER', data:p})} onAdd={()=>setModal({type:'PLAYER', data: { teamId: adminTeam.id } })} /></div>}
                        
                        {screen === 'MARKET' && (
                            <Market 
                                me={user.data?.id} 
                                teams={teams} 
                                players={players} 
                                open={conf.marketOpen} 
                                isVis={user.type === 'VISITOR'} 
                                onNeg={(p) => setModal({ type: 'OFFER', data: p })} 
                                onPayClause={async (p) => {
                                    const buy = teams.find(t => t.id === user.data.id);
                                    const sel = teams.find(t => t.id === p.teamId);
                                    if (buy.balance < p.clause) return alert("Saldo insuficiente!");
                                    if (!confirm(`Pagar multa de ${fmt(p.clause)} por ${p.name}?`)) return;
                                    const b = db.batch();
                                    b.update(db.collection('teams').doc(buy.id), { balance: buy.balance - p.clause });
                                    b.update(db.collection('teams').doc(sel.id), { balance: sel.balance + p.clause });
                                    b.update(db.collection('players').doc(p.id), { teamId: buy.id, status: 'NAO_A_VENDA', contract: 3, history: firebase.firestore.FieldValue.arrayUnion({ date: Date.now(), from: sel.name, to: buy.name, type: 'MULTA', value: p.clause }) });
                                    await b.commit();
                                    postNews(`üö® **MULTA PAGA!**\nO **${buy.name}** pagou a multa de **${p.name}**!`, 'transfer');
                                    alert("Contratado via multa!");
                                }}
                                onPre={async (p) => {
                                    const buy = teams.find(t => t.id === user.data.id);
                                    if (!confirm(`Assinar pr√©-contrato com ${p.name}?`)) return;
                                    await db.collection('players').doc(p.id).update({ preContract: { teamId: buy.id, teamName: buy.name }, mood: 'ü§©' });
                                    postNews(`üìù **PR√â-CONTRATO**\n**${p.name}** refor√ßar√° o **${buy.name}** na pr√≥xima temporada!`, 'transfer');
                                    alert("Pr√©-contrato assinado!");
                                }}
                            />
                        )}

                        {screen === 'SHOPPING' && <ShoppingScreen products={products} companies={companies} userTeam={user.type==='USER' || user.type==='PLAYER'} onBuy={buyProduct} />}
                        
                        {screen === 'SPONSORSHIPS' && user.type === 'USER' && (
                            <div>
                                <h3>Buscar Patroc√≠nio</h3>
                                <p style={{fontSize:11, color:'#aaa'}}>Envie propostas semanais para as empresas.</p>
                                {companies.filter(c=>c.status==='ACTIVE').map(c => (
                                    <div key={c.id} className="card">
                                        <b>{c.name}</b> <small>({(COMPANY_TYPES[c.companyType] || {}).label})</small>
                                        <div style={{display:'flex', gap:5, marginTop:5}}>
                                            <button className="btn btn-purple" onClick={()=>{const v=prompt("Valor Semanal pedido (‚Ç£):"); if(v) requestSponsorship(c.id, v);}}>PEDIR PATROC√çNIO</button>
                                        </div>
                                    </div>
                                ))}
                                <hr style={{borderColor:'#333'}}/>
                                <h4>Meus Contratos</h4>
                                {sps.filter(s=>s.teamId===user.data.id).length === 0 && <p style={{color:'#666'}}>Sem contratos.</p>}
                                {sps.filter(s=>s.teamId===user.data.id).map(s => (
                                    <div key={s.id} className="card" style={{borderLeft:`4px solid ${s.status==='ACTIVE'?'var(--primary)':'#666'}`}}>
                                        <b>{s.companyName}</b><br/>
                                        Valor: {fmt(s.value)}/sem <small>({s.status === 'PENDING' ? 'Aguardando' : 'Ativo'})</small>
                                        {s.status==='ACTIVE' && <button className="btn btn-red" style={{width:'auto', marginTop:5}} onClick={()=>{if(confirm("Encerrar contrato de patroc√≠nio?")) db.collection('sponsorships').doc(s.id).delete();}}>ENCERRAR</button>}
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {screen === 'RANKING' && <Ranking teams={teams} players={players} />}
                        {screen === 'NEWS' && <div><h3>Not√≠cias</h3>{news.map(n=><div key={n.id} className={`news-card news-${n.type}`}>{n.text}<br/><small style={{color:'#666'}}>{new Date(n.date).toLocaleString()}</small></div>)}</div>}
                        
                        {screen === 'OFFERS' && (
                            <OffersScreen user={user} offers={offers} teams={teams} onAccept={acceptOffer} onReject={rejectOffer} onCounter={(o) => setModal({ type: 'OFFER', data: { ...players.find(p => p.id === o.playerId), oldOffer: o } })} />
                        )}                        
                        
                        {(screen === 'COMPANY_DASH' || screen === 'COMPANY_HOME') && user.type === 'COMPANY' && 
                            <CompanyDashboard company={user.data} products={products.filter(p => p.companyId === user.data.id)} sps={sps.filter(s => s.companyId === user.data.id)} sales={sales || []} teams={teams} onSaveProd={saveProduct} onDeleteProd={async(id)=>{if(confirm("Excluir produto?")) await db.collection('products').doc(id).delete();}} onProcessSpons={processSponsorship} />
                        }
                        
                        {screen === 'PLAYER_DASH' && user.type === 'PLAYER' && 
                            <PlayerDashboard player={players.find(p=>p.id===user.data.id) || user.data} team={teams.find(t=>t.id===user.data.teamId)} sales={sales || []} onAction={handlePlayerActions} onUpdatePassword={async(newP)=>{ await db.collection('players').doc(user.data.id).update({password: newP}); alert("Senha alterada!"); }} />
                        }
                    </div>

                    <div className="bottom-nav">
                        <div className={`nav-item ${['HOME','COMPANY_HOME','COMPANY_DASH','PLAYER_DASH'].includes(screen)?'active':''}`} onClick={() => { if(user.type.includes('PRESS')) setScreen('PRESS_DASH'); else if(user.type === 'COMPANY') setScreen('COMPANY_HOME'); else if(user.type === 'PLAYER') setScreen('PLAYER_DASH'); else setScreen('HOME'); }}>
                            <i className="fas fa-home"></i>IN√çCIO
                        </div>
                        {user.type!=='COMPANY' && user.type!=='PLAYER' && <div className={`nav-item ${screen==='MARKET'?'active':''}`} onClick={()=>setScreen('MARKET')}><i className="fas fa-globe"></i>MERCADO</div>}
                        {user.type!=='COMPANY' && <div className={`nav-item ${screen==='SHOPPING'?'active':''}`} onClick={()=>setScreen('SHOPPING')}><i className="fas fa-shopping-bag"></i>SHOP</div>}
                        {user.type==='USER' && <div className={`nav-item ${screen==='SPONSORSHIPS'?'active':''}`} onClick={()=>setScreen('SPONSORSHIPS')}><i className="fas fa-handshake"></i>PATRO</div>}
                        {user.type!=='COMPANY' && <div className={`nav-item ${screen==='RANKING'?'active':''}`} onClick={()=>setScreen('RANKING')}><i className="fas fa-trophy"></i>RANK</div>}
                        <div className={`nav-item ${screen==='NEWS'?'active':''}`} onClick={()=>{setScreen('NEWS'); setNewNews(false); localStorage.setItem('lastRead', Date.now());}}><i className="fas fa-newspaper"></i>NEWS</div>
                    </div>

                    {modal && <div className="modal-overlay" onClick={(e)=>e.target===e.currentTarget && setModal(null)}>
                        <div className="modal-content">
                            {modal.type==='PLAYER' && <PlayerForm initial={modal.data} onSave={savePlayer} onDelete={async(id)=>{db.collection('players').doc(id).delete(); setModal(null);}} isAdmin={user.type==='ADMIN'} teams={teams} onRenew={renewContract} isOwner={user.type==='USER' && modal.data?.teamId===user.data?.id} />}
                            {modal.type==='OFFER' && <OfferForm target={modal.data} myPlayers={players.filter(p => p.teamId === user.data.id)} onSend={sendOffer} setModal={setModal} user={user} />}
                            {modal.type==='SETTINGS' && <SettingsForm team={modal.data || user.data} isAdmin={user.type==='ADMIN'} onUp={(d)=>{const tid=(modal.data?.id)||user.data.id; db.collection('teams').doc(tid).update(d); setModal(null);}} onUpgrade={()=>{/*Up*/}} onReq={(t,a,d)=>{db.collection('financeRequests').add({teamId:user.data.id, teamName:user.data.name, type:t, amount:parseFloat(a), details:d, status:'PENDING'}); setModal(null); alert("Enviado!");}} onWithdraw={withdrawMoney} />}
                            {modal.type==='MATCH_PERFORMANCE' && <MatchPerformanceForm players={players} teams={teams} onSaveStats={saveMatchStats} />}
                            {modal.type==='TEAM_TABLE' && <TeamStandingsEditor teams={teams} onUpdateTeamStats={updateTeamStats} />}
                            {modal.type==='POST_NEWS' && <div><h3>Nova Not√≠cia</h3><input className="input-field" placeholder="Manchete / Texto" id="news-body" /><button className="btn btn-blue" onClick={()=>{postNews(`üì∞ **${user.data.name}:**\n${document.getElementById('news-body').value}`, 'press'); setModal(null);}}>PUBLICAR</button></div>}
                            {modal.type==='STATS_SEARCH' && <StatsEditor players={players} teams={teams} onSave={updateStats} />}
                        </div>
                    </div>}
                </div>
            );
        }
// FIM DO COMPONENTE APP

// --- COMPONENTS ---
        const LoginScreen = ({ teams, players, papers, journalists, companies, onLogin, onCreateTeam, onCreatePaper, onCreateJourno, onCreateCompany, onAdmin, onVisitor }) => {
            const [tab, setTab] = useState('LOGIN'); 
            const [subTab, setSubTab] = useState('TEAM'); 
            const [f, setF] = useState({n:'', b:'10000000', s:'A', p:''}); 
            const [fc, setFC] = useState({n:'', owner:'', p:'', type:'COMERCIO'});
            const [sel, setSel] = useState(null); 
            const [selPaper, setSelPaper] = useState(null); 
            const [selTeamForPlayer, setSelTeamForPlayer] = useState(null); 
            const [lp, setLp] = useState('');

            const handleUpload = (e) => { const file=e.target.files[0]; const reader=new FileReader(); reader.onloadend=()=>setF({...f, l:reader.result}); if(file) reader.readAsDataURL(file); };
            
            // Vari√°vel auxiliar para pegar os dados do tipo selecionado
            const selectedTypeInfo = COMPANY_TYPES[fc.type] || {};

            return (
                <div style={{minHeight:'100vh', padding:20, textAlign:'center'}}>
                    <h1 style={{color:'var(--primary)'}}>Gerenciador de Times<br/><span style={{color:'white'}}>de Mato Real</span></h1>
                    <div className="dev-credits">Desenvolvido por: Nathan Reis |v1.54.1</div>
                    
                    <div className="login-tabs">
                        <div className={`tab ${tab==='LOGIN'?'active':''}`} onClick={()=>setTab('LOGIN')}>ENTRAR</div>
                        <div className={`tab ${tab==='CREATE'?'active':''}`} onClick={()=>setTab('CREATE')}>CRIAR TIME</div>
                        <div className={`tab ${tab==='PRESS'?'active':''}`} onClick={()=>setTab('PRESS')}>IMPRENSA</div>
                        <div className={`tab ${tab==='COMPANY'?'active':''}`} onClick={()=>setTab('COMPANY')}>EMPRESAS</div>
                    </div>

                    {tab==='LOGIN' && <div>
                        <div style={{marginBottom:15, display:'flex', gap:10, justifyContent:'center'}}>
                            <button className={`btn ${subTab==='TEAM'?'btn-green':'btn-ghost'}`} style={{width:'auto'}} onClick={()=>setSubTab('TEAM')}>TIMES</button>
                            <button className={`btn ${subTab==='PLAYER'?'btn-blue':'btn-ghost'}`} style={{width:'auto'}} onClick={()=>{setSubTab('PLAYER'); setSelTeamForPlayer(null);}}>JOGADORES</button>
                            <button className={`btn ${subTab==='COMPANY'?'btn-purple':'btn-ghost'}`} style={{width:'auto'}} onClick={()=>setSubTab('COMPANY')}>EMPRESAS</button>
                        </div>

                        {subTab==='TEAM' && (teams||[]).filter(t=>t.status!=='PENDING').map(t=><div key={t.id} className="card" onClick={()=>setSel({...t, type:'TEAM'})} style={{display:'flex', alignItems:'center', gap:10, cursor:'pointer'}}>{t.logo ? <img src={t.logo} className="team-logo" style={{width:40, height:40, objectFit:'cover'}}/> : <div className="team-logo"></div>}<div><b>{t.name}</b><br/><small style={{color:'#666'}}>S√©rie {t.serie}</small></div></div>)}
                        
                        {subTab==='PLAYER' && !selTeamForPlayer && <div>
    <p style={{color:'#aaa'}}>Selecione o clube onde voc√™ joga ou acesse como livre:</p>
    
    {/* BOT√ÉO PARA AGENTES LIVRES (FREE) */}
    <div 
        className="card" 
        onClick={() => setSelTeamForPlayer({ id: 'FREE', name: 'Agentes Livres' })} 
        style={{cursor:'pointer', border: '1px solid var(--warning)', background: 'rgba(255, 196, 0, 0.1)'}}
    >
        <b style={{color: 'var(--warning)'}}>üÜì BUSCAR MEU PERFIL (AGENTE LIVRE)</b>
    </div>

    <hr style={{borderColor: '#333', margin: '15px 0'}} />

    {(teams||[]).filter(t=>t.status!=='PENDING').map(t=>(
        <div key={t.id} className="card" onClick={()=>setSelTeamForPlayer(t)} style={{cursor:'pointer'}}>
            <b>{t.name}</b>
        </div>
    ))}
</div>}

{subTab==='PLAYER' && selTeamForPlayer && <div>
    <button className="btn" style={{marginBottom:10, background:'#333'}} onClick={()=>setSelTeamForPlayer(null)}>
        ‚¨Ö VOLTAR
    </button>
    <h4 style={{color:'var(--secondary)'}}>Jogadores - {selTeamForPlayer.name}:</h4>
    
    {/* Lista os jogadores do time selecionado OU os Agentes Livres */}
    {(players||[]).filter(p => p.teamId === selTeamForPlayer.id).length === 0 && 
        <p style={{color:'#666'}}>Nenhum jogador encontrado aqui.</p>
    }
    
    {(players||[]).filter(p => p.teamId === selTeamForPlayer.id).map(p => (
        <div key={p.id} className="card" onClick={()=>setSel({...p, type:'PLAYER'})} style={{cursor:'pointer', borderLeft:'4px solid var(--secondary)'}}>
            üëü <b>{p.name}</b>
        </div>
    ))}
</div>}

                        {subTab==='COMPANY' && (companies||[]).filter(c=>c.status!=='PENDING').map(c=><div key={c.id} className="card" onClick={()=>setSel({...c, type:'COMPANY'})} style={{cursor:'pointer', borderLeft:'4px solid var(--purple)'}}>üè¢ <b>{c.name}</b><br/><small>{(c.companyType)}</small></div>)}
                        
                        <div style={{marginTop:20}}><button className="btn btn-blue" onClick={onVisitor}>ENTRAR COMO VISITANTE</button><button className="btn btn-ghost" onClick={()=> {if(prompt("Senha:")==='2503') onAdmin()}}>ADMIN</button></div>
                    </div>}

                    {tab==='CREATE' && <div><input type="file" className="file-input" onChange={handleUpload} /><input className="input-field" placeholder="Nome" value={f.n} onChange={e=>setF({...f, n:e.target.value})} /><input className="input-field" type="number" placeholder="Saldo" value={f.b} onChange={e=>setF({...f, b:e.target.value})} /><select className="input-field" value={f.s} onChange={e=>setF({...f, s:e.target.value})}>{['A','B','C','D'].map(s=><option key={s} value={s}>S√©rie {s}</option>)}</select><input className="input-field" type="number" placeholder="Senha" value={f.p} onChange={e=>setF({...f, p:e.target.value})} /><button className="btn btn-green" onClick={()=>onCreateTeam(f.n, f.b, f.s, f.p, f.l)}>CRIAR</button></div>}
                    
                    {tab==='PRESS' && <div><div style={{display:'flex', gap:10, marginBottom:10}}><button className="btn btn-ghost" onClick={()=>setSubTab('LOGIN_P')}>LOGIN</button><button className="btn btn-ghost" onClick={()=>setSubTab('NEW_PAPER')}>CRIAR JORNAL</button><button className="btn btn-ghost" onClick={()=>setSubTab('NEW_JOURNO')}>SOU JORNALISTA</button></div>
                        {subTab==='LOGIN_P' && !selPaper && <div><h4>Selecione o Jornal</h4>{(papers||[]).filter(p=>p.status==='ACTIVE').map(p=><div key={p.id} className="card" onClick={()=>setSelPaper(p)}>üì∞ {p.name}</div>)}</div>}
                        {subTab==='LOGIN_P' && selPaper && <div><button className="btn" style={{marginBottom:10}} onClick={()=>setSelPaper(null)}>‚¨Ö VOLTAR</button><h4>{selPaper.name} - Jornalistas</h4><div className="card" onClick={()=>setSel({...selPaper, type:'PAPER'})} style={{border:'1px solid var(--primary)'}}>üëë {selPaper.ownerName} (Dono)</div>{(journalists||[]).filter(j=>j.newspaperId===selPaper.id && j.status==='ACTIVE').map(j=><div key={j.id} className="card" onClick={()=>setSel({...j, type:'JOURNALIST'})}>‚úíÔ∏è {j.name}</div>)}</div>}
                        {subTab==='NEW_PAPER' && <div><input className="input-field" placeholder="Nome do Jornal" id="pn" /><input className="input-field" placeholder="Seu Nome (Dono)" id="po" /><input className="input-field" type="number" placeholder="Senha" id="pp" /><button className="btn btn-green" onClick={()=>onCreatePaper(document.getElementById('pn').value, document.getElementById('pp').value, document.getElementById('po').value)}>SOLICITAR CRIA√á√ÉO</button></div>}
                        {subTab==='NEW_JOURNO' && <div><input className="input-field" placeholder="Seu Nome" id="jn" /><select className="input-field" id="jp_id"><option value="">Selecione o Jornal</option>{(papers||[]).filter(p=>p.status==='ACTIVE').map(p=><option key={p.id} value={p.id}>{p.name}</option>)}</select><input className="input-field" type="number" placeholder="Senha" id="jp" /><button className="btn btn-green" onClick={()=>onCreateJourno(document.getElementById('jn').value, document.getElementById('jp').value, document.getElementById('jp_id').value)}>SOLICITAR EMPREGO</button></div>}</div>}
                    
                    {tab==='COMPANY' && <div>
                        <h3 style={{color:'var(--purple)'}}>Abrir Empresa</h3>
                        <input className="input-field" placeholder="Nome da Empresa" value={fc.n} onChange={e=>setFC({...fc, n:e.target.value})} />
                        <input className="input-field" placeholder="Nome do Dono" value={fc.owner} onChange={e=>setFC({...fc, owner:e.target.value})} />
                        
                        <label style={{textAlign:'left', display:'block', color:'#aaa', fontSize:12}}>Porte da Empresa</label>
                        <select className="input-field" value={fc.type} onChange={e=>setFC({...fc, type:e.target.value})}>
                            <option value="COMERCIO">Com√©rcio Local</option>
                            <option value="MEDIA">M√©dia Empresa</option>
                            <option value="GRANDE">Grande Empresa</option>
                        </select>

                        <div style={{background: 'rgba(255, 255, 255, 0.05)', padding: 10, borderRadius: 5, marginBottom: 10, textAlign: 'left', border: '1px solid #444'}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: 5}}>
                                <span>üí∞ Capital Inicial:</span>
                                <span style={{color: 'var(--primary)', fontWeight: 'bold'}}>{fmt(selectedTypeInfo.start)}</span>
                            </div>
                            <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                <span>üí∏ Imposto Semanal:</span>
                                <span style={{color: 'var(--danger)', fontWeight: 'bold'}}>{fmt(selectedTypeInfo.tax)}</span>
                            </div>
                            <p style={{fontSize: 11, color: '#888', marginTop: 8, fontStyle: 'italic', borderTop:'1px solid #333', paddingTop:5}}>
                                "{selectedTypeInfo.desc}"
                            </p>
                        </div>

                        <input className="input-field" type="number" placeholder="Senha de Acesso" value={fc.p} onChange={e=>setFC({...fc, p:e.target.value})} />
                        <button className="btn btn-purple" onClick={()=>onCreateCompany(fc)}>SOLICITAR ABERTURA</button>
                    </div>}
                    
                    {sel && <div className="modal-overlay"><div className="modal-content"><h3>{sel.name}</h3><input className="input-field" type="password" placeholder="Senha" value={lp} onChange={e=>setLp(e.target.value)} /><button className="btn btn-green" onClick={()=>onLogin(sel.id, lp, sel.type)}>ENTRAR</button><button className="btn" onClick={()=>setSel(null)}>CANCELAR</button></div></div>}
                </div>
            );
        };

        const VisitorDashboard = ({ players, teams }) => {
            const topScorer = players.sort((a,b)=>(b.stats?.goals||0)-(a.stats?.goals||0))[0];
            const topAssist = players.sort((a,b)=>(b.stats?.assists||0)-(a.stats?.assists||0))[0];
            return (
                <div>
                    <div className="highlight-card"><h2 style={{margin:0, color:'var(--primary)'}}>Jornal do Dia</h2><small>Resumo da Temporada</small><div style={{marginTop:15, textAlign:'left'}}><div style={{marginBottom:10}}><span style={{color:'#aaa', fontSize:10, textTransform:'uppercase'}}>Artilheiro</span><div style={{fontWeight:'bold', fontSize:16}}>‚öΩ {topScorer?.name || 'Ningu√©m'} <span style={{color:'var(--primary)'}}>{topScorer?.stats?.goals||0} Gols</span></div></div><div><span style={{color:'#aaa', fontSize:10, textTransform:'uppercase'}}>Rei das Assist√™ncias</span><div style={{fontWeight:'bold', fontSize:16}}>üëü {topAssist?.name || 'Ningu√©m'} <span style={{color:'var(--secondary)'}}>{topAssist?.stats?.assists||0} Assis</span></div></div></div></div>
                    <div style={{textAlign:'center', color:'#666'}}>Use o menu abaixo para navegar.</div>
                </div>
            );
        };

// FIM DA LOGIN SCREEN E VISITOR DASHBOARD

        // --- NOVO COMPONENTE: PAINEL DA EMPRESA ---
       const CompanyDashboard = ({ company, products, sps, sales, teams, onSaveProd, onDeleteProd, onProcessSpons }) => {
            const [tab, setTab] = useState('PRODS'); 
            const [editP, setEditP] = useState(null); 
            
            return (
                <div>
                    <div style={{display:'flex', gap:10, marginBottom:15}}>
                        <button className={`btn ${tab==='PRODS'?'btn-purple':'btn-ghost'}`} onClick={()=>setTab('PRODS')}>PRODUTOS</button>
                        <button className={`btn ${tab==='FIN'?'btn-purple':'btn-ghost'}`} onClick={()=>setTab('FIN')}>FINAN√áAS</button>
                    </div>
                    
                    {tab==='PRODS' && <div>
                        <button className="btn btn-green" onClick={()=>setEditP({name:'', price:'', img:'', desc:'', cat:'CHUTEIRA'})}>+ NOVO PRODUTO</button>
                        
                        {products.map(p => (
                            <div key={p.id} className="card" style={{display:'flex', gap:10, textAlign:'left'}}>
                                <img src={p.img || 'https://via.placeholder.com/100'} style={{width:80, height:80, objectFit:'cover', borderRadius:6}} />
                                <div style={{flex:1}}>
                                    <span style={{fontSize:10, background:'#333', padding:'2px 6px', borderRadius:4, color:'#aaa'}}>{PROD_CATS[p.cat] || p.cat}</span>
                                    <div style={{fontWeight:'bold', marginTop:2}}>{p.name}</div>
                                    <span style={{color:'var(--primary)', fontWeight:'bold'}}>{fmt(p.price)}</span>
                                    <p style={{fontSize:11, color:'#aaa', margin:'5px 0'}}>{p.desc}</p>
                                </div>
                                <div style={{display:'flex', flexDirection:'column', gap:5}}>
                                    <button className="btn btn-blue" style={{width:'auto', padding:'5px 10px'}} onClick={()=>setEditP(p)}>‚úèÔ∏è</button>
                                    <button className="btn btn-red" style={{width:'auto', padding:'5px 10px'}} onClick={()=>onDeleteProd(p.id)}>X</button>
                                </div>
                            </div>
                        ))}
                    </div>}

                    {tab==='FIN' && <div>
                        <div className="highlight-card"><h3>Saldo: {fmt(company.balance)}</h3><small>Imposto Semanal: {fmt((COMPANY_TYPES[company.companyType] || {}).tax || 0)}</small></div>
                        <h4 style={{marginTop:20, color:'#ddd'}}>Hist√≥rico de Vendas</h4>
                        <div style={{maxHeight:200, overflowY:'auto', background:'rgba(0,0,0,0.3)', padding:10, borderRadius:8, marginBottom:15, border:'1px solid #333'}}>
                            {(!sales || sales.filter(s => s.companyId === company.id).length === 0) && <p style={{color:'#666', textAlign:'center', fontSize:11, margin:0}}>Nenhuma venda recente.</p>}
                            {(sales || []).filter(s => s.companyId === company.id).map((s, i) => (
                                <div key={i} style={{borderBottom:'1px solid #444', padding:'8px 0', fontSize:11, textAlign:'left'}}>
                                    <div style={{display:'flex', justifyContent:'space-between'}}><b style={{color:'var(--primary)'}}>+ {fmt(s.price)}</b><span style={{color:'#888'}}>{new Date(s.date).toLocaleDateString()}</span></div>
                                    <div style={{marginTop:2}}>üë§ <span style={{color:'#fff', fontWeight:'bold'}}>{s.buyerName}</span> comprou 1x <span style={{color:'var(--purple)'}}>{s.productName}</span></div>
                                </div>
                            ))}
                        </div>
                        <h4>Solicita√ß√µes</h4>{sps.filter(s=>s.status==='PENDING').length === 0 && <p style={{color:'#666'}}>Nenhuma.</p>}{sps.filter(s=>s.status==='PENDING').map(s => (<div key={s.id} className="card"><b>{s.teamName}</b> pede patroc√≠nio.<br/>Valor: <span style={{color:'var(--warning)'}}>{fmt(s.value)}</span><br/><div style={{display:'flex', gap:5, marginTop:5}}><button className="btn btn-green" onClick={()=>onProcessSpons(s, 'ACTIVE')}>ACEITAR</button><button className="btn btn-red" onClick={()=>onProcessSpons(s, 'REJECTED')}>RECUSAR</button></div></div>))}
                        <h4>Contratos Ativos</h4>{sps.filter(s=>s.status==='ACTIVE').length === 0 && <p style={{color:'#666'}}>Nenhum.</p>}{sps.filter(s=>s.status==='ACTIVE').map(s => (<div key={s.id} className="card" style={{borderLeft:'4px solid var(--primary)'}}><b>{s.teamName}</b><br/>Pagamento: {fmt(s.value)}<button className="btn btn-red" style={{marginTop:5}} onClick={()=>onProcessSpons(s, 'CANCELLED')}>CANCELAR</button></div>))}
                    </div>}

                    {editP && <div className="modal-overlay"><div className="modal-content">
                        <h3>{editP.id ? 'Editar' : 'Novo'} Produto</h3>
                        <label>Categoria</label>
                        <select className="input-field" value={editP.cat || 'CHUTEIRA'} onChange={e=>setEditP({...editP, cat:e.target.value})}>
                            {Object.keys(PROD_CATS).map(key => <option key={key} value={key}>{PROD_CATS[key]}</option>)}
                        </select>
                        <label>Nome</label><input className="input-field" value={editP.name} onChange={e=>setEditP({...editP, name:e.target.value})} />
                        <label>Pre√ßo</label><input className="input-field" type="number" value={editP.price} onChange={e=>setEditP({...editP, price:e.target.value})} />
                        <label>Imagem URL</label><input className="input-field" value={editP.img} onChange={e=>setEditP({...editP, img:e.target.value})} />
                        <label>Descri√ß√£o</label><textarea className="input-field" value={editP.desc} onChange={e=>setEditP({...editP, desc:e.target.value})} />
                        <div style={{display:'flex', gap:10}}>
                            <button className="btn btn-green" onClick={()=>{onSaveProd(editP); setEditP(null);}}>SALVAR</button>
                            <button className="btn" onClick={()=>setEditP(null)}>CANCELAR</button>
                        </div>
                    </div></div>}
                </div>
            );
        };

// FIM DO COMPONENTE COMPANY DASHBOARD
// --- JOGADOR, MERCADO E OUTROS COMPONENTES QUE FALTARAM ---

        const PlayerDashboard = ({ player, team, sales, onUpdatePassword, onAction }) => {
            const [newPass, setNewPass] = useState('');
            const [tab, setTab] = useState('PERFIL'); 

            const myItems = (sales||[]).filter(s => s.buyerName === player.name);
            
            // --- C√ÅLCULO DE XP ATUALIZADO (SISTEMA DE ATRIBUTOS) ---
            // A cada 100 XP, o jogador ganha 1 ponto de atributo na virada.
            const xpCurrent = (player.xp || 0) + (player.pendingXP || 0);
            const pointsToGain = Math.floor(xpCurrent / 100);
            const xpRest = xpCurrent % 100; // O que falta para o pr√≥ximo ponto (0 a 99)
            
            const energy = player.energy !== undefined ? player.energy : 100;

            const badges = [];
            const s = player.stats || {};
            if (s.goals >= 1) badges.push({icon:'‚öΩ', name:'Primeiro Gol', color:'#fff'});
            if (s.goals >= 10) badges.push({icon:'üî•', name:'Artilheiro', color:'gold'});
            if (s.assists >= 10) badges.push({icon:'üé©', name:'Maestro', color:'var(--secondary)'});
            if (s.tackles >= 10) badges.push({icon:'üß±', name:'Pared√£o', color:'#aaa'});
            if (player.overall >= 80) badges.push({icon:'‚≠ê', name:'Craque', color:'var(--purple)'});

            return (
                <div>
                    {/* CABE√áALHO COM BARRA DE XP */}
                    <div className="highlight-card" style={{textAlign:'center', paddingBottom:30, position:'relative'}}>
                        <h2 style={{margin:0}}>{player.name} <span style={{fontSize:14}}>{player.mood}</span></h2>
                        <small style={{color:'#ccc'}}>{team?.name || 'Agente Livre'}</small>
                        
                        <div style={{display:'flex', justifyContent:'center', gap:30, marginTop:15}}>
                            <div style={{textAlign:'center'}}>
                                <div style={{display:'flex', alignItems:'center', justifyContent:'center', gap:5}}>
                                    <div style={{fontSize:40, fontWeight:'900', color:'var(--warning)', lineHeight:1}}>{player.overall}</div>
                                    {pointsToGain > 0 && <span className="pulse" style={{fontSize:14, color:'#00E676', fontWeight:'bold'}}>+{pointsToGain} pts</span>}
                                </div>
                                <span style={{fontSize:10, textTransform:'uppercase', color:'#888'}}>Overall</span>
                            </div>
                            
                            <div style={{textAlign:'center'}}>
                                <div style={{fontSize:40, fontWeight:'900', color: energy > 50 ? 'var(--primary)' : 'var(--danger)', lineHeight:1}}>{energy}%</div>
                                <span style={{fontSize:10, textTransform:'uppercase', color:'#888'}}>Energia</span>
                            </div>
                        </div>

                        {/* Barra de Progresso (Ciclo de 100 XP) */}
                        <div style={{position:'absolute', bottom:0, left:0, right:0, height:8, background:'#333'}}>
                            <div style={{width:`${xpRest}%`, height:'100%', background:'linear-gradient(90deg, var(--warning), gold)', transition:'1s'}}></div>
                        </div>
                        <div style={{position:'absolute', bottom:10, right:5, fontSize:9, color:'#fff', textShadow:'0 1px 2px black'}}>
                            Pr√≥x. Ponto: {xpRest} / 100 XP
                        </div>
                    </div>

                    <div style={{display:'flex', gap:10, marginBottom:15, overflowX:'auto'}}>
                        <button className={`btn ${tab==='PERFIL'?'btn-blue':'btn-ghost'}`} onClick={()=>setTab('PERFIL')}>PERFIL</button>
                        <button className={`btn ${tab==='ACOES'?'btn-red':'btn-ghost'}`} onClick={()=>setTab('ACOES')}>A√á√ïES</button>
                        <button className={`btn ${tab==='CARREIRA'?'btn-purple':'btn-ghost'}`} onClick={()=>setTab('CARREIRA')}>CARREIRA</button>
                        <button className={`btn ${tab==='INV'?'btn-gold':'btn-ghost'}`} onClick={()=>setTab('INV')}>MOCHILA</button>
                    </div>

                    {tab==='PERFIL' && <div>
                        <div className="card" style={{borderLeft:'4px solid var(--primary)', background:'linear-gradient(90deg, #1b2e1b, #1E1E1E)'}}>
                            <h3 style={{marginTop:0, color:'var(--primary)'}}>üè¶ {fmt(player.balance)}</h3>
                            <small style={{color:'#aaa'}}>Sal√°rio: {fmt(player.salary)} | Passe: {fmt(player.value)}</small>
                        </div>
                        
                        {/* ATRIBUTOS DETALHADOS NO PAINEL DO JOGADOR */}
                        <div className="card">
                            <AttributeGrid attrs={player.attributes} pendingXP={xpCurrent} />
                        </div>

                        <div className="card">
                            <h3>üìä Estat√≠sticas</h3>
                            <div className="stats-grid" style={{gridTemplateColumns:'1fr 1fr 1fr'}}>
                                <div className="stat-item"><span className="stat-lbl">‚öΩ Gols</span><span className="stat-val">{player.stats?.goals||0}</span></div>
                                <div className="stat-item"><span className="stat-lbl">üëü Assis</span><span className="stat-val">{player.stats?.assists||0}</span></div>
                                <div className="stat-item"><span className="stat-lbl">üõ°Ô∏è Desar</span><span className="stat-val">{player.stats?.tackles||0}</span></div>
                                <div className="stat-item"><span className="stat-lbl">üß§ Defes</span><span className="stat-val">{player.stats?.saves||0}</span></div>
                                <div className="stat-item"><span className="stat-lbl">üü® Amar</span><span className="stat-val">{player.stats?.yellows||0}</span></div>
                                <div className="stat-item"><span className="stat-lbl">üü• Verm</span><span className="stat-val">{player.stats?.reds||0}</span></div>
                            </div>
                        </div>
                    </div>}

                    {tab==='ACOES' && <div>
                        <div className="card" style={{borderLeft:'4px solid var(--danger)'}}>
                            <h4>üì¢ O Gabinete do Presidente</h4>
                            {team ? (
                                <div style={{display:'flex', gap:10, flexDirection:'column'}}>
                                    <button className="btn btn-gold" onClick={()=>onAction('ASK_RAISE', player)}>üí∞ PEDIR AUMENTO</button>
                                    <button className="btn btn-red" onClick={()=>onAction('TRANSFER_REQUEST', player)}>üò° PEDIR TRANSFER√äNCIA</button>
                                </div>
                            ) : (
                                <p style={{color:'var(--primary)', fontWeight:'bold'}}>Est√°s livre no mercado!</p>
                            )}
                        </div>
                        <div className="card">
                            <h4>üîê Seguran√ßa</h4>
                            <div style={{display:'flex', gap:5}}>
                                <input className="input-field" type="password" placeholder="Nova Senha" value={newPass} onChange={e=>setNewPass(e.target.value)} style={{marginBottom:0}} />
                                <button className="btn btn-purple" style={{width:'auto'} } onClick={()=>{ if(!newPass) return alert("Digite uma senha!"); onUpdatePassword(newPass); setNewPass(''); }}>ALTERAR</button>
                            </div>
                        </div>
                    </div>}

                    {tab==='CARREIRA' && <div>
                        <div className="card">
                            <h3>üèÜ Conquistas</h3>
                            {badges.length === 0 && <p style={{color:'#666', fontSize:11}}>Joga para desbloquear.</p>}
                            <div style={{display:'flex', flexWrap:'wrap', gap:8}}>
                                {badges.map((b, i) => (<div key={i} style={{background:'#333', padding:'5px 10px', borderRadius:20, display:'flex', alignItems:'center', gap:5, border:`1px solid ${b.color}`}}><span>{b.icon}</span><span style={{fontSize:11, fontWeight:'bold', color:b.color}}>{b.name}</span></div>))}
                            </div>
                        </div>
                        <div className="card" style={{borderLeft:'4px solid #fff'}}>
                            <h3>üåç Hist√≥rico</h3>
                            <div style={{display:'flex', flexDirection:'column-reverse', gap:10}}>
                                {(player.history || []).map((h, i) => (
                                    <div key={i} style={{display:'flex', alignItems:'center', justifyContent:'space-between', background:'rgba(255,255,255,0.05)', padding:10, borderRadius:8}}>
                                        <span style={{fontSize:9, color:'#aaa'}}>{h.from}</span>
                                        <div style={{textAlign:'center'}}><div style={{color:'var(--primary)', fontSize:12}}>‚û°</div><div style={{fontSize:9, color:'#fff'}}>{h.value > 0 ? fmt(h.value) : 'Gr√°tis'}</div></div>
                                        <span style={{fontSize:9, fontWeight:'bold'}}>{h.to}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>}

                    {tab==='INV' && <div>
                        <h3>üéí Mochila</h3>
                        {myItems.length === 0 && <p style={{color:'#666', textAlign:'center'}}>Vazia.</p>}
                        {myItems.map((item, index) => (<div key={index} className="card" style={{border:'1px solid #444', textAlign:'center', padding:10}}><div style={{fontSize:24}}>üì¶</div><div style={{fontWeight:'bold', fontSize:12}}>{item.productName}</div><div style={{fontSize:10, color:'#aaa'}}>Pre√ßo: {fmt(item.price)}</div></div>))}
                    </div>}
                </div>
            );
        };

        // ... continua√ß√£o do c√≥digo anterior

        const ShoppingScreen = ({ products, companies, userTeam, onBuy }) => {
            const [term, setTerm] = useState('');
            const list = products.filter(p => p.name.toLowerCase().includes(term.toLowerCase()));
            
            return (
                <div>
                    <h3>Shopping Global</h3>
                    <input className="input-field" placeholder="Buscar produto..." value={term} onChange={e=>setTerm(e.target.value)} />
                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10}}>
                        {list.map(p => { 
                            const comp = companies.find(c => c.id === p.companyId); 
                            if (comp?.status !== 'ACTIVE') return null; 
                            
                            return (
                                <div key={p.id} className="card" style={{padding:10, position:'relative'}}>
                                    <div style={{fontSize:9, background:'var(--purple)', position:'absolute', top:5, right:5, padding:'2px 5px', borderRadius:4, zIndex:10}}>
                                        {comp.name}
                                    </div>
                                    <img src={p.img || 'https://via.placeholder.com/100'} className="prod-img" style={{width:'100%', height:100, objectFit:'cover', borderRadius:4}} />
                                    <span style={{fontSize:9, color:'#888', display:'block', marginTop:5}}>
                                        {PROD_CATS[p.cat] || 'Item'}
                                    </span>
                                    <div style={{fontWeight:'bold', fontSize:13, lineHeight:'1.2em'}}>{p.name}</div>
                                    <div style={{color:'var(--primary)', fontWeight:'900', fontSize:14}}>{fmt(p.price)}</div>
                                    {userTeam && <button className="btn btn-green" style={{marginTop:5, fontSize:10}} onClick={()=>onBuy(p, comp)}>COMPRAR</button>}
                                </div>
                            ); 
                        })}
                    </div>
                    {list.length === 0 && <p style={{textAlign:'center', color:'#666'}}>Nenhum produto encontrado.</p>}
                </div>
            );
        };

        const TeamDashboard = ({ team, players, isVisitor, onEdit, onAdd }) => {
            const wageBill = players.reduce((a,p) => a + (parseFloat(p.salary)||0), 0);

            return (
                <div>
                    <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:15}}>
                        <div>
                            <h3>Elenco ({players.length})</h3>
                            <small style={{color:'#aaa'}}>Folha: <span style={{color:'var(--danger)', fontWeight:'bold'}}>{fmt(wageBill)}/sem</span></small>
                        </div>
                        {!isVisitor && <button className="btn btn-green" style={{width:'auto'}} onClick={onAdd}>+ JOGADOR</button>}
                    </div>

                    {players.map(p => (
                        <div key={p.id} className="card" style={{borderLeft: `4px solid ${getPosColor(p.position)}`, marginBottom:10}}>
                            <div style={{display:'flex', justifyContent:'space-between', alignItems:'start'}}>
                                <div>
                                    <span className="badge-pos" style={{background:getPosColor(p.position)}}>{p.position}</span>
                                    <b style={{fontSize:16, marginLeft:8}}>{p.name}</b>
                                    <div style={{fontSize:11, color:'#888', marginTop:4}}>
                                        Sal: {fmt(p.salary)} <span style={{margin:'0 5px'}}>|</span> Con: {p.contract}
                                        {p.status === 'VENDA' && <span style={{color:'var(--primary)', marginLeft:5}}> (√Ä VENDA)</span>}
                                    </div>
                                </div>
                                <div className="player-ov">{p.overall}</div>
                            </div>

                            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr 1fr', gap:5, textAlign:'center', marginTop:10, background:'rgba(0,0,0,0.3)', padding:5, borderRadius:5}}>
                                <div><small style={{color:'#aaa'}}>‚öΩ {p.stats?.goals||0}</small></div>
                                <div><small style={{color:'#aaa'}}>üëü {p.stats?.assists||0}</small></div>
                                <div><small style={{color:'#aaa'}}>üõ°Ô∏è {p.stats?.tackles||0}</small></div>
                                <div><small style={{color:'#aaa'}}>üß§ {p.stats?.saves||0}</small></div>
                                <div><small style={{color:'#aaa'}}>üü® {p.stats?.yellows||0}</small></div>
                                <div><small style={{color:'#aaa'}}>üü• {p.stats?.reds||0}</small></div>
                            </div>

                            {/* ATRIBUTOS VIS√çVEIS NO PAINEL */}
                            <div style={{marginTop:10, paddingTop:5, borderTop:'1px dashed #444'}}>
                                 <AttributeGrid attrs={p.attributes} pendingXP={p.pendingXP} />
                            </div>

                            {!isVisitor && (
                                <div style={{marginTop:10, display:'flex', justifyContent:'flex-end'}}>
                                    <button className="btn btn-ghost" style={{width:'auto', fontSize:12}} onClick={()=>onEdit(p)}>
                                        <i className="fas fa-edit"></i> EDITAR
                                    </button>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            );
        };
// FIM DO SHOPPING E TEAM DASHBOARD



       const StatsEditor = ({ players, teams, onSave }) => {
            const [search, setSearch] = useState(''); const [selP, setSelP] = useState(null); const [s, setS] = useState({});
            const filtered = players.filter(p => p.name.toLowerCase().includes(search.toLowerCase()));
            if (selP) return ( <div><h3>Editando: {selP.name}</h3><div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10}}><div><label>Gols</label><input className="input-field" type="number" value={s.goals} onChange={e=>setS({...s, goals:parseInt(e.target.value)})} /></div><div><label>Assist√™ncias</label><input className="input-field" type="number" value={s.assists} onChange={e=>setS({...s, assists:parseInt(e.target.value)})} /></div><div><label>Desarmes</label><input className="input-field" type="number" value={s.tackles} onChange={e=>setS({...s, tackles:parseInt(e.target.value)})} /></div><div><label>Defesas</label><input className="input-field" type="number" value={s.saves} onChange={e=>setS({...s, saves:parseInt(e.target.value)})} /></div><div><label>Amarelos</label><input className="input-field" type="number" value={s.yellows} onChange={e=>setS({...s, yellows:parseInt(e.target.value)})} /></div><div><label>Vermelhos</label><input className="input-field" type="number" value={s.reds} onChange={e=>setS({...s, reds:parseInt(e.target.value)})} /></div></div><button className="btn btn-green" onClick={()=>onSave(selP.id, s)}>SALVAR ESTAT√çSTICAS</button><button className="btn" onClick={()=>setSelP(null)}>VOLTAR</button></div> );
            return (<div><input className="input-field" placeholder="Buscar jogador..." value={search} onChange={e=>setSearch(e.target.value)} /><div style={{maxHeight:300, overflowY:'auto'}}>{search.length > 0 && filtered.map(p => (<div key={p.id} className="card" onClick={()=>{setSelP(p); setS(p.stats || {goals:0,assists:0,tackles:0,saves:0,yellows:0,reds:0})}}><b>{p.name}</b> <small>({teams.find(t=>t.id===p.teamId)?.name})</small></div>))}</div></div>);
        };

      const PlayerForm = ({ initial, onSave, onDelete, isAdmin, teams, onRenew, isOwner }) => {
            const isEditing = initial && initial.id;

            const [f, setF] = useState(initial || {
                name:'', position:'ATA', overall:45, value:'', salary:'', 
                clause:'', contract:'', mood:'üòê', status:'NAO_A_VENDA', 
                password:'', balance: 0, rating: '', 
                stats: {goals:0, assists:0, tackles:0, saves:0, yellows:0, reds:0},
                attributes: null 
            });
            
            // Fun√ß√£o auxiliar para calcular m√©dia ignorando status in√∫teis (Balanceamento)
            const calculateRealOverall = (position, attrs) => {
                let sum = 0;
                let count = 0;
                // Goleiro ignora atributos de linha; Linha ignora atributo de goleiro.
                const ignoreList = position === 'GOL' 
                    ? ['shot', 'attack', 'dribble', 'curve', 'freeKick', 'weakFootAcc', 'weakFootFreq'] 
                    : ['gk'];

                Object.entries(attrs).forEach(([key, val]) => {
                    if (ignoreList.includes(key)) return;
                    sum += val;
                    count++;
                });
                return Math.round(sum / count);
            };

            const handleSave = () => {
                const dataToSave = { ...f };

                // SE N√ÉO TIVER ATRIBUTOS (Cria√ß√£o ou Jogador Antigo), GERA AGORA!
                if (!dataToSave.attributes || Object.keys(dataToSave.attributes).length === 0) {
                    const targetOv = parseInt(dataToSave.overall) || 60;
                    const newAttrs = generateAttributes(dataToSave.position, targetOv);
                    
                    // Calcula a m√©dia real balanceada
                    const realAvg = calculateRealOverall(dataToSave.position, newAttrs);
                    
                    // Atualiza o objeto final
                    dataToSave.attributes = newAttrs;
                    dataToSave.overall = realAvg;

                    alert(`Atributos gerados!\nOverall Real (Balanceado): ${realAvg}`);
                }

                onSave(dataToSave);
            };

            return (
                <div className="modal-bg">
                    <div className="modal-content" style={{maxHeight:'90vh', overflowY:'auto'}}>
                        <h3>{isEditing ? 'Ficha do Jogador' : 'Criar Jogador'}</h3>
                        
                        <label>Nome</label>
                        {/* S√≥ desabilita se n√£o for admin E se o jogador j√° existir (isEditing) */}
                        <input className="input-field" value={f.name} onChange={e=>setF({...f, name:e.target.value})} disabled={!isAdmin && isEditing} />
                        
                        <div style={{background:'rgba(255,255,255,0.05)', padding:10, borderRadius:5, marginBottom:10, border:'1px solid #444'}}>
                            <label style={{color:'var(--secondary)'}}>üîê Senha de Acesso</label>
                            <input className="input-field" type="text" placeholder="Crie uma senha provis√≥ria" value={f.password || ''} onChange={e=>setF({...f, password:e.target.value})} />
                        </div>

                        {isAdmin && (
                            <div style={{border:'1px solid var(--primary)', padding:8, borderRadius:5, marginBottom:10, background:'rgba(0,255,0,0.05)'}}>
                                <label style={{color:'var(--primary)'}}>üí∞ Saldo em Conta (Admin)</label>
                                <input className="input-field" type="number" value={f.balance||0} onChange={e=>setF({...f, balance:e.target.value})} />
                            </div>
                        )}

                        <div style={{display:'flex', gap:5}}>
                            <div style={{flex:1}}>
                                <label>Posi√ß√£o</label>
                                <select className="input-field" value={f.position} onChange={e=>setF({...f, position:e.target.value})} disabled={!isAdmin && isEditing}>
                                    {POS.map(p=><option key={p} value={p}>{p}</option>)}
                                </select>
                            </div>
                            <div style={{flex:1}}>
                                <label>Overall (Meta)</label>
                                <input className="input-field" type="number" value={f.overall} onChange={e=>setF({...f, overall:e.target.value})} disabled={!isAdmin && isEditing} />
                            </div>
                        </div>

                        {/* VISUALIZA√á√ÉO APENAS (Read-Only) */}
                        {f.attributes ? (
                            <div style={{border:'1px solid #444', padding:10, borderRadius:8, margin:'10px 0'}}>
                                <AttributeGrid attrs={f.attributes} pendingXP={f.pendingXP || 0} />
                                {isAdmin && <button className="btn btn-gold" style={{marginTop:5, fontSize:10}} onClick={()=>{
                                    if(confirm("Regerar (Admin)?")) {
                                        const n = generateAttributes(f.position, parseInt(f.overall)||60);
                                        const avg = calculateRealOverall(f.position, n);
                                        setF({...f, attributes:n, overall: avg});
                                    }
                                }}>üé≤ REGERAR (ADM)</button>}
                            </div>
                        ) : (
                            <div style={{padding:15, textAlign:'center', color:'#aaa', border:'1px dashed #666', borderRadius:8, margin:'10px 0', background:'rgba(0,0,0,0.2)'}}>
                                <i className="fas fa-magic" style={{fontSize:20, marginBottom:5}}></i><br/>
                                Os atributos ser√£o gerados e salvos<br/>automaticamente ao clicar em <b>SALVAR</b>.
                            </div>
                        )}

                        <div style={{display:'flex', gap:5}}>
                            <div style={{flex:1}}><label>Valor</label><input className="input-field" type="number" value={f.value} onChange={e=>setF({...f, value:e.target.value})} /></div>
                            <div style={{flex:1}}><label>Sal√°rio</label><input className="input-field" type="number" value={f.salary} onChange={e=>setF({...f, salary:e.target.value})} /></div>
                        </div>
                        <div style={{display:'flex', gap:5}}>
                            <div style={{flex:1}}><label>Multa</label><input className="input-field" type="number" value={f.clause} onChange={e=>setF({...f, clause:e.target.value})} /></div>
                            <div style={{flex:1}}><label>Contrato</label><input className="input-field" type="number" value={f.contract} onChange={e=>setF({...f, contract:e.target.value})} /></div>
                        </div>
                        
                        <label>Status</label>
                        <select className="input-field" value={f.status} onChange={e=>setF({...f, status:e.target.value})}>
                            <option value="NAO_A_VENDA">N√£o Listado</option>
                            <option value="VENDA">√Ä Venda</option>
                            <option value="EMPRESTIMO">Empr√©stimo</option>
                            <option value="INTRANSFERIVEL">Bloqueado</option>
                        </select>
                        <label>Humor</label>
                        <select className="input-field" value={f.mood} onChange={e=>setF({...f, mood:e.target.value})}><option>ü§©</option><option>üòê</option><option>üò°</option></select>
                        
                        {isAdmin && (
                            <div style={{border:'1px solid var(--purple)', padding:8, borderRadius:5, margin:'5px 0'}}>
                                <label style={{color:'var(--purple)'}}>Nota Oficial (XP)</label>
                                <input className="input-field" type="number" step="0.1" value={f.rating} onChange={e=>setF({...f, rating:e.target.value})} />
                            </div>
                        )}

                        {isAdmin && <div style={{border:'1px solid var(--primary)', padding:8, borderRadius:8, marginTop:10}}>
                            <label style={{color:'var(--primary)'}}>Estat√≠sticas (Admin)</label>
                            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr 1fr', gap:5}}>
                                <div><small>‚öΩ Gols</small><input className="input-field" type="number" value={f.stats?.goals||0} onChange={e=>setF({...f, stats:{...f.stats, goals:e.target.value}})} /></div>
                                <div><small>üëü Assis</small><input className="input-field" type="number" value={f.stats?.assists||0} onChange={e=>setF({...f, stats:{...f.stats, assists:e.target.value}})} /></div>
                                <div><small>üõ°Ô∏è Desar</small><input className="input-field" type="number" value={f.stats?.tackles||0} onChange={e=>setF({...f, stats:{...f.stats, tackles:e.target.value}})} /></div>
                                <div><small>üß§ Defes</small><input className="input-field" type="number" value={f.stats?.saves||0} onChange={e=>setF({...f, stats:{...f.stats, saves:e.target.value}})} /></div>
                                <div><small>üü® Amar</small><input className="input-field" type="number" value={f.stats?.yellows||0} onChange={e=>setF({...f, stats:{...f.stats, yellows:e.target.value}})} /></div>
                                <div><small>üü• Verm</small><input className="input-field" type="number" value={f.stats?.reds||0} onChange={e=>setF({...f, stats:{...f.stats, reds:e.target.value}})} /></div>
                            </div>
                        </div>}

                        {isAdmin && <div style={{border:'1px solid gold', padding:5, marginTop:5}}>
                            <label style={{color:'gold'}}>Mover Time (Adm)</label>
                            <select className="input-field" onChange={e=>setF({...f, forcedTeamId:e.target.value})}>
                                <option value="">-- Manter --</option>
                                {teams.map(t=><option key={t.id} value={t.id}>{t.name}</option>)}
                            </select>
                        </div>}
                        
                        <div style={{display:'flex', gap:10, marginTop:15}}>
                            <button className="btn btn-green" onClick={handleSave}>SALVAR</button>
                            
                            {/* Bot√µes extras s√≥ aparecem se o jogador j√° existe (isEditing) */}
                            {isOwner && isEditing && <button className="btn btn-blue" onClick={()=>onRenew(initial)}>RENOVAR</button>}
                            {isEditing && <button className="btn btn-red" onClick={()=>onDelete(initial.id)}>X</button>}
                            
                            <button className="btn" onClick={()=>setF(null)}>CANCELAR</button>
                        </div>
                    </div>
                </div>
            );
        };
// FIM DO STATS EDITOR E PLAYER FORM

const Market = ({ me, teams, players, open, isVis, onNeg, onPayClause, onPre }) => {
    const [view, setView] = useState('MENU'); 
    const [serie, setSerie] = useState('A'); 
    const [selT, setSelT] = useState(null); 
    const [filt, setFilt] = useState('VENDA');

    if(view==='MENU') return (
        <div>
            <h3 style={{display:'flex', alignItems:'center', gap:10}}>
                Mercado Global {open ? <span style={{color:'var(--primary)', fontSize:12}}>üü¢ ABERTO</span> : <span style={{color:'var(--danger)', fontSize:12}}>üî¥ FECHADO</span>}
            </h3>
            
            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr 1fr', gap:10, marginBottom:15}}>
                <div className="card" style={{textAlign:'center', cursor:'pointer', border:filt==='VENDA'?'2px solid var(--primary)':'1px solid #333', background: filt==='VENDA'?'rgba(0,230,118,0.1)':'var(--bg-card)'}} onClick={()=>{setFilt('VENDA'); setView('GLOBAL');}}>
                    <i className="fas fa-shopping-cart" style={{fontSize:20, marginBottom:5, color:'var(--primary)'}}></i><br/>
                    <span style={{fontSize:10, fontWeight:'bold'}}>√Ä VENDA</span>
                </div>
                <div className="card" style={{textAlign:'center', cursor:'pointer', border:filt==='EMPRESTIMO'?'2px solid var(--secondary)':'1px solid #333', background: filt==='EMPRESTIMO'?'rgba(41,121,255,0.1)':'var(--bg-card)'}} onClick={()=>{setFilt('EMPRESTIMO'); setView('GLOBAL');}}>
                    <i className="fas fa-retweet" style={{fontSize:20, marginBottom:5, color:'var(--secondary)'}}></i><br/>
                    <span style={{fontSize:10, fontWeight:'bold'}}>EMPR√âST.</span>
                </div>
                <div className="card" style={{textAlign:'center', cursor:'pointer', border:filt==='FREE'?'2px solid var(--warning)':'1px solid #333', background: filt==='FREE'?'rgba(255,196,0,0.1)':'var(--bg-card)'}} onClick={()=>{setFilt('FREE'); setView('GLOBAL');}}>
                    <i className="fas fa-user-check" style={{fontSize:20, marginBottom:5, color:'var(--warning)'}}></i><br/>
                    <span style={{fontSize:10, fontWeight:'bold'}}>LIVRES</span>
                </div>
            </div>

            <h4>Navegar por S√©ries</h4>
            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10}}>
                {SERIES.map(s=>(
                    <div key={s} className="card" style={{textAlign:'center', cursor:'pointer', borderLeft:`4px solid var(--secondary)`}} onClick={()=>{setSerie(s); setView('LIST');}}>
                        <b>S√âRIE {s}</b>
                    </div>
                ))}
            </div>
        </div>
    );

    let list = []; 
    if(view==='GLOBAL') {
        if(filt === 'FREE') {
            list = players.filter(p => p.teamId === 'FREE' || !p.teamId).sort((a,b)=>b.overall-a.overall);
        } else {
            list = players.filter(p => p.status === filt && p.teamId !== me && p.teamId !== 'FREE').sort((a,b)=>b.overall-a.overall);
        }
    } else if(view==='TEAM') {
        list = players.filter(p => p.teamId === selT.id).sort((a,b)=>b.overall-a.overall);
    }

    if(view==='LIST') return (
        <div>
            <button className="btn btn-ghost" style={{marginBottom:15, width:'auto'}} onClick={()=>setView('MENU')}>
                <i className="fas fa-chevron-left"></i> VOLTAR
            </button>
            <h3>Clubes da S√©rie {serie}</h3>
            {teams.filter(t=>t.serie===serie && t.status!=='PENDING').map(t=>(
                <div key={t.id} className="card" onClick={()=>{setSelT(t); setView('TEAM');}} style={{display:'flex', alignItems:'center', gap:15, cursor:'pointer'}}>
                    {t.logo ? <img src={t.logo} style={{width:40, height:40, borderRadius:'50%', objectFit:'cover', border:'1px solid #444'}}/> : <div style={{width:40, height:40, borderRadius:'50%', background:'#333', display:'grid', placeItems:'center'}}><i className="fas fa-shield-alt"></i></div>}
                    <b style={{fontSize:16}}>{t.name}</b>
                    <i className="fas fa-chevron-right" style={{marginLeft:'auto', color:'#555'}}></i>
                </div>
            ))}
        </div>
    );

    return (
        <div>
            <button className="btn btn-ghost" style={{marginBottom:15, width:'auto'}} onClick={()=>view==='GLOBAL' ? setView('MENU') : setView('LIST')}>
                <i className="fas fa-chevron-left"></i> VOLTAR
            </button>
            <h3>{view==='GLOBAL' ? (filt === 'FREE' ? 'Mercado de Agentes Livres' : `Lista de ${filt}`) : selT.name}</h3>
            
            {list.length === 0 && <p style={{textAlign:'center', color:'#666', marginTop:30, fontStyle:'italic'}}>Nenhum jogador dispon√≠vel nesta categoria.</p>}
            
            {list.map(p => (
                <div key={p.id} className="card" style={{borderLeft: `4px solid ${getPosColor(p.position)}`, opacity: p.preContract ? 0.7 : 1}}>
                    <div style={{display:'flex', justifyContent:'space-between', alignItems:'start'}}>
                        <div>
                            <span className="badge-pos" style={{background:getPosColor(p.position)}}>{p.position}</span>
                            <b style={{fontSize:16}}>{p.name}</b>
                            <div style={{fontSize:10, color:'#888', marginTop:2}}>
                                {p.teamId === 'FREE' ? <b style={{color:'var(--warning)'}}><i className="fas fa-unlock"></i> PASSE LIVRE</b> : <span><i className="fas fa-tshirt"></i> {teams.find(t=>t.id===p.teamId)?.name}</span>}
                            </div>
                        </div>
                        <span className="player-ov">{p.overall}</span>
                    </div>

                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10, fontSize:11, color:'#aaa', marginTop:10, background:'rgba(0,0,0,0.2)', padding:8, borderRadius:8}}>
                        <div>Valor: <b style={{color:'#fff'}}>{fmt(p.value)}</b></div>
                        <div>Contrato: <b style={{color: p.contract === 0 ? 'var(--danger)' : (p.contract === 1 ? 'var(--warning)' : '#fff')}}>{p.contract} Temporada{p.contract !== 1 ? 's' : ''}</b></div>
                    </div>

                    {/* --- MOSTRA OS ATRIBUTOS NO MERCADO --- */}
                    <div style={{marginTop:8, borderTop:'1px dashed #444', paddingTop:5}}>
                        <AttributeGrid attrs={p.attributes} />
                    </div>

                    {/* AVISO DE PR√â-CONTRATO ASSINADO */}
                    {p.preContract && (
                        <div style={{marginTop:10, background:'rgba(0,0,0,0.5)', padding:5, borderRadius:4, textAlign:'center', border:'1px solid var(--secondary)'}}>
                            <small style={{color:'var(--secondary)', fontWeight:'bold'}}>üìù J√Å ASSINOU PR√â-CONTRATO</small><br/>
                            <small style={{color:'#aaa', fontSize:9}}>Vai para o {p.preContract.teamName} no fim da temporada.</small>
                        </div>
                    )}

                    {!isVis && !p.preContract && (
                        <div style={{marginTop:12, display:'flex', gap:8}}>
                            
                            {/* BOT√ÉO NORMAL DE NEGOCIA√á√ÉO */}
                            {(open || p.teamId === 'FREE') && p.status !== 'INTRANSFERIVEL' && (
                                <button className="btn btn-purple" style={{flex:1, marginBottom:0}} onClick={()=>onNeg(p)}>
                                    <i className="fas fa-handshake"></i> {p.teamId === 'FREE' ? 'CONTRATAR' : 'NEGOCIAR'}
                                </button>
                            )}

                            {/* BOT√ÉO PR√â-CONTRATO (S√ì APARECE SE TIVER 1 ANO DE CONTRATO) */}
                            {p.contract === 1 && p.teamId !== 'FREE' && p.status !== 'INTRANSFERIVEL' && (
                                <button className="btn btn-blue" style={{flex:1, marginBottom:0}} onClick={()=>{
                                    // Abre a modal j√° setando o tipo para PRE_CONTRATO na oferta
                                    const dummyOffer = { type: 'PRE_CONTRATO', value: 0 };
                                    // Passamos dummyOffer dentro do objeto target para o OfferForm ler
                                    onNeg({...p, oldOffer: dummyOffer});
                                }}>
                                    <i className="fas fa-file-signature"></i> PR√â-CONTRATO
                                </button>
                            )}
                            
                            {/* BOT√ÉO DE FECHADO (se n√£o se encaixar nos de cima) */}
                            {!open && p.teamId !== 'FREE' && p.contract !== 1 && (
                                <button className="btn btn-ghost" style={{flex:1, marginBottom:0, opacity:0.5}} disabled>
                                    <i className="fas fa-lock"></i> FECHADO
                                </button>
                            )}
                            
                            {/* BOT√ÉO DE MULTA */}
                            {p.teamId !== 'FREE' && parseFloat(p.clause) > 0 && (
                                <button className="btn btn-gold" style={{width:'auto', marginBottom:0}} onClick={()=>onPayClause(p)}>
                                    <i className="fas fa-gavel"></i> MULTA
                                </button>
                            )}
                        </div>
                    )}
                </div>
            ))}
        </div>
    );
};
//fim
        // --- COMPONENTE OFFER FORM CORRIGIDO ---
const OfferForm = ({ target, myPlayers, onSend, setModal, user }) => {
    const old = target.oldOffer || {};
    const isCounter = !!old.id;
    const isPlayerActing = user?.type === 'PLAYER';
    const clubsHaveAgreed = old?.sellerAccepted === true;
    const isUrgentRenewal = old?.type === 'RENOVACAO_URGENTE';
    const shouldHidePart1 = isPlayerActing || clubsHaveAgreed || isUrgentRenewal;
    const maxLoanAllowed = parseInt(target.contract) || 1;

    // Se vier do bot√£o "Pr√©-Contrato", o type inicial ser√° PRE_CONTRATO
    const [t, setT] = useState(old.type || 'COMPRA');
    const [v, setV] = useState(old.value || '');
    const [sal, setSal] = useState(old.meta?.newSalary || target.salary || 0);
    const [con, setCon] = useState(old.offerContract || '1');
    const [role, setRole] = useState(old.meta?.role || 'ROTACAO');
    const [hasBuyOption, setHasBuyOption] = useState(old.meta?.hasBuyOption || false);

    const [meta, setMeta] = useState(old.meta || { 
        sellOn: 0, 
        installments: 1, 
        signingBonus: 0, 
        loanDuration: 1, 
        salarySplit: 100, 
        buyOpt: 0 
    });
    const [swaps, setSwaps] = useState(old.swapPlayerIds || []);

    const toggleSwap = (id) => {
        if (swaps.length >= 3 && !swaps.includes(id)) return alert("M√°ximo de 3 jogadores!");
        setSwaps(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
    };

    const isPreContract = t === 'PRE_CONTRATO';

    return (
        <div className="modal-bg">
            <div className="modal-content" style={{maxWidth: '500px'}}>
                <h3 style={{color:'var(--primary)'}}>
                    {isUrgentRenewal ? 'üö® Renova√ß√£o Obrigat√≥ria' : (isPreContract ? 'üìù Pr√©-Contrato' : (isCounter ? 'Responder Proposta' : `Negociar ${target.name}`))}
                </h3>
                
                {/* AVISO DE PR√â-CONTRATO */}
                {isPreContract && (
                    <div style={{background:'rgba(41, 121, 255, 0.2)', padding:10, borderRadius:8, border:'1px solid var(--secondary)', marginBottom:15, fontSize:12, color:'#fff'}}>
                        ‚ÑπÔ∏è <b>ASSINATURA LIVRE:</b> O jogador tem menos de 6 meses de contrato protegido.
                        <br/>Ele vir√° <b>de gra√ßa</b> para o seu time apenas no in√≠cio da <b>pr√≥xima temporada</b>.
                    </div>
                )}

                {/* 1. ACORDO ENTRE CLUBES (FINANCEIRO) */}
                {/* Se for pr√©-contrato, esconde essa parte pois n√£o tem taxa */}
                {!shouldHidePart1 && !isPreContract ? (
                    <div style={{borderBottom: '1px solid #444', paddingBottom: 15, marginBottom: 15}}>
                        <label style={{fontSize: '11px', color: 'gold', fontWeight: 'bold'}}>1. ACORDO ENTRE CLUBES (FINANCEIRO)</label>
                        <div style={{display:'flex', gap:5, margin:'10px 0'}}>
                            {['COMPRA','EMPRESTIMO','TROCA'].map(x=>(
                                <button key={x} className={`btn ${t===x?'btn-green':'btn-ghost'}`} onClick={()=>setT(x)} style={{flex: 1}}>{x}</button>
                            ))}
                        </div>

                        <label>{t === 'EMPRESTIMO' ? 'Taxa de Empr√©stimo (‚Ç£)' : 'Taxa de Transfer√™ncia (‚Ç£)'}</label>
                        <input className="input-field" type="number" value={v} onChange={e=>setV(e.target.value)} />

                        {t === 'EMPRESTIMO' && (
                            <div className="card" style={{background: '#222', padding: '10px', marginTop: 10}}>
                                <label style={{fontSize: '11px'}}>Dura√ß√£o (M√°x: {maxLoanAllowed} Temp.)</label>
                                <input 
                                    className="input-field" 
                                    type="number" 
                                    min="1" 
                                    max={maxLoanAllowed} 
                                    value={meta.loanDuration} 
                                    onChange={e=>{
                                        const val = parseInt(e.target.value);
                                        setMeta({...meta, loanDuration: val > maxLoanAllowed ? maxLoanAllowed : (val || 1)});
                                    }} 
                                />
                                
                                <div style={{margin: '10px 0', display: 'flex', alignItems: 'center', gap: 10}}>
                                    <label style={{fontSize: '11px'}}>Op√ß√£o de Compra?</label>
                                    <button className={`btn ${hasBuyOption ? 'btn-green' : 'btn-ghost'}`} style={{width: '60px', padding: '5px', marginBottom:0}} onClick={() => setHasBuyOption(true)}>SIM</button>
                                    <button className={`btn ${!hasBuyOption ? 'btn-red' : 'btn-ghost'}`} style={{width: '60px', padding: '5px', marginBottom:0}} onClick={() => {setHasBuyOption(false); setMeta({...meta, buyOpt: 0});}}>N√ÉO</button>
                                </div>

                                {hasBuyOption && (
                                    <div>
                                        <label style={{fontSize: '11px'}}>Valor da Op√ß√£o (‚Ç£)</label>
                                        <input className="input-field" type="number" value={meta.buyOpt} onChange={e=>setMeta({...meta, buyOpt: parseFloat(e.target.value)})} />
                                    </div>
                                )}

                                <label style={{marginTop:10, display:'block', fontSize: '11px'}}>Divis√£o Salarial (Comprador paga: {meta.salarySplit}%)</label>
                                <input type="range" min="0" max="100" step="10" value={meta.salarySplit} onChange={e=>setMeta({...meta, salarySplit: parseInt(e.target.value)})} style={{width:'100%', accentColor: 'var(--primary)'}} />
                            </div>
                        )}

                        {t === 'TROCA' && (
                            <div className="card" style={{background: '#222', padding: '10px', marginTop: 10}}>
                                <small style={{display:'block', marginBottom: 10}}>Selecionar jogadores (M√°x 3):</small>
                                <div style={{maxHeight: '120px', overflowY: 'auto', display: 'flex', flexDirection: 'column', gap: 5}}>
                                    {(myPlayers || []).map(p => (
                                        <div key={p.id} onClick={() => toggleSwap(p.id)} style={{padding: '8px', borderRadius: '6px', fontSize: '11px', cursor: 'pointer', background: swaps.includes(p.id) ? 'var(--primary)' : '#333', color: swaps.includes(p.id) ? '#000' : '#fff', display: 'flex', justifyContent: 'space-between'}}>
                                            <span>{p.name}</span><b>OV: {p.overall}</b>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {t === 'COMPRA' && (
                            <div className="card" style={{background: '#222', padding: '10px', marginTop: 10}}>
                                <small>üì¶ PARCELAMENTO: <b>{meta.installments}x</b></small>
                                <input type="range" min="1" max="12" value={meta.installments} onChange={e=>setMeta({...meta, installments: parseInt(e.target.value)})} style={{width:'100%'}} />
                                <hr style={{borderColor: '#444', margin: '10px 0'}} />
                                <small>üìà REVENDA FUTURA: <b style={{color:'gold'}}>{meta.sellOn}%</b></small>
                                <input type="range" min="0" max="80" step="5" value={meta.sellOn} onChange={e=>setMeta({...meta, sellOn: parseInt(e.target.value)})} style={{width:'100%', accentColor: 'gold'}} />
                            </div>
                        )}
                    </div>
                ) : !isPreContract ? (
                    /* VIS√ÉO BLOQUEADA (Normal) */
                    <div style={{background: 'rgba(0,230,118,0.05)', padding: 12, borderRadius: 8, marginBottom: 15, fontSize: 11, border: '1px solid var(--primary)'}}>
                        <b style={{color: 'gold', display: 'block', marginBottom: 5}}><i className="fas fa-lock"></i> ACORDO SELADO:</b>
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 5, color: '#ccc'}}>
                            <span>Tipo: <b>{isUrgentRenewal ? 'RENOVA√á√ÉO' : t}</b></span>
                            {!isUrgentRenewal && <span>Valor: <b>{fmt(v)}</b></span>}
                            {t === 'EMPRESTIMO' && <span>Dura√ß√£o: <b>{meta.loanDuration} Temp.</b></span>}
                            {t === 'COMPRA' && meta.sellOn > 0 && <span style={{color:'gold'}}>Revenda: <b>{meta.sellOn}%</b></span>}
                        </div>
                    </div>
                ) : null}

                {/* 2. TERMOS PESSOAIS (JOGADOR x COMPRADOR) */}
                <div>
                    <label style={{fontSize: '11px', color: 'cyan', fontWeight: 'bold'}}>2. CONTRATO PESSOAL DO ATLETA</label>
                    
                    <div style={{background: 'rgba(0,230,118,0.05)', padding: '10px', borderRadius: '8px', marginTop: 10, border: '1px dashed var(--primary)'}}>
                        <label style={{color: 'var(--primary)', fontWeight: 'bold', fontSize: '12px'}}>üí∞ Luvas / B√¥nus de Assinatura (‚Ç£)</label>
                        <input className="input-field" type="number" value={meta.signingBonus} onChange={e=>setMeta({...meta, signingBonus: parseFloat(e.target.value)})} />
                    </div>

                    <div style={{marginTop: 10}}>
                        <label>Sal√°rio Semanal (‚Ç£)</label>
                        <input className="input-field" type="number" value={sal} onChange={e=>setSal(e.target.value)} />
                    </div>
                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10}}>
                        <div>
                            <label>{t === 'EMPRESTIMO' ? 'Dura√ß√£o (Fixo)' : 'Contrato (Anos)'}</label>
                            <input className="input-field" type="number" value={t === 'EMPRESTIMO' ? meta.loanDuration : con} disabled={t === 'EMPRESTIMO'} onChange={e=>setCon(e.target.value)} />
                        </div>
                        <div><label>Papel</label>
                            <select className="input-field" value={role} onChange={e=>setRole(e.target.value)}>
                                <option value="CRUCIAL">‚≠ê Crucial</option>
                                <option value="TITULAR">‚úÖ Titular</option>
                                <option value="ROTACAO">üîÑ Rota√ß√£o</option>
                                <option value="RESERVA">üí§ Reserva</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style={{display:'flex', gap:10, marginTop:15}}>
                    <button className="btn btn-green" style={{flex: 2}} onClick={() => {
                        // Se for pr√©-contrato, o valor √© 0
                        const finalVal = isPreContract ? 0 : v;
                        onSend(target, t, finalVal, swaps, (t === 'EMPRESTIMO' ? meta.loanDuration : con), {...meta, hasBuyOption, newSalary: parseFloat(sal), role, status: 'PENDING'}, old);
                    }}>
                        {isUrgentRenewal ? 'OFERECER RENOVA√á√ÉO' : (isPreContract ? 'ENVIAR PR√â-CONTRATO' : 'ENVIAR RESPOSTA')}
                    </button>
                    <button className="btn btn-red" style={{flex: 1}} onClick={()=>setModal(null)}>CANCELAR</button>
                </div>
            </div>
        </div>
    );
};
// FIM DO COMPONENTE MARKET E OFFER FORM


const OffersScreen = ({ user, offers, teams, onAccept, onReject, onCounter }) => {
    // FILTRO RIGOROSO: 
    // A proposta s√≥ aparece se o usu√°rio logado for o destinat√°rio atual (recipientId).
    // Isso garante o fluxo: Comprador -> Vendedor -> Jogador.
    // Ao enviar uma contraproposta, o recipientId muda e ela some automaticamente daqui.
    const myOffers = offers.filter(o => 
        o.recipientId === user.data.id && 
        o.status === 'PENDING'
    );

    return (
        <div>
            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom: 15}}>
                <h3 style={{margin:0}}>Caixa de Entrada ({myOffers.length})</h3>
                <button className="btn btn-ghost" style={{width:'auto', padding:'5px 10px'}} onClick={() => window.location.reload()}>
                    <i className="fas fa-sync"></i> ATUALIZAR
                </button>
            </div>

            {myOffers.length === 0 && (
                <div style={{marginTop: 30, textAlign:'center'}}>
                    <i className="fas fa-envelope-open" style={{fontSize: 40, color: '#333', marginBottom: 10}}></i>
                    <p style={{color:'#666'}}>Nenhuma proposta aguardando sua a√ß√£o no momento.</p>
                </div>
            )}
            
            {myOffers.map(o => (
                <div key={o.id} className="card" style={{borderLeft: o.type === 'NOTIFICACAO' ? '4px solid #00E676' : '4px solid gold', background: '#1e1e1e'}}>
                    
                    {/* AVISOS DE STATUS REALISTA PARA O JOGADOR */}
                    {o.sellerAccepted && user.type === 'PLAYER' && (
                        <div style={{background:'rgba(0,230,118,0.2)', color:'var(--primary)', padding:'6px', borderRadius:8, fontSize:10, marginBottom:10, textAlign:'center', fontWeight:'bold', border:'1px solid var(--primary)'}}>
                            ‚úÖ O SEU CLUBE ACEITOU A VENDA. DEPENDE DE VOC√ä!
                        </div>
                    )}

                    {!o.sellerAccepted && user.type === 'PLAYER' && o.sellerId !== 'FREE' && (
                        <div style={{background:'rgba(255,196,0,0.1)', color:'var(--warning)', padding:'6px', borderRadius:8, fontSize:10, marginBottom:10, textAlign:'center', fontWeight:'bold', border:'1px solid var(--warning)'}}>
                            ‚è≥ SEU CLUBE AINDA EST√Å ANALISANDO A TAXA DE TRANSFER√äNCIA.
                        </div>
                    )}

                    <div style={{display:'flex', justifyContent:'space-between'}}>
                        <b style={{color:'var(--primary)', fontSize:16}}>{o.playerName}</b>
                        <span style={{fontSize:10, background: o.type === 'NOTIFICACAO' ? '#00E676' : 'gold', color:'black', padding:'2px 5px', borderRadius:4, fontWeight:'bold'}}>{o.type}</span>
                    </div>
                    <small style={{display:'block', marginBottom:10, color: '#aaa'}}>
                        {o.type === 'NOTIFICACAO' ? 'Remetente:' : 'Interessado:'} <b style={{color:'#fff'}}>{o.buyerName}</b>
                    </small>
                    
                    <div style={{background:'#121212', padding:12, borderRadius:8, whiteSpace:'pre-wrap', fontSize:12, border:'1px solid #333', lineHeight:'1.5', color: '#eee', marginBottom: 10}}>
                        {o.description}
                    </div>

                    {/*v1.54.1: L√ìGICA DE BOT√ÉO CONDICIONAL (NOTIFICA√á√ÉO VS OFERTA) */}
                    {o.type === 'NOTIFICACAO' ? (
                        <div style={{display:'flex', gap:5}}>
                            <button className="btn btn-green" style={{width:'100%'}} onClick={()=>onAccept(o)}>
                                <i className="fas fa-check"></i> ENTENDIDO
                            </button>
                        </div>
                    ) : (
                        <div style={{display:'flex', gap:5}}>
                            <button className="btn btn-green" style={{flex:1}} onClick={()=>onAccept(o)}>ACEITAR</button>
                            <button className="btn btn-blue" style={{flex:1}} onClick={()=>onCounter(o)}>CONTRA</button>
                            <button className="btn btn-red" style={{flex:1}} onClick={()=>onReject(o)}>RECUSAR</button>
                        </div>
                    )}
                </div>
            ))}
        </div>
    );
};


const Ranking = ({ teams, players }) => {
            const [view, setView] = React.useState('TEAMS');

            // Filtra para n√£o mostrar jogadores bugados (sem time)
            const validPlayers = players.filter(p => p.teamId && p.teamId !== 'FREE' && p.name);

            const renderTeams = () => teams
                .filter(t => t.status !== 'PENDING')
                .map(t => {
                    const squadValue = validPlayers.filter(p => p.teamId === t.id).reduce((a, b) => a + (parseFloat(b.value) || 0), 0);
                    return { ...t, totalWealth: (parseFloat(t.balance) || 0) + squadValue, squadValue };
                })
                .sort((a, b) => b.totalWealth - a.totalWealth)
                .map((t, i) => (
                    <div key={t.id} className="card" style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                        <b style={{ fontSize: 20, color: '#555', width: 30 }}>{i + 1}</b>
                        {t.logo ? <img src={t.logo} style={{ width: 35, height: 35, borderRadius: '50%', objectFit: 'cover' }} /> : <div style={{ width: 35 }}></div>}
                        <div style={{ flex: 1 }}>
                            <b>{t.name}</b><br />
                            <small style={{ color: 'var(--primary)', fontWeight: 'bold' }}>Patrim√¥nio: {fmt(t.totalWealth)}</small>
                        </div>
                    </div>
                ));

            const renderPlayers = (sortKey, label, color, isStat = true) => {
                let sorted = [];
                if (isStat) {
                    sorted = validPlayers.filter(p => p.stats && p.stats[sortKey] > 0).sort((a, b) => (b.stats[sortKey] || 0) - (a.stats[sortKey] || 0));
                } else {
                    sorted = [...validPlayers].sort((a, b) => (parseFloat(b[sortKey]) || 0) - (parseFloat(a[sortKey]) || 0));
                }

                return sorted.slice(0, 20).map((p, i) => (
                    <div key={p.id} className="card" style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                        <b style={{ fontSize: 20, color: '#555', width: 30 }}>{i + 1}</b>
                        <div style={{ flex: 1 }}>
                            <b>{p.name}</b> <small>({teams.find(t => t.id === p.teamId)?.name})</small>
                        </div>
                        <div style={{ fontWeight: 'bold', fontSize: 14, color: color }}>
                            {label} {isStat ? p.stats[sortKey] : (sortKey === 'salary' ? fmt(p[sortKey]) : p[sortKey])}
                        </div>
                    </div>
                ));
            };

            return (
                <div>
                    <h3>Ranking e Estat√≠sticas</h3>
                    <div className="rank-tabs">
                        <div className={`rank-tab ${view === 'TEAMS' ? 'active' : ''}`} onClick={() => setView('TEAMS')}>üí∞ Clubes</div>
                        <div className={`rank-tab ${view === 'OVERALL' ? 'active' : ''}`} onClick={() => setView('OVERALL')}>‚≠ê Craques</div>
                        <div className={`rank-tab ${view === 'SALARY' ? 'active' : ''}`} onClick={() => setView('SALARY')}>üí∏ Sal√°rios</div>
                        <div className={`rank-tab ${view === 'GOALS' ? 'active' : ''}`} onClick={() => setView('GOALS')}>‚öΩ Gols</div>
                        <div className={`rank-tab ${view === 'ASSIST' ? 'active' : ''}`} onClick={() => setView('ASSIST')}>üëü Assis</div>
                        <div className={`rank-tab ${view === 'SAVES' ? 'active' : ''}`} onClick={() => setView('SAVES')}>üß§ Defesas</div>
                        <div className={`rank-tab ${view === 'YEL' ? 'active' : ''}`} onClick={() => setView('YEL')}>üü® Amarelos</div>
                        <div className={`rank-tab ${view === 'RED' ? 'active' : ''}`} onClick={() => setView('RED')}>üü• Vermelhos</div>
                    </div>

                    <div style={{ marginTop: 10 }}>
                        {view === 'TEAMS' && renderTeams()}
                        {view === 'OVERALL' && renderPlayers('overall', 'Ov:', 'var(--warning)', false)}
                        {view === 'SALARY' && renderPlayers('salary', '', 'var(--primary)', false)}
                        {view === 'GOALS' && renderPlayers('goals', '‚öΩ', '#fff')}
                        {view === 'ASSIST' && renderPlayers('assists', 'üëü', '#fff')}
                        {view === 'SAVES' && renderPlayers('saves', 'üß§', '#fff')}
                        {view === 'YEL' && renderPlayers('yellows', 'üü®', 'yellow')}
                        {view === 'RED' && renderPlayers('reds', 'üü•', 'red')}
                    </div>
                </div>
            );
        };

// FIM DO COMPONENTE RANKING

// --- COMPONENTES QUE FALTAVAM (S√∫mula e Tabela) ---

        const MatchPerformanceForm = ({ players, teams, onSaveStats }) => {
            const [selP, setSelP] = useState(null);
            const [match, setMatch] = useState({ goals:0, assists:0, tackles:0, saves:0, yellows:0, reds:0, rating:'', result:'NENHUM' }); 
            const [search, setSearch] = useState('');

            // Calcula XP (INTERNO - O JORNALISTA N√ÉO V√ä MAIS)
            const calcMatchXP = () => {
                let xp = 0;
                // Usa regras padr√£o se n√£o existirem
                const R = (typeof XP_RULES !== 'undefined') ? XP_RULES : { GOAL: 150, ASSIST: 120, TACKLE: 80, SAVE: 100, WIN: 300, DRAW: 100, LOSS: -100, YELLOW: -50, RED: -200, RATING_MULT: 50 };
                
                xp += (match.goals || 0) * R.GOAL;
                xp += (match.assists || 0) * R.ASSIST;
                xp += (match.tackles || 0) * R.TACKLE;
                xp += (match.saves || 0) * R.SAVE;
                xp += (match.yellows || 0) * R.YELLOW;
                xp += (match.reds || 0) * R.RED;
                
                if (match.result === 'VITORIA') xp += R.WIN;
                if (match.result === 'EMPATE') xp += R.DRAW;
                if (match.result === 'DERROTA') xp += R.LOSS;
                
                // IMPORTANTE: Usa a nota do ADMIN (selP.rating) para o c√°lculo oficial do XP
                // Se o admin n√£o deu nota ainda, usa 0 (ou seja, s√≥ ganha XP de scout por enquanto)
                xp += (parseFloat(selP.rating) || 0) * R.RATING_MULT;
                
                return parseInt(xp);
            };

            const filtered = players.filter(p => p.name.toLowerCase().includes(search.toLowerCase()));

            // TELA 1: Preenchendo a S√∫mula (Quando selecionou um jogador)
            if (selP) return (
                <div>
                    <h3 style={{color:'var(--primary)'}}>S√∫mula: {selP.name}</h3>
                    <div style={{background:'rgba(255,255,255,0.05)', padding:10, borderRadius:8, marginBottom:10}}>
                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10}}>
                            <div><label>‚öΩ Gols</label><input className="input-field" type="number" value={match.goals} onChange={e=>setMatch({...match, goals:parseInt(e.target.value)})} /></div>
                            <div><label>üëü Assist√™ncias</label><input className="input-field" type="number" value={match.assists} onChange={e=>setMatch({...match, assists:parseInt(e.target.value)})} /></div>
                            <div><label>üõ°Ô∏è Desarmes</label><input className="input-field" type="number" value={match.tackles} onChange={e=>setMatch({...match, tackles:parseInt(e.target.value)})} /></div>
                            <div><label>üß§ Defesas</label><input className="input-field" type="number" value={match.saves} onChange={e=>setMatch({...match, saves:parseInt(e.target.value)})} /></div>
                            <div><label>üü® Amarelo</label><input className="input-field" type="number" value={match.yellows} onChange={e=>setMatch({...match, yellows:parseInt(e.target.value)})} /></div>
                            <div><label>üü• Vermelho</label><input className="input-field" type="number" value={match.reds} onChange={e=>setMatch({...match, reds:parseInt(e.target.value)})} /></div>
                        </div>
                        <hr style={{borderColor:'#444'}}/>
                        
                        {/* TRAVA DE SEGURAN√áA NA NOTA (M√ÅXIMO 10) */}
                        <label>‚≠ê Nota da Atua√ß√£o (Jornalista)</label>
                        <input className="input-field" type="number" step="0.1" min="0" max="10" placeholder="0.0 a 10.0" 
                            value={match.rating} 
                            onChange={e=> {
                                let v = parseFloat(e.target.value);
                                if(v > 10) v = 10; 
                                if(v < 0) v = 0;
                                setMatch({...match, rating: v})
                            }} 
                        />
                        
                        <label>üö© Resultado do Time</label>
                        <select className="input-field" value={match.result} onChange={e=>setMatch({...match, result:e.target.value})}>
                            <option value="NENHUM">-- Neutro --</option>
                            <option value="VITORIA">Vit√≥ria</option>
                            <option value="EMPATE">Empate</option>
                            <option value="DERROTA">Derrota</option>
                        </select>
                    </div>
                    <div style={{display:'flex', gap:10}}>
                        <button className="btn btn-green" onClick={()=>onSaveStats(selP, match, calcMatchXP())}>LAN√áAR NA S√öMULA</button>
                        <button className="btn" onClick={()=>setSelP(null)}>VOLTAR</button>
                    </div>
                </div>
            );

            // TELA 2: Buscando Jogador (Retorno Principal)
            return (
                <div>
                    <h3>Lan√ßar Desempenho</h3>
                    <input className="input-field" placeholder="Buscar jogador..." value={search} onChange={e=>setSearch(e.target.value)} />
                    <div style={{maxHeight:300, overflowY:'auto'}}>
                        {search.length > 0 && filtered.map(p => (
                            <div key={p.id} className="card" onClick={()=>{setSelP(p); setMatch({goals:0, assists:0, tackles:0, saves:0, yellows:0, reds:0, rating:'', result:'NENHUM'});}}>
                                <b>{p.name}</b> <small>({teams.find(t=>t.id===p.teamId)?.name})</small>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

// FIM DO COMPONENTE MATCH PERFORMANCE FORM


       const TeamStandingsEditor = ({ teams, onUpdateTeamStats }) => {
            return (
                <div>
                    <h3>Editar Tabela (Jornalista)</h3>
                    <div style={{maxHeight:400, overflowY:'auto'}}>
                        {teams.filter(t=>t.status!=='PENDING').map(t => (
                            <div key={t.id} className="card" style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                <div style={{width:'30%'}}><b>{t.name}</b></div>
                                <div style={{display:'flex', gap:5}}>
                                    <div style={{textAlign:'center'}}><small>V</small><input className="input-field" type="number" style={{width:40, padding:5, marginBottom:0}} defaultValue={t.stats?.wins||0} id={`w-${t.id}`} /></div>
                                    <div style={{textAlign:'center'}}><small>E</small><input className="input-field" type="number" style={{width:40, padding:5, marginBottom:0}} defaultValue={t.stats?.draws||0} id={`d-${t.id}`} /></div>
                                    <div style={{textAlign:'center'}}><small>D</small><input className="input-field" type="number" style={{width:40, padding:5, marginBottom:0}} defaultValue={t.stats?.losses||0} id={`l-${t.id}`} /></div>
                                    <button className="btn btn-green" style={{width:'auto', height:35, marginTop:18}} onClick={()=>{
                                        const w = parseInt(document.getElementById(`w-${t.id}`).value)||0;
                                        const d = parseInt(document.getElementById(`d-${t.id}`).value)||0;
                                        const l = parseInt(document.getElementById(`l-${t.id}`).value)||0;
                                        onUpdateTeamStats(t.id, {wins:w, draws:d, losses:l});
                                    }}>üíæ</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

// FIM DO COMPONENTE TEAM STANDINGS EDITOR

        
const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);

    </script>
</body>
</html>
